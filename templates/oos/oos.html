<!DOCTYPE html>
<html lang="ru">
<head>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="/static/css/sidebar.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìà OOS —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.umd.js"></script>
    <style>
        #resultModelsSection { font-size: 12px; }
        #resultModelsSection #resultModelsList { display: block; overflow: visible; padding: 0; }
        #resultModelsTable { width: 100%; border-collapse: collapse; table-layout: fixed; }
        #resultModelsTable th, #resultModelsTable td { padding: 6px 8px; text-align: left; vertical-align: middle; }
        #resultModelsTable th { background: #f5f7fb; font-weight: 600; }
        #resultModelsTable tr:nth-child(even) { background: #fafbfe; }
        #resultModelsTable .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
        #resultModelsTable .muted { color: #6b7280; }
        #resultModelsTable .nowrap { white-space: nowrap; }
        #resultModelsTable .truncate { max-width: 360px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: inline-block; vertical-align: bottom; }
        #resultModelsSection .button-group { margin-bottom: 10px; }
        #resultModelsSection .btn.btn-danger { font-size: 12px; padding: 6px 10px; }
        #resultModelsSection .btn { font-size: 11px; padding: 4px 8px; margin: 1px; white-space: nowrap; }
        #resultModelsSection .btn-group { display: flex; gap: 4px; flex-wrap: wrap; justify-content: flex-end; }
        #resultModelsSection .btn-group .btn { margin: 0; }
    </style>
</head>
<body>
    <nav class="sidebar">
        <h3>üìã –ù–∞–≤–∏–≥–∞—Ü–∏—è</h3>
        <ul class="sidebar-nav">
            <li><a href="/" class="back-link">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a></li>
            <li><a href="javascript:history.back()">‚Üê –ù–∞–∑–∞–¥</a></li>
            <li><a href="#result-models" onclick="scrollToSection('result-models')">üóëÔ∏è –ú–æ–¥–µ–ª–∏ –≤ result</a></li>
            <li><a href="#oos-results" onclick="scrollToSection('oos-results')">üìà OOS —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</a></li>
        </ul>
    </nav>

    <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>

    <div class="container">
        <div class="main-content">
            <div class="header">
                <h1>üìà OOS –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Result</h1>
                <p>–ò—Å—Ç–æ—Ä–∏—è —Ç–µ—Å—Ç–æ–≤ –∏ –æ—á–∏—Å—Ç–∫–∞ –ø–∞–ø–∫–∏ result</p>
            </div>

            <div class="content">
                <a href="/" class="back-link">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>

                <div class="section" id="result-models">
                    <h2>üóëÔ∏è –ú–æ–¥–µ–ª–∏ –≤ result</h2>
                    <p>–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫–µ <code>result/</code> —Å –∫—Ä–∞—Ç–∫–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π. –ú–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –∫–æ–º–ø–ª–µ–∫—Ç (–≤–µ—Å–∞, –±—É—Ñ–µ—Ä, —Ä–µ–∑—É–ª—å—Ç–∞—Ç) –ø–æ –∫–æ–¥—É –º–æ–¥–µ–ª–∏.</p>
                    <div class="button-group">
                        <button class="btn btn-info" id="refreshResultModelsBtn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
                    </div>
                    <div id="resultModelsList">
                        <div class="loading"><div class="spinner"></div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    </div>
                </div>

                <div class="section" id="oos-results">
                    <h2>üìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã OOS (–∫–æ–ø–∏—Ä—É–µ–º—ã–µ)</h2>
                    <div style="margin-bottom:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
                        <button class="btn btn-info" id="openOOSModalBtn">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ OOS</button>
                        <button class="btn btn-secondary" id="clearOOSResultsBtn">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
                        <div class="muted" style="font-size:12px;">
                            <strong>–ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏:</strong><br>
                            ‚úÖ <span style="color:#10b981;">–ö–∞–Ω–¥–∏–¥–∞—Ç –Ω–∞ –¥–æ–æ–±—É—á–µ–Ω–∏–µ</span>: ROI>10%, PF‚â•1.2, PLR>1.0, MaxDD<40%<br>
                            ‚ùå <span style="color:#ef4444;">–î–æ–æ–±—É—á–∞—Ç—å –Ω–µ–ª—å–∑—è</span>: ROI‚â§0% –ò–õ–ò PF<1.0 –ò–õ–ò PLR<1.0 –ò–õ–ò MaxDD>70%<br>
                            ‚ö†Ô∏è <span style="color:#6b7280;">–¢—Ä–µ–±—É–µ—Ç –∞–Ω–∞–ª–∏–∑–∞</span>: —Å—Ä–µ–¥–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
                        </div>
                    </div>
                    <div id="oosChart" style="height: 400px; margin-bottom: 20px;"></div>
                    <div id="oosResults"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function scrollToSection(id){
            const el = document.getElementById(id);
            if(el){ el.scrollIntoView({behavior:'smooth'}); }
        }

        function toggleSidebar(){ document.body.classList.toggle('sidebar-open'); }

    </script>
    <script>
        // --- –í—Å—Ç–∞–≤–ª–µ–Ω –ø–æ–ª–Ω—ã–π JS –±–ª–æ–∫ –∏–∑ models.html ---
        async function refreshResultModels() {
            console.log('refreshResultModels: starting');
            const listDiv = document.getElementById('resultModelsList');
            if (!listDiv) {
                console.log('refreshResultModels: listDiv not found, returning');
                return;
            }
            listDiv.innerHTML = '<div class="loading"><div class="spinner"></div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            try {
                const symResp = await fetch('/api/runs/symbols');
                const symData = await symResp.json();
                console.log('refreshResultModels: /api/runs/symbols response:', symData);
                if(!symData.success){
                    console.error('Error fetching symbols:', symData.error);
                    listDiv.innerHTML = '<div class="status error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∏–º–≤–æ–ª–æ–≤</div>';
                    return;
                }
                const symbols = Array.isArray(symData.symbols)? symData.symbols: [];
                console.log('refreshResultModels: processed symbols:', symbols);
                if(symbols.length===0){ listDiv.innerHTML = '<div class="status info">üì≠ –ü–∞–ø–∫–∞ result –ø—É—Å—Ç–∞</div>'; return; }

                const rows = [];
                for(const s of symbols){
                    try{
                        console.log(`refreshResultModels: fetching runs for symbol: ${s}`);
                        const r = await fetch('/api/runs/list?symbol='+encodeURIComponent(s));
                        const d = await r.json();
                        console.log(`refreshResultModels: /api/runs/list?symbol=${s} response:`, d);
                        if (!d.success) {
                            console.error(`Error fetching runs for ${s}:`, d.error);
                            continue; // –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —ç—Ç–æ—Ç —Å–∏–º–≤–æ–ª –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –¥—Ä—É–≥–∏–º–∏
                        }
                        const runs = Array.isArray(d.runs)? d.runs: [];
                        console.log(`refreshResultModels: processed runs for ${s}:`, runs);
                        const idToNode = {}; const idToChildren = {};
                        runs.forEach(x=>{ idToNode[x.run_id]=x; idToChildren[x.run_id]=[]; });
                        runs.forEach(x=>{
                            if(x.parent_run_id) {
                                if(idToChildren[x.parent_run_id]) {
                                    idToChildren[x.parent_run_id].push(x.run_id);
                                }
                            }
                        });
                        const roots = runs.filter(x=>!x.parent_run_id || !idToNode[x.parent_run_id]).map(x=>x.run_id);

                        async function renderRunRow(runId, depth){
                            const run = idToNode[runId]; if(!run) return;
                            let win = 'N/A', plr = 'N/A', episodes = 'N/A';
                            let isBad = false;
                            if(typeof run.winrate === 'number') {
                                win = (run.winrate * 100).toFixed(1) + '%';
                                if(run.winrate < 0.5) isBad = true;
                            }
                            if(typeof run.pl_ratio === 'number') {
                                plr = run.pl_ratio.toFixed(2);
                                if(run.pl_ratio < 1.0) isBad = true;
                            }
                            if(run.episodes != null) episodes = run.episodes;
                            const indent = `<span style="display:inline-block; width:${depth*16}px;"></span>`;
                            const label = `${depth>0?'‚ñ∏ ':''}${run.run_id}`;
                            const parent = (run.parent_run_id && idToNode[run.parent_run_id]) ? run.parent_run_id : '‚Äî';
                            const oosBtn = run.model_path ? `<button class="btn btn-info" onclick="runOOSTest('${run.run_id}','${run.model_path}')">Test</button>` : '';
                            const showResultsBtn = `<button class="btn btn-secondary" onclick="showOOSResults('${s}','${run.run_id}')">Result</button>`;
                            const graphBtn = `<a class="btn btn-secondary" target="_blank" href="/oos_graph?symbol=${encodeURIComponent(s)}&run=${encodeURIComponent(run.run_id)}">Graph</a>`;
                            const delBtn = `<button class="btn btn-danger" onclick="deleteRun('${s}','${run.run_id}')">‚úñ</button>`;
                            const buttonsHtml = `<div class="btn-group">${oosBtn}${showResultsBtn}${graphBtn}${delBtn}</div>`;
                            const rowStyle = isBad ? 'style="background-color: #fef2f2; border-left: 3px solid #ef4444;"' : '';
                            rows.push(`
                                <tr ${rowStyle}>
                                    <td class="nowrap">${s}</td>
                                    <td class="nowrap">${indent}${label}</td>
                                    <td class="nowrap">${parent}</td>
                                    <td class="nowrap">${win}</td>
                                    <td class="nowrap">${plr}</td>
                                    <td class="nowrap">${episodes}</td>
                                    <td class="nowrap" style="text-align:right;">${buttonsHtml}</td>
                                </tr>
                            `);
                            const children = idToChildren[runId]||[];
                            for(const cid of children){ await renderRunRow(cid, depth+1); }
                        }
                        for(const rootId of roots){ await renderRunRow(rootId, 0); }
                    }catch(e){ console.error(`Error processing symbol ${s}:`, e); }
                }
                const header = `
                    <thead>
                        <tr>
                            <th class="nowrap">–°–∏–º–≤–æ–ª</th>
                            <th class="nowrap">–ú–æ–¥–µ–ª—å</th>
                            <th class="nowrap">–†–æ–¥–∏—Ç–µ–ª—å</th>
                            <th class="nowrap">Winrate</th>
                            <th class="nowrap">P/L Ratio</th>
                            <th class="nowrap">–≠–ø–∏–∑–æ–¥—ã</th>
                            <th class="nowrap" style="width:300px; text-align:right;">–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>`;
                listDiv.innerHTML = rows.length>0 ? `<table id="resultModelsTable">${header}<tbody>${rows.join('')}</tbody></table>` : '<div class="status info">üì≠ –ü–∞–ø–∫–∞ result –ø—É—Å—Ç–∞</div>';
                if (rows.length === 0) {
                    console.log('refreshResultModels: No rows rendered, resultModelsList should show empty message');
                }
            } catch (e) {
                console.error('Error in refreshResultModels:', e);
                listDiv.innerHTML = `<div class="status error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${e.message}</div>`;
            }
        }

        function deleteRun(symbol, runId){
            if(!confirm(`–£–¥–∞–ª–∏—Ç—å run ${runId} –¥–ª—è ${symbol}?`)) return;
            fetch('/api/runs/delete', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({symbol, run_id: runId})})
                .then(r=>r.json()).then(data=>{
                    if(data.success){ refreshResultModels(); }
                    else{ alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: '+(data.error||'Unknown')); }
                }).catch(e=> alert('–°–µ—Ç—å: '+e.message));
        }

        async function showOOSResults(symbol, runId){
            try{
                const resp = await fetch(`/api/runs/oos_results?symbol=${encodeURIComponent(symbol)}&run_id=${encodeURIComponent(runId)}`);
                const data = await resp.json();
                if(!data.success){
                    alert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: ' + (data.error || 'Unknown'));
                    return;
                }
                const oosData = data.data;
                const counters = oosData.counters || {};
                const history = oosData.history || [];
                ensureOOSPanel();
                const wrap = document.getElementById('oosResults');
                wrap.innerHTML = '';
                const totalTests = (counters.good||0) + (counters.bad||0) + (counters.neutral||0);
                const summaryHtml = `
                    <div class="card" style="margin-bottom: 16px; border: 1px solid #e5e7eb;">
                        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
                            <div class="mono" style="font-weight:600;">üìä –ò—Å—Ç–æ—Ä–∏—è OOS —Ç–µ—Å—Ç–æ–≤: ${symbol}/${runId}</div>
                            <div class="muted">–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤: ${totalTests}</div>
                        </div>
                        <div style="margin:8px 0; display:flex;gap:16px;">
                            <span class="badge" style="background:#10b981;color:#fff;border-radius:4px;padding:4px 8px;">
                                ‚úÖ –•–æ—Ä–æ—à–∏–µ: ${counters.good || 0}
                            </span>
                            <span class="badge" style="background:#ef4444;color:#fff;border-radius:4px;padding:4px 8px;">
                                ‚ùå –ü–ª–æ—Ö–∏–µ: ${counters.bad || 0}
                            </span>
                            <span class="badge" style="background:#6b7280;color:#fff;border-radius:4px;padding:4px 8px;">
                                ‚ö†Ô∏è –°—Ä–µ–¥–Ω–∏–µ: ${counters.neutral || 0}
                            </span>
                        </div>
                    </div>
                `;
                wrap.insertAdjacentHTML('afterbegin', summaryHtml);
                const sortedHistory = [...history].reverse();
                for(const test of sortedHistory){
                    const metrics = test.metrics || {};
                    const classification = test.classification || 'unknown';
                    const ts = new Date(test.ts || '');
                    const timeStr = ts.toLocaleString('ru-RU');
                    let cardStyle = 'border: 1px solid #e5e7eb;';
                    if(classification === 'good'){
                        cardStyle = 'border: 1px solid #10b981; box-shadow: 0 0 0 2px rgba(16,185,129,0.12);';
                    } else if(classification === 'bad'){
                        cardStyle = 'border: 1px solid #ef4444; box-shadow: 0 0 0 2px rgba(239,68,68,0.12);';
                    }
                    const roiPct = metrics.roi_pct != null ? metrics.roi_pct.toFixed(2) + '%' : 'N/A';
                    const winrate = metrics.winrate != null ? (metrics.winrate * 100).toFixed(1) + '%' : 'N/A';
                    const plr = metrics.pl_ratio != null ? metrics.pl_ratio.toFixed(2) : 'N/A';
                    const pf = metrics.profit_factor != null ? metrics.profit_factor.toFixed(2) : 'N/A';
                    const maxdd = metrics.max_dd != null ? (metrics.max_dd * 100).toFixed(1) + '%' : 'N/A';
                    const trades = metrics.trades != null ? metrics.trades : 'N/A';
                    const gateInfo = test.gate_disable ? 'Q-gate: –æ—Ç–∫–ª—é—á–µ–Ω' : (test.gate_scale != null ? `Q-gate: ${((1-test.gate_scale)*100).toFixed(0)}%` : 'Q-gate: —Å—Ç–∞–Ω–¥–∞—Ä—Ç');
                    const testCard = `
                        <div class="card" style="${cardStyle}">
                            <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
                                <div class="mono" style="font-weight:600;">${test.days}–¥ ${gateInfo}</div>
                                <div class="muted">${timeStr}</div>
                            </div>
                            <pre style="white-space:pre-wrap;margin:6px 0;">
ROI: ${roiPct} | Winrate: ${winrate} | PLR: ${plr} | PF: ${pf} | MaxDD: ${maxdd} | Trades: ${trades}
Symbol: ${test.symbol || 'N/A'} | Capital: ${metrics.start_capital || 'N/A'}
                            </pre>
                        </div>
                    `;
                    wrap.insertAdjacentHTML('beforeend', testCard);
                }
            }catch(e){
                console.error('[OOS Results] error', e);
                alert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: ' + e.message);
            }
        }

        function clearOOSResults(){
            const wrap = document.getElementById('oosResults');
            if(wrap){ wrap.innerHTML = '<div class="status info">üì≠ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—á–∏—â–µ–Ω—ã</div>'; }
        }

        function openOOSModal(){
            if(document.getElementById('oosModal')){ document.getElementById('oosModal').style.display='block'; return; }
            const html = `
                <div id="oosModal" style="position:fixed;inset:0;display:block;background:rgba(0,0,0,0.4);z-index:9999;">
                    <div style="background:#fff;max-width:460px;margin:10% auto;padding:16px;border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,.2);">
                        <h3 style="margin-top:0;">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ OOS</h3>
                        <div class="form-group">
                            <label><input type="checkbox" id="oosGateDisable"> –û—Ç–∫–ª—é—á–∏—Ç—å Q‚Äëgate (T1/T2=0)</label>
                        </div>
                        <div class="form-group">
                            <label>–ë–∏—Ä–∂–∞ –¥–ª—è OOS</label>
                            <select id="oosExchange" class="form-control">
                                <option value="bybit" selected>Bybit</option>
                                <option value="binance">Binance</option>
                            </select>
                            <div class="muted">–ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω–∞—è –±–∏—Ä–∂–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–≤—Ç–æ‚Äë—Ñ–æ–ª–±—ç–∫</div>
                        </div>
                        <div class="form-group">
                            <label>–°–Ω–∏–∑–∏—Ç—å –ø–æ—Ä–æ–≥–∏ Q‚Äëgate –Ω–∞ –¥–æ–ª—é (0..1)</label>
                            <input type="number" id="oosGateScale" class="form-control" step="0.05" min="0" max="1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 0.5">
                            <div class="muted">0.5 = –ø–æ—Ä–æ–≥–∏ –≤–¥–≤–æ–µ –Ω–∏–∂–µ; –ø—É—Å—Ç–æ = –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π</div>
                        </div>
                        <div class="form-group">
                            <label>–°—Ç–∞—Ä—Ç–æ–≤—ã–π –∫–∞–ø–∏—Ç–∞–ª (–¥–ª—è MaxDD)</label>
                            <input type="number" id="oosStartCapital" class="form-control" step="100" min="0" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 10000">
                            <div class="muted">–≠–∫–≤–∏—Ç–∏ = —Å—Ç–∞—Ä—Ç + PnL; MaxDD —Å—á–∏—Ç–∞–µ—Ç—Å—è –æ—Ç —ç–∫–≤–∏—Ç–∏</div>
                        </div>
                        <div class="form-group">
                            <label><input type="checkbox" id="oosMultiRuns"> –í—ã–ø–æ–ª–Ω–∏—Ç—å 3 –ø—Ä–æ–≥–æ–Ω–∞: 100% / 50% / 0% –ø–æ—Ä–æ–≥–æ–≤</label>
                        </div>
                        <div style="text-align:right;display:flex;gap:8px;justify-content:flex-end;">
                            <button class="btn" onclick="document.getElementById('oosModal').style.display='none'">–ó–∞–∫—Ä—ã—Ç—å</button>
                            <button class="btn btn-info" onclick="document.getElementById('oosModal').style.display='none'">OK</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }

        function ensureOOSPanel(){}

        async function runOOSTest(code, filename){
            const file = filename || '';
            const name = code || (file.split('/').pop().split('\\').pop());
            try{
                const btn = event.target; const prev = btn.textContent; btn.disabled=true; btn.textContent='‚è≥ OOS...';
                const gateDisable = !!document.getElementById('oosGateDisable')?.checked;
                const multiRuns = !!document.getElementById('oosMultiRuns')?.checked;
                let gateScale = document.getElementById('oosGateScale')?.value;
                gateScale = gateScale===''? null : Number(gateScale);
                let startCapital = document.getElementById('oosStartCapital')?.value;
                startCapital = startCapital===''? null : Number(startCapital);
                const exchangeSel = document.getElementById('oosExchange');
                const exchange = exchangeSel ? (exchangeSel.value||'bybit') : 'bybit';
                const payloadBase = { filename:file, code:code, gate_disable: gateDisable, gate_scale: gateScale, start_capital: startCapital, exchange };
                const windows = [30,60,90];
                const scales = multiRuns ? [0.0, 0.5, 1.0] : [null];
                const allResults = [];
                const pending = [];
                for(const days of windows){
                    for(const s of scales){
                        const payload = {...payloadBase, days};
                        if (s !== null){ payload.gate_disable = false; payload.gate_scale = s; }
                        const r = await fetch('/oos_test_model_async', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
                        const j = await r.json().catch(()=>({success:false,error:'bad json'}));
                        if (j && j.success && j.task_id){ pending.push({days, scale:s, task_id:j.task_id}); }
                        else { allResults.push({days, scale:s, data:j}); }
                    }
                }
                async function waitTask(task_id){
                    for(let tries=0; tries<600; tries++){
                        await new Promise(r=>setTimeout(r, 1000));
                        const s = await fetch('/oos_test_status?task_id='+encodeURIComponent(task_id));
                        const sj = await s.json().catch(()=>null);
                        if (sj && sj.state === 'SUCCESS' && sj.result){ return sj.result; }
                        if (sj && sj.state === 'FAILURE' && sj.result){ return sj.result; }
                    }
                    return {success:false, error:'timeout waiting task '+task_id};
                }
                const settled = await Promise.all(pending.map(async item=>{
                    const data = await waitTask(item.task_id);
                    return {days:item.days, scale:item.scale, data};
                }));
                allResults.push(...settled);
                btn.disabled=false; btn.textContent=prev;
                ensureOOSPanel();
                const wrap = document.getElementById('oosResults');
                wrap.innerHTML = '';
                const first = (allResults[0]||{}).data || {success:false};
                const chartDiv = document.getElementById('oosChart');
                if (chartDiv) { chartDiv.innerHTML = ''; }
                if(!first.success){
                    const err = '‚ùå OOS: '+(first.error||'–æ—à–∏–±–∫–∞');
                    if (wrap){
                        const el = document.createElement('div'); el.className = 'status error'; el.textContent = err; wrap.prepend(el);
                    } else { alert(err); }
                    return;
                }
                function renderCard(title, res){
                    const r = (res||{}).result || {};
                    const details = Array.isArray(r.trades_details)? r.trades_details: [];
                    const roiPct = (r && r.start_capital && typeof r.pnl_total === 'number') ? ((r.pnl_total / r.start_capital) * 100.0) : null;
                    const isGood = (roiPct!=null && roiPct>10) && (r.profit_factor==null || r.profit_factor>=1.2) && (r.pl_ratio==null || r.pl_ratio>1.0) && (r.max_dd==null || r.max_dd<0.40);
                    const isBad  = (roiPct!=null && roiPct<=0) || (r.profit_factor!=null && r.profit_factor<1.0) || (r.pl_ratio!=null && r.pl_ratio<1.0) || (r.max_dd!=null && r.max_dd>0.70);
                    let statusBadge = '';
                    if (isGood) {
                        statusBadge = '<span class="badge" style="background:#10b981;color:#fff;border-radius:4px;padding:2px 6px;">‚úÖ –ö–∞–Ω–¥–∏–¥–∞—Ç –Ω–∞ –¥–æ–æ–±—É—á–µ–Ω–∏–µ</span>';
                    } else if (isBad) {
                        statusBadge = '<span class="badge" style="background:#ef4444;color:#fff;border-radius:4px;padding:2px 6px;">‚ùå –î–æ–æ–±—É—á–∞—Ç—å –Ω–µ–ª—å–∑—è</span>';
                    } else {
                        statusBadge = '<span class="badge" style="background:#6b7280;color:#fff;border-radius:4px;padding:2px 6px;">‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –∞–Ω–∞–ª–∏–∑–∞</span>';
                    }
                    const dc = (r.decisions_counts||{});
                    const dBuy = Number(dc.buy||0), dHold = Number(dc.hold||0), dSell = Number(dc.sell||0);
                    const dTotal = (typeof r.decisions_total==='number')? r.decisions_total : (dBuy + dHold + dSell);
                    const ni = (r.nan_indicators!=null)? r.nan_indicators: '‚Äî';
                    const ii = (r.inf_indicators!=null)? r.inf_indicators: '‚Äî';
                    const lines = [title + ' ' + statusBadge,
                        `Winrate: ${r.winrate!=null?(r.winrate*100).toFixed(1)+'%':'N/A'}`,
                        `PLR: ${r.pl_ratio!=null?r.pl_ratio.toFixed(2):'N/A'}`,
                        `PF: ${r.profit_factor!=null?r.profit_factor.toFixed(2):'N/A'}`,
                        `MaxDD: ${r.max_dd!=null?(r.max_dd*100).toFixed(1)+'%':'N/A'}`,
                        `PnL: ${roiPct!=null?roiPct.toFixed(2)+'%':'N/A'}`,
                        `Trades: ${r.trades!=null?r.trades:'N/A'}`,
                        `Decisions: B=${dBuy} H=${dHold} S=${dSell} (total ${dTotal})`,
                        `Indicators NaN: ${ni} / Inf: ${ii}`,
                        r.symbol? `Symbol: ${r.symbol}`: '',
                        r.days!=null? `Window: ${r.days}d`: ''
                    ].filter(Boolean);
                    const text = lines.join('\n');
                    const item = document.createElement('div'); item.className = 'card';
                    if(isGood){ item.style.border = '1px solid #10b981'; item.style.boxShadow = '0 0 0 2px rgba(16,185,129,0.12)'; }
                    else if(isBad){ item.style.border = '1px solid #ef4444'; item.style.boxShadow = '0 0 0 2px rgba(239,68,68,0.12)'; }
                    const ts = new Date(); const hh = String(ts.getHours()).padStart(2,'0'); const mm = String(ts.getMinutes()).padStart(2,'0');
                    const tradesFile = r.trades_file || '';
                    const symbolForChart = r.symbol || '';
                    const runIdForChart = res.run_id || '';
                    let tradesButton = '';
                    if (tradesFile && symbolForChart && runIdForChart) {
                        const q = `symbol=${encodeURIComponent(symbolForChart)}&run=${encodeURIComponent(runIdForChart)}&trades=${encodeURIComponent(tradesFile)}`;
                        tradesButton = `<a class="btn btn-info" target="_blank" title="–û—Ç–∫—Ä—ã—Ç—å –≥—Ä–∞—Ñ–∏–∫" href="/oos_graph?${q}">–ì—Ä–∞—Ñ–∏–∫</a>`;
                    }
                    item.innerHTML = `
                        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;"><div class="mono" style="font-weight:600;">${name}</div><div class="muted">${hh}:${mm}</div></div>
                        <pre style="white-space:pre-wrap;margin:6px 0;">${text}</pre>
                        <div style="text-align:right;display:flex;gap:8px;justify-content:flex-end;"><button class="btn" data-text="${text.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}" onclick="copyText(this.getAttribute('data-text'))">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>${tradesButton}</div>`;
                    return item;
                }
                const groups = {30:[],60:[],90:[]};
                for(const r of allResults){ if(r.data&&r.data.success) groups[r.days].push(r); }
                const firstResult = allResults.find(r => r.data && r.data.success)?.data || {};
                const ohlcvData = allResults.find(r => r.data && r.data.success)?.data?.ohlcv_data || [];
                const tradesFilePath = allResults.find(r => r.data && r.data.success)?.data?.result?.trades_file || '';
                const runId = allResults.find(r => r.data && r.data.success)?.data?.run_id || '';
                const symbol = firstResult.symbol || '';
                if (ohlcvData.length > 0 && tradesFilePath && runId && symbol) {
                    await loadAndRenderTradesChart(symbol, runId, tradesFilePath, ohlcvData);
                }
                let stats = {good: 0, bad: 0, neutral: 0};
                for(const r of allResults){
                    if(r.data && r.data.success){
                        const res = r.data.result || {};
                        const roiPct = (res && res.start_capital && typeof res.pnl_total === 'number') ? ((res.pnl_total / res.start_capital) * 100.0) : null;
                        const isGood = (roiPct!=null && roiPct>10) && (res.profit_factor==null || res.profit_factor>=1.2) && (res.pl_ratio==null || res.pl_ratio>1.0) && (res.max_dd==null || res.max_dd<0.40);
                        const isBad  = (roiPct!=null && roiPct<=0) || (res.profit_factor!=null && res.profit_factor<1.0) || (res.pl_ratio!=null && res.pl_ratio<1.0) || (res.max_dd!=null && res.max_dd>0.70);
                        if(isGood) stats.good++;
                        else if(isBad) stats.bad++;
                        else stats.neutral++;
                    }
                }
                try {
                    await fetch('/api/strategies/save_stats', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ filename: file, code: code, stats: stats })
                    });
                } catch(e) {
                    console.warn('Failed to save OOS stats:', e);
                }
                for(const g of groups[30]){
                    const pct = (g.scale===null)? '100%' : ((1-g.scale)*100).toFixed(0)+'%';
                    const card = renderCard(`‚úÖ 30d (${pct})`, g.data);
                    wrap.prepend(card);
                }
                for(const g of groups[60]){
                    const pct = (g.scale===null)? '100%' : ((1-g.scale)*100).toFixed(0)+'%';
                    const card = renderCard(`‚úÖ 60d (${pct})`, g.data);
                    wrap.prepend(card);
                }
                for(const g of groups[90]){
                    const pct = (g.scale===null)? '100%' : ((1-g.scale)*100).toFixed(0)+'%';
                    const card = renderCard(`‚úÖ 90d (${pct})`, g.data);
                    wrap.prepend(card);
                }
            }catch(e){ console.error('[OOS] error', e); alert('‚ùå OOS —Å–µ—Ç—å: '+e.message); }
        }

        async function loadAndRenderTradesChart(symbol, runId, tradesFilePath, ohlcvData = []) {
            const chartDiv = document.getElementById('oosChart');
            if (!chartDiv) { console.error('oosChart div not found'); return; }
            try {
                const resp = await fetch(`/api/runs/trades?symbol=${encodeURIComponent(symbol)}&run_id=${encodeURIComponent(runId)}&trades_file=${encodeURIComponent(tradesFilePath)}`);
                const data = await resp.json();
                if (!data.success) {
                    console.error('Failed to load trades data:', data.error);
                    chartDiv.innerHTML = `<div class="status error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ —Å–¥–µ–ª–∫–∞—Ö: ${data.error}</div>`;
                    return;
                }
                const trades = Array.isArray(data.trades) ? data.trades : [];
                renderChart(ohlcvData, trades);
            } catch (e) {
                console.error('[OOS Chart] error loading trades', e);
                chartDiv.innerHTML = `<div class="status error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ —Å–¥–µ–ª–∫–∞—Ö: ${e.message}</div>`;
            }
        }

        let currentChart = null;
        function renderChart(ohlcvData, trades) {
            const chartDiv = document.getElementById('oosChart');
            if (!chartDiv) return;
            if (currentChart) {
                currentChart.remove();
                currentChart = null;
            }
            chartDiv.innerHTML = '';
            const chart = LightweightCharts.createChart(chartDiv, {
                width: chartDiv.clientWidth,
                height: 400,
                layout: { backgroundColor: '#ffffff', textColor: '#333' },
                grid: { vertLines: { color: '#e1e2e4' }, horzLines: { color: '#e1e2e4' } },
                timeScale: { timeVisible: true, secondsVisible: false },
            });
            currentChart = chart;
            const candlestickSeries = chart.addCandlestickSeries({
                upColor: '#4CAF50', downColor: '#F44336', borderVisible: false,
                wickUpColor: '#4CAF50', wickDownColor: '#F44336',
            });
            const chartData = ohlcvData.map(d => ({
                time: d.dt,
                open: d.open,
                high: d.high,
                low: d.low,
                close: d.close,
            }));
            candlestickSeries.setData(chartData);
            const markers = trades.slice(-50).flatMap(trade => {
                return [
                    { time: trade.entry_ts, position: 'aboveBar', color: '#2196F3', shape: 'arrowUp', text: `Buy @ ${trade.entry_price.toFixed(2)}` },
                    { time: trade.exit_ts, position: 'belowBar', color: '#FF9800', shape: 'arrowDown', text: `Sell @ ${trade.exit_price.toFixed(2)} | PnL ${trade.pnl.toFixed(2)}` },
                ];
            });
            candlestickSeries.setMarkers(markers);
            new ResizeObserver(entries => {
                if (entries.length === 0 || entries[0].target.id !== 'oosChart') { return; }
                const newRect = entries[0].contentRect;
                chart.applyOptions({ width: newRect.width });
            }).observe(chartDiv);
            chart.timeScale().fitContent();
        }

        async function copyText(t){
            try{ await navigator.clipboard.writeText(String(t||'')); }
            catch(_){ try{ prompt('–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é:', String(t||'')); }catch(__){} }
        }

        // Add event listeners after DOM is fully loaded and all functions are defined
        document.addEventListener('DOMContentLoaded', function() {
            try { refreshResultModels(); } catch(_){ console.error("Error calling refreshResultModels on DOMContentLoaded:", _); }
            document.getElementById('refreshResultModelsBtn')?.addEventListener('click', refreshResultModels);
            document.getElementById('openOOSModalBtn')?.addEventListener('click', openOOSModal);
            document.getElementById('clearOOSResultsBtn')?.addEventListener('click', clearOOSResults);
        });
    </script>
    <script src="/static/js/sidebar.js"></script>
</body>
</html>