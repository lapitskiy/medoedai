<!DOCTYPE html>
<html lang="ru">
<head>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="/static/css/sidebar.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìà OOS —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.umd.js"></script>
    <style>
        #resultModelsSection { font-size: 12px; }
        #resultModelsSection #resultModelsList { display: block; overflow: visible; padding: 0; }
        #resultModelsTable { width: 100%; border-collapse: collapse; table-layout: fixed; }
        #resultModelsTable th, #resultModelsTable td { padding: 6px 8px; text-align: left; vertical-align: middle; }
        #resultModelsTable th { background: #f5f7fb; font-weight: 600; }
        #resultModelsTable tr:nth-child(even) { background: #fafbfe; }
        #resultModelsTable .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
        #resultModelsTable .muted { color: #6b7280; }
        #resultModelsTable .nowrap { white-space: nowrap; }
        #resultModelsTable .truncate { max-width: 360px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: inline-block; vertical-align: bottom; }
        #resultModelsSection .button-group { margin-bottom: 10px; }
        #resultModelsSection .btn.btn-danger { font-size: 12px; padding: 6px 10px; }
        #resultModelsSection .btn { font-size: 11px; padding: 4px 8px; margin: 1px; white-space: nowrap; }
        #resultModelsSection .btn-group { display: flex; gap: 4px; flex-wrap: wrap; justify-content: flex-end; }
        #resultModelsSection .btn-group .btn { margin: 0; }
    </style>
</head>
<body>
    <nav class="sidebar">
        <h3>üìã –ù–∞–≤–∏–≥–∞—Ü–∏—è</h3>
        <ul class="sidebar-nav">
            <li><a href="/" class="back-link">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a></li>
            <li><a href="javascript:history.back()">‚Üê –ù–∞–∑–∞–¥</a></li>
            <li><a href="#result-models" onclick="scrollToSection('result-models')">üóëÔ∏è –ú–æ–¥–µ–ª–∏ –≤ result</a></li>
            <li><a href="#oos-results" onclick="scrollToSection('oos-results')">üìà OOS —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</a></li>
        </ul>
    </nav>

    <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>

    <div class="container">
        <div class="main-content">
            <div class="header">
                <h1>üìà OOS –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Result</h1>
                <p>–ò—Å—Ç–æ—Ä–∏—è —Ç–µ—Å—Ç–æ–≤ –∏ –æ—á–∏—Å—Ç–∫–∞ –ø–∞–ø–∫–∏ result</p>
            </div>

            <div class="content">
                <a href="/" class="back-link">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>

                <div class="section" id="result-models">
                    <h2>üóëÔ∏è –ú–æ–¥–µ–ª–∏ –≤ result</h2>
                    <p>–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫–µ <code>result/</code> —Å –∫—Ä–∞—Ç–∫–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π. –ú–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –∫–æ–º–ø–ª–µ–∫—Ç (–≤–µ—Å–∞, –±—É—Ñ–µ—Ä, —Ä–µ–∑—É–ª—å—Ç–∞—Ç) –ø–æ –∫–æ–¥—É –º–æ–¥–µ–ª–∏.</p>
                    <div class="button-group">
                        <button class="btn btn-info" id="refreshResultModelsBtn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
                    </div>
                    <div id="modelTypeSelection" style="margin-bottom: 10px;">
                        <label for="agentTypeSelect">–¢–∏–ø –º–æ–¥–µ–ª–∏:</label>
                        <select id="agentTypeSelect" class="form-control" style="width: auto; display: inline-block; margin-left: 10px;">
                            <option value="dqn" selected>DQN</option>
                            <option value="sac">SAC</option>
                        </select>
                    </div>
                    <div id="dqnSymbolSelection" style="margin-bottom: 10px; display: none;">
                        <label for="dqnSymbolSelect">–í—ã–±–µ—Ä–∏—Ç–µ —Å–∏–º–≤–æ–ª DQN:</label>
                        <select id="dqnSymbolSelect" class="form-control" style="width: auto; display: inline-block; margin-left: 10px;">
                            <option value="">-- –í—Å–µ --</option>
                            {% for symbol in dqn_symbols %}
                            <option value="{{ symbol }}">{{ symbol }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div id="sacRunSelection" style="margin-bottom: 10px; display: none;">
                        <label for="sacRunNameSelect">–í—ã–±–µ—Ä–∏—Ç–µ SAC Run:</label>
                        <select id="sacRunNameSelect" class="form-control" style="width: auto; display: inline-block; margin-left: 10px;">
                            <option value="">-- –í—Å–µ --</option>
                            {% for run in sac_runs %}
                            <option value="{{ run }}">{{ run }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div id="resultModelsList">
                        <div class="loading"><div class="spinner"></div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    </div>
                </div>

                <div class="section" id="oos-results">
                    <h2>üìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã OOS (–∫–æ–ø–∏—Ä—É–µ–º—ã–µ)</h2>
                    <div style="margin-bottom:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
                        <button class="btn btn-info" id="openOOSModalBtn">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ OOS</button>
                        <button class="btn btn-secondary" id="clearOOSResultsBtn">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
                        <div class="muted" style="font-size:12px;">
                            <strong>–ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏:</strong><br>
                            ‚úÖ <span style="color:#10b981;">–ö–∞–Ω–¥–∏–¥–∞—Ç –Ω–∞ –¥–æ–æ–±—É—á–µ–Ω–∏–µ</span>: ROI>10%, PF‚â•1.2, PLR>1.0, MaxDD<40%<br>
                            ‚ùå <span style="color:#ef4444;">–î–æ–æ–±—É—á–∞—Ç—å –Ω–µ–ª—å–∑—è</span>: ROI‚â§0% –ò–õ–ò PF<1.0 –ò–õ–ò PLR<1.0 –ò–õ–ò MaxDD>70%<br>
                            ‚ö†Ô∏è <span style="color:#6b7280;">–¢—Ä–µ–±—É–µ—Ç –∞–Ω–∞–ª–∏–∑–∞</span>: —Å—Ä–µ–¥–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
                        </div>
                    </div>
                    
                    <div id="oosResults"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function scrollToSection(id){
            const el = document.getElementById(id);
            if(el){ el.scrollIntoView({behavior:'smooth'}); }
        }

        function toggleSidebar(){ document.body.classList.toggle('sidebar-open'); }

    </script>
    <script>
        // --- –í—Å—Ç–∞–≤–ª–µ–Ω –ø–æ–ª–Ω—ã–π JS –±–ª–æ–∫ –∏–∑ models.html ---
        function updateFilterVisibility(agentType) {
            const dqnBlock = document.getElementById('dqnSymbolSelection');
            const sacBlock = document.getElementById('sacRunSelection');
            if (dqnBlock) dqnBlock.style.display = agentType === 'dqn' ? 'block' : 'none';
            if (sacBlock) sacBlock.style.display = agentType === 'sac' ? 'block' : 'none';
        }

        async function refreshResultModels() {
            console.log('refreshResultModels: starting');
            const listDiv = document.getElementById('resultModelsList');
            if (!listDiv) {
                console.log('refreshResultModels: listDiv not found, returning');
                return;
            }
            listDiv.innerHTML = '<div class="loading"><div class="spinner"></div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            try {
                const agentType = document.getElementById('agentTypeSelect')?.value || 'dqn';
                updateFilterVisibility(agentType);

                let url = '';
                let params = {};

                if (agentType === 'dqn') {
                    const dqnSelect = document.getElementById('dqnSymbolSelect');
                    url = '/api/runs/list';
                    params.model_type = 'dqn';
                    if (dqnSelect) {
                        if (!dqnSelect.value) {
                            const firstOption = Array.from(dqnSelect.options || []).find(opt => opt.value);
                            if (firstOption) {
                                dqnSelect.value = firstOption.value;
                            }
                        }
                        if (dqnSelect.value) {
                            params.symbol = dqnSelect.value;
                        } else {
                            listDiv.innerHTML = '<div class="status info">–í—ã–±–µ—Ä–∏—Ç–µ —Å–∏–º–≤–æ–ª –¥–ª—è DQN.</div>';
                            return;
                        }
                    } else {
                        listDiv.innerHTML = '<div class="status error">–°–µ–ª–µ–∫—Ç–æ—Ä —Å–∏–º–≤–æ–ª–æ–≤ DQN –Ω–µ –Ω–∞–π–¥–µ–Ω.</div>';
                        return;
                    }
                } else if (agentType === 'sac') {
                    const sacSelect = document.getElementById('sacRunNameSelect');
                    url = '/api/runs/list';
                    params.model_type = 'sac';
                    if (sacSelect && sacSelect.value) {
                        params.symbol = sacSelect.value;
                    }
                }

                const queryString = new URLSearchParams(params).toString();
                const fullUrl = `${url}?${queryString}`;

                console.log('refreshResultModels: fetching runs from URL:', fullUrl);
                const resp = await fetch(fullUrl);
                const data = await resp.json();
                console.log('refreshResultModels: API response:', data);

                if (!data.success) {
                    console.error('Error fetching runs:', data.error);
                    listDiv.innerHTML = `<div class="status error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${data.error}</div>`;
                    return;
                }
                const runs = Array.isArray(data.runs) ? data.runs : [];
                console.log('refreshResultModels: processed runs:', runs);

                if (runs.length === 0) {
                    listDiv.innerHTML = '<div class="status info">üì≠ –ù–µ—Ç –∑–∞–ø—É—Å–∫–æ–≤ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞/—Ñ–∏–ª—å—Ç—Ä–∞</div>';
                    return;
                }

                const rows = [];
                for (const run of runs) {
                    let win = 'N/A', roi = 'N/A', max_dd = 'N/A', episodes = 'N/A', symbolOrRunId = '';
                    let isBad = false;

                    if (agentType === 'dqn') {
                        symbolOrRunId = run.symbol;
                        if (typeof run.winrate === 'number') {
                            win = (run.winrate * 100).toFixed(1) + '%';
                            if (run.winrate < 0.5) isBad = true;
                        }
                        if (typeof run.pl_ratio === 'number') {
                            roi = run.pl_ratio.toFixed(2);
                            if (run.pl_ratio < 1.0) isBad = true;
                        }
                        // MaxDD may not be present for older DQN runs
                        if (typeof run.max_dd === 'number') {
                            max_dd = (run.max_dd * 100).toFixed(1) + '%';
                            if (run.max_dd > 0.7) isBad = true;
                        }
                    } else if (agentType === 'sac') {
                        symbolOrRunId = run.run_id;
                        if (typeof run.winrate === 'number') {
                            win = (run.winrate * 100).toFixed(1) + '%';
                            if (run.winrate < 0.5) isBad = true;
                        }
                        if (typeof run.roi === 'number') {
                            roi = run.roi.toFixed(2);
                            if (run.roi < 0) isBad = true;
                        }
                        if (typeof run.max_dd === 'number') {
                            max_dd = (run.max_dd * 100).toFixed(1) + '%';
                            if (run.max_dd > 0.7) isBad = true;
                        }
                    }

                    if (run.episodes != null) episodes = run.episodes;

                    const oosBtn = run.model_path ? `<button class="btn btn-info" onclick="runOOSTest('${agentType}', '${symbolOrRunId}', '${run.model_path}')">Test</button>` : '';
                    const symbolHint = agentType === 'sac'
                        ? (document.getElementById('sacRunNameSelect')?.value || '')
                        : (document.getElementById('dqnSymbolSelect')?.value || '');
                    const showResultsBtn = `<button class="btn btn-secondary" onclick="showOOSResults('${agentType}', '${symbolOrRunId}', '${symbolHint}')">Result</button>`;
                    const graphBtn = `<a class="btn btn-secondary" target="_blank" href="/oos_graph?agent_type=${agentType}&id=${encodeURIComponent(symbolOrRunId)}">Graph</a>`;
                    const delBtn = `<button class="btn btn-danger" onclick="deleteAgentRun('${agentType}', '${symbolOrRunId}', '${run.ensemble || 'ensemble-a'}', '${run.version || 'v1'}')">‚úñ</button>`;
                    const buttonsHtml = `<div class="btn-group">${oosBtn}${showResultsBtn}${graphBtn}${delBtn}</div>`;
                    const rowStyle = isBad ? 'style="background-color: #fef2f2; border-left: 3px solid #ef4444;"' : '';

                    rows.push(`
                        <tr ${rowStyle}>
                            <td class="nowrap">${run.agent_type || run.model_type || 'N/A'}</td>
                            <td class="nowrap">${symbolOrRunId}</td>
                            <td class="nowrap">${run.version || 'N/A'}</td>
                            <td class="nowrap">${win}</td>
                            <td class="nowrap">${roi}</td>
                            <td class="nowrap">${max_dd}</td>
                            <td class="nowrap">${episodes}</td>
                            <td class="nowrap" style="text-align:right;">${buttonsHtml}</td>
                        </tr>
                    `);
                }

                const header = `
                    <thead>
                        <tr>
                            <th class="nowrap">–¢–∏–ø –∞–≥–µ–Ω—Ç–∞</th>
                            <th class="nowrap">ID –ó–∞–ø—É—Å–∫–∞/–°–∏–º–≤–æ–ª</th>
                            <th class="nowrap">–í–µ—Ä—Å–∏—è</th>
                            <th class="nowrap">Winrate</th>
                            <th class="nowrap">ROI/P/L Ratio</th>
                            <th class="nowrap">Max DD</th>
                            <th class="nowrap">–≠–ø–∏–∑–æ–¥—ã</th>
                            <th class="nowrap" style="width:300px; text-align:right;">–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>`;
                listDiv.innerHTML = rows.length > 0 ? `<table id="resultModelsTable">${header}<tbody>${rows.join('')}</tbody></table>` : '<div class="status info">üì≠ –ù–µ—Ç –∑–∞–ø—É—Å–∫–æ–≤ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞/—Ñ–∏–ª—å—Ç—Ä–∞</div>';
                if (rows.length === 0) {
                    console.log('refreshResultModels: No rows rendered, resultModelsList should show empty message');
                }
            } catch (e) {
                console.error('Error in refreshResultModels:', e);
                listDiv.innerHTML = `<div class="status error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${e.message}</div>`;
            }
        }

        function deleteAgentRun(agentType, id, ensembleName, version) {
            let confirmMsg = `–£–¥–∞–ª–∏—Ç—å ${agentType.toUpperCase()} –º–æ–¥–µ–ª—å ${id}?`;
            let apiUrl = '';
            let payload = {};

            if (agentType === 'dqn') {
                confirmMsg = `–£–¥–∞–ª–∏—Ç—å DQN –º–æ–¥–µ–ª—å ${id} (—Å–∏–º–≤–æ–ª ${id})?`;
                apiUrl = '/api/runs/delete'; // –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è DQN
                payload = { symbol: id, run_id: id }; // id –∑–¥–µ—Å—å —ç—Ç–æ —Å–∏–º–≤–æ–ª –¥–ª—è DQN
            } else if (agentType === 'sac') {
                confirmMsg = `–£–¥–∞–ª–∏—Ç—å SAC –º–æ–¥–µ–ª—å ${id}/${ensembleName}/${version}?`;
                apiUrl = '/api/sac_models/delete'; // –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è SAC
                payload = { run_name: id, ensemble: ensembleName, version: version };
            } else {
                alert('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –∞–≥–µ–Ω—Ç–∞: ' + agentType);
                return;
            }

            if (!confirm(confirmMsg)) return;

            fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    refreshResultModels();
                } else {
                    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + (data.error || 'Unknown'));
                }
            })
            .catch(e => alert('–°–µ—Ç—å: ' + e.message));
        }

        async function showOOSResults(agentType, id, symbolHint = '') {
            try {
                let url = '';
                if (agentType === 'dqn') {
                    url = `/api/runs/oos_results?symbol=${encodeURIComponent(id)}&run_id=${encodeURIComponent(id)}`;
                } else if (agentType === 'sac') {
                    const symbol = symbolHint || document.getElementById('sacRunNameSelect')?.value || '';
                    url = `/api/sac_runs/oos_results?symbol=${encodeURIComponent(symbol)}&run_id=${encodeURIComponent(id)}`;
                } else {
                    alert('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –∞–≥–µ–Ω—Ç–∞: ' + agentType);
                    return;
                }

                const resp = await fetch(url);
                const data = await resp.json();
                if (!data.success) {
                    alert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: ' + (data.error || 'Unknown'));
                    return;
                }
                const oosData = data.data;
                const counters = oosData.counters || {};
                const history = oosData.history || [];
                ensureOOSPanel();
                const wrap = document.getElementById('oosResults');
                wrap.innerHTML = '';
                const totalTests = (counters.good||0) + (counters.bad||0) + (counters.neutral||0);
                const summaryHtml = `
                    <div class="card" style="margin-bottom: 16px; border: 1px solid #e5e7eb;">
                        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
                            <div class="mono" style="font-weight:600;">üìä –ò—Å—Ç–æ—Ä–∏—è OOS —Ç–µ—Å—Ç–æ–≤: ${id}</div>
                            <div class="muted">–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤: ${totalTests}</div>
                        </div>
                        <div style="margin:8px 0; display:flex;gap:16px;">
                            <span class="badge" style="background:#10b981;color:#fff;border-radius:4px;padding:4px 8px;">
                                ‚úÖ –•–æ—Ä–æ—à–∏–µ: ${counters.good || 0}
                            </span>
                            <span class="badge" style="background:#ef4444;color:#fff;border-radius:4px;padding:4px 8px;">
                                ‚ùå –ü–ª–æ—Ö–∏–µ: ${counters.bad || 0}
                            </span>
                            <span class="badge" style="background:#6b7280;color:#fff;border-radius:4px;padding:4px 8px;">
                                ‚ö†Ô∏è –°—Ä–µ–¥–Ω–∏–µ: ${counters.neutral || 0}
                            </span>
                        </div>
                    </div>
                `;
                wrap.insertAdjacentHTML('afterbegin', summaryHtml);
                const sortedHistory = [...history].reverse();
                for(const test of sortedHistory){
                    const metrics = test.metrics || {};
                    const classification = test.classification || 'unknown';
                    const ts = new Date(test.ts || '');
                    const timeStr = ts.toLocaleString('ru-RU');
                    let cardStyle = 'border: 1px solid #e5e7eb;';
                    if(classification === 'good'){
                        cardStyle = 'border: 1px solid #10b981; box-shadow: 0 0 0 2px rgba(16,185,129,0.12);';
                    } else if(classification === 'bad'){
                        cardStyle = 'border: 1px solid #ef4444; box-shadow: 0 0 0 2px rgba(239,68,68,0.12);';
                    }
                    const roiPct = metrics.roi_pct != null ? metrics.roi_pct.toFixed(2) + '%' : 'N/A';
                    const winrate = metrics.winrate != null ? (metrics.winrate * 100).toFixed(1) + '%' : 'N/A';
                    const plr = metrics.pl_ratio != null ? metrics.pl_ratio.toFixed(2) : 'N/A';
                    const pf = metrics.profit_factor != null ? metrics.profit_factor.toFixed(2) : 'N/A';
                    const maxdd = metrics.max_dd != null ? (metrics.max_dd * 100).toFixed(1) + '%' : 'N/A';
                    const trades = metrics.trades != null ? metrics.trades : 'N/A';
                    const gateInfo = test.gate_disable ? 'Q-gate: –æ—Ç–∫–ª—é—á–µ–Ω' : (test.gate_scale != null ? `Q-gate: ${((1-test.gate_scale)*100).toFixed(0)}%` : 'Q-gate: —Å—Ç–∞–Ω–¥–∞—Ä—Ç');
                    const testCard = `
                        <div class="card" style="${cardStyle}">
                            <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
                                <div class="mono" style="font-weight:600;">${test.days}–¥ ${gateInfo}</div>
                                <div class="muted">${timeStr}</div>
                            </div>
                            <pre style="white-space:pre-wrap;margin:6px 0;">
ROI: ${roiPct} | Winrate: ${winrate} | PLR: ${plr} | PF: ${pf} | MaxDD: ${maxdd} | Trades: ${trades}
Symbol: ${test.symbol || 'N/A'} | Capital: ${metrics.start_capital || 'N/A'}
                            </pre>
                        </div>
                    `;
                    wrap.insertAdjacentHTML('beforeend', testCard);
                }
            }catch(e){
                console.error('[OOS Results] error', e);
                alert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: ' + e.message);
            }
        }

        function clearOOSResults(){
            const wrap = document.getElementById('oosResults');
            if(wrap){ wrap.innerHTML = '<div class="status info">üì≠ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—á–∏—â–µ–Ω—ã</div>'; }
        }

        function openOOSModal(){
            if(document.getElementById('oosModal')){ document.getElementById('oosModal').style.display='block'; return; }
            const html = `
                <div id="oosModal" style="position:fixed;inset:0;display:block;background:rgba(0,0,0,0.4);z-index:9999;">
                    <div style="background:#fff;max-width:460px;margin:10% auto;padding:16px;border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,.2);">
                        <h3 style="margin-top:0;">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ OOS</h3>
                        <div class="form-group">
                            <label><input type="checkbox" id="oosGateDisable"> –û—Ç–∫–ª—é—á–∏—Ç—å Q‚Äëgate (T1/T2=0)</label>
                        </div>
                        <div class="form-group">
                            <label>–ë–∏—Ä–∂–∞ –¥–ª—è OOS</label>
                            <select id="oosExchange" class="form-control">
                                <option value="bybit" selected>Bybit</option>
                                <option value="binance">Binance</option>
                            </select>
                            <div class="muted">–ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω–∞—è –±–∏—Ä–∂–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–≤—Ç–æ‚Äë—Ñ–æ–ª–±—ç–∫</div>
                        </div>
                        <div class="form-group">
                            <label>–°–Ω–∏–∑–∏—Ç—å –ø–æ—Ä–æ–≥–∏ Q‚Äëgate –Ω–∞ –¥–æ–ª—é (0..1)</label>
                            <input type="number" id="oosGateScale" class="form-control" step="0.05" min="0" max="1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 0.5">
                            <div class="muted">0.5 = –ø–æ—Ä–æ–≥–∏ –≤–¥–≤–æ–µ –Ω–∏–∂–µ; –ø—É—Å—Ç–æ = –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π</div>
                        </div>
                        <div class="form-group">
                            <label>–°—Ç–∞—Ä—Ç–æ–≤—ã–π –∫–∞–ø–∏—Ç–∞–ª (–¥–ª—è MaxDD)</label>
                            <input type="number" id="oosStartCapital" class="form-control" step="100" min="0" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 10000">
                            <div class="muted">–≠–∫–≤–∏—Ç–∏ = —Å—Ç–∞—Ä—Ç + PnL; MaxDD —Å—á–∏—Ç–∞–µ—Ç—Å—è –æ—Ç —ç–∫–≤–∏—Ç–∏</div>
                        </div>
                        <div class="form-group">
                            <label><input type="checkbox" id="oosMultiRuns"> –í—ã–ø–æ–ª–Ω–∏—Ç—å 3 –ø—Ä–æ–≥–æ–Ω–∞: 100% / 50% / 0% –ø–æ—Ä–æ–≥–æ–≤</label>
                        </div>
                        <div style="text-align:right;display:flex;gap:8px;justify-content:flex-end;">
                            <button class="btn" onclick="document.getElementById('oosModal').style.display='none'">–ó–∞–∫—Ä—ã—Ç—å</button>
                            <button class="btn btn-info" onclick="document.getElementById('oosModal').style.display='none'">OK</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }

        function ensureOOSPanel(){}

        async function runOOSTest(agentType, code, filename){
            const file = filename || '';
            const name = code || (file.split('/').pop().split('\\').pop());
            try{
                const btn = event.target; const prev = btn.textContent; btn.disabled=true; btn.textContent='‚è≥ OOS...';
                const gateDisable = !!document.getElementById('oosGateDisable')?.checked;
                const multiRuns = !!document.getElementById('oosMultiRuns')?.checked;
                let gateScale = document.getElementById('oosGateScale')?.value;
                gateScale = gateScale===''? null : Number(gateScale);
                let startCapital = document.getElementById('oosStartCapital')?.value;
                startCapital = startCapital===''? null : Number(startCapital);
                const exchangeSel = document.getElementById('oosExchange');
                const exchange = exchangeSel ? (exchangeSel.value||'bybit') : 'bybit';
                
                let payloadBase = { filename:file, code:code, gate_disable: gateDisable, gate_scale: gateScale, start_capital: startCapital, exchange, agent_type: agentType };
                
                // –ï—Å–ª–∏ —ç—Ç–æ DQN, –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å —Å–∏–º–≤–æ–ª, –µ—Å–ª–∏ —ç—Ç–æ SAC - run_id
                if (agentType === 'dqn') {
                    payloadBase.symbol = code; // `code` –≤ —ç—Ç–æ–º —Å–ª—É—á–∞–µ –±—É–¥–µ—Ç —Å–∏–º–≤–æ–ª–æ–º
                } else if (agentType === 'sac') {
                    payloadBase.run_id = code; // `code` –≤ —ç—Ç–æ–º —Å–ª—É—á–∞–µ –±—É–¥–µ—Ç run_id
                }

                const windows = [30,60,90,180];
                const scales = multiRuns ? [0.0, 0.5, 1.0] : [null];
                const allResults = [];
                const pending = [];
                for(const days of windows){
                    for(const s of scales){
                        const payload = {...payloadBase, days};
                        if (s !== null){ payload.gate_disable = false; payload.gate_scale = s; }
                        const r = await fetch('/oos_test_model_async', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
                        const j = await r.json().catch(()=>({success:false,error:'bad json'}));
                        if (j && j.success && j.task_id){ pending.push({days, scale:s, task_id:j.task_id}); }
                        else { allResults.push({days, scale:s, data:j}); }
                    }
                }
                async function waitTask(task_id){
                    for(let tries=0; tries<600; tries++){
                        await new Promise(r=>setTimeout(r, 1000));
                        const s = await fetch('/oos_test_status?task_id='+encodeURIComponent(task_id));
                        const sj = await s.json().catch(()=>null);
                        if (sj && sj.state === 'SUCCESS' && sj.result){ return sj.result; }
                        if (sj && sj.state === 'FAILURE' && sj.result){ return sj.result; }
                    }
                    return {success:false, error:'timeout waiting task '+task_id};
                }
                const settled = await Promise.all(pending.map(async item=>{
                    const data = await waitTask(item.task_id);
                    return {days:item.days, scale:item.scale, data};
                }));
                allResults.push(...settled);
                btn.disabled=false; btn.textContent=prev;
                ensureOOSPanel();
                const wrap = document.getElementById('oosResults');
                wrap.innerHTML = '';
                const first = (allResults[0]||{}).data || {success:false};
                const chartDiv = document.getElementById('oosChart');
                if (chartDiv) { chartDiv.innerHTML = ''; }
                if(!first.success){
                    const err = '‚ùå OOS: '+(first.error||'–æ—à–∏–±–∫–∞');
                    if (wrap){
                        const el = document.createElement('div'); el.className = 'status error'; el.textContent = err; wrap.prepend(el);
                    } else { alert(err); }
                    return;
                }
                function renderCard(title, res){
                    const r = (res||{}).result || {};
                    const details = Array.isArray(r.trades_details)? r.trades_details: [];
                    const roiPct = (r && r.start_capital && typeof r.pnl_total === 'number') ? ((r.pnl_total / r.start_capital) * 100.0) : null;
                    const isGood = (roiPct!=null && roiPct>10) && (r.profit_factor==null || r.profit_factor>=1.2) && (r.pl_ratio==null || r.pl_ratio>1.0) && (r.max_dd==null || r.max_dd<0.40);
                    const isBad  = (roiPct!=null && roiPct<=0) || (r.profit_factor!=null && r.profit_factor<1.0) || (r.pl_ratio!=null && r.pl_ratio<1.0) || (r.max_dd!=null && r.max_dd>0.70);
                    let statusBadge = '';
                    if (isGood) {
                        statusBadge = '<span class="badge" style="background:#10b981;color:#fff;border-radius:4px;padding:2px 6px;">‚úÖ –ö–∞–Ω–¥–∏–¥–∞—Ç –Ω–∞ –¥–æ–æ–±—É—á–µ–Ω–∏–µ</span>';
                    } else if (isBad) {
                        statusBadge = '<span class="badge" style="background:#ef4444;color:#fff;border-radius:4px;padding:2px 6px;">‚ùå –î–æ–æ–±—É—á–∞—Ç—å –Ω–µ–ª—å–∑—è</span>';
                    } else {
                        statusBadge = '<span class="badge" style="background:#6b7280;color:#fff;border-radius:4px;padding:2px 6px;">‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –∞–Ω–∞–ª–∏–∑–∞</span>';
                    }
                    const dc = (r.decisions_counts||{});
                    const dBuy = Number(dc.buy||0), dHold = Number(dc.hold||0), dSell = Number(dc.sell||0);
                    const dTotal = (typeof r.decisions_total==='number')? r.decisions_total : (dBuy + dHold + dSell);
                    const ni = (r.nan_indicators!=null)? r.nan_indicators: '‚Äî';
                    const ii = (r.inf_indicators!=null)? r.inf_indicators: '‚Äî';
                    const lines = [title + ' ' + statusBadge,
                        `Winrate: ${r.winrate!=null?(r.winrate*100).toFixed(1)+'%':'N/A'}`,
                        `PLR: ${r.pl_ratio!=null?r.pl_ratio.toFixed(2):'N/A'}`,
                        `PF: ${r.profit_factor!=null?r.profit_factor.toFixed(2):'N/A'}`,
                        `MaxDD: ${r.max_dd!=null?(r.max_dd*100).toFixed(1)+'%':'N/A'}`,
                        `PnL: ${roiPct!=null?roiPct.toFixed(2)+'%':'N/A'}`,
                        `Trades: ${r.trades!=null?r.trades:'N/A'}`,
                        `Decisions: B=${dBuy} H=${dHold} S=${dSell} (total ${dTotal})`,
                        `Indicators NaN: ${ni} / Inf: ${ii}`,
                        r.symbol? `Symbol: ${r.symbol}`: '',
                        r.days!=null? `Window: ${r.days}d`: ''
                    ].filter(Boolean);
                    const text = lines.join('\n');
                    const item = document.createElement('div'); item.className = 'card';
                    if(isGood){ item.style.border = '1px solid #10b981'; item.style.boxShadow = '0 0 0 2px rgba(16,185,129,0.12)'; }
                    else if(isBad){ item.style.border = '1px solid #ef4444'; item.style.boxShadow = '0 0 0 2px rgba(239,68,68,0.12)'; }
                    const ts = new Date(); const hh = String(ts.getHours()).padStart(2,'0'); const mm = String(ts.getMinutes()).padStart(2,'0');
                    const tradesFile = r.trades_file || '';
                    const symbolForChart = r.symbol || '';
                    const runIdForChart = res.run_id || '';
                    let tradesButton = '';
                    if (tradesFile && symbolForChart && runIdForChart) {
                        const q = `agent_type=${agentType}&symbol=${encodeURIComponent(symbolForChart)}&run=${encodeURIComponent(runIdForChart)}&trades=${encodeURIComponent(tradesFile)}`;
                        tradesButton = `<a class="btn btn-info" target="_blank" title="–û—Ç–∫—Ä—ã—Ç—å –≥—Ä–∞—Ñ–∏–∫" href="/oos_graph?${q}">–ì—Ä–∞—Ñ–∏–∫</a>`;
                    }
                    item.innerHTML = `
                        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;"><div class="mono" style="font-weight:600;">${name}</div><div class="muted">${hh}:${mm}</div></div>
                        <pre style="white-space:pre-wrap;margin:6px 0;">${text}</pre>
                        <div style="text-align:right;display:flex;gap:8px;justify-content:flex-end;"><button class="btn" data-text="${text.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}" onclick="copyText(this.getAttribute('data-text'))">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>${tradesButton}</div>`;
                    return item;
                }
                const groups = {};
                for(const w of windows){ groups[w]=[]; }
                for(const r of allResults){
                    if(r.data && r.data.success){
                        if(!groups[r.days]){ groups[r.days] = []; }
                        groups[r.days].push(r);
                    }
                }
                const firstResult = allResults.find(r => r.data && r.data.success)?.data || {};
                const firstSuccess = allResults.find(r => r.data && r.data.success)?.data || {};
                const tradesFilePath = firstSuccess?.result?.trades_file || '';
                const runId = firstSuccess?.run_id || '';
                const symbol = firstSuccess?.symbol || '';
                const ohlcvData = firstSuccess?.ohlcv_data || [];
                if (ohlcvData.length > 0 && tradesFilePath && runId) {
                    await loadAndRenderTradesChart(agentType, symbol, runId, tradesFilePath, ohlcvData);
                }
                let stats = {good: 0, bad: 0, neutral: 0};
                for(const r of allResults){
                    if(r.data && r.data.success){
                        const res = r.data.result || {};
                        const roiPct = (res && res.start_capital && typeof res.pnl_total === 'number') ? ((res.pnl_total / res.start_capital) * 100.0) : null;
                        const isGood = (roiPct!=null && roiPct>10) && (res.profit_factor==null || res.profit_factor>=1.2) && (res.pl_ratio==null || res.pl_ratio<1.0) && (res.max_dd==null || res.max_dd<0.40);
                        const isBad  = (roiPct!=null && roiPct<=0) || (res.profit_factor!=null && res.profit_factor<1.0) || (res.pl_ratio!=null && res.pl_ratio<=1.0) || (res.max_dd!=null && res.max_dd>0.70);
                        if(isGood) stats.good++;
                        else if(isBad) stats.bad++;
                        else stats.neutral++;
                    }
                }
                try {
                    await fetch('/api/strategies/save_stats', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ filename: file, code: code, stats: stats, agent_type: agentType })
                    });
                } catch(e) {
                    console.warn('Failed to save OOS stats:', e);
                }
                for(const days of windows){
                    const bucket = groups[days] || [];
                    for(const g of bucket){
                        const pct = (g.scale===null)? '100%' : ((1-g.scale)*100).toFixed(0)+'%';
                        const card = renderCard(`‚úÖ ${days}d (${pct})`, g.data);
                        wrap.prepend(card);
                    }
                }
            }catch(e){ console.error('[OOS] error', e); alert('‚ùå OOS —Å–µ—Ç—å: '+e.message); }
        }

        async function loadAndRenderTradesChart(agentType, symbol, runId, tradesFilePath, ohlcvData = []) {
            const chartDiv = document.getElementById('oosChart');
            if (!chartDiv) { console.error('oosChart div not found'); return; }
            try {
                let url = '';
                let params = {};
                if (agentType === 'dqn') {
                    url = `/api/runs/trades`;
                    params = { symbol: symbol, run_id: runId, trades_file: tradesFilePath };
                } else if (agentType === 'sac') {
                    url = `/api/sac_runs/trades`;
                    params = { symbol: symbol, run_id: runId, trades_file: tradesFilePath };
                } else {
                    console.error('Unknown agent type for chart loading:', agentType);
                    return;
                }
                
                const queryString = new URLSearchParams(params).toString();
                const fullUrl = `${url}?${queryString}`;

                const resp = await fetch(fullUrl);
                const data = await resp.json();
                if (!data.success) {
                    console.error('Failed to load trades data:', data.error);
                    chartDiv.innerHTML = `<div class="status error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ —Å–¥–µ–ª–∫–∞—Ö: ${data.error}</div>`;
                    return;
                }
                const trades = Array.isArray(data.trades) ? data.trades : [];
                renderChart(ohlcvData, trades);
            } catch (e) {
                console.error('[OOS Chart] error loading trades', e);
                chartDiv.innerHTML = `<div class="status error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ —Å–¥–µ–ª–∫–∞—Ö: ${e.message}</div>`;
            }
        }

        let currentChart = null;
        function renderChart(ohlcvData, trades) {
            const chartDiv = document.getElementById('oosChart');
            if (!chartDiv) return;
            if (currentChart) {
                currentChart.remove();
                currentChart = null;
            }
            chartDiv.innerHTML = '';
            const chart = LightweightCharts.createChart(chartDiv, {
                width: chartDiv.clientWidth,
                height: 400,
                layout: { backgroundColor: '#ffffff', textColor: '#333' },
                grid: { vertLines: { color: '#e1e2e4' }, horzLines: { color: '#e1e2e4' } },
                timeScale: { timeVisible: true, secondsVisible: false },
            });
            currentChart = chart;
            const candlestickSeries = chart.addCandlestickSeries({
                upColor: '#4CAF50', downColor: '#F44336', borderVisible: false,
                wickUpColor: '#4CAF50', wickDownColor: '#F44336',
            });
            const chartData = ohlcvData.map(d => ({
                time: d.dt,
                open: d.open,
                high: d.high,
                low: d.low,
                close: d.close,
            }));
            candlestickSeries.setData(chartData);
            const markers = trades.slice(-50).flatMap(trade => {
                return [
                    { time: trade.entry_ts, position: 'aboveBar', color: '#2196F3', shape: 'arrowUp', text: `Buy @ ${trade.entry_price.toFixed(2)}` },
                    { time: trade.exit_ts, position: 'belowBar', color: '#FF9800', shape: 'arrowDown', text: `Sell @ ${trade.exit_price.toFixed(2)} | PnL ${trade.pnl.toFixed(2)}` },
                ];
            });
            candlestickSeries.setMarkers(markers);
            new ResizeObserver(entries => {
                if (entries.length === 0 || entries[0].target.id !== 'oosChart') { return; }
                const newRect = entries[0].contentRect;
                chart.applyOptions({ width: newRect.width });
            }).observe(chartDiv);
            chart.timeScale().fitContent();
        }

        async function copyText(t){
            try{ await navigator.clipboard.writeText(String(t||'')); }
            catch(_){ try{ prompt('–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é:', String(t||'')); }catch(__){} }
        }

        // Add event listeners after DOM is fully loaded and all functions are defined
        document.addEventListener('DOMContentLoaded', function() {
            const agentSelect = document.getElementById('agentTypeSelect');
            agentSelect?.addEventListener('change', function(event) {
                const val = event.target.value;
                updateFilterVisibility(val);
                refreshResultModels();
            });
            document.getElementById('dqnSymbolSelect')?.addEventListener('change', refreshResultModels);
            document.getElementById('sacRunNameSelect')?.addEventListener('change', refreshResultModels);

            updateFilterVisibility(agentSelect?.value || 'dqn');
            try { refreshResultModels(); } catch(_){ console.error("Error calling refreshResultModels on DOMContentLoaded:", _); }
            document.getElementById('refreshResultModelsBtn')?.addEventListener('click', refreshResultModels);
            document.getElementById('openOOSModalBtn')?.addEventListener('click', openOOSModal);
            document.getElementById('clearOOSResultsBtn')?.addEventListener('click', clearOOSResults);
        });
    </script>
    <script src="/static/js/sidebar.js"></script>
</body>
</html>