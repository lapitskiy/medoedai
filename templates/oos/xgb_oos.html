<!DOCTYPE html>
<html lang="ru">
<head>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="/static/css/sidebar.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìà XGB OOS</title>
    <style>
        .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
        .grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        @media (min-width: 900px){ .grid { grid-template-columns: 1fr 1fr; } }
        .card { border: 1px solid #e5e7eb; border-radius: 10px; padding: 12px; background: #fff; }
        .row { display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; }
        .row .form-group { margin:0; }
        pre { white-space: pre-wrap; word-break: break-word; }
        .tbl { width:100%; border-collapse:collapse; font-size:12px; }
        .tbl th,.tbl td { padding:5px 6px; text-align:left; border-bottom:1px solid #e5e7eb; white-space:nowrap; }
        .tbl th { background:#f5f7fb; font-weight:600; position:sticky; top:0; }
        .tbl tr:hover { background:#f0f4ff; }
        .tbl .sel { width:30px; text-align:center; }
    </style>
</head>
<body>
    {% include 'include/_sidebar.html' %}
    <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>

    <div class="container">
        <div class="main-content">
            <div class="header">
                <h1>üìà XGB OOS</h1>
                <p>OOS-–æ—Ü–µ–Ω–∫–∞ XGB run –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö N –¥–Ω—è—Ö —Å–≤–µ—á–µ–π. –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π —Å —É–¥–∞–ª–µ–Ω–∏–µ–º.</p>
            </div>

            <div class="content">
                <a href="/" class="back-link">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>

                <!-- OOS launch -->
                <div class="section">
                    <div class="grid">
                        <div class="card">
                            <h2 style="margin-top:0;">‚öôÔ∏è –ó–∞–ø—É—Å–∫ OOS</h2>
                            <div class="row">
                                <div class="form-group" style="min-width:420px;">
                                    <label>–í—ã–±–µ—Ä–∏ XGB run</label>
                                    <select id="xgbRunSelect" class="form-control">
                                        {% for r in xgb_runs %}
                                        <option value="{{ r.result_dir }}">
                                            {{ r.symbol }} ‚Ä¢ {{ r.run_name }} ‚Ä¢ {{ r.task }} ‚Ä¢ {{ r.direction }} ‚Ä¢ {{ r.source }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-group" style="min-width:160px;">
                                    <label>Days</label>
                                    <input id="xgbOosDays" class="form-control" type="number" min="1" max="365" step="1" value="30">
                                </div>
                                <div class="form-group">
                                    <button class="btn btn-info" onclick="startXgbOos()">‚ñ∂Ô∏è Run XGB OOS</button>
                                </div>
                            </div>
                            <div id="xgbOosStatus" class="status info" style="display:none; margin-top:10px; white-space:pre-wrap;"></div>
                        </div>

                        <div class="card">
                            <h2 style="margin-top:0;">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç</h2>
                            <div id="xgbOosResult" class="mono" style="font-size:12px;"></div>
                        </div>
                    </div>
                </div>

                <!-- Runs list -->
                <div class="section">
                    <h2>üóÇÔ∏è –í—Å–µ XGB run'—ã</h2>
                    <div style="margin-bottom:10px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                        <button class="btn btn-danger" id="btnDeleteSelected" onclick="deleteSelectedRuns()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
                        <span id="selectedInfo" class="mono" style="color:#6b7280;">–í—ã–±—Ä–∞–Ω–æ: 0</span>
                    </div>
                    <div id="xgbDeleteStatus" class="status info" style="display:none; margin-bottom:10px; white-space:pre-wrap;"></div>

                    {% if not xgb_runs %}
                        <div class="status info">–ù–µ—Ç XGB run'–æ–≤.</div>
                    {% else %}
                    <div style="overflow-x:auto; max-height:70vh; overflow-y:auto;">
                        <table class="tbl">
                            <thead>
                                <tr>
                                    <th class="sel"><input type="checkbox" id="cbAll" onchange="toggleAll(this)"></th>
                                    <th>Symbol</th>
                                    <th>Run</th>
                                    <th>Task</th>
                                    <th>Dir</th>
                                    <th>Source</th>
                                    <th>H</th>
                                    <th>Thr</th>
                                    <th>max_hold</th>
                                    <th>min_profit%</th>
                                    <th>val_acc</th>
                                    <th>f1_buy_sell</th>
                                    <th>f1(1)</th>
                                    <th>prec(1)</th>
                                    <th>recall(1)</th>
                                    <th>y_non_hold</th>
                                    <th>pred_non_hold</th>
                                    <th>Path</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for r in xgb_runs %}
                                {% set m = r.metrics or {} %}
                                {% set c = r.cfg or {} %}
                                {% set f1v = m.get('f1_val') %}
                                {% set pv = m.get('precision_val') %}
                                {% set rv = m.get('recall_val') %}
                                <tr>
                                    <td class="sel"><input type="checkbox" class="cb-run" value="{{ r.result_dir }}" onchange="updateSelectedCount()"></td>
                                    <td>{{ r.symbol }}</td>
                                    <td>{{ r.run_name }}</td>
                                    <td>{{ r.task }}</td>
                                    <td>{{ r.direction }}</td>
                                    <td>{{ r.source }}</td>
                                    <td>{{ c.get('horizon_steps','') }}</td>
                                    <td>{{ c.get('threshold','') }}</td>
                                    <td>{{ c.get('max_hold_steps','') }}</td>
                                    <td>{{ '%0.2f'|format(c.get('min_profit',0)*100) if c.get('min_profit') is not none else '' }}</td>
                                    <td>{{ '%0.5f'|format(m.val_acc) if m.val_acc is defined and m.val_acc is not none else '' }}</td>
                                    <td>{{ '%0.4f'|format(m.f1_buy_sell_val) if m.f1_buy_sell_val is defined and m.f1_buy_sell_val is not none else '' }}</td>
                                    <td>{{ '%0.4f'|format(f1v[1]) if f1v and f1v|length > 1 else '' }}</td>
                                    <td>{{ '%0.4f'|format(pv[1]) if pv and pv|length > 1 else '' }}</td>
                                    <td>{{ '%0.4f'|format(rv[1]) if rv and rv|length > 1 else '' }}</td>
                                    <td>{{ '%0.4f'|format(m.y_non_hold_rate_val) if m.y_non_hold_rate_val is defined and m.y_non_hold_rate_val is not none else '' }}</td>
                                    <td>{{ '%0.4f'|format(m.pred_non_hold_rate_val) if m.pred_non_hold_rate_val is defined and m.pred_non_hold_rate_val is not none else '' }}</td>
                                    <td class="mono" style="font-size:10px;">{{ r.result_dir }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script>
        function toggleSidebar(){ document.body.classList.toggle('sidebar-open'); }

        /* ---------- selection ---------- */
        function toggleAll(el){
            document.querySelectorAll('.cb-run').forEach(cb=>{ cb.checked=el.checked; });
            updateSelectedCount();
        }
        function updateSelectedCount(){
            const n = document.querySelectorAll('.cb-run:checked').length;
            const info = document.getElementById('selectedInfo');
            if(info) info.textContent = '–í—ã–±—Ä–∞–Ω–æ: '+n;
        }

        /* ---------- delete ---------- */
        async function deleteSelectedRuns(){
            const paths = [...document.querySelectorAll('.cb-run:checked')].map(c=>c.value);
            if(!paths.length){ alert('–ù–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ'); return; }
            if(!confirm('–£–¥–∞–ª–∏—Ç—å '+paths.length+' run(–æ–≤)?')) return;
            const st = document.getElementById('xgbDeleteStatus');
            if(st){ st.style.display='block'; st.className='status info'; st.textContent='–£–¥–∞–ª—è—é‚Ä¶'; }
            try{
                const resp = await fetch('/xgb_oos_delete_runs', {
                    method:'POST',
                    headers:{'Content-Type':'application/json','Accept':'application/json'},
                    body: JSON.stringify({paths})
                });
                const d = await resp.json();
                if(d.success){
                    if(st){ st.className='status success'; st.textContent='–£–¥–∞–ª–µ–Ω–æ: '+d.deleted_count; }
                    setTimeout(()=>location.reload(), 600);
                }else{
                    if(st){ st.className='status error'; st.textContent='–û—à–∏–±–∫–∞: '+(d.error||'unknown'); }
                }
            }catch(e){
                if(st){ st.className='status error'; st.textContent='–û—à–∏–±–∫–∞: '+e.message; }
            }
        }

        /* ---------- OOS ---------- */
        function _showStatus(msg, cls){
            const el = document.getElementById('xgbOosStatus');
            if(!el) return;
            el.style.display = 'block';
            el.className = 'status ' + (cls || 'info');
            el.textContent = msg;
        }

        function _renderResult(data){
            const el = document.getElementById('xgbOosResult');
            if(!el) return;
            if(!data){ el.innerHTML = ''; return; }
            const m = data.oos_metrics || {};
            const lines = [
                `symbol: ${data.symbol || '‚Äî'}`,
                `task: ${data.task || '‚Äî'}  direction: ${data.direction || '‚Äî'}`,
                `days: ${data.days || '‚Äî'}  bars: ${data.bars || '‚Äî'}`,
                '',
                `val_acc: ${m.val_acc ?? '‚Äî'}`,
                `y_counts_val: ${JSON.stringify(m.y_counts_val ?? '‚Äî')}`,
                `y_non_hold: ${m.y_non_hold_rate_val ?? '‚Äî'}  pred_non_hold: ${m.pred_non_hold_rate_val ?? '‚Äî'}`,
                `f1_buy_sell: ${m.f1_buy_sell_val ?? '‚Äî'}`,
                '',
                `f1_val: ${JSON.stringify(m.f1_val ?? '‚Äî')}`,
                `precision_val: ${JSON.stringify(m.precision_val ?? '‚Äî')}`,
                `recall_val: ${JSON.stringify(m.recall_val ?? '‚Äî')}`,
            ];
            el.innerHTML = '<pre>' + lines.join('\n') + '</pre>';
        }

        async function startXgbOos(){
            try{
                const runDir = (document.getElementById('xgbRunSelect')?.value || '').trim();
                const days = parseInt(document.getElementById('xgbOosDays')?.value || '30', 10) || 30;
                if(!runDir){ _showStatus('–í—ã–±–µ—Ä–∏ run.', 'error'); return; }
                _showStatus('‚è≥ –°—Ç–∞–≤–ª—é –∑–∞–¥–∞—á—É...', 'info');
                _renderResult(null);

                const r = await fetch('/xgb_oos_test_async', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify({ result_dir: runDir, days })
                });
                const d = await r.json().catch(()=>null);
                if(!d || !d.success){ _showStatus('‚ùå –û—à–∏–±–∫–∞: ' + (d && d.error ? d.error : 'unknown'), 'error'); return; }
                const taskId = d.task_id;
                _showStatus('‚úÖ –ó–∞–ø—É—â–µ–Ω–æ. task_id=' + taskId + '\n–ñ–¥—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç...', 'info');

                const poll = async ()=>{
                    const s = await fetch('/xgb_oos_test_status?task_id=' + encodeURIComponent(taskId));
                    const sd = await s.json().catch(()=>null);
                    if(!sd || !sd.success){ _showStatus('‚ùå –û—à–∏–±–∫–∞ —Å—Ç–∞—Ç—É—Å–∞', 'error'); return; }
                    if(sd.state === 'SUCCESS'){
                        const res = sd.result || {};
                        if(res.success){
                            _showStatus('‚úÖ –ì–æ—Ç–æ–≤–æ', 'success');
                            _renderResult(res);
                        }else{
                            _showStatus('‚ùå –û—à–∏–±–∫–∞: ' + (res.error || 'unknown'), 'error');
                        }
                        return;
                    }
                    if(sd.state === 'FAILURE'){
                        _showStatus('‚ùå FAILURE', 'error');
                        return;
                    }
                    setTimeout(poll, 1000);
                };
                setTimeout(poll, 600);
            }catch(e){
                _showStatus('‚ùå –û—à–∏–±–∫–∞: ' + (e && e.message ? e.message : e), 'error');
            }
        }
    </script>
</body>
</html>
