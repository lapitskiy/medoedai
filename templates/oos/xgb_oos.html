<!DOCTYPE html>
<html lang="ru">
<head>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="/static/css/sidebar.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìà XGB OOS</title>
    <style>
        .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
        .grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        @media (min-width: 900px){ .grid { grid-template-columns: 1fr 1fr; } }
        .card { border: 1px solid #e5e7eb; border-radius: 10px; padding: 12px; background: #fff; }
        .row { display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; }
        .row .form-group { margin:0; }
        pre { white-space: pre-wrap; word-break: break-word; }
    </style>
</head>
<body>
    {% include 'include/_sidebar.html' %}
    <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>

    <div class="container">
        <div class="main-content">
            <div class="header">
                <h1>üìà XGB OOS</h1>
                <p>OOS-–æ—Ü–µ–Ω–∫–∞ XGB run –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö N –¥–Ω—è—Ö —Å–≤–µ—á–µ–π (–º–µ—Ç—Ä–∏–∫–∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏).</p>
            </div>

            <div class="content">
                <a href="/" class="back-link">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>

                <div class="section">
                    <div class="grid">
                        <div class="card">
                            <h2 style="margin-top:0;">‚öôÔ∏è –ó–∞–ø—É—Å–∫</h2>
                            <div class="row">
                                <div class="form-group" style="min-width: 420px;">
                                    <label>–í—ã–±–µ—Ä–∏ XGB run</label>
                                    <select id="xgbRunSelect" class="form-control">
                                        {% for r in xgb_runs %}
                                        <option value="{{ r.result_dir }}">
                                            {{ r.symbol }} ‚Ä¢ {{ r.run_name }} ‚Ä¢ {{ r.task }} ‚Ä¢ {{ r.direction }} ‚Ä¢ {{ r.source }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-group" style="min-width: 160px;">
                                    <label>Days</label>
                                    <input id="xgbOosDays" class="form-control" type="number" min="1" max="365" step="1" value="30">
                                </div>
                                <div class="form-group">
                                    <button class="btn btn-info" onclick="startXgbOos()">‚ñ∂Ô∏è Run XGB OOS</button>
                                </div>
                            </div>
                            <div id="xgbOosStatus" class="status info" style="display:none; margin-top:10px; white-space: pre-wrap;"></div>
                        </div>

                        <div class="card">
                            <h2 style="margin-top:0;">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç</h2>
                            <div id="xgbOosResult" class="mono" style="font-size:12px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function toggleSidebar(){ document.body.classList.toggle('sidebar-open'); }

        function _showStatus(msg, cls){
            const el = document.getElementById('xgbOosStatus');
            if(!el) return;
            el.style.display = 'block';
            el.className = 'status ' + (cls || 'info');
            el.textContent = msg;
        }

        function _renderResult(data){
            const el = document.getElementById('xgbOosResult');
            if(!el) return;
            if(!data){ el.innerHTML = ''; return; }
            const m = data.oos_metrics || {};
            const lines = [
                `symbol: ${data.symbol || '‚Äî'}`,
                `task: ${data.task || '‚Äî'}  direction: ${data.direction || '‚Äî'}`,
                `days: ${data.days || '‚Äî'}  bars: ${data.bars || '‚Äî'}`,
                '',
                `val_acc: ${m.val_acc ?? '‚Äî'}`,
                `y_counts_val: ${JSON.stringify(m.y_counts_val ?? '‚Äî')}`,
                `y_non_hold: ${m.y_non_hold_rate_val ?? '‚Äî'}  pred_non_hold: ${m.pred_non_hold_rate_val ?? '‚Äî'}`,
                `f1_buy_sell: ${m.f1_buy_sell_val ?? '‚Äî'}`,
                '',
                `f1_val: ${JSON.stringify(m.f1_val ?? '‚Äî')}`,
                `precision_val: ${JSON.stringify(m.precision_val ?? '‚Äî')}`,
                `recall_val: ${JSON.stringify(m.recall_val ?? '‚Äî')}`,
            ];
            el.innerHTML = '<pre>' + lines.join('\n') + '</pre>';
        }

        async function startXgbOos(){
            try{
                const runDir = (document.getElementById('xgbRunSelect')?.value || '').trim();
                const days = parseInt(document.getElementById('xgbOosDays')?.value || '30', 10) || 30;
                if(!runDir){ _showStatus('–í—ã–±–µ—Ä–∏ run.', 'error'); return; }
                _showStatus('‚è≥ –°—Ç–∞–≤–ª—é –∑–∞–¥–∞—á—É...', 'info');
                _renderResult(null);

                const r = await fetch('/xgb_oos_test_async', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify({ result_dir: runDir, days })
                });
                const d = await r.json().catch(()=>null);
                if(!d || !d.success){ _showStatus('‚ùå –û—à–∏–±–∫–∞: ' + (d && d.error ? d.error : 'unknown'), 'error'); return; }
                const taskId = d.task_id;
                _showStatus('‚úÖ –ó–∞–ø—É—â–µ–Ω–æ. task_id=' + taskId + '\n–ñ–¥—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç...', 'info');

                const poll = async ()=>{
                    const s = await fetch('/xgb_oos_test_status?task_id=' + encodeURIComponent(taskId));
                    const sd = await s.json().catch(()=>null);
                    if(!sd || !sd.success){ _showStatus('‚ùå –û—à–∏–±–∫–∞ —Å—Ç–∞—Ç—É—Å–∞', 'error'); return; }
                    if(sd.state === 'SUCCESS'){
                        const res = sd.result || {};
                        if(res.success){
                            _showStatus('‚úÖ –ì–æ—Ç–æ–≤–æ', 'success');
                            _renderResult(res);
                        }else{
                            _showStatus('‚ùå –û—à–∏–±–∫–∞: ' + (res.error || 'unknown'), 'error');
                        }
                        return;
                    }
                    if(sd.state === 'FAILURE'){
                        _showStatus('‚ùå FAILURE', 'error');
                        return;
                    }
                    setTimeout(poll, 1000);
                };
                setTimeout(poll, 600);
            }catch(e){
                _showStatus('‚ùå –û—à–∏–±–∫–∞: ' + (e && e.message ? e.message : e), 'error');
            }
        }
    </script>
</body>
</html>

