<!DOCTYPE html>
<html lang="ru">
<head>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="/static/css/sidebar.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìà XGB OOS</title>
    <style>
        .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
        .grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        @media (min-width: 900px){ .grid { grid-template-columns: 1fr 1fr; } }
        .card { border: 1px solid #e5e7eb; border-radius: 10px; padding: 12px; background: #fff; }
        .row { display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; }
        .row .form-group { margin:0; }
        pre { white-space: pre-wrap; word-break: break-word; }
        .tbl { width:100%; border-collapse:collapse; font-size:12px; }
        .tbl th,.tbl td { padding:5px 6px; text-align:left; border-bottom:1px solid #e5e7eb; white-space:nowrap; }
        .tbl th { background:#f5f7fb; font-weight:600; position:sticky; top:0; }
        .tbl tr:hover { background:#f0f4ff; }
        .tbl .sel { width:30px; text-align:center; }
    </style>
</head>
<body>
    {% include 'include/_sidebar.html' %}
    <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>

    <div class="container">
        <div class="main-content">
            <div class="header">
                <h1>üìà XGB OOS</h1>
                <p>OOS-–æ—Ü–µ–Ω–∫–∞ XGB run –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö N –¥–Ω—è—Ö —Å–≤–µ—á–µ–π. –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π —Å —É–¥–∞–ª–µ–Ω–∏–µ–º.</p>
            </div>

            <div class="content">
                <a href="/" class="back-link">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>

                <!-- OOS launch (single) -->
                <div class="section">
                    <div class="grid">
                        <div class="card">
                            <h2 style="margin-top:0;">‚öôÔ∏è –ó–∞–ø—É—Å–∫ OOS (–æ–¥–∏–Ω–æ—á–Ω—ã–π)</h2>
                            <div class="row">
                                <div class="form-group" style="min-width:420px;">
                                    <label>–í—ã–±–µ—Ä–∏ XGB run</label>
                                    <select id="xgbRunSelect" class="form-control">
                                        {% for r in xgb_runs %}
                                        <option value="{{ r.result_dir }}">
                                            {{ r.symbol }} ‚Ä¢ {{ r.run_name }} ‚Ä¢ {{ r.task }} ‚Ä¢ {{ r.direction }} ‚Ä¢ {{ r.source }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-group" style="min-width:160px;">
                                    <label>Days</label>
                                    <input id="xgbOosDays" class="form-control" type="number" min="1" max="365" step="1" value="30">
                                </div>
                                <div class="form-group">
                                    <button class="btn btn-info" onclick="startXgbOos()">‚ñ∂Ô∏è Run XGB OOS</button>
                                </div>
                            </div>
                            <div id="xgbOosStatus" class="status info" style="display:none; margin-top:10px; white-space:pre-wrap;"></div>
                        </div>

                        <div class="card">
                            <h2 style="margin-top:0;">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç</h2>
                            <div id="xgbOosResult" class="mono" style="font-size:12px;"></div>
                        </div>
                    </div>
                </div>

                <!-- CSV history -->
                <div class="section">
                    <h2>üìÅ –°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ CSV</h2>
                    <div id="csvListArea" style="font-size:13px;"></div>
                </div>

                <!-- Runs list -->
                <div class="section">
                    <h2>üóÇÔ∏è –í—Å–µ XGB run'—ã</h2>
                    <div style="margin-bottom:10px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                        <button class="btn btn-info" onclick="startBatchOos()">‚ñ∂Ô∏è Run Selected OOS</button>
                        <button class="btn btn-warning" onclick="selectCollapsed()" title="–í—ã–¥–µ–ª–∏—Ç—å –º–æ–¥–µ–ª–∏ —Å pred_non_hold=0 (collapsed)">üíÄ –í—ã–¥–µ–ª–∏—Ç—å collapsed</button>
                        <button class="btn btn-danger" id="btnDeleteSelected" onclick="deleteSelectedRuns()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
                        <span id="selectedInfo" class="mono" style="color:#6b7280;">–í—ã–±—Ä–∞–Ω–æ: 0</span>
                    </div>
                    <div id="batchStatus" class="status info" style="display:none; margin-bottom:10px; white-space:pre-wrap;"></div>
                    <div id="xgbDeleteStatus" class="status info" style="display:none; margin-bottom:10px; white-space:pre-wrap;"></div>

                    {% if not xgb_runs %}
                        <div class="status info">–ù–µ—Ç XGB run'–æ–≤.</div>
                    {% else %}
                    <div style="overflow-x:auto; max-height:70vh; overflow-y:auto;">
                        <table class="tbl">
                            <thead>
                                <tr>
                                    <th class="sel"><input type="checkbox" id="cbAll" onchange="toggleAll(this)"></th>
                                    <th>Symbol</th>
                                    <th>Run</th>
                                    <th>Task</th>
                                    <th>Dir</th>
                                    <th>Source</th>
                                    <th>H</th>
                                    <th>Thr</th>
                                    <th>max_hold</th>
                                    <th>min_profit%</th>
                                    <th>val_acc</th>
                                    <th>f1_buy_sell</th>
                                    <th>f1(1)</th>
                                    <th>prec(1)</th>
                                    <th>recall(1)</th>
                                    <th>y_non_hold</th>
                                    <th>pred_non_hold</th>
                                    <th>Path</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for r in xgb_runs %}
                                {% set m = r.metrics or {} %}
                                {% set c = r.cfg or {} %}
                                {% set f1v = m.get('f1_val') %}
                                {% set pv = m.get('precision_val') %}
                                {% set rv = m.get('recall_val') %}
                                <tr>
                                    <td class="sel"><input type="checkbox" class="cb-run" value="{{ r.result_dir }}" data-pred-nonhold="{{ '%0.6f'|format(m.pred_non_hold_rate_val) if m.pred_non_hold_rate_val is defined and m.pred_non_hold_rate_val is not none else '-1' }}" onchange="updateSelectedCount()"></td>
                                    <td>{{ r.symbol }}</td>
                                    <td>{{ r.run_name }}</td>
                                    <td>{{ r.task }}</td>
                                    <td>{{ r.direction }}</td>
                                    <td>{{ r.source }}</td>
                                    <td>{{ c.get('horizon_steps','') }}</td>
                                    <td>{{ c.get('threshold','') }}</td>
                                    <td>{{ c.get('max_hold_steps','') }}</td>
                                    <td>{{ '%0.2f'|format(c.get('min_profit',0)*100) if c.get('min_profit') is not none else '' }}</td>
                                    <td>{{ '%0.5f'|format(m.val_acc) if m.val_acc is defined and m.val_acc is not none else '' }}</td>
                                    <td>{{ '%0.4f'|format(m.f1_buy_sell_val) if m.f1_buy_sell_val is defined and m.f1_buy_sell_val is not none else '' }}</td>
                                    <td>{{ '%0.4f'|format(f1v[1]) if f1v and f1v|length > 1 else '' }}</td>
                                    <td>{{ '%0.4f'|format(pv[1]) if pv and pv|length > 1 else '' }}</td>
                                    <td>{{ '%0.4f'|format(rv[1]) if rv and rv|length > 1 else '' }}</td>
                                    <td>{{ '%0.4f'|format(m.y_non_hold_rate_val) if m.y_non_hold_rate_val is defined and m.y_non_hold_rate_val is not none else '' }}</td>
                                    <td>{{ '%0.4f'|format(m.pred_non_hold_rate_val) if m.pred_non_hold_rate_val is defined and m.pred_non_hold_rate_val is not none else '' }}</td>
                                    <td class="mono" style="font-size:10px;">{{ r.result_dir }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script>
        function toggleSidebar(){ document.body.classList.toggle('sidebar-open'); }

        /* ---------- selection ---------- */
        function toggleAll(el){
            document.querySelectorAll('.cb-run').forEach(cb=>{ cb.checked=el.checked; });
            updateSelectedCount();
        }
        function updateSelectedCount(){
            const n = document.querySelectorAll('.cb-run:checked').length;
            const info = document.getElementById('selectedInfo');
            if(info) info.textContent = '–í—ã–±—Ä–∞–Ω–æ: '+n;
        }

        /* ---------- delete ---------- */
        async function deleteSelectedRuns(){
            const paths = [...document.querySelectorAll('.cb-run:checked')].map(c=>c.value);
            if(!paths.length){ alert('–ù–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ'); return; }
            if(!confirm('–£–¥–∞–ª–∏—Ç—å '+paths.length+' run(–æ–≤)?')) return;
            const st = document.getElementById('xgbDeleteStatus');
            if(st){ st.style.display='block'; st.className='status info'; st.textContent='–£–¥–∞–ª—è—é‚Ä¶'; }
            try{
                const resp = await fetch('/xgb_oos_delete_runs', {
                    method:'POST',
                    headers:{'Content-Type':'application/json','Accept':'application/json'},
                    body: JSON.stringify({paths})
                });
                const d = await resp.json();
                if(d.success){
                    if(st){ st.className='status success'; st.textContent='–£–¥–∞–ª–µ–Ω–æ: '+d.deleted_count; }
                    setTimeout(()=>location.reload(), 600);
                }else{
                    if(st){ st.className='status error'; st.textContent='–û—à–∏–±–∫–∞: '+(d.error||'unknown'); }
                }
            }catch(e){
                if(st){ st.className='status error'; st.textContent='–û—à–∏–±–∫–∞: '+e.message; }
            }
        }

        /* ---------- select collapsed ---------- */
        function selectCollapsed(){
            let count = 0;
            document.querySelectorAll('.cb-run').forEach(cb=>{
                const v = parseFloat(cb.dataset.predNonhold);
                if(v === 0 || (v >= 0 && v < 0.001)){
                    cb.checked = true;
                    count++;
                }
            });
            updateSelectedCount();
            if(!count) alert('Collapsed –º–æ–¥–µ–ª–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
        }

        /* ---------- helpers ---------- */
        function _showStatus(msg, cls){
            const el = document.getElementById('xgbOosStatus');
            if(!el) return;
            el.style.display = 'block';
            el.className = 'status ' + (cls || 'info');
            el.textContent = msg;
        }
        function _showBatch(msg, cls){
            const el = document.getElementById('batchStatus');
            if(!el) return;
            el.style.display = 'block';
            el.className = 'status ' + (cls || 'info');
            el.textContent = msg;
        }
        function _fmt(v, d=4){ return (v != null && v !== '') ? Number(v).toFixed(d) : '‚Äî'; }

        function _renderResult(data){
            const el = document.getElementById('xgbOosResult');
            if(!el) return;
            if(!data){ el.innerHTML = ''; return; }
            const m = data.oos_metrics || {};
            const bt = data.backtest || {};
            const lines = [
                `symbol: ${data.symbol || '‚Äî'}`,
                `task: ${data.task || '‚Äî'}  direction: ${data.direction || '‚Äî'}`,
                `days: ${data.days || '‚Äî'}  bars: ${data.bars || '‚Äî'}`,
                '',
                '‚îÄ‚îÄ Classification ‚îÄ‚îÄ',
                `val_acc: ${_fmt(m.val_acc)}`,
                `y_counts_val: ${JSON.stringify(m.y_counts_val ?? '‚Äî')}`,
                `y_non_hold: ${_fmt(m.y_non_hold_rate_val)}  pred_non_hold: ${_fmt(m.pred_non_hold_rate_val)}`,
                `f1_buy_sell: ${m.f1_buy_sell_val ?? '‚Äî'}`,
                `f1_val: ${JSON.stringify(m.f1_val ?? '‚Äî')}`,
                `precision_val: ${JSON.stringify(m.precision_val ?? '‚Äî')}`,
                `recall_val: ${JSON.stringify(m.recall_val ?? '‚Äî')}`,
            ];
            if(!bt.skip){
                lines.push('', '‚îÄ‚îÄ Backtest ‚îÄ‚îÄ',
                    `pnl_total: ${_fmt(bt.pnl_total,2)}  roi: ${_fmt(bt.roi_pct,2)}%`,
                    `trades: ${bt.trades_count ?? '‚Äî'}  wins: ${bt.wins ?? '‚Äî'}  losses: ${bt.losses ?? '‚Äî'}`,
                    `winrate: ${_fmt(bt.winrate)}  PF: ${_fmt(bt.profit_factor)}`,
                    `max_dd: ${_fmt(bt.max_dd,4)}  avg_bars: ${_fmt(bt.avg_bars_held,1)}`,
                    `equity: ${_fmt(bt.start_capital,0)} ‚Üí ${_fmt(bt.equity_end,2)}`
                );
            }
            el.innerHTML = '<pre>' + lines.join('\n') + '</pre>';
        }

        /* ---------- Single OOS ---------- */
        async function startXgbOos(){
            try{
                const runDir = (document.getElementById('xgbRunSelect')?.value || '').trim();
                const days = parseInt(document.getElementById('xgbOosDays')?.value || '30', 10) || 30;
                if(!runDir){ _showStatus('–í—ã–±–µ—Ä–∏ run.', 'error'); return; }
                _showStatus('‚è≥ –°—Ç–∞–≤–ª—é –∑–∞–¥–∞—á—É...', 'info');
                _renderResult(null);
                const r = await fetch('/xgb_oos_test_async', {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({ result_dir: runDir, days })
                });
                const d = await r.json().catch(()=>null);
                if(!d||!d.success){ _showStatus('‚ùå '+(d&&d.error||'unknown'),'error'); return; }
                _showStatus('‚è≥ task_id='+d.task_id+' ‚Ä¶','info');
                _pollTask(d.task_id, res=>{
                    if(res.success){ _showStatus('‚úÖ –ì–æ—Ç–æ–≤–æ','success'); _renderResult(res); }
                    else _showStatus('‚ùå '+(res.error||'fail'),'error');
                }, ()=> _showStatus('‚ùå FAILURE','error'));
            }catch(e){ _showStatus('‚ùå '+e.message,'error'); }
        }

        function _pollTask(taskId, onDone, onFail){
            const poll = async()=>{
                try{
                    const s = await fetch('/xgb_oos_test_status?task_id='+encodeURIComponent(taskId));
                    const sd = await s.json();
                    if(sd.state==='SUCCESS'){ onDone(sd.result||{}); return; }
                    if(sd.state==='FAILURE'){ onFail(); return; }
                    setTimeout(poll, 1500);
                }catch{ setTimeout(poll, 3000); }
            };
            setTimeout(poll, 800);
        }

        /* ---------- Batch OOS ---------- */
        async function startBatchOos(){
            const dirs = [...document.querySelectorAll('.cb-run:checked')].map(c=>c.value);
            if(!dirs.length){ alert('–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª–∏ –≥–∞–ª–æ—á–∫–∞–º–∏'); return; }
            const days = parseInt(document.getElementById('xgbOosDays')?.value || '30', 10) || 30;
            _showBatch(`‚è≥ –ó–∞–ø—É—Å–∫–∞—é OOS –¥–ª—è ${dirs.length} –º–æ–¥–µ–ª–µ–π‚Ä¶`, 'info');

            let resp;
            try{
                resp = await fetch('/xgb_oos_batch_async', {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({ result_dirs: dirs, days })
                });
            }catch(e){ _showBatch('‚ùå '+e.message,'error'); return; }
            const bd = await resp.json().catch(()=>null);
            if(!bd||!bd.success){ _showBatch('‚ùå '+(bd&&bd.error||'unknown'),'error'); return; }

            const tasks = bd.tasks; // [{result_dir, task_id}]
            const total = tasks.length;
            let done = 0;
            const results = [];

            const checkAll = ()=>{
                if(done >= total) finishBatch(results);
            };

            for(const t of tasks){
                _pollTask(t.task_id, res=>{
                    results.push(res);
                    done++;
                    _showBatch(`‚è≥ ${done}/${total} –≥–æ—Ç–æ–≤–æ‚Ä¶`, 'info');
                    checkAll();
                }, ()=>{
                    done++;
                    _showBatch(`‚è≥ ${done}/${total} –≥–æ—Ç–æ–≤–æ (–µ—Å—Ç—å –æ—à–∏–±–∫–∏)‚Ä¶`, 'info');
                    checkAll();
                });
            }
        }

        async function finishBatch(results){
            _showBatch(`‚úÖ –í—Å–µ ${results.length} —Ç–µ—Å—Ç–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω—ã. –°–æ—Ö—Ä–∞–Ω—è—é CSV‚Ä¶`, 'info');
            try{
                const r = await fetch('/xgb_oos_batch_save_csv', {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({ results })
                });
                const d = await r.json();
                if(d.success){
                    _showBatch(`‚úÖ CSV —Å–æ—Ö—Ä–∞–Ω—ë–Ω: ${d.filename} (${d.rows} —Å—Ç—Ä–æ–∫)`, 'success');
                    const link = document.createElement('a');
                    link.href = '/xgb_oos_csv_download/'+encodeURIComponent(d.filename);
                    link.textContent = 'üì• –°–∫–∞—á–∞—Ç—å '+d.filename;
                    link.style.cssText = 'display:inline-block;margin-top:6px;font-weight:600;';
                    document.getElementById('batchStatus').appendChild(document.createElement('br'));
                    document.getElementById('batchStatus').appendChild(link);
                    loadCsvList();
                }else{
                    _showBatch('‚ùå CSV –æ—à–∏–±–∫–∞: '+(d.error||'unknown'), 'error');
                }
            }catch(e){ _showBatch('‚ùå '+e.message,'error'); }
        }

        /* ---------- CSV list ---------- */
        async function loadCsvList(){
            const area = document.getElementById('csvListArea');
            if(!area) return;
            try{
                const r = await fetch('/xgb_oos_csv_list');
                const d = await r.json();
                if(!d.success || !d.files.length){ area.innerHTML='<span style="color:#9ca3af;">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö CSV</span>'; return; }
                let html = '<table class="tbl" style="max-width:700px;"><thead><tr><th>–§–∞–π–ª</th><th>–†–∞–∑–º–µ—Ä</th><th>–î–∞—Ç–∞</th><th></th></tr></thead><tbody>';
                for(const f of d.files){
                    html += `<tr>
                        <td class="mono">${f.name}</td>
                        <td>${(f.size/1024).toFixed(1)} KB</td>
                        <td>${f.mtime}</td>
                        <td><a href="/xgb_oos_csv_download/${encodeURIComponent(f.name)}">üì•</a></td>
                    </tr>`;
                }
                html += '</tbody></table>';
                area.innerHTML = html;
            }catch(e){ area.innerHTML='<span style="color:red;">–û—à–∏–±–∫–∞: '+e.message+'</span>'; }
        }

        // Load CSV list on page load
        loadCsvList();
    </script>
</body>
</html>
