<!DOCTYPE html>
<html lang="ru">
<head>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="/static/css/sidebar.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìà –ê–∫—Ü–∏–∏ –†–§ ‚Äî DQN</title>
</head>
<body>
    {% include 'include/_sidebar.html' %}
    <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>

    <div class="container">
        <div class="main-content">
            <div class="header">
                <h1>üìà –û–±—É—á–µ–Ω–∏–µ DQN ‚Äî –ê–∫—Ü–∏–∏ –†–§</h1>
                <p>T-Invest API (–¢–∏–Ω—å–∫–æ—Ñ—Ñ –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏) ¬∑ –û—Ç–¥–µ–ª—å–Ω—ã–π pipeline –æ—Ç –∫—Ä–∏–ø—Ç—ã</p>
            </div>

            <div class="content">
                <a href="/models" class="back-link">‚Üê DQN –ö—Ä–∏–ø—Ç–æ</a>

                <!-- –°–µ–∫—Ü–∏—è –æ–±—É—á–µ–Ω–∏—è -->
                <div class="section" id="training-stock">
                    <h2>üéØ –ó–∞–ø—É—Å–∫ –æ–±—É—á–µ–Ω–∏—è</h2>

                    <div class="form-group">
                        <label>–¢–∏–∫–µ—Ä</label>
                        <select id="stockTickerSelect" class="form-control">
                            <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>–≠–ø–∏–∑–æ–¥—ã</label>
                        <input id="stockEpisodes" class="form-control" type="number" min="1" value="500">
                    </div>

                    <div class="form-group">
                        <label>–î–ª–∏–Ω–∞ —ç–ø–∏–∑–æ–¥–∞ (—Å–≤–µ—á–µ–π 5m)</label>
                        <input id="stockEpisodeLength" class="form-control" type="number" min="100" value="2000">
                    </div>

                    <div class="form-group">
                        <label>Seed (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                        <input id="stockSeed" class="form-control" type="number" placeholder="42">
                    </div>

                    <div class="button-group">
                        <button id="btnTrainStock" class="btn btn-success" onclick="trainStock()">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±—É—á–µ–Ω–∏–µ</button>
                    </div>

                    <div id="stockStatus" class="status" style="display:none; margin-top:16px;"></div>
                </div>

                <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ -->
                <div class="section" id="active-tasks-stock">
                    <h2>üìã –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏</h2>
                    <div id="stockTasksList" style="font-family:monospace; font-size:13px;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á</div>
                </div>
            </div>
        </div>
    </div>

<script>
// --- Load tickers ---
(async()=>{
    try{
        const r = await fetch('/api/stock/tickers');
        const d = await r.json();
        const sel = document.getElementById('stockTickerSelect');
        sel.innerHTML = '';
        (d.tickers||[]).forEach(t=>{
            const o = document.createElement('option');
            o.value = t.ticker;
            o.textContent = `${t.ticker} ‚Äî ${t.name}`;
            sel.appendChild(o);
        });
    }catch(e){ console.error(e); }
})();

// --- Train ---
let activeTasks = {};
async function trainStock(){
    const ticker = document.getElementById('stockTickerSelect').value;
    if(!ticker){ alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–∫–µ—Ä'); return; }
    const episodes = parseInt(document.getElementById('stockEpisodes').value)||500;
    const epLen = parseInt(document.getElementById('stockEpisodeLength').value)||2000;
    const seedVal = document.getElementById('stockSeed').value;
    const seed = seedVal ? parseInt(seedVal) : null;

    const st = document.getElementById('stockStatus');
    st.style.display = 'block';
    st.className = 'status info';
    st.textContent = `‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–¥–∞—á–∏ ${ticker}...`;

    try{
        const r = await fetch('/api/stock/train', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ticker, episodes, episode_length:epLen, seed})
        });
        const d = await r.json();
        if(d.success){
            st.className = 'status success';
            st.textContent = `‚úÖ –ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞: ${d.task_id}`;
            activeTasks[d.task_id] = {ticker, startedAt: new Date()};
            pollTask(d.task_id);
        }else{
            st.className = 'status error';
            st.textContent = `‚ùå ${d.error}`;
        }
    }catch(e){
        st.className = 'status error';
        st.textContent = `‚ùå –û—à–∏–±–∫–∞: ${e}`;
    }
}

function pollTask(taskId){
    const interval = setInterval(async()=>{
        try{
            const r = await fetch(`/api/stock/task_status/${taskId}`);
            const d = await r.json();
            renderTasks();
            if(['SUCCESS','FAILURE','REVOKED'].includes(d.state)){
                clearInterval(interval);
                delete activeTasks[taskId];
                renderTasks();
                const st = document.getElementById('stockStatus');
                if(d.state==='SUCCESS'){
                    st.className='status success';
                    st.textContent=`‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ: ${JSON.stringify(d.result)}`;
                }else{
                    st.className='status error';
                    st.textContent=`‚ùå ${d.state}: ${JSON.stringify(d.result)}`;
                }
            }
        }catch(e){ console.error(e); }
    }, 5000);
}

function renderTasks(){
    const el = document.getElementById('stockTasksList');
    const keys = Object.keys(activeTasks);
    if(!keys.length){ el.textContent = '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á'; return; }
    el.innerHTML = keys.map(id=>{
        const t = activeTasks[id];
        return `<div style="padding:4px 0">üîÑ <b>${t.ticker}</b> ‚Äî ${id.slice(0,8)}‚Ä¶ (—Å ${t.startedAt.toLocaleTimeString()})</div>`;
    }).join('');
}
</script>
</body>
</html>
