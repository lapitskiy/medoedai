<!DOCTYPE html>
<html lang="ru">
<head>
    <link rel="stylesheet" href="/static/css/styles.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–≥–µ–Ω—Ç ‚Äî {{ symbol }}</title>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ –ê–≥–µ–Ω—Ç –ø–æ —Å–∏–º–≤–æ–ª—É: <code>{{ symbol }}</code></h1>
            <p>–í—Å–µ –¥–∞–Ω–Ω—ã–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞</p>
        </div>

        <div class="content">
            <nav style="margin: 6px 0 14px 0; font-size: 14px; color:#555;">
                <a href="/" class="back-link">–ì–ª–∞–≤–Ω–∞—è</a>
                <span>‚Ä∫</span>
                <a href="/trading_agent" class="back-link">–¢–æ—Ä–≥–æ–≤—ã–π –∞–≥–µ–Ω—Ç</a>
                <span>‚Ä∫</span>
                <span style="font-weight:600;">{{ symbol }}</span>
            </nav>
            <a href="/trading_agent" class="btn back-btn">‚Üê –û–±—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</a>
            <div class="button-group" style="margin:10px 0;">
                <a class="btn" href="/agent/BTCUSDT">BTC</a>
                <a class="btn" href="/agent/ETHUSDT">ETH</a>
                <a class="btn" href="/agent/SOLUSDT">SOL</a>
                <a class="btn" href="/agent/TONUSDT">TON</a>
                <a class="btn" href="/agent/BNBUSDT">BNB</a>
                <a class="btn" href="/agent/ADAUSDT">ADA</a>
                <a class="btn" href="/agent/XRPUSDT">XRP</a>
                <span style="margin-left:10px; color:#666;">–∏–ª–∏</span>
                <select id="symbolSelectQuick" class="form-control" style="width:auto; display:inline-block; margin-left:8px;" onchange="goSymbol(this.value)">
                    <option value="BTCUSDT">BTCUSDT</option>
                    <option value="ETHUSDT">ETHUSDT</option>
                    <option value="SOLUSDT">SOLUSDT</option>
                    <option value="TONUSDT">TONUSDT</option>
                    <option value="BNBUSDT">BNBUSDT</option>
                    <option value="ADAUSDT">ADAUSDT</option>
                    <option value="XRPUSDT">XRPUSDT</option>
                </select>
            </div>

            <div class="button-group" style="margin:10px 0;">
                <button class="btn btn-info" onclick="startMonitoringSymbol('{{ symbol }}')">üîÑ –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ ({{ symbol }})</button>
                <button class="btn btn-warning" onclick="stopMonitoringSymbol()">‚è∏Ô∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</button>
                <div id="monInfo" class="status info" style="display:none;">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ {{ symbol }} –∞–∫—Ç–∏–≤–µ–Ω (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω)</div>
            </div>

            <div class="section">
                <h2>üìä –°—Ç–∞—Ç—É—Å –∏ –±–∞–ª–∞–Ω—Å</h2>
                <div class="button-group">
                    <button class="btn btn-info" onclick="getTradingStatus('{{ symbol }}')">üîç –°—Ç–∞—Ç—É—Å</button>
                    <button class="btn btn-info" onclick="getBalance()">üí∞ –ë–∞–ª–∞–Ω—Å</button>
                </div>
                <div id="statusBox" class="trading-status" style="display:none;">
                    <h3>üìä –°—Ç–∞—Ç—É—Å</h3>
                    <div id="statusContent"></div>
                </div>
                <div id="balanceBox" class="trading-status" style="display:none;">
                    <h3>üí∞ –ë–∞–ª–∞–Ω—Å</h3>
                    <div id="balanceContent"></div>
                </div>
            </div>

            <div class="section">
                <h2>üìà –ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫ (–ë–î)</h2>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="loadDbHistory('{{ symbol }}')">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
                <div id="dbHistoryBox" class="trading-history" style="display:none;">
                    <h3>üìö –ò—Å—Ç–æ—Ä–∏—è</h3>
                    <div id="dbHistoryContent"></div>
                </div>
            </div>

            <!-- –û—Ç–¥–µ–ª—å–Ω—ã–π –±–ª–æ–∫: –ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫ –∏–∑ –±–∞–∑—ã (–≤—Å–µ–≥–¥–∞ –Ω–∞ –≤–∏–¥—É) -->
            <div class="section">
                <h2>üìö –ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫ (–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö)</h2>
                <p>–û—Ç–¥–µ–ª—å–Ω—ã–π –±–ª–æ–∫ –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è BUY ‚Üí SELL –ø–æ –¥–∞–Ω–Ω—ã–º –∏–∑ –ë–î</p>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="refreshDbTradeHistory('{{ symbol }}')">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é (–ë–î)</button>
                </div>
                <div id="dbTradeHistory" class="trading-history" style="display: none;">
                    <h3>üìö –ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫ (–ë–î)</h3>
                    <div id="dbTradeHistoryContent"></div>
                </div>
            </div>

            <div class="section">
                <h2>üß† –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –ò–ò</h2>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="loadPredictions('{{ symbol }}')">–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è</button>
                    <button class="btn btn-primary" onclick="loadPredictionStats('{{ symbol }}')">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π</button>
                </div>
                <div id="predictionsBox" class="trading-history" style="display:none;">
                    <h3>üß† –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è</h3>
                    <div id="predictionsContent"></div>
                </div>
                <div id="predStatsBox" class="trading-history" style="display:none;">
                    <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π</h3>
                    <div id="predStatsContent"></div>
                </div>
            </div>

            <div class="section">
                <h2>üîç –†–µ–∑—É–ª—å—Ç–∞—Ç—ã Celery</h2>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="loadCeleryResults('{{ symbol }}', false)">–†–µ–∞–ª—å–Ω—ã–µ —Å–¥–µ–ª–∫–∏</button>
                    <button class="btn btn-secondary" onclick="loadCeleryResults('{{ symbol }}', true)">–í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
                </div>
                <div id="celeryBox" class="trading-history" style="display:none;">
                    <h3 id="celeryTitle">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h3>
                    <div id="celeryContent"></div>
                </div>
            </div>

            <!-- –°–µ–∫—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —Ç–æ—Ä–≥–æ–≤–ª–∏ -->
            <div class="section">
                <h2>üìà –ò—Å—Ç–æ—Ä–∏—è —Ç–æ—Ä–≥–æ–≤–ª–∏</h2>
                <p>–î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—Å–µ—Ö —Å–¥–µ–ª–∫–∞—Ö</p>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="getTradingHistory()">üìä –ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫</button>
                </div>
                <div id="tradingHistory" class="trading-history" style="display: none;">
                    <h3>üìà –ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫</h3>
                    <div id="historyContent"></div>
                </div>
            </div>

            <!-- –°–µ–∫—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–¥–µ–ª–æ–∫ -->
            <div class="section">
                <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–¥–µ–ª–æ–∫</h2>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="getTradeStatistics()">üìä –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
                </div>
                <div id="tradeStatistics" class="trading-history" style="display: none;">
                    <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–¥–µ–ª–æ–∫</h3>
                    <div id="tradeStatisticsContent"></div>
                </div>
            </div>

        </div>
    </div>

<script>
// –£—Å—Ç–∞–Ω–æ–≤–∏–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª –≤ —Å–µ–ª–µ–∫—Ç–µ
try{
  const sel = document.getElementById('symbolSelectQuick');
  if(sel){ sel.value = '{{ symbol }}'; }
}catch(_){ }

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã/–≤—Ä–µ–º–µ–Ω–∏ –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ
function formatMoscowDateTime(value) {
  let date;
  if (typeof value === 'string') {
    const hasTimezone = /[zZ]|[\+\-]\d{2}:?\d{2}$/.test(value);
    const isoBasic = /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d+)?$/;
    const src = (!hasTimezone && isoBasic.test(value)) ? (value + 'Z') : value;
    date = new Date(src);
  } else if (typeof value === 'number') {
    date = new Date(value);
  } else {
    date = value;
  }
  if (!date || isNaN(date.getTime())) return 'N/A';
  return date.toLocaleString('ru-RU', {
    timeZone: 'Europe/Moscow',
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    hour12: false
  });
}

function goSymbol(sym){
  if(!sym) return;
  window.location.href = '/agent/' + encodeURIComponent(sym);
}
async function getTradingStatus(symbol){
  try{
    const resp = await fetch('/api/trading/status');
    const data = await resp.json();
    const box = document.getElementById('statusBox');
    const el = document.getElementById('statusContent');
    if(data.success){
      // –û–ø—Ä–µ–¥–µ–ª–∏–º, –µ—Å—Ç—å –ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞—è –ø–æ–∑–∏—Ü–∏—è
      const pos = (data.position || {});
      const posAmt = Number(pos.amount || pos.qty || 0);
      const inPos = Boolean(data.is_in_position || posAmt > 0);
      const posType = pos && pos.type ? String(pos.type).toUpperCase() : (inPos ? 'LONG' : '');
      const entry = (pos && (pos.entry_price != null ? pos.entry_price : pos.entryPrice));
      const posLine = inPos
        ? `<p><strong>–ü–æ–∑–∏—Ü–∏—è:</strong> üü° –í –ø–æ–∑–∏—Ü–∏–∏${posType?` (${posType})`:''}${posAmt?`, qty=${posAmt}`:''}</p>`
        : `<p><strong>–ü–æ–∑–∏—Ü–∏—è:</strong> ‚ö™ –ù–µ—Ç</p>`;
      const entryLine = (inPos && entry!=null)
        ? `<p><strong>–í—Ö–æ–¥:</strong> $${Number(entry).toFixed(4)}</p>`
        : '';

      el.innerHTML = `<p><strong>–°–∏–º–≤–æ–ª:</strong> ${symbol}</p>` +
        `<p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${data.trading_status_full || data.trading_status || (data.is_trading ? 'üü¢ –ê–∫—Ç–∏–≤–Ω–∞' : 'üî¥ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞')}</p>` +
        posLine + entryLine +
        `<p><strong>–°–¥–µ–ª–æ–∫:</strong> ${data.trades_count}</p>`;
      box.style.display='block';
    }
  }catch(e){
    console.error(e);
  }
}

async function getBalance(){
  try{
    const resp = await fetch('/api/trading/balance');
    const data = await resp.json();
    const box = document.getElementById('balanceBox');
    const el = document.getElementById('balanceContent');
    if(data.success){
      el.innerHTML = `<p><strong>USDT:</strong> ${data.balance.USDT.toFixed(2)}</p>`;
      box.style.display='block';
    }
  }catch(e){console.error(e);}
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Ç–æ—Ä–≥–æ–≤–ª–∏
async function getTradingHistory() {
  try {
    const response = await fetch('/api/trading/history');
    const result = await response.json();
    if (result.success) {
      const historyDiv = document.getElementById('tradingHistory');
      const contentDiv = document.getElementById('historyContent');
      let positionHTML = '';
      try {
        const statusResp = await fetch('/api/trading/status');
        const statusJson = await statusResp.json();
        if (statusJson && (statusJson.success || statusJson.agent_status)) {
          const agent = statusJson.agent_status || statusJson;
          const position = agent.position;
          const currentPrice = agent.current_price;
          if (position && position.amount && position.amount > 0) {
            const entryPrice = position.entry_price || 0;
            const pnlAbs = currentPrice && entryPrice ? (currentPrice - entryPrice) * position.amount : 0;
            const pnlPct = currentPrice && entryPrice ? ((currentPrice - entryPrice) / entryPrice) * 100 : 0;
            const entryTime = position.entry_time ? formatMoscowDateTime(position.entry_time) : '';
            positionHTML = `
              <div class="trade-item" style="border-left:4px solid #28a745;">
                <div class="trade-header">
                  <span class="trade-action buy">–¢–ï–ö–£–©–ê–Ø –ü–û–ó–ò–¶–ò–Ø ${position.type ? position.type.toUpperCase() : 'LONG'}</span>
                  ${entryTime ? `<span>–û—Ç–∫—Ä—ã—Ç–∞: ${entryTime}</span>` : ''}
                </div>
                <div class="trade-details">
                  <div class="trade-detail"><div class="label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</div><div class="value">${position.amount}</div></div>
                  <div class="trade-detail"><div class="label">–¶–µ–Ω–∞ –≤—Ö–æ–¥–∞</div><div class="value">$${entryPrice ? entryPrice.toFixed(2) : 'N/A'}</div></div>
                  <div class="trade-detail"><div class="label">–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞</div><div class="value">$${currentPrice ? currentPrice.toFixed(2) : 'N/A'}</div></div>
                  <div class="trade-detail"><div class="label">P&L</div><div class="value" style="color:${pnlAbs >= 0 ? 'green' : 'red'}">${pnlAbs >= 0 ? '+' : ''}$${pnlAbs.toFixed(4)} (${pnlPct >= 0 ? '+' : ''}${pnlPct.toFixed(2)}%)</div></div>
                  ${position.trade_number ? `<div class="trade-detail"><div class="label">Trade #</div><div class="value">${position.trade_number}</div></div>` : ''}
                </div>
              </div>
            `;
          } else {
            positionHTML = `
              <div class="trade-item" style="border-left:4px solid #6c757d;">
                <div class="trade-header">
                  <span class="trade-action hold">–¢–ï–ö–£–©–ê–Ø –ü–û–ó–ò–¶–ò–Ø</span>
                  <span>–Ω–µ—Ç –æ—Ç–∫—Ä—ã—Ç–æ–π –ø–æ–∑–∏—Ü–∏–∏</span>
                </div>
              </div>
            `;
          }
        }
      } catch (e) {}

      if (result.trades && result.trades.length > 0) {
        let historyHTML = `<p><strong>–í—Å–µ–≥–æ —Å–¥–µ–ª–æ–∫:</strong> ${result.total_trades}</p>`;
        result.trades.forEach((trade) => {
          const tradeTime = formatMoscowDateTime(trade.time);
          const actionClass = trade.action === 'buy' ? 'buy' : 'sell';
          historyHTML += `
            <div class="trade-item">
              <div class="trade-header">
                <span class="trade-action ${actionClass}">${trade.action.toUpperCase()}</span>
                <span>${tradeTime}</span>
              </div>
              <div class="trade-details">
                <div class="trade-detail"><div class="label">–¶–µ–Ω–∞</div><div class="value">$${trade.price}</div></div>
                <div class="trade-detail"><div class="label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</div><div class="value">${trade.amount}</div></div>
                ${trade.pnl ? `<div class="trade-detail"><div class="label">P&L</div><div class="value" style="color: ${trade.pnl >= 0 ? 'green' : 'red'}">${trade.pnl >= 0 ? '+' : ''}$${trade.pnl.toFixed(4)}</div></div>` : ''}
              </div>
            </div>
          `;
        });
        contentDiv.innerHTML = positionHTML + historyHTML;
      } else {
        const emptyHTML = '<p>üìà –ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫ –ø–æ–∫–∞ –ø—É—Å—Ç–∞</p><p><em>–°–¥–µ–ª–∫–∏ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–æ—Ä–≥–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π</em></p>';
        contentDiv.innerHTML = positionHTML + emptyHTML;
      }
      historyDiv.style.display = 'block';
      try { historyDiv.scrollIntoView({ behavior: 'smooth' }); } catch (_) {}
    } else {
      const historyDiv = document.getElementById('tradingHistory');
      const contentDiv = document.getElementById('historyContent');
      contentDiv.innerHTML = '<p>‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏</p><p><em>' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</em></p>';
      historyDiv.style.display = 'block';
      try { historyDiv.scrollIntoView({ behavior: 'smooth' }); } catch (_) {}
    }
  } catch (error) {
    const historyDiv = document.getElementById('tradingHistory');
    const contentDiv = document.getElementById('historyContent');
    contentDiv.innerHTML = '<p>‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏</p><p><em>' + error.message + '</em></p>';
    historyDiv.style.display = 'block';
    try { historyDiv.scrollIntoView({ behavior: 'smooth' }); } catch (_) {}
  }
}

async function loadDbHistory(symbol){
  try{
    const qs = new URLSearchParams({limit_trades:'400',limit_predictions:'2000',tolerance_buckets:'2',symbol}).toString();
    const resp = await fetch('/api/trades/matched_full?'+qs);
    const data = await resp.json();
    const box = document.getElementById('dbHistoryBox');
    const el = document.getElementById('dbHistoryContent');
    if(!data.success){ el.innerHTML = '‚ùå –û—à–∏–±–∫–∞'; box.style.display='block'; return; }
    const pairs = Array.isArray(data.pairs)?data.pairs:[];
    if(!pairs.length){ el.innerHTML = '–ù–µ—Ç —Å–æ–≤–ø–∞–≤—à–∏—Ö –ø–∞—Ä'; box.style.display='block'; return; }
    let html = '';
    for(const d of pairs){
      html += `<div class="trade-item"><div class="trade-header"><span class="trade-action buy">BUY</span><span>${d.entry_time}</span><span class="trade-action sell">‚Üí SELL</span><span>${d.exit_time}</span></div></div>`
    }
    el.innerHTML = html; box.style.display='block';
  }catch(e){console.error(e)}
}

async function loadPredictions(symbol){
  try{
    const resp = await fetch('/api/predictions/recent?limit=150&symbol='+encodeURIComponent(symbol));
    const data = await resp.json();
    const box = document.getElementById('predictionsBox');
    const el = document.getElementById('predictionsContent');
    if(!box || !el) return;
    if(!data.success){ el.innerHTML='‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π'; box.style.display='block'; return; }
    const preds = Array.isArray(data.predictions)? data.predictions : [];
    if(preds.length === 0){
      el.innerHTML = '<p>üß† –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –º–æ–¥–µ–ª–∏ –ø–æ–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</p><p><em>–î–∞–Ω–Ω—ã–µ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–æ—Ä–≥–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π</em></p>';
      box.style.display='block';
      return;
    }
    let predictionsHTML = `<p><strong>–í—Å–µ–≥–æ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π:</strong> ${data.total_predictions}</p>`;
    for(const prediction of preds){
      const predictionTime = formatMoscowDateTime(prediction.timestamp);
      const action = (prediction.action||'hold').toLowerCase();
      const actionClass = action === 'buy' ? 'buy' : action === 'sell' ? 'sell' : 'hold';
      const conf = typeof prediction.confidence === 'number' ? prediction.confidence : null;
      const confidenceClass = conf != null && conf > 0.5 ? 'success' : (conf != null && conf > 0.2 ? 'info' : 'warning');
      const qvals = Array.isArray(prediction.q_values) ? prediction.q_values : [];
      const isQgateFiltered = prediction.market_conditions && prediction.market_conditions.qgate_filtered;
      const qgateReason = prediction.market_conditions && prediction.market_conditions.qgate_reason;
      const qgateSide = prediction.market_conditions && prediction.market_conditions.qgate_side;
      const qgateT1 = prediction.market_conditions && prediction.market_conditions.qgate_T1;
      const qgateT2 = prediction.market_conditions && prediction.market_conditions.qgate_T2;
      const qgateMaxQ = prediction.market_conditions && prediction.market_conditions.qgate_maxQ;
      const qgateGapQ = prediction.market_conditions && prediction.market_conditions.qgate_gapQ;

      predictionsHTML += `
        <div class="trade-item" style="border-left: 4px solid ${isQgateFiltered ? '#ffc107' : (actionClass === 'buy' ? '#28a745' : actionClass === 'sell' ? '#dc3545' : '#6c757d')};">
          <div class="trade-header">
            <span class="trade-action ${actionClass}">${String(action).toUpperCase()}</span>
            ${isQgateFiltered ? '<span class="trade-confidence warning">üö´ Q-gate –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ</span>' : (conf!=null ? `<span class="trade-confidence ${confidenceClass}">–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${(conf*100).toFixed(1)}%</span>` : '')}
            <span>${predictionTime}</span>
          </div>
          <div class="trade-details">
            <div class="trade-detail"><div class="label">–°–∏–º–≤–æ–ª</div><div class="value">${prediction.symbol||symbol}</div></div>
            <div class="trade-detail"><div class="label">–¶–µ–Ω–∞</div><div class="value">$${prediction.current_price!=null ? Number(prediction.current_price).toFixed(6) : 'N/A'}</div></div>
            <div class="trade-detail"><div class="label">–ü–æ–∑–∏—Ü–∏—è</div><div class="value">${prediction.position_status||'none'}</div></div>
            <div class="trade-detail"><div class="label">Q-Values</div><div class="value">[${qvals.map(v=>Number(v).toFixed(3)).join(', ')}]</div></div>
          </div>
          ${isQgateFiltered ? `
          <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; font-size: 12px;">
            <strong>üö´ Q-gate —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è</strong>${qgateSide ? ` <span style="opacity:0.8">(${String(qgateSide).toUpperCase()})</span>` : ''}:<br>
            <div style="margin-top:6px; color:#856404;">${qgateReason || '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏'}</div>
            <div style="margin-top:8px; display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:6px; color:#444;">
              ${typeof qgateT1 === 'number' ? `<div><strong>T1 (maxQ)</strong>: ${qgateT1.toFixed(3)}</div>` : ''}
              ${typeof qgateT2 === 'number' ? `<div><strong>T2 (gapQ)</strong>: ${qgateT2.toFixed(3)}</div>` : ''}
              ${typeof qgateMaxQ === 'number' ? `<div><strong>maxQ</strong>: ${qgateMaxQ.toFixed(3)}</div>` : ''}
              ${typeof qgateGapQ === 'number' ? `<div><strong>gapQ</strong>: ${qgateGapQ.toFixed(3)}</div>` : ''}
            </div>
          </div>` : ''}
          ${prediction.market_conditions && Object.keys(prediction.market_conditions).filter(k=>!String(k).startsWith('qgate_')).length>0 && !isQgateFiltered ? `
          <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 12px;">
            <strong>–£—Å–ª–æ–≤–∏—è —Ä—ã–Ω–∫–∞:</strong><br>
            ${Object.entries(prediction.market_conditions).filter(([key]) => !String(key).startsWith('qgate_')).map(([key, value]) => `${key}: ${value}`).join(', ')}
          </div>` : ''}
        </div>
      `;
    }
    el.innerHTML = predictionsHTML;
    box.style.display='block';
  }catch(e){
    console.error(e);
    try{
      const box = document.getElementById('predictionsBox');
      const el = document.getElementById('predictionsContent');
      if(el){ el.innerHTML = '<p>‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏</p>'; }
      if(box){ box.style.display='block'; }
    }catch(_){ }
  }
}

async function loadPredictionStats(symbol){
  try{
    const resp = await fetch('/api/predictions/statistics?symbol='+encodeURIComponent(symbol));
    const data = await resp.json();
    const box = document.getElementById('predStatsBox');
    const el = document.getElementById('predStatsContent');
    if(!data.success){ el.innerHTML='‚ùå –û—à–∏–±–∫–∞'; box.style.display='block'; return; }
    el.innerHTML = JSON.stringify(data.statistics);
    box.style.display='block';
  }catch(e){console.error(e)}
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–¥–µ–ª–æ–∫
async function getTradeStatistics() {
  try {
    const response = await fetch('/api/trades/statistics');
    const result = await response.json();
    const statsDiv = document.getElementById('tradeStatistics');
    const contentDiv = document.getElementById('tradeStatisticsContent');
    if (result.success) {
      const stats = result.statistics;
      const successRate = stats.success_rate || 0;
      const successRateClass = successRate >= 50 ? 'success' : 'error';
      const statsHTML = `
        <div class="statistics-grid">
          <div class="stat-item"><div class="stat-label">–í—Å–µ–≥–æ —Å–¥–µ–ª–æ–∫</div><div class="stat-value">${stats.total_trades}</div></div>
          <div class="stat-item"><div class="stat-label">–£—Å–ø–µ—à–Ω—ã—Ö —Å–¥–µ–ª–æ–∫</div><div class="stat-value success">${stats.successful_trades}</div></div>
          <div class="stat-item"><div class="stat-label">–ù–µ—É–¥–∞—á–Ω—ã—Ö —Å–¥–µ–ª–æ–∫</div><div class="stat-value error">${stats.failed_trades}</div></div>
          <div class="stat-item"><div class="stat-label">–ü—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—Ö–∞</div><div class="stat-value ${successRateClass}">${successRate}%</div></div>
          <div class="stat-item"><div class="stat-label">–û–±—â–∏–π –æ–±—ä–µ–º</div><div class="stat-value">${stats.total_volume.toFixed(6)}</div></div>
          <div class="stat-item"><div class="stat-label">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</div><div class="stat-value">$${stats.total_value.toFixed(2)}</div></div>
        </div>
      `;
      contentDiv.innerHTML = statsHTML;
      statsDiv.style.display = 'block';
    } else {
      contentDiv.innerHTML = '<p>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</p><p><em>' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</em></p>';
      statsDiv.style.display = 'block';
    }
  } catch (error) {
    const statsDiv = document.getElementById('tradeStatistics');
    const contentDiv = document.getElementById('tradeStatisticsContent');
    contentDiv.innerHTML = '<p>‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏</p><p><em>' + error.message + '</em></p>';
    statsDiv.style.display = 'block';
  }
}

// –û—Ç–¥–µ–ª—å–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Å–¥–µ–ª–æ–∫ –∏–∑ –ë–î (—Å—Ç–∞—Ü–∏–æ–Ω–∞—Ä–Ω—ã–π –±–ª–æ–∫)
async function refreshDbTradeHistory(symbol){
  try{
    const qs = new URLSearchParams({
      limit_trades:'400',
      limit_predictions:'2000',
      tolerance_buckets:'2',
      ...(symbol ? { symbol } : {})
    }).toString();
    const resp = await fetch('/api/trades/matched_full?' + qs);
    const data = await resp.json();

    const historyDiv = document.getElementById('dbTradeHistory');
    const contentDiv = document.getElementById('dbTradeHistoryContent');

    if (!data.success) {
      contentDiv.innerHTML = '<p>‚ùå –û—à–∏–±–∫–∞ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è</p><p><em>' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</em></p>';
      historyDiv.style.display = 'block';
      return;
    }

    // –î–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –¥–æ–±–∞–≤–∏–º —Å—ã—Ä—ã–µ —Å–ø–∏—Å–∫–∏
    const tradesUrl = symbol ? (`/api/trades/by_symbol/${encodeURIComponent(symbol)}?limit=200`) : '/api/trades/recent?limit=200';
    const predsUrl = '/api/predictions/recent?limit=500' + (symbol ? ('&symbol=' + encodeURIComponent(symbol)) : '');
    let tradesJson = { success: false }, predsJson = { success: false };
    try {
      const [tResp, pResp] = await Promise.all([fetch(tradesUrl), fetch(predsUrl)]);
      tradesJson = await tResp.json();
      predsJson = await pResp.json();
    } catch (_) {}

    const toMs = (v) => {
      if (!v) return null;
      try {
        if (typeof v === 'number') return v;
        const s = String(v);
        const hasTimezone = /[zZ]|[\+\-]\d{2}:?\d{2}$/.test(s);
        const isoBasic = /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d+)?$/;
        const src = (!hasTimezone && isoBasic.test(s)) ? (s + 'Z') : s;
        const d = new Date(src);
        const t = d.getTime();
        return isNaN(t) ? null : t;
      } catch (_) { return null; }
    };
    const bucket5m = (ms) => (ms == null ? null : Math.floor(ms / 300000));

    const trades = (tradesJson && tradesJson.success && Array.isArray(tradesJson.trades)) ? tradesJson.trades : [];
    const tBuyLines = [];
    const tSellLines = [];
    for (const t of trades) {
      const ts = toMs(t.executed_at) ?? toMs(t.created_at) ?? toMs(t.time);
      const bk = bucket5m(ts);
      const priceNum = Number(t.price);
      const qtyNum = Number(t.quantity || t.amount || 0);
      const act = (t.action || '').toLowerCase();
      const actDisplay = act === 'sell_partial' ? 'SELL_PARTIAL' : (t.action?.toUpperCase());
      const line = `${formatMoscowDateTime(ts)} | ${t.symbol} | ${actDisplay} | $${(priceNum||0).toFixed(4)} | qty=${qtyNum} | b=${bk}`;
      if (act === 'buy') tBuyLines.push(line);
      if (act === 'sell' || act === 'sell_partial') tSellLines.push(line);
    }

    const predictions = (predsJson && predsJson.success && Array.isArray(predsJson.predictions)) ? predsJson.predictions : [];
    const pBuyLines = [];
    const pSellLines = [];
    for (const p of predictions) {
      const ts = toMs(p.timestamp);
      const bk = bucket5m(ts);
      const conf = (typeof p.confidence === 'number') ? (p.confidence * 100).toFixed(1) + '%' : '‚Äî';
      const line = `${formatMoscowDateTime(ts)} | ${p.symbol} | ${p.action?.toUpperCase()} | conf=${conf} | b=${bk}`;
      if ((p.action || '').toLowerCase() === 'buy') pBuyLines.push(line);
      if ((p.action || '').toLowerCase() === 'sell') pSellLines.push(line);
    }

    const debugHTML = `
      <div class="trade-item">
        <div class="trade-header">
          <span>–°–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö (—Å–∏–º–≤–æ–ª: ${symbol || '‚Äî'})</span>
        </div>
        <div class="trade-details" style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
          <div>
            <div class="label" style="font-weight:600; margin-bottom:6px;">–°–¥–µ–ª–∫–∏ (Bybit)</div>
            <div style="font-size:12px; color:#444;">
              <div><strong>BUY (${tBuyLines.length})</strong></div>
              <pre style="white-space:pre-wrap; margin:6px 0;">${tBuyLines.join('\n')}</pre>
              <div><strong>SELL (${tSellLines.length})</strong></div>
              <pre style="white-space:pre-wrap; margin:6px 0;">${tSellLines.join('\n')}</pre>
            </div>
          </div>
          <div>
            <div class="label" style="font-weight:600; margin-bottom:6px;">–ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è (–ë–î)</div>
            <div style="font-size:12px; color:#444;">
              <div><strong>BUY (${pBuyLines.length})</strong></div>
              <pre style="white-space:pre-wrap; margin:6px 0;">${pBuyLines.join('\n')}</pre>
              <div><strong>SELL (${pSellLines.length})</strong></div>
              <pre style="white-space:pre-wrap; margin:6px 0;">${pSellLines.join('\n')}</pre>
            </div>
          </div>
        </div>
      </div>
    `;

    const pairs = Array.isArray(data.pairs) ? data.pairs : [];
    if (pairs.length === 0) {
      contentDiv.innerHTML = debugHTML + '<p>–ù–µ—Ç –ø–æ–ª–Ω—ã—Ö —Å–æ–≤–ø–∞–≤—à–∏—Ö —Å–¥–µ–ª–æ–∫ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.</p>';
      historyDiv.style.display = 'block';
      return;
    }

    let html = `<p><strong>–ù–∞–π–¥–µ–Ω–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π:</strong> ${pairs.length}</p>`;
    for (const d of pairs) {
      const pnlColor = (d.pnl_abs || 0) >= 0 ? 'green' : 'red';
      const buyConf = (d.pred_buy && typeof d.pred_buy.confidence === 'number') ? (d.pred_buy.confidence * 100).toFixed(1) + '%' : '‚Äî';
      const sellConf = (d.pred_sell && typeof d.pred_sell.confidence === 'number') ? (d.pred_sell.confidence * 100).toFixed(1) + '%' : '‚Äî';
      const buyQ = d.pred_buy && Array.isArray(d.pred_buy.q_values) ? d.pred_buy.q_values.map(v=>Number(v).toFixed(3)).join(', ') : '‚Äî';
      const sellQ = d.pred_sell && Array.isArray(d.pred_sell.q_values) ? d.pred_sell.q_values.map(v=>Number(v).toFixed(3)).join(', ') : '‚Äî';

      html += `
        <div class="trade-item">
          <div class="trade-header">
            <span class="trade-action buy">BUY</span>
            <span>${formatMoscowDateTime(d.entry_time)}</span>
            <span class="trade-action sell">‚Üí SELL</span>
            <span>${formatMoscowDateTime(d.exit_time)}</span>
          </div>
          <div class="trade-details">
            <div class="trade-detail"><div class="label">–°–∏–º–≤–æ–ª</div><div class="value">${d.symbol}</div></div>
            <div class="trade-detail"><div class="label">–í—Ö–æ–¥</div><div class="value">$${Number(d.entry_price).toFixed(4)}</div></div>
            <div class="trade-detail"><div class="label">–í—ã—Ö–æ–¥</div><div class="value">$${Number(d.exit_price).toFixed(4)}</div></div>
            <div class="trade-detail"><div class="label">–ö–æ–ª-–≤–æ</div><div class="value">${d.qty}</div></div>
            <div class="trade-detail"><div class="label">P&L</div><div class="value" style="color:${pnlColor}">${(d.pnl_abs||0) >= 0 ? '+' : ''}$${Number(d.pnl_abs||0).toFixed(4)} ${d.pnl_pct!=null?`(${Number(d.pnl_pct).toFixed(2)}%)`:''}</div></div>
            <div class="trade-detail"><div class="label">BUY conf</div><div class="value">${buyConf}</div></div>
            <div class="trade-detail"><div class="label">SELL conf</div><div class="value">${sellConf}</div></div>
            <div class="trade-detail"><div class="label">BUY Q</div><div class="value">[${buyQ}]</div></div>
            <div class="trade-detail"><div class="label">SELL Q</div><div class="value">[${sellQ}]</div></div>
          </div>
        </div>
      `;
    }

    contentDiv.innerHTML = debugHTML + html;
    historyDiv.style.display = 'block';
  }catch(error){
    const historyDiv = document.getElementById('dbTradeHistory');
    const contentDiv = document.getElementById('dbTradeHistoryContent');
    contentDiv.innerHTML = '<p>‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏</p><p><em>' + error.message + '</em></p>';
    historyDiv.style.display = 'block';
  }
}

let monitoringTimer = null;

function startMonitoringSymbol(symbol){
  try{ stopMonitoringSymbol(); }catch(_){ }
  getTradingStatus(symbol);
  getBalance();
  loadDbHistory(symbol);
  refreshDbTradeHistory(symbol);
  loadPredictions(symbol);
  loadPredictionStats(symbol);
  loadCeleryResults(symbol, false);
  getTradingHistory();
  getTradeStatistics();
  monitoringTimer = setInterval(()=>{
    getTradingStatus(symbol);
    getBalance();
    loadDbHistory(symbol);
    refreshDbTradeHistory(symbol);
    loadPredictions(symbol);
    loadPredictionStats(symbol);
    loadCeleryResults(symbol, false);
    getTradingHistory();
    getTradeStatistics();
  }, 300000);
  const mi = document.getElementById('monInfo');
  if(mi) mi.style.display='block';
  try{ localStorage.setItem('agent:last_symbol', symbol); }catch(_){ }
}

function stopMonitoringSymbol(){
  if(monitoringTimer){ clearInterval(monitoringTimer); monitoringTimer=null; }
  const mi = document.getElementById('monInfo');
  if(mi) mi.style.display='none';
}

async function loadCeleryResults(symbol, showAll){
  try{
    const resp = await fetch('/api/trading/latest_results?symbol='+encodeURIComponent(symbol));
    const data = await resp.json();
    const box = document.getElementById('celeryBox');
    const el = document.getElementById('celeryContent');
    const title = document.getElementById('celeryTitle');
    if(!data.success){ el.innerHTML='‚ùå –û—à–∏–±–∫–∞'; box.style.display='block'; return; }
    const list = Array.isArray(data.latest_results)?data.latest_results:[];
    const filtered = showAll? list : list.filter(r=> r.trade_executed===true || r.exit_code!==0);
    title.textContent = showAll? 'üìä –í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã' : 'üìä –†–µ–∞–ª—å–Ω—ã–µ —Å–¥–µ–ª–∫–∏';
    if(!filtered.length){ el.innerHTML='–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'; box.style.display='block'; return; }
    el.innerHTML = filtered.map(r=>`<div class=\"trade-item\">`
      + `<div class=\"trade-header\">`
      + `<span class=\"trade-action ${r.exit_code!==0?'error':(r.trade_executed?'success':'info')}\">${r.exit_code!==0?'‚ùå –û–®–ò–ë–ö–ê':(r.trade_executed?'üí∞ –°–î–ï–õ–ö–ê':'‚è∏Ô∏è –û–ñ–ò–î–ê–ù–ò–ï')}</span>`
      + `<span>${r.timestamp}</span>`
      + `</div>`
      + `</div>`).join('');
    box.style.display='block';
  }catch(e){console.error(e)}
}

window.addEventListener('load', ()=>{
  const sym = '{{ symbol }}';
  try{
    const last = localStorage.getItem('agent:last_symbol');
    if(!sym && last){ startMonitoringSymbol(last); return; }
  }catch(_){ }
  startMonitoringSymbol(sym);
});
</script>

</body>
</html>


