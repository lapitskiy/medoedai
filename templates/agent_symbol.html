<!DOCTYPE html>
<html lang="ru">
<head>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="/static/css/sidebar.css">
    <link rel="stylesheet" href="/static/css/tabs.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–≥–µ–Ω—Ç ‚Äî {{ symbol }}</title>
    <style>
        /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É –±–ª–æ–∫–∞ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π –≤ 3 —Ä–∞–∑–∞ */
        .predictions-large {
            max-height: 1200px !important;
        }
    </style>
</head>
<body>
    <!-- Sidebar –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
    <nav class="sidebar">
        <h3>üìã –ù–∞–≤–∏–≥–∞—Ü–∏—è</h3>
        <ul class="sidebar-nav">
            <li><a href="/" class="back-link">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a></li>
            <li><a href="javascript:history.back()">‚Üê –ù–∞–∑–∞–¥</a></li>
            <li><a href="#status-balance" onclick="scrollToSection('status-balance')">üìä –°—Ç–∞—Ç—É—Å –∏ –±–∞–ª–∞–Ω—Å</a></li>
            <li><a href="#db-history" onclick="scrollToSection('db-history')">üìö –ò—Å—Ç–æ—Ä–∏—è (–ë–î)</a></li>
            <li><a href="#predictions" onclick="scrollToSection('predictions')">üß† –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –ò–ò</a></li>
            <li><a href="#celery-results" onclick="scrollToSection('celery-results')">üîç –†–µ–∑—É–ª—å—Ç–∞—Ç—ã Celery</a></li>
            <li><a href="#trading-history" onclick="scrollToSection('trading-history')">üìà –ò—Å—Ç–æ—Ä–∏—è —Ç–æ—Ä–≥–æ–≤–ª–∏</a></li>
            <li><a href="#trade-stats" onclick="scrollToSection('trade-stats')">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–¥–µ–ª–æ–∫</a></li>
        </ul>
    </nav>

    <!-- –ö–Ω–æ–ø–∫–∞ –º–æ–±–∏–ª—å–Ω–æ–≥–æ –º–µ–Ω—é -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>

    <div class="container">
        <div class="main-content">
            <div class="header">
                <h1>ü§ñ –ê–≥–µ–Ω—Ç –ø–æ —Å–∏–º–≤–æ–ª—É: <code>{{ symbol }}</code></h1>
                <p>–í—Å–µ –¥–∞–Ω–Ω—ã–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞</p>
            </div>

            <div class="content">
            <div class="tabs" data-tabs="main">
                <div class="tabs-nav">
                    <button class="tab-btn active" data-tab-btn data-target="#status-balance">üìä –°—Ç–∞—Ç—É—Å –∏ –±–∞–ª–∞–Ω—Å</button>
                    <button class="tab-btn" data-tab-btn data-target="#db-history">üìö –ò—Å—Ç–æ—Ä–∏—è (–ë–î)</button>
                    <button class="tab-btn" data-tab-btn data-target="#predictions">üß† –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –ò–ò</button>
                    <button class="tab-btn" data-tab-btn data-target="#celery-results">üîç –†–µ–∑—É–ª—å—Ç–∞—Ç—ã Celery</button>
                    <button class="tab-btn" data-tab-btn data-target="#trading-history">üìà –ò—Å—Ç–æ—Ä–∏—è —Ç–æ—Ä–≥–æ–≤–ª–∏</button>
                    <button class="tab-btn" data-tab-btn data-target="#trade-stats">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–¥–µ–ª–æ–∫</button>
                </div>
                <div class="tabs-content">
                    <!-- –ü–∞–Ω–µ–ª—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                    <div class="tab-panel" data-tab-panel id="status-balance">
                        <nav style="margin: 6px 0 14px 0; font-size: 14px; color:#555;">
                            <a href="/" class="back-link">–ì–ª–∞–≤–Ω–∞—è</a>
                            <span>‚Ä∫</span>
                            <a href="/trading_agent" class="back-link">–¢–æ—Ä–≥–æ–≤—ã–π –∞–≥–µ–Ω—Ç</a>
                            <span>‚Ä∫</span>
                            <span style="font-weight:600;">{{ symbol }}</span>
                        </nav>
                        <a href="/trading_agent" class="btn back-btn">‚Üê –û–±—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</a>

                        <div class="button-group" style="margin:10px 0;">
                            <button class="btn btn-info" onclick="startMonitoringSymbol('{{ symbol }}')">üîÑ –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ ({{ symbol }})</button>
                            <button class="btn btn-warning" onclick="stopMonitoringSymbol()">‚è∏Ô∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</button>
                            <div id="monInfo" class="status info" style="display:none;">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ {{ symbol }} –∞–∫—Ç–∏–≤–µ–Ω (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω)</div>
                        </div>

                        <div class="section">
                            <h2>üìä –°—Ç–∞—Ç—É—Å –∏ –±–∞–ª–∞–Ω—Å</h2>
                            <div class="button-group">
                                <button class="btn btn-info" onclick="getTradingStatus('{{ symbol }}')">üîç –°—Ç–∞—Ç—É—Å {{ symbol }}</button>
                                <button class="btn btn-info" onclick="getAllTradingStatus()">üåê –í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∞–≥–µ–Ω—Ç—ã</button>
                                <button class="btn btn-info" onclick="getBalance()">üí∞ –ë–∞–ª–∞–Ω—Å</button>
                            </div>
                            <div id="statusBox" class="trading-status" style="display:none;">
                                <h3>üìä –°—Ç–∞—Ç—É—Å {{ symbol }}</h3>
                                <div id="statusContent"></div>
                            </div>
                            <div id="allStatusBox" class="trading-status" style="display:none;">
                                <h3>üåê –í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∞–≥–µ–Ω—Ç—ã</h3>
                                <div id="allStatusContent"></div>
                            </div>
                            <div id="balanceBox" class="trading-status" style="display:none;">
                                <h3>üí∞ –ë–∞–ª–∞–Ω—Å</h3>
                                <div id="balanceContent"></div>
                            </div>
                        </div>
                    </div><!-- /status-balance tab-panel -->

            

                    <!-- –ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫ –∏–∑ –±–∞–∑—ã -->
                    <div class="tab-panel" data-tab-panel id="db-history">
                        <div class="section">
                            <h2>üìö –ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫ (–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö)</h2>
                            <p>–û—Ç–¥–µ–ª—å–Ω—ã–π –±–ª–æ–∫ –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è BUY ‚Üí SELL –ø–æ –¥–∞–Ω–Ω—ã–º –∏–∑ –ë–î</p>
                            <div class="button-group">
                                <button class="btn btn-primary" onclick="refreshDbTradeHistory('{{ symbol }}')">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é (–ë–î)</button>
                            </div>
                            <div id="dbTradeHistory" class="trading-history" style="display: none;">
                                <h3>üìö –ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫ (–ë–î)</h3>
                                <div id="dbTradeHistoryContent"></div>
                            </div>
                        </div>
                    </div><!-- /db-history tab-panel -->

                    <!-- –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –ò–ò -->
                    <div class="tab-panel" data-tab-panel id="predictions">
                        <div class="section">
                            <h2>üß† –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –ò–ò - {{ symbol }}</h2>
                            <div class="button-group">
                                <button class="btn btn-primary" onclick="loadPredictions('{{ symbol }}')">–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è</button>
                                <button class="btn btn-primary" onclick="loadPredictionStats('{{ symbol }}')">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π</button>
                            </div>
                            <div id="predictionsBox" class="trading-history predictions-large" style="display:none;">
                                <h3>üß† –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –¥–ª—è {{ symbol }}</h3>
                                <div id="predictionsContent"></div>
                            </div>
                            <div id="predStatsBox" class="trading-history" style="display:none;">
                                <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π –¥–ª—è {{ symbol }}</h3>
                                <div id="predStatsContent"></div>
                            </div>
                        </div>
                    </div><!-- /predictions tab-panel -->

                    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã Celery -->
                    <div class="tab-panel" data-tab-panel id="celery-results">
                        <div class="section">
                            <h2>üîç –†–µ–∑—É–ª—å—Ç–∞—Ç—ã Celery</h2>
                            <div class="button-group">
                                <button class="btn btn-primary" onclick="loadCeleryResults('{{ symbol }}', false)">–†–µ–∞–ª—å–Ω—ã–µ —Å–¥–µ–ª–∫–∏</button>
                                <button class="btn btn-secondary" onclick="loadCeleryResults('{{ symbol }}', true)">–í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
                            </div>
                            <div id="celeryBox" class="trading-history" style="display:none;">
                                <h3 id="celeryTitle">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h3>
                                <div id="celeryContent"></div>
                            </div>
                        </div>
                    </div><!-- /celery-results tab-panel -->

                    <!-- –ò—Å—Ç–æ—Ä–∏—è —Ç–æ—Ä–≥–æ–≤–ª–∏ -->
                    <div class="tab-panel" data-tab-panel id="trading-history">
                        <div class="section">
                            <h2>üìà –ò—Å—Ç–æ—Ä–∏—è —Ç–æ—Ä–≥–æ–≤–ª–∏</h2>
                            <p>–î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—Å–µ—Ö —Å–¥–µ–ª–∫–∞—Ö</p>
                            <div class="button-group">
                                <button class="btn btn-primary" onclick="getTradingHistory()">üìä –ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫</button>
                            </div>
                            <div id="tradingHistory" class="trading-history" style="display: none;">
                                <h3>üìà –ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫</h3>
                                <div id="historyContent"></div>
                            </div>
                        </div>
                    </div><!-- /trading-history tab-panel -->

                    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–¥–µ–ª–æ–∫ -->
                    <div class="tab-panel" data-tab-panel id="trade-stats">
                        <div class="section">
                            <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–¥–µ–ª–æ–∫</h2>
                            <div class="button-group">
                                <button class="btn btn-primary" onclick="getTradeStatistics()">üìä –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
                            </div>
                            <div id="tradeStatistics" class="trading-history" style="display: none;">
                                <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–¥–µ–ª–æ–∫</h3>
                                <div id="tradeStatisticsContent"></div>
                            </div>
                        </div>
                    </div><!-- /trade-stats tab-panel -->
                </div><!-- /tabs-content -->
            </div><!-- /tabs -->
            </div>
        </div>
    </div>

<script>
// –°–≤—è–∑—ã–≤–∞–µ–º –ø–µ—Ä–µ—Ö–æ–¥ –∏–∑ —Å–∞–π–¥–±–∞—Ä–∞ —Å –∞–∫—Ç–∏–≤–∞—Ü–∏–µ–π —Ç–∞–±–æ–≤
document.addEventListener('DOMContentLoaded', function(){
    try{
        document.querySelectorAll('.sidebar-nav a[href^="#"]').forEach(a => {
            a.addEventListener('click', function(){
                const href = a.getAttribute('href');
                if(href){
                    try{ window.__tabs && window.__tabs.activateTabByAnchor('[data-tabs="main"]', href); }catch(_){ }
                }
            });
        });
    }catch(_){ }
});


// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã/–≤—Ä–µ–º–µ–Ω–∏ –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ
function formatMoscowDateTime(value) {
  let date;
  if (typeof value === 'string') {
    const hasTimezone = /[zZ]|[\+\-]\d{2}:?\d{2}$/.test(value);
    const isoBasic = /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d+)?$/;
    const src = (!hasTimezone && isoBasic.test(value)) ? (value + 'Z') : value;
    date = new Date(src);
  } else if (typeof value === 'number') {
    date = new Date(value);
  } else {
    date = value;
  }
  if (!date || isNaN(date.getTime())) return 'N/A';
  return date.toLocaleString('ru-RU', {
    timeZone: 'Europe/Moscow',
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    hour12: false
  });
}

async function getTradingStatus(symbol){
  try{
    const resp = await fetch('/api/trading/status');
    const box = document.getElementById('statusBox');
    const el = document.getElementById('statusContent');

    // –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–µ 2xx ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –ø—É—Å—Ç–æ
    if(!resp.ok){
      let detail = '';
      try{ detail = await resp.text(); }catch(_){ detail=''; }
      el.innerHTML = `<p>‚ùå –°—Ç–∞—Ç—É—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (HTTP ${resp.status})</p>` + (detail ? `<pre style="white-space:pre-wrap; font-size:12px; color:#666;">${detail}</pre>` : '');
      box.style.display='block';
      return;
    }

    // –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON; –ø—Ä–∏ –æ—à–∏–±–∫–µ —Ç–æ–∂–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    let data = null;
    try{
      data = await resp.json();
      console.log('[getTradingStatus] raw', data);
      try{ console.log('[getTradingStatus] agent_status', data.agent_status || data); }catch(_){}
    }catch(parseErr){
      el.innerHTML = `<p>‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Å—Ç–∞—Ç—É—Å</p><pre style="white-space:pre-wrap; font-size:12px; color:#666;">${String(parseErr)}</pre>`;
      box.style.display='block';
      return;
    }

    const st = (data && (data.agent_status || data)) || {};
    const hasAny = !!(data && (data.success || data.agent_status || data.trading_status || data.trading_status_full || st.status));
    if(!hasAny){
      el.innerHTML = '<p>‚ùå –°—Ç–∞—Ç—É—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</p>';
      box.style.display='block';
      return;
    }

    const isTrading = Boolean(st.is_trading ?? st.active ?? st.running ?? false);
    const displaySymbol = (st.symbol_display || st.symbol || symbol);
    const tradingText = st.trading_status_full || st.trading_status || st.status || (isTrading ? 'üü¢ –ê–∫—Ç–∏–≤–Ω–∞' : 'üî¥ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
    const pos = st.position || st.current_position || st.pos || {};
    const posAmt = Number(pos.amount ?? pos.qty ?? 0);
    const inPos = Boolean(st.is_in_position ?? (posAmt > 0));
    const posType = pos && pos.type ? String(pos.type).toUpperCase() : (inPos ? 'LONG' : '');
    const entryRaw = (pos && (pos.entry_price != null ? pos.entry_price : pos.entryPrice));
    const entry = (entryRaw != null && entryRaw !== '') ? Number(entryRaw) : null;
    const entryTime = (pos && pos.entry_time) ? formatMoscowDateTime(pos.entry_time) : null;
    const cur = Number(st.current_price ?? st.price ?? 0);

    let pnlAbs = null, pnlPct = null;
    if(inPos && entry != null && isFinite(entry) && cur > 0){
      pnlAbs = (cur - entry) * (posAmt || 0);
      pnlPct = ((cur - entry) / entry) * 100;
    }

    const posLine = inPos
      ? `<p><strong>–ü–æ–∑–∏—Ü–∏—è:</strong> üü° –í –ø–æ–∑–∏—Ü–∏–∏${posType?` (${posType})`:''}${posAmt?`, qty=${posAmt}`:''}</p>`
      : `<p><strong>–ü–æ–∑–∏—Ü–∏—è:</strong> ‚ö™ –ù–µ—Ç</p>`;
    const entryLine = (inPos && entry!=null && isFinite(entry))
      ? `<p><strong>–í—Ö–æ–¥:</strong> $${entry.toFixed(4)}${entryTime?` <span style=\"opacity:.75\">(${entryTime})</span>`:''}</p>`
      : '';
    const priceLine = cur>0 ? `<p><strong>–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞:</strong> $${cur.toFixed(4)}</p>` : '';
    const pnlLine = (pnlAbs!=null && pnlPct!=null)
      ? `<p><strong>P&L:</strong> <span style=\"color:${pnlAbs>=0?'green':'red'}\">${pnlAbs>=0?'+':''}$${pnlAbs.toFixed(4)} (${pnlPct>=0?'+':''}${pnlPct.toFixed(2)}%)</span></p>`
      : '';
    const lmVal = st.last_model_prediction ?? st.latest_model_prediction ?? st.last_decision;
    const lm = lmVal ? `<p><strong>–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Ä–µ—à–µ–Ω–∏–µ –ò–ò:</strong> ${String(lmVal).toUpperCase()}</p>` : '';
    const tradesCntVal = (st.trades_count!=null) ? st.trades_count : (Array.isArray(st.trades)? st.trades.length : null);
    const tradesCnt = (tradesCntVal!=null) ? `<p><strong>–°–¥–µ–ª–æ–∫:</strong> ${tradesCntVal}</p>` : '';

    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –∏–∑ API
    const freshLine = (typeof st.is_fresh !== 'undefined') ? `<p><strong>–î–∞–Ω–Ω—ã–µ —Å–≤–µ–∂–∏–µ:</strong> ${st.is_fresh ? '–î–∞' : '–ù–µ—Ç'}</p>` : '';
    const reasonLine = st.reason ? `<p><strong>–ü—Ä–∏—á–∏–Ω–∞:</strong> ${st.reason}</p>` : '';
    const amountLine = (st.amount_display || (st.amount!=null)) ? `<p><strong>–û–±—ä—ë–º:</strong> ${st.amount_display || st.amount}</p>` : '';

    el.innerHTML = `<p><strong>–°–∏–º–≤–æ–ª:</strong> ${displaySymbol}</p>` +
      `<p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${tradingText}</p>` +
      posLine + entryLine + priceLine + pnlLine + amountLine + lm + tradesCnt + freshLine + reasonLine;
    box.style.display='block';
  }catch(e){
    console.error(e);
    try{
      const box = document.getElementById('statusBox');
      const el = document.getElementById('statusContent');
      el.innerHTML = `<p>‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏</p><pre style="white-space:pre-wrap; font-size:12px; color:#666;">${String(e && e.message || e)}</pre>`;
      box.style.display='block';
    }catch(_){ }
  }
}

async function getAllTradingStatus(){
  try{
    const resp = await fetch('/api/trading/status_all');
    const data = await resp.json();
    const box = document.getElementById('allStatusBox');
    const el = document.getElementById('allStatusContent');
    
    if(!data.success){
      el.innerHTML = '<p>‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞</p>';
      box.style.display='block';
      return;
    }
    
    const activeAgents = data.active_agents || [];
    const totalActive = data.total_active || 0;
    
    if(totalActive === 0){
      el.innerHTML = '<p>üìä –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–æ—Ä–≥–æ–≤—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤</p><p><em>–í—Å–µ –∞–≥–µ–Ω—Ç—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã</em></p>';
      box.style.display='block';
      return;
    }
    
    let statusHTML = `<p><strong>–í—Å–µ–≥–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤:</strong> ${totalActive}</p>`;
    
    activeAgents.forEach(agent => {
      const symbol = agent.symbol;
      const ttl = agent.ttl_seconds;
      const minutes = Math.floor(ttl / 60);
      const seconds = ttl % 60;
      const timeRemaining = `${minutes}–º ${seconds}—Å`;
      
      const currentPrice = agent.current_price ? `$${Number(agent.current_price).toFixed(4)}` : 'N/A';
      const tradesCount = agent.trades_count || 0;
      const lastPrediction = agent.last_prediction || 'N/A';
      const hasPosition = agent.position && agent.position.amount > 0;
      const amountDisplay = agent.amount_display || agent.amount || 'N/A';
      
      statusHTML += `
        <div class="trade-item" style="border-left: 4px solid #28a745; margin-top: 10px;">
          <div class="trade-header">
            <span class="trade-action buy">üü¢ ${symbol}</span>
            <span>–ê–∫—Ç–∏–≤–µ–Ω ${timeRemaining}</span>
          </div>
          <div class="trade-details">
            <div class="trade-detail">
              <div class="label">–¶–µ–Ω–∞</div>
              <div class="value">${currentPrice}</div>
            </div>
            <div class="trade-detail">
              <div class="label">–û–±—ä—ë–º</div>
              <div class="value">${amountDisplay}</div>
            </div>
            <div class="trade-detail">
              <div class="label">–ü–æ–∑–∏—Ü–∏—è</div>
              <div class="value">${hasPosition ? '–û—Ç–∫—Ä—ã—Ç–∞' : '–ù–µ—Ç'}</div>
            </div>
            <div class="trade-detail">
              <div class="label">–°–¥–µ–ª–æ–∫</div>
              <div class="value">${tradesCount}</div>
            </div>
            <div class="trade-detail">
              <div class="label">–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Ä–µ—à–µ–Ω–∏–µ</div>
              <div class="value">${lastPrediction}</div>
            </div>
            <div class="trade-detail">
              <div class="label">–î–µ–π—Å—Ç–≤–∏—è</div>
              <div class="value">
                <a href="/agent/${symbol}" class="btn btn-sm" style="padding: 4px 8px; font-size: 12px;">üìä –ü–µ—Ä–µ–π—Ç–∏ –∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ</a>
              </div>
            </div>
          </div>
        </div>
      `;
    });
    
    el.innerHTML = statusHTML;
    box.style.display='block';
  }catch(e){
    console.error(e);
    try{
      const box = document.getElementById('allStatusBox');
      const el = document.getElementById('allStatusContent');
      el.innerHTML = `<p>‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏</p><pre style="white-space:pre-wrap; font-size:12px; color:#666;">${String(e && e.message || e)}</pre>`;
      box.style.display='block';
    }catch(_){ }
  }
}

async function getBalance(){
  try{
    const resp = await fetch('/api/trading/balance');
    const data = await resp.json();
    const box = document.getElementById('balanceBox');
    const el = document.getElementById('balanceContent');
    if(data.success){
      el.innerHTML = `<p><strong>USDT:</strong> ${data.balance.USDT.toFixed(2)}</p>`;
      box.style.display='block';
    }
  }catch(e){console.error(e);}
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Ç–æ—Ä–≥–æ–≤–ª–∏
async function getTradingHistory() {
  try {
    const response = await fetch('/api/trading/history');
    const result = await response.json();
    if (result.success) {
      const historyDiv = document.getElementById('tradingHistory');
      const contentDiv = document.getElementById('historyContent');
      let positionHTML = '';
      try {
        const statusResp = await fetch('/api/trading/status');
        const statusJson = await statusResp.json();
        if (statusJson && (statusJson.success || statusJson.agent_status)) {
          const agent = statusJson.agent_status || statusJson;
          const position = agent.position;
          const currentPrice = agent.current_price;
          if (position && position.amount && position.amount > 0) {
            const entryPrice = position.entry_price || 0;
            const pnlAbs = currentPrice && entryPrice ? (currentPrice - entryPrice) * position.amount : 0;
            const pnlPct = currentPrice && entryPrice ? ((currentPrice - entryPrice) / entryPrice) * 100 : 0;
            const entryTime = position.entry_time ? formatMoscowDateTime(position.entry_time) : '';
            positionHTML = `
              <div class="trade-item" style="border-left:4px solid #28a745;">
                <div class="trade-header">
                  <span class="trade-action buy">–¢–ï–ö–£–©–ê–Ø –ü–û–ó–ò–¶–ò–Ø ${position.type ? position.type.toUpperCase() : 'LONG'}</span>
                  ${entryTime ? `<span>–û—Ç–∫—Ä—ã—Ç–∞: ${entryTime}</span>` : ''}
                </div>
                <div class="trade-details">
                  <div class="trade-detail"><div class="label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</div><div class="value">${position.amount}</div></div>
                  <div class="trade-detail"><div class="label">–¶–µ–Ω–∞ –≤—Ö–æ–¥–∞</div><div class="value">$${entryPrice ? entryPrice.toFixed(2) : 'N/A'}</div></div>
                  <div class="trade-detail"><div class="label">–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞</div><div class="value">$${currentPrice ? currentPrice.toFixed(2) : 'N/A'}</div></div>
                  <div class="trade-detail"><div class="label">P&L</div><div class="value" style="color:${pnlAbs >= 0 ? 'green' : 'red'}">${pnlAbs >= 0 ? '+' : ''}$${pnlAbs.toFixed(4)} (${pnlPct >= 0 ? '+' : ''}${pnlPct.toFixed(2)}%)</div></div>
                  ${position.trade_number ? `<div class="trade-detail"><div class="label">Trade #</div><div class="value">${position.trade_number}</div></div>` : ''}
                </div>
              </div>
            `;
          } else {
            positionHTML = `
              <div class="trade-item" style="border-left:4px solid #6c757d;">
                <div class="trade-header">
                  <span class="trade-action hold">–¢–ï–ö–£–©–ê–Ø –ü–û–ó–ò–¶–ò–Ø</span>
                  <span>–Ω–µ—Ç –æ—Ç–∫—Ä—ã—Ç–æ–π –ø–æ–∑–∏—Ü–∏–∏</span>
                </div>
              </div>
            `;
          }
        }
      } catch (e) {}

      if (result.trades && result.trades.length > 0) {
        let historyHTML = `<p><strong>–í—Å–µ–≥–æ —Å–¥–µ–ª–æ–∫:</strong> ${result.total_trades}</p>`;
        result.trades.forEach((trade) => {
          const tradeTime = formatMoscowDateTime(trade.time);
          const actionClass = trade.action === 'buy' ? 'buy' : 'sell';
          historyHTML += `
            <div class="trade-item">
              <div class="trade-header">
                <span class="trade-action ${actionClass}">${trade.action.toUpperCase()}</span>
                <span>${tradeTime}</span>
              </div>
              <div class="trade-details">
                <div class="trade-detail"><div class="label">–¶–µ–Ω–∞</div><div class="value">$${trade.price}</div></div>
                <div class="trade-detail"><div class="label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</div><div class="value">${trade.amount}</div></div>
                ${trade.pnl ? `<div class="trade-detail"><div class="label">P&L</div><div class="value" style="color: ${trade.pnl >= 0 ? 'green' : 'red'}">${trade.pnl >= 0 ? '+' : ''}$${trade.pnl.toFixed(4)}</div></div>` : ''}
              </div>
            </div>
          `;
        });
        contentDiv.innerHTML = positionHTML + historyHTML;
      } else {
        const emptyHTML = '<p>üìà –ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫ –ø–æ–∫–∞ –ø—É—Å—Ç–∞</p><p><em>–°–¥–µ–ª–∫–∏ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–æ—Ä–≥–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π</em></p>';
        contentDiv.innerHTML = positionHTML + emptyHTML;
      }
      historyDiv.style.display = 'block';
      try { historyDiv.scrollIntoView({ behavior: 'smooth' }); } catch (_) {}
    } else {
      const historyDiv = document.getElementById('tradingHistory');
      const contentDiv = document.getElementById('historyContent');
      contentDiv.innerHTML = '<p>‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏</p><p><em>' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</em></p>';
      historyDiv.style.display = 'block';
      try { historyDiv.scrollIntoView({ behavior: 'smooth' }); } catch (_) {}
    }
  } catch (error) {
    const historyDiv = document.getElementById('tradingHistory');
    const contentDiv = document.getElementById('historyContent');
    contentDiv.innerHTML = '<p>‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏</p><p><em>' + error.message + '</em></p>';
    historyDiv.style.display = 'block';
    try { historyDiv.scrollIntoView({ behavior: 'smooth' }); } catch (_) {}
  }
}

async function loadDbHistory(symbol){
  try{
    const qs = new URLSearchParams({limit_trades:'400',limit_predictions:'2000',tolerance_buckets:'2',symbol}).toString();
    const resp = await fetch('/api/trades/matched_full?'+qs);
    const data = await resp.json();
    const box = document.getElementById('dbHistoryBox');
    const el = document.getElementById('dbHistoryContent');
    if(!data.success){ el.innerHTML = '‚ùå –û—à–∏–±–∫–∞'; box.style.display='block'; return; }
    const pairs = Array.isArray(data.pairs)?data.pairs:[];
    if(!pairs.length){ el.innerHTML = '–ù–µ—Ç —Å–æ–≤–ø–∞–≤—à–∏—Ö –ø–∞—Ä'; box.style.display='block'; return; }
    let html = '';
    for(const d of pairs){
      const entry = formatMoscowDateTime(d.entry_time);
      const exit  = formatMoscowDateTime(d.exit_time);
      html += `<div class="trade-item"><div class="trade-header"><span class="trade-action buy">BUY</span><span>${entry}</span><span class="trade-action sell">‚Üí SELL</span><span>${exit}</span></div></div>`
    }
    el.innerHTML = html; box.style.display='block';
  }catch(e){console.error(e)}
}

async function loadPredictions(symbol){
  try{
    const resp = await fetch('/api/predictions/recent?limit=150&symbol='+encodeURIComponent(symbol));
    const data = await resp.json();
    const box = document.getElementById('predictionsBox');
    const el = document.getElementById('predictionsContent');
    if(!box || !el) return;
    if(!data.success){ el.innerHTML='‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π'; box.style.display='block'; return; }
    const preds = Array.isArray(data.predictions)? data.predictions : [];
    if(preds.length === 0){
      el.innerHTML = `<p>üß† –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –º–æ–¥–µ–ª–∏ –¥–ª—è ${symbol} –ø–æ–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</p><p><em>–î–∞–Ω–Ω—ã–µ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–æ—Ä–≥–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π</em></p>`;
      box.style.display='block';
      return;
    }
    let predictionsHTML = `<p><strong>–í—Å–µ–≥–æ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π:</strong> ${data.total_predictions}</p>`;
    const seenGroups = new Set();
    for(const prediction of preds){
      const predictionTime = formatMoscowDateTime(prediction.timestamp);
      const action = (prediction.action||'hold').toLowerCase();
      const actionClass = action === 'buy' ? 'buy' : action === 'sell' ? 'sell' : 'hold';
      const conf = typeof prediction.confidence === 'number' ? prediction.confidence : null;
      const confidenceClass = conf != null && conf > 0.5 ? 'success' : (conf != null && conf > 0.2 ? 'info' : 'warning');
      const qvals = Array.isArray(prediction.q_values) ? prediction.q_values : [];
      const isQgateFiltered = prediction.market_conditions && prediction.market_conditions.qgate_filtered;
      const qgateReason = prediction.market_conditions && prediction.market_conditions.qgate_reason;
      const qgateSide = prediction.market_conditions && prediction.market_conditions.qgate_side;
      const qgateT1 = prediction.market_conditions && prediction.market_conditions.qgate_T1;
      const qgateT2 = prediction.market_conditions && prediction.market_conditions.qgate_T2;
      const qgateMaxQ = prediction.market_conditions && prediction.market_conditions.qgate_maxQ;
      const qgateGapQ = prediction.market_conditions && prediction.market_conditions.qgate_gapQ;
      const gatePass = !isQgateFiltered;
      const gateClass = gatePass ? 'success' : 'warning';
      const gateText = gatePass ? 'Gate: –ø—Ä–æ—Ö–æ–¥–∏—Ç' : 'Gate: –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç';

      // –í–µ—Ä—Å–∏—è –º–æ–¥–µ–ª–∏ (–∏–∑ –ø—É—Ç–∏) + —ç–º–æ–¥–∑–∏ –¥–µ–π—Å—Ç–≤–∏—è; —Ü–≤–µ—Ç —Ñ–æ–Ω–∞ —á–∏–ø–∞ = PASS (–∑–µ–ª—ë–Ω—ã–π) / BLOCK (–∫—Ä–∞—Å–Ω—ã–π)
      const modelPath = prediction.model_path || '';
      let modelVer = '';
      try{
        const m = modelPath.match(/\/(v\d+)\//i);
        modelVer = m ? m[1].toUpperCase() : (modelPath.split('/')?.slice(-2,-1)?.[0] || '').toUpperCase();
      }catch(_){ modelVer=''; }
      const chipColor = gatePass ? '#28a745' : '#dc3545';
      const actLetter = action === 'buy' ? 'B' : (action === 'sell' ? 'S' : 'H');
      const modelChip = modelVer ? `<span style="margin-left:6px; padding:2px 8px; border-radius:999px; background:${chipColor}1a; color:${chipColor}; font-weight:600; font-size:12px;">${modelVer} ${actLetter}</span>` : '';

      // –ö–æ–Ω—Å–µ–Ω—Å—É—Å –∞–Ω—Å–∞–º–±–ª—è (–µ—Å–ª–∏ –µ—Å—Ç—å –≤ market_conditions)
      const mc = prediction.market_conditions || {};
      const etotal = Number(mc.ensemble_total);
      const evb = Number(mc.ensemble_votes_buy);
      const evs = Number(mc.ensemble_votes_sell);
      const evh = Number(mc.ensemble_votes_hold);
      const ereq = (mc.ensemble_required!=null) ? Number(mc.ensemble_required) : null;
      const ereqType = mc.ensemble_required_type || null;
      const ereg = mc.ensemble_regime || null;
      const edec = mc.ensemble_decision || null;
      // –î–µ–¥—É–ø–ª–∏–∫–∞—Ç–æ—Ä –∫–∞—Ä—Ç–æ—á–µ–∫: –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ –ø–æ ensemble_group_id, –∏–Ω–∞—á–µ –ø–æ (symbol,total,5s_bucket)
      try{
        const gid = mc.ensemble_group_id || null;
        if (gid) {
          if (seenGroups.has('gid:'+gid)) { continue; }
          seenGroups.add('gid:'+gid);
        } else {
          const curTs = Date.parse(prediction.timestamp);
          const bucket = isFinite(curTs) ? Math.floor(curTs/5000) : `na|${String(prediction.timestamp)}`;
          const groupKey = `${prediction.symbol||symbol}|${Number(etotal)||0}|${bucket}`;
          if (seenGroups.has(groupKey)) { continue; }
          seenGroups.add(groupKey);
        }
      }catch(_){ }
      // –î–ª—è —à–∞–ø–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ç–æ–≥ –∞–Ω—Å–∞–º–±–ª—è, –µ—Å–ª–∏ –µ—Å—Ç—å
      const headerAction = (edec || action || 'hold').toLowerCase();
      const headerActionClass = headerAction === 'buy' ? 'buy' : (headerAction === 'sell' ? 'sell' : 'hold');
      // –ü–æ–¥–≥–æ—Ç–æ–≤–∏–º —á–∏–ø—ã –¥–ª—è –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π —Ç–µ–∫—É—â–µ–≥–æ —Ç–∏–∫–∞: V1 B / V2 S / V3 H
      let modelsLine = '';
      let anyPassForHeader = false;
      let perModelQHtml = '';
      try{
        const curTs = Date.parse(prediction.timestamp);
        const siblings = (Array.isArray(preds)? preds : []).filter(pp => {
          try{
            if ((pp.symbol||'') !== (prediction.symbol||'')) return false;
            const a = Number(mc.ensemble_total) || null;
            const b = Number((pp.market_conditions||{}).ensemble_total) || null;
            if (a && b && a !== b) return false;
            const ts = Date.parse(pp.timestamp);
            if (!isFinite(curTs) || !isFinite(ts)) return String(pp.timestamp) === String(prediction.timestamp);
            return Math.abs(ts - curTs) <= 5000; // 5 —Å–µ–∫—É–Ω–¥–Ω—ã–π –∫–æ—Ä–∏–¥–æ—Ä –¥–ª—è –æ–¥–Ω–æ–≥–æ —Ç–∏–∫–∞ –∞–Ω—Å–∞–º–±–ª—è
          }catch(_){ return false; }
        });
        // –ï—Å—Ç—å –ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –º–æ–¥–µ–ª—å, –ø—Ä–æ—à–µ–¥—à–∞—è Q-gate –ø–æ –∏—Ç–æ–≥–æ–≤–æ–º—É –¥–µ–π—Å—Ç–≤–∏—é –∑–∞–≥–æ–ª–æ–≤–∫–∞ (BUY/SELL)?
        try{
          for(const pp of siblings){
            const act = String(pp.action||'').toLowerCase();
            const filt = !!(pp.market_conditions && pp.market_conditions.qgate_filtered);
            if (act === headerAction && !filt){ anyPassForHeader = true; break; }
          }
        }catch(__){}
        // –û—Ç—Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤–µ—Ä—Å–∏–∏ –º–æ–¥–µ–ª–∏: V1, V2, V3, ...
        const getVerNum = (mp) => {
          try{
            const m = String(mp||'').match(/\/v(\d+)\//i);
            if (m) return parseInt(m[1], 10);
            const seg = String(mp||'').split('/').find(s=>/^v\d+$/i.test(s));
            if (seg) return parseInt(seg.replace(/[^0-9]/g,''), 10);
          }catch(_){ }
          return Number.MAX_SAFE_INTEGER;
        };
        siblings.sort((a,b)=>{
          const va = getVerNum(a.model_path);
          const vb = getVerNum(b.model_path);
          if (va !== vb) return va - vb;
          return String(a.model_path||'').localeCompare(String(b.model_path||''));
        });
        const chips = siblings.map(pp => {
          try{
            const act = (pp.action||'hold').toLowerCase();
            const gateBlocked = !!(pp.market_conditions && pp.market_conditions.qgate_filtered);
            const pass = !gateBlocked;
            const color = pass ? '#28a745' : '#dc3545';
            const mp = pp.model_path || '';
            let ver = '';
            try{
              const m = mp.match(/\/(v\d+)\//i);
              ver = m ? m[1].toUpperCase() : (mp.split('/')?.slice(-2,-1)?.[0] || '').toUpperCase();
            }catch(_){ ver=''; }
            const letter = act === 'buy' ? 'B' : (act === 'sell' ? 'S' : 'H');
            return `<span style="padding:2px 8px; border-radius:999px; background:${color}1a; color:${color}; font-weight:600; font-size:12px;">${ver||'‚Äî'} ${letter}</span>`;
          }catch(__){ return ''; }
        }).filter(Boolean);
        if(chips.length){ modelsLine = chips.join(' / '); }
        // –°—Ñ–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏ —Å Q-Values –∏ —Å—Ç–∞—Ç—É—Å–æ–º gate –ø–æ –∫–∞–∂–¥–æ–π –º–æ–¥–µ–ª–∏
        try{
          const rows = siblings.map(pp => {
            try{
              const mp = String(pp.model_path||'');
              let ver = '';
              try{
                const m = mp.match(/\/(v\d+)\//i);
                ver = m ? m[1].toUpperCase() : (mp.split('/')?.slice(-2,-1)?.[0] || '').toUpperCase();
              }catch(_){ ver=''; }
              const qs = Array.isArray(pp.q_values) ? pp.q_values.map(v=>Number(v).toFixed(3)).join(', ') : '‚Äî';
              const blocked = !!(pp.market_conditions && pp.market_conditions.qgate_filtered);
              const gate = blocked ? 'BLOCK' : 'PASS';
              const act = (pp.action||'hold').toLowerCase();
              const letter = act==='buy'?'B':(act==='sell'?'S':'H');
              const mc2 = pp.market_conditions || {};
              const t1 = (typeof mc2.qgate_T1 === 'number') ? mc2.qgate_T1 : null;
              const t2 = (typeof mc2.qgate_T2 === 'number') ? mc2.qgate_T2 : null;
              const mQ = (typeof mc2.qgate_maxQ === 'number') ? mc2.qgate_maxQ : null;
              const gQ = (typeof mc2.qgate_gapQ === 'number') ? mc2.qgate_gapQ : null;
              const dM = (mQ!=null && t1!=null) ? (mQ - t1) : null;
              const dG = (gQ!=null && t2!=null) ? (gQ - t2) : null;
              const fmt = (v)=> (typeof v === 'number' ? v.toFixed(3) : '‚Äî');
              const details = `MAXQ>=${fmt(t1)}, GAPQ>=${fmt(t2)}, m=${fmt(mQ)}, g=${fmt(gQ)}${(dM!=null||dG!=null)?` (Œîm=${fmt(dM)}, Œîg=${fmt(dG)})`:''}`;
              return `<div><strong>${ver||'‚Äî'} ${letter}</strong>: [${qs}] <span style="font-weight:600; color:${blocked?'#dc3545':'#28a745'}">${gate}</span><span style="margin-left:8px; color:#555;">${details}</span></div>`;
            }catch(__){ return ''; }
          }).filter(Boolean);
          if(rows.length){ perModelQHtml = rows.join(''); }
        }catch(__){}
      }catch(__){}
      let ensembleBlock = '';
      if (Number.isFinite(etotal) && (Number.isFinite(evb) || Number.isFinite(evs) || Number.isFinite(evh))) {
        const votesLine = `BUY=${Number.isFinite(evb)?evb:'‚Äî'}, SELL=${Number.isFinite(evs)?evs:'‚Äî'}, HOLD=${Number.isFinite(evh)?evh:'‚Äî'}`;
        const reqLine = (ereq!=null) ? `–¢—Ä–µ–±—É–µ—Ç—Å—è: ${ereq} (${ereqType||'‚Äî'})` : '';
        const regLine = ereg ? `–†–µ–∂–∏–º: ${ereg}` : '';
        // –î–µ—Ç–∞–ª–∏ —Ä–µ–∂–∏–º–∞ –ø–æ –æ–∫–Ω–∞–º: 60=F, 180=U, 300=D
        let regWindowsLine = '';
        try{
          const rw = Array.isArray(mc.regime_windows) ? mc.regime_windows : [];
          const rl = Array.isArray(mc.regime_labels) ? mc.regime_labels : [];
          if(rw.length && rl.length){
            const mapLabel = (s)=>{
              const v = String(s||'flat').toLowerCase();
              if(v==='uptrend') return 'U';
              if(v==='downtrend') return 'D';
              return 'F';
            };
            const chips = rw.map((w,i)=>{
              const lab = mapLabel(rl[i]);
              const color = (lab==='U')? '#1976d2' : (lab==='D' ? '#dc3545' : '#28a745');
              const faded = (ereg && rl[i] && String(rl[i]).toLowerCase() !== String(ereg).toLowerCase());
              const style = `padding:2px 8px; border-radius:999px; background:${color}1a; color:${color}; font-weight:600; font-size:12px;` + (faded? ' opacity:0.55; text-decoration:line-through;' : '');
              return `<span style="${style}">${w}=${lab}</span>`;
            });
            if(chips.length){ regWindowsLine = chips.join(' '); }
          }
        }catch(__){}
        const decLine = edec ? `–ò—Ç–æ–≥: ${String(edec).toUpperCase()}` : '';
        ensembleBlock = `
          <div style="margin-top: 8px; padding: 8px; background:#f8f9fa; border:1px solid #e9ecef; border-radius:6px; font-size:12px;">
            <strong>–ö–æ–Ω—Å–µ–Ω—Å—É—Å –∞–Ω—Å–∞–º–±–ª—è</strong>
            <div style="margin-top:4px; display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:6px;">
              <div>–í—Å–µ–≥–æ –º–æ–¥–µ–ª–µ–π: ${etotal}</div>
              <div>–ì–æ–ª–æ—Å–∞: ${votesLine}</div>
              ${reqLine ? `<div>${reqLine}</div>` : ''}
              ${regLine ? `<div>${regLine}</div>` : ''}
              ${regWindowsLine ? `<div style="grid-column: 1 / -1;">–†–µ–∂–∏–º (–æ–∫–Ω–∞): ${regWindowsLine}</div>` : ''}
              ${decLine ? `<div>${decLine}</div>` : ''}
              ${modelsLine ? `<div style="grid-column: 1 / -1;">–ú–æ–¥–µ–ª–∏: ${modelsLine}</div>` : ''}
              ${perModelQHtml ? `<div style="grid-column: 1 / -1; margin-top:4px;"><div style=\"font-weight:600; margin-bottom:3px;\">Q-Values –ø–æ –º–æ–¥–µ–ª—è–º:</div>${perModelQHtml}</div>` : ''}
            </div>
          </div>`;
      }

      const showQgateBanner = isQgateFiltered && !anyPassForHeader;
      predictionsHTML += `
        <div class="trade-item" style="border-left: 4px solid ${isQgateFiltered ? '#ffc107' : (headerActionClass === 'buy' ? '#28a745' : headerActionClass === 'sell' ? '#dc3545' : '#6c757d')};">
          <div class="trade-header">
            <span class="trade-action ${headerActionClass}">${String(headerAction).toUpperCase()}</span>
            ${showQgateBanner ? '<span class="trade-confidence warning">üö´ Q-gate –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ</span>' : (conf!=null ? `<span class="trade-confidence ${confidenceClass}">–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${(conf*100).toFixed(1)}%</span>` : '')}
            <span>${predictionTime}</span>
          </div>
          <div class="trade-details">
            <div class="trade-detail"><div class="label">–°–∏–º–≤–æ–ª</div><div class="value">${prediction.symbol||symbol}</div></div>
            <div class="trade-detail"><div class="label">–¶–µ–Ω–∞</div><div class="value">$${prediction.current_price!=null ? Number(prediction.current_price).toFixed(6) : 'N/A'}</div></div>
            <div class="trade-detail"><div class="label">–ü–æ–∑–∏—Ü–∏—è</div><div class="value">${prediction.position_status||'none'}</div></div>
          </div>
          ${ensembleBlock}
          ${isQgateFiltered ? `
          <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; font-size: 12px;">
            <strong>üö´ Q-gate —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è</strong>${qgateSide ? ` <span style="opacity:0.8">(${String(qgateSide).toUpperCase()})</span>` : ''}:<br>
            <div style="margin-top:6px; color:#856404;">${qgateReason || '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏'}</div>
            <div style="margin-top:8px; display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:6px; color:#444;">
              ${typeof qgateT1 === 'number' ? `<div><strong>T1 (maxQ)</strong>: ${qgateT1.toFixed(3)}</div>` : ''}
              ${typeof qgateT2 === 'number' ? `<div><strong>T2 (gapQ)</strong>: ${qgateT2.toFixed(3)}</div>` : ''}
              ${typeof qgateMaxQ === 'number' ? `<div><strong>maxQ</strong>: ${qgateMaxQ.toFixed(3)}</div>` : ''}
              ${typeof qgateGapQ === 'number' ? `<div><strong>gapQ</strong>: ${qgateGapQ.toFixed(3)}</div>` : ''}
            </div>
          </div>` : ''}
          ${prediction.market_conditions && Object.keys(prediction.market_conditions).filter(k=>!String(k).startsWith('qgate_')).length>0 && !isQgateFiltered ? `
          <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 12px;">
            <strong>–£—Å–ª–æ–≤–∏—è —Ä—ã–Ω–∫–∞:</strong><br>
            ${Object.entries(prediction.market_conditions).filter(([key]) => !String(key).startsWith('qgate_')).map(([key, value]) => `${key}: ${value}`).join(', ')}
          </div>` : ''}
        </div>
      `;
    }
    el.innerHTML = predictionsHTML;
    box.style.display='block';
  }catch(e){
    console.error(e);
    try{
      const box = document.getElementById('predictionsBox');
      const el = document.getElementById('predictionsContent');
      if(el){ el.innerHTML = '<p>‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏</p>'; }
      if(box){ box.style.display='block'; }
    }catch(_){ }
  }
}

async function loadPredictionStats(symbol){
  try{
    const resp = await fetch('/api/predictions/statistics?symbol='+encodeURIComponent(symbol));
    const data = await resp.json();
    const box = document.getElementById('predStatsBox');
    const el = document.getElementById('predStatsContent');
    if(!data.success){ 
      el.innerHTML=`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è ${symbol}`; 
      box.style.display='block'; 
      return; 
    }
    
    const stats = data.statistics || {};
    const statsHTML = `
      <p><strong>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π –¥–ª—è ${symbol}:</strong></p>
      <div style="margin-top: 10px;">
        <pre style="background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px;">${JSON.stringify(stats, null, 2)}</pre>
      </div>
    `;
    
    el.innerHTML = statsHTML;
    box.style.display='block';
  }catch(e){
    console.error(e);
    const box = document.getElementById('predStatsBox');
    const el = document.getElementById('predStatsContent');
    if(el) el.innerHTML = `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è ${symbol}`;
    if(box) box.style.display='block';
  }
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–¥–µ–ª–æ–∫
async function getTradeStatistics() {
  try {
    const response = await fetch('/api/trades/statistics');
    const result = await response.json();
    const statsDiv = document.getElementById('tradeStatistics');
    const contentDiv = document.getElementById('tradeStatisticsContent');
    if (result.success) {
      const stats = result.statistics;
      const successRate = stats.success_rate || 0;
      const successRateClass = successRate >= 50 ? 'success' : 'error';
      const statsHTML = `
        <div class="statistics-grid">
          <div class="stat-item"><div class="stat-label">–í—Å–µ–≥–æ —Å–¥–µ–ª–æ–∫</div><div class="stat-value">${stats.total_trades}</div></div>
          <div class="stat-item"><div class="stat-label">–£—Å–ø–µ—à–Ω—ã—Ö —Å–¥–µ–ª–æ–∫</div><div class="stat-value success">${stats.successful_trades}</div></div>
          <div class="stat-item"><div class="stat-label">–ù–µ—É–¥–∞—á–Ω—ã—Ö —Å–¥–µ–ª–æ–∫</div><div class="stat-value error">${stats.failed_trades}</div></div>
          <div class="stat-item"><div class="stat-label">–ü—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—Ö–∞</div><div class="stat-value ${successRateClass}">${successRate}%</div></div>
          <div class="stat-item"><div class="stat-label">–û–±—â–∏–π –æ–±—ä–µ–º</div><div class="stat-value">${stats.total_volume.toFixed(6)}</div></div>
          <div class="stat-item"><div class="stat-label">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</div><div class="stat-value">$${stats.total_value.toFixed(2)}</div></div>
        </div>
      `;
      contentDiv.innerHTML = statsHTML;
      statsDiv.style.display = 'block';
    } else {
      contentDiv.innerHTML = '<p>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</p><p><em>' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</em></p>';
      statsDiv.style.display = 'block';
    }
  } catch (error) {
    const statsDiv = document.getElementById('tradeStatistics');
    const contentDiv = document.getElementById('tradeStatisticsContent');
    contentDiv.innerHTML = '<p>‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏</p><p><em>' + error.message + '</em></p>';
    statsDiv.style.display = 'block';
  }
}

// –û—Ç–¥–µ–ª—å–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Å–¥–µ–ª–æ–∫ –∏–∑ –ë–î (—Å—Ç–∞—Ü–∏–æ–Ω–∞—Ä–Ω—ã–π –±–ª–æ–∫)
async function refreshDbTradeHistory(symbol){
  try{
    const qs = new URLSearchParams({
      limit_trades:'400',
      limit_predictions:'2000',
      tolerance_buckets:'2',
      ...(symbol ? { symbol } : {})
    }).toString();
    const resp = await fetch('/api/trades/matched_full?' + qs);
    const data = await resp.json();

    const historyDiv = document.getElementById('dbTradeHistory');
    const contentDiv = document.getElementById('dbTradeHistoryContent');

    if (!data.success) {
      contentDiv.innerHTML = '<p>‚ùå –û—à–∏–±–∫–∞ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è</p><p><em>' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</em></p>';
      historyDiv.style.display = 'block';
      return;
    }

    const validPairs = Array.isArray(data.pairs) ? data.pairs : [];
    if (validPairs.length === 0) {
      contentDiv.innerHTML = '<p>–ù–µ—Ç —Å–æ–≤–ø–∞–≤—à–∏—Ö BUY‚ÜíSELL —Å–¥–µ–ª–æ–∫ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.</p>';
      historyDiv.style.display = 'block';
      return;
    }

    let html = `<p><strong>–ù–∞–π–¥–µ–Ω–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π:</strong> ${validPairs.length}</p>`;
    for (const d of validPairs) {
      const pnlColor = (d.pnl_abs || 0) >= 0 ? 'green' : 'red';
      const buyConf = (d.pred_buy && typeof d.pred_buy.confidence === 'number') ? (d.pred_buy.confidence * 100).toFixed(1) + '%' : '‚Äî';
      const sellConf = (d.pred_sell && typeof d.pred_sell.confidence === 'number') ? (d.pred_sell.confidence * 100).toFixed(1) + '%' : '‚Äî';
      const buyQ = d.pred_buy && Array.isArray(d.pred_buy.q_values) ? d.pred_buy.q_values.map(v=>Number(v).toFixed(3)).join(', ') : '‚Äî';
      const sellQ = d.pred_sell && Array.isArray(d.pred_sell.q_values) ? d.pred_sell.q_values.map(v=>Number(v).toFixed(3)).join(', ') : '‚Äî';

      html += `
        <div class="trade-item">
          <div class="trade-header">
            <span class="trade-action buy">BUY</span>
            <span>${formatMoscowDateTime(d.entry_time)}</span>
            <span class="trade-action sell">‚Üí SELL</span>
            <span>${formatMoscowDateTime(d.exit_time)}</span>
          </div>
          <div class="trade-details">
            <div class="trade-detail"><div class="label">–°–∏–º–≤–æ–ª</div><div class="value">${d.symbol}</div></div>
            <div class="trade-detail"><div class="label">–í—Ö–æ–¥</div><div class="value">$${Number(d.entry_price).toFixed(4)}</div></div>
            <div class="trade-detail"><div class="label">–í—ã—Ö–æ–¥</div><div class="value">$${Number(d.exit_price).toFixed(4)}</div></div>
            <div class="trade-detail"><div class="label">–ö–æ–ª-–≤–æ</div><div class="value">${d.qty}</div></div>
            <div class="trade-detail"><div class="label">P&L</div><div class="value" style="color:${pnlColor}">${(d.pnl_abs||0) >= 0 ? '+' : ''}$${Number(d.pnl_abs||0).toFixed(4)} ${d.pnl_pct!=null?`(${Number(d.pnl_pct).toFixed(2)}%)`:''}</div></div>
            <div class="trade-detail"><div class="label">BUY conf</div><div class="value">${buyConf}</div></div>
            <div class="trade-detail"><div class="label">SELL conf</div><div class="value">${sellConf}</div></div>
            <div class="trade-detail"><div class="label">BUY Q</div><div class="value">[${buyQ}]</div></div>
            <div class="trade-detail"><div class="label">SELL Q</div><div class="value">[${sellQ}]</div></div>
          </div>
        </div>
      `;
    }

    contentDiv.innerHTML = html;
    historyDiv.style.display = 'block';
  }catch(error){
    const historyDiv = document.getElementById('dbTradeHistory');
    const contentDiv = document.getElementById('dbTradeHistoryContent');
    contentDiv.innerHTML = '<p>‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏</p><p><em>' + error.message + '</em></p>';
    historyDiv.style.display = 'block';
  }
}

let monitoringTimer = null;

function startMonitoringSymbol(symbol){
  try{ stopMonitoringSymbol(); }catch(_){ }
  getTradingStatus(symbol);
  getAllTradingStatus();
  getBalance();
  loadDbHistory(symbol);
  refreshDbTradeHistory(symbol);
  loadPredictions(symbol);
  loadPredictionStats(symbol);
  loadCeleryResults(symbol, false);
  getTradingHistory();
  getTradeStatistics();
  monitoringTimer = setInterval(()=>{
    getTradingStatus(symbol);
    getAllTradingStatus();
    getBalance();
    loadDbHistory(symbol);
    refreshDbTradeHistory(symbol);
    loadPredictions(symbol);
    loadPredictionStats(symbol);
    loadCeleryResults(symbol, false);
    getTradingHistory();
    getTradeStatistics();
  }, 300000);
  const mi = document.getElementById('monInfo');
  if(mi) mi.style.display='block';
  try{ localStorage.setItem('agent:last_symbol', symbol); }catch(_){ }
}

function stopMonitoringSymbol(){
  if(monitoringTimer){ clearInterval(monitoringTimer); monitoringTimer=null; }
  const mi = document.getElementById('monInfo');
  if(mi) mi.style.display='none';
}

async function loadCeleryResults(symbol, showAll){
  try{
    const resp = await fetch('/api/trading/latest_results?symbol='+encodeURIComponent(symbol));
    const data = await resp.json();
    const box = document.getElementById('celeryBox');
    const el = document.getElementById('celeryContent');
    const title = document.getElementById('celeryTitle');
    if(!data.success){ el.innerHTML='‚ùå –û—à–∏–±–∫–∞'; box.style.display='block'; return; }
    const list = Array.isArray(data.latest_results)?data.latest_results:[];
    const filtered = showAll? list : list.filter(r=> r.trade_executed===true || r.exit_code!==0);
    title.textContent = showAll? 'üìä –í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã' : 'üìä –†–µ–∞–ª—å–Ω—ã–µ —Å–¥–µ–ª–∫–∏';
    if(!filtered.length){ el.innerHTML='–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'; box.style.display='block'; return; }
    el.innerHTML = filtered.map(r=>`<div class=\"trade-item\">`
      + `<div class=\"trade-header\">`
      + `<span class=\"trade-action ${r.exit_code!==0?'error':(r.trade_executed?'success':'info')}\">${r.exit_code!==0?'‚ùå –û–®–ò–ë–ö–ê':(r.trade_executed?'üí∞ –°–î–ï–õ–ö–ê':'‚è∏Ô∏è –û–ñ–ò–î–ê–ù–ò–ï')}</span>`
      + `<span>${r.timestamp}</span>`
      + `</div>`
      + `</div>`).join('');
    box.style.display='block';
  }catch(e){console.error(e)}
}

window.addEventListener('load', ()=>{
  const sym = '{{ symbol }}';
  try{
    const last = localStorage.getItem('agent:last_symbol');
    if(!sym && last){ startMonitoringSymbol(last); return; }
  }catch(_){ }
  startMonitoringSymbol(sym);
});
</script>
<script src="/static/js/sidebar.js"></script>
<script src="/static/js/tabs.js"></script>

</body>
</html>


