<!DOCTYPE html>
<html lang="ru">
<head>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="/static/css/sidebar.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>!–û–±—É—á–µ–Ω–∏–µ XGB</title>
</head>
<body>
    {% include 'include/_sidebar.html' %}
    <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>

    <div class="container">
        <div class="main-content">
            <div class="header">
                <h1>üß† XGB (buy/sell/hold)</h1>
                <p>–û—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ–±—É—á–µ–Ω–∏—è XGBoost-–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞</p>
            </div>

            <div class="content">
                <a href="/" class="back-link">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>

                <div class="section" id="xgb-training">
                    <h2>üéØ –û–±—É—á–µ–Ω–∏–µ XGB –º–æ–¥–µ–ª–∏</h2>
                    <p>
                        –ó–∞–ø—É—Å–∫ –æ–±—É—á–µ–Ω–∏—è XGB. –í–∞–∂–Ω–æ: <b>Task</b> –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –º–æ–¥–µ–ª–∏.
                        –ö–Ω–æ–ø–∫–∞ <b>Grid</b> —Å–µ–π—á–∞—Å —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è <code>directional</code>.
                    </p>

                    <div class="form-group">
                        <label>–°–∏–º–≤–æ–ª –¥–ª—è –æ–±—É—á–µ–Ω–∏—è</label>
                        <select id="xgbSymbolSelect" class="form-control">
                            <option value="BTCUSDT">BTC</option>
                            <option value="TONUSDT">TON</option>
                            <option value="ETHUSDT">ETH</option>
                            <option value="SOLUSDT">SOL</option>
                            <option value="ADAUSDT">ADA</option>
                            <option value="BNBUSDT">BNB</option>
                            <option value="XMRUSDT">XMR</option>
                            <option value="XRPUSDT">XRP</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label>
                        <select id="xgbDirectionSelect" class="form-control">
                            <option value="long" selected>Long</option>
                            <option value="short">Short</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Task</label>
                        <select id="xgbTaskSelect" class="form-control">
                            <option value="directional" selected>directional (hold/buy/sell)</option>
                            <option value="entry_long">entry_long (flat‚Üíenter)</option>
                            <option value="exit_long">exit_long (long‚Üíexit)</option>
                            <option value="entry_short">entry_short (flat‚Üíenter)</option>
                            <option value="exit_short">exit_short (short‚Üíexit)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>horizon_steps (5m —à–∞–≥–∏)</label>
                        <input id="xgbHorizonStepsInput" class="form-control" type="number" min="1" step="1" value="12">
                    </div>

                    <div class="form-group">
                        <label>threshold, % (–ø–æ—Ä–æ–≥ hold –¥–ª—è directional)</label>
                        <input id="xgbThresholdPctInput" class="form-control" type="number" min="0" step="0.01" value="0.20">
                    </div>

                    <div class="form-group">
                        <label>max_hold_steps (–º–∞–∫—Å. —É–¥–µ—Ä–∂–∞–Ω–∏–µ, —à–∞–≥–∏ 5m)</label>
                        <input id="xgbMaxHoldStepsInput" class="form-control" type="number" min="2" step="1" value="48">
                    </div>

                    <div class="form-group">
                        <label>fee, % (–∫–æ–º–∏—Å—Å–∏—è+—Å–ª–∏–ø–ø–µ–¥–∂ round-trip)</label>
                        <input id="xgbFeePctInput" class="form-control" type="number" min="0" step="0.01" value="0.06">
                    </div>

                    <div class="form-group">
                        <label>min_profit, % (–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–∏–±—ã–ª—å –¥–ª—è label=1)</label>
                        <input id="xgbMinProfitPctInput" class="form-control" type="number" min="0" step="0.01" value="0.00">
                    </div>

                    <div class="form-group">
                        <label>label_delta, % (–¥–æ–ø—É—Å–∫ –¥–æ best –¥–ª—è –≤—ã—Ö–æ–¥–∞)</label>
                        <input id="xgbLabelDeltaPctInput" class="form-control" type="number" min="0" step="0.01" value="0.05">
                    </div>

                    <div class="form-group">
                        <label>limit_candles (5m)</label>
                        <input id="xgbLimitCandlesInput" class="form-control" type="number" min="1000" step="1000" value="100000">
                    </div>

                    <div class="button-group">
                        <button class="btn btn-info" onclick="startXgbTrainingSelected()">üß† –û–±—É—á–∏—Ç—å XGB</button>
                        <button class="btn btn-primary" onclick="startXgbGridSelected()">üß™ Grid (auto ‚Üí —Ñ–∏–Ω–∞–ª)</button>
                    </div>

                    <div id="xgbStatus"></div>
                </div>

                <!-- ========== FULL GRID SEARCH ========== -->
                <div class="section" id="xgb-grid-full" style="margin-top:24px;">
                    <h2>üß™ XGB Full Grid Search (labeling + model hyper-params)</h2>
                    <p class="muted">–ü–µ—Ä–µ–±–æ—Ä –≤—Å–µ—Ö –∫–æ–º–±–∏–Ω–∞—Ü–∏–π. –ö–∞–∂–¥–æ–µ –æ–±—É—á–µ–Ω–∏–µ ~1-3 –º–∏–Ω. Queue: <code>celery</code> (–Ω–µ –º–µ—à–∞–µ—Ç DQN –Ω–∞ <code>train</code>).</p>

                    <div class="statistics-grid" style="grid-template-columns: repeat(3, 1fr); gap:10px;">
                        <div class="form-group">
                            <label>–°–∏–º–≤–æ–ª</label>
                            <select id="gfSymbol" class="form-control">
                                <option value="BTCUSDT">BTC</option>
                                <option value="TONUSDT">TON</option>
                                <option value="ETHUSDT">ETH</option>
                                <option value="SOLUSDT">SOL</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Task</label>
                            <select id="gfTask" class="form-control" onchange="gfUpdateLabels()">
                                <option value="entry_long" selected>entry_long</option>
                                <option value="exit_long">exit_long</option>
                                <option value="entry_short">entry_short</option>
                                <option value="exit_short">exit_short</option>
                                <option value="directional">directional</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Direction</label>
                            <select id="gfDirection" class="form-control">
                                <option value="long" selected>Long</option>
                                <option value="short">Short</option>
                            </select>
                        </div>
                    </div>

                    <div class="statistics-grid" style="grid-template-columns: repeat(3, 1fr); gap:10px;">
                        <div class="form-group">
                            <label>limit_candles (5m)</label>
                            <input id="gfLimitCandles" class="form-control" type="number" min="5000" step="5000" value="100000">
                        </div>
                        <div class="form-group">
                            <label>early_stopping_rounds</label>
                            <input id="gfEarlyStopping" class="form-control" type="number" min="0" step="10" value="50">
                        </div>
                        <div class="form-group">
                            <label>keep_top_n (—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª—É—á—à–∏—Ö)</label>
                            <input id="gfKeepTopN" class="form-control" type="number" min="1" step="1" value="20">
                        </div>
                    </div>

                    <h3 style="margin-top:14px;">üìê Labeling params (from / to / step)</h3>
                    <div id="gfLabelDirectional" style="display:none;">
                        <div class="statistics-grid" style="grid-template-columns: repeat(2, 1fr); gap:10px;">
                            <div class="form-group">
                                <label>horizon_steps</label>
                                <input id="gfHsFrom" class="form-control gf-range" type="number" step="1" value="12" placeholder="from">
                                <input id="gfHsTo" class="form-control gf-range" type="number" step="1" value="48" placeholder="to" style="margin-top:4px;">
                                <input id="gfHsStep" class="form-control gf-range" type="number" step="1" value="12" placeholder="step" style="margin-top:4px;">
                            </div>
                            <div class="form-group">
                                <label>threshold, % (0.2 = 0.002)</label>
                                <input id="gfThrFrom" class="form-control gf-range" type="number" step="0.01" value="0.10" placeholder="from">
                                <input id="gfThrTo" class="form-control gf-range" type="number" step="0.01" value="0.40" placeholder="to" style="margin-top:4px;">
                                <input id="gfThrStep" class="form-control gf-range" type="number" step="0.01" value="0.10" placeholder="step" style="margin-top:4px;">
                            </div>
                        </div>
                    </div>

                    <div id="gfLabelEntry">
                        <div class="statistics-grid" style="grid-template-columns: repeat(6, 1fr); gap:10px;">
                            <div class="form-group">
                                <label>horizon_steps</label>
                                <input id="gfHsFrom2" class="form-control gf-range" type="number" step="1" value="12" placeholder="from">
                                <input id="gfHsTo2" class="form-control gf-range" type="number" step="1" value="12" placeholder="to" style="margin-top:4px;">
                                <input id="gfHsStep2" class="form-control gf-range" type="number" step="1" value="12" placeholder="step" style="margin-top:4px;">
                            </div>
                            <div class="form-group">
                                <label>threshold, % (0.2 = 0.002)</label>
                                <input id="gfThrFrom2" class="form-control gf-range" type="number" step="0.01" value="0.20" placeholder="from">
                                <input id="gfThrTo2" class="form-control gf-range" type="number" step="0.01" value="0.20" placeholder="to" style="margin-top:4px;">
                                <input id="gfThrStep2" class="form-control gf-range" type="number" step="0.01" value="0.10" placeholder="step" style="margin-top:4px;">
                            </div>
                            <div class="form-group">
                                <label>max_hold_steps</label>
                                <input id="gfMhFrom" class="form-control gf-range" type="number" step="1" value="48" placeholder="from">
                                <input id="gfMhTo" class="form-control gf-range" type="number" step="1" value="96" placeholder="to" style="margin-top:4px;">
                                <input id="gfMhStep" class="form-control gf-range" type="number" step="1" value="48" placeholder="step" style="margin-top:4px;">
                            </div>
                            <div class="form-group">
                                <label>min_profit, % (0.25 = 0.0025)</label>
                                <input id="gfMpFrom" class="form-control gf-range" type="number" step="0.01" value="0.00" placeholder="from">
                                <input id="gfMpTo" class="form-control gf-range" type="number" step="0.01" value="0.50" placeholder="to" style="margin-top:4px;">
                                <input id="gfMpStep" class="form-control gf-range" type="number" step="0.01" value="0.25" placeholder="step" style="margin-top:4px;">
                            </div>
                            <div class="form-group">
                                <label>fee, % (0.06 = 6bps)</label>
                                <input id="gfFeeFrom" class="form-control gf-range" type="number" step="0.01" value="0.06" placeholder="from">
                                <input id="gfFeeTo" class="form-control gf-range" type="number" step="0.01" value="0.06" placeholder="to" style="margin-top:4px;">
                                <input id="gfFeeStep" class="form-control gf-range" type="number" step="0.01" value="0.01" placeholder="step" style="margin-top:4px;">
                            </div>
                            <div class="form-group">
                                <label>label_delta, %</label>
                                <input id="gfLdFrom" class="form-control gf-range" type="number" step="0.01" value="0.05" placeholder="from">
                                <input id="gfLdTo" class="form-control gf-range" type="number" step="0.01" value="0.05" placeholder="to" style="margin-top:4px;">
                                <input id="gfLdStep" class="form-control gf-range" type="number" step="0.01" value="0.01" placeholder="step" style="margin-top:4px;">
                            </div>
                        </div>
                    </div>

                    <h3 style="margin-top:14px;">‚öôÔ∏è Model hyper-params (from / to / step)</h3>
                    <div class="statistics-grid" style="grid-template-columns: repeat(3, 1fr); gap:10px;">
                        <div class="form-group">
                            <label>max_depth</label>
                            <input id="gfMdFrom" class="form-control gf-range" type="number" step="1" value="4" placeholder="from">
                            <input id="gfMdTo" class="form-control gf-range" type="number" step="1" value="8" placeholder="to" style="margin-top:4px;">
                            <input id="gfMdStep" class="form-control gf-range" type="number" step="1" value="2" placeholder="step" style="margin-top:4px;">
                        </div>
                        <div class="form-group">
                            <label>learning_rate</label>
                            <input id="gfLrFrom" class="form-control gf-range" type="number" step="0.001" value="0.01" placeholder="from">
                            <input id="gfLrTo" class="form-control gf-range" type="number" step="0.001" value="0.10" placeholder="to" style="margin-top:4px;">
                            <input id="gfLrStep" class="form-control gf-range" type="number" step="0.001" value="0.03" placeholder="step" style="margin-top:4px;">
                        </div>
                        <div class="form-group">
                            <label>n_estimators</label>
                            <input id="gfNeFrom" class="form-control gf-range" type="number" step="100" value="400" placeholder="from">
                            <input id="gfNeTo" class="form-control gf-range" type="number" step="100" value="800" placeholder="to" style="margin-top:4px;">
                            <input id="gfNeStep" class="form-control gf-range" type="number" step="100" value="200" placeholder="step" style="margin-top:4px;">
                        </div>
                    </div>
                    <div class="statistics-grid" style="grid-template-columns: repeat(3, 1fr); gap:10px;">
                        <div class="form-group">
                            <label>subsample</label>
                            <input id="gfSsFrom" class="form-control gf-range" type="number" step="0.05" value="0.7" placeholder="from">
                            <input id="gfSsTo" class="form-control gf-range" type="number" step="0.05" value="0.9" placeholder="to" style="margin-top:4px;">
                            <input id="gfSsStep" class="form-control gf-range" type="number" step="0.05" value="0.1" placeholder="step" style="margin-top:4px;">
                        </div>
                        <div class="form-group">
                            <label>colsample_bytree</label>
                            <input id="gfCbFrom" class="form-control gf-range" type="number" step="0.05" value="0.7" placeholder="from">
                            <input id="gfCbTo" class="form-control gf-range" type="number" step="0.05" value="0.9" placeholder="to" style="margin-top:4px;">
                            <input id="gfCbStep" class="form-control gf-range" type="number" step="0.05" value="0.1" placeholder="step" style="margin-top:4px;">
                        </div>
                        <div class="form-group">
                            <label>reg_lambda</label>
                            <input id="gfRlFrom" class="form-control gf-range" type="number" step="0.5" value="1.0" placeholder="from">
                            <input id="gfRlTo" class="form-control gf-range" type="number" step="0.5" value="5.0" placeholder="to" style="margin-top:4px;">
                            <input id="gfRlStep" class="form-control gf-range" type="number" step="0.5" value="2.0" placeholder="step" style="margin-top:4px;">
                        </div>
                    </div>
                    <div class="statistics-grid" style="grid-template-columns: repeat(3, 1fr); gap:10px;">
                        <div class="form-group">
                            <label>min_child_weight</label>
                            <input id="gfMcwFrom" class="form-control gf-range" type="number" step="1" value="1" placeholder="from">
                            <input id="gfMcwTo" class="form-control gf-range" type="number" step="1" value="5" placeholder="to" style="margin-top:4px;">
                            <input id="gfMcwStep" class="form-control gf-range" type="number" step="1" value="2" placeholder="step" style="margin-top:4px;">
                        </div>
                        <div class="form-group">
                            <label>gamma</label>
                            <input id="gfGmFrom" class="form-control gf-range" type="number" step="0.1" value="0.0" placeholder="from">
                            <input id="gfGmTo" class="form-control gf-range" type="number" step="0.1" value="0.5" placeholder="to" style="margin-top:4px;">
                            <input id="gfGmStep" class="form-control gf-range" type="number" step="0.1" value="0.5" placeholder="step" style="margin-top:4px;">
                        </div>
                        <div class="form-group">
                            <label>scale_pos_weight (-1=auto)</label>
                            <input id="gfSpwFrom" class="form-control gf-range" type="number" step="0.5" value="-1" placeholder="from">
                            <input id="gfSpwTo" class="form-control gf-range" type="number" step="0.5" value="1" placeholder="to" style="margin-top:4px;">
                            <input id="gfSpwStep" class="form-control gf-range" type="number" step="0.5" value="2" placeholder="step" style="margin-top:4px;">
                        </div>
                    </div>

                    <div style="margin-top:10px;">
                        <span style="font-weight:600; color:#2563eb;" id="gfTotalCombo">0</span> –∫–æ–º–±–∏–Ω–∞—Ü–∏–π
                    </div>
                    <div class="button-group" style="margin-top:10px;">
                        <button class="btn btn-primary" onclick="startXgbGridFull()">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å Full Grid</button>
                    </div>
                    <div id="gfStatus"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function startXgbTrainingSelected(){
            const statusDiv = document.getElementById('xgbStatus');
            const symbol = (document.getElementById('xgbSymbolSelect')?.value || 'BTCUSDT').trim();
            const direction = (document.getElementById('xgbDirectionSelect')?.value || 'long').trim().toLowerCase();
            const task = (document.getElementById('xgbTaskSelect')?.value || 'directional').trim().toLowerCase();
            const horizonSteps = document.getElementById('xgbHorizonStepsInput')?.value || 12;
            const thresholdPct = document.getElementById('xgbThresholdPctInput')?.value || 0.20;
            const maxHold = document.getElementById('xgbMaxHoldStepsInput')?.value || 48;
            const feePct = document.getElementById('xgbFeePctInput')?.value || 0.06;
            const minProfitPct = document.getElementById('xgbMinProfitPctInput')?.value || 0.00;
            const labelDeltaPct = document.getElementById('xgbLabelDeltaPctInput')?.value || 0.05;
            const limitCandles = document.getElementById('xgbLimitCandlesInput')?.value || 100000;
            statusDiv.innerHTML = '<div class="status info">‚è≥ –ó–∞–ø—É—Å–∫ XGB: ' + symbol + ' dir=' + direction + ' task=' + task + '...</div>';
            try {
                const threshold = (parseFloat(thresholdPct) || 0.0) / 100.0;
                const fee_bps = (parseFloat(feePct) || 0.0) * 100.0; // % -> bps
                const min_profit = (parseFloat(minProfitPct) || 0.0) / 100.0;
                const label_delta = (parseFloat(labelDeltaPct) || 0.0) / 100.0;
                const payload = { symbol, direction, task, horizon_steps: horizonSteps, threshold: threshold, max_hold_steps: maxHold, fee_bps: fee_bps, min_profit: min_profit, label_delta: label_delta, limit_candles: limitCandles };
                const resp = await fetch('/training/train_xgb_symbol', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await resp.json().catch(() => null);
                if (data && data.success) {
                    const tname = data.task ? String(data.task) : task;
                    statusDiv.innerHTML = '<div class="status success">‚úÖ XGB –∑–∞–ø—É—â–µ–Ω: task=' + tname + ' (celery: ' + data.task_id + ')</div>';
                } else if (data && data.error) {
                    statusDiv.innerHTML = '<div class="status error">‚ùå ' + String(data.error) + '</div>';
                } else {
                    statusDiv.innerHTML = '<div class="status error">‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞</div>';
                }
            } catch (e) {
                statusDiv.innerHTML = '<div class="status error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ XGB: ' + (e && e.message ? e.message : e) + '</div>';
            }
        }

        /* ===== Full Grid helpers ===== */
        function gfRange(fromId, toId, stepId) {
            const f = parseFloat(document.getElementById(fromId).value);
            const t = parseFloat(document.getElementById(toId).value);
            const s = parseFloat(document.getElementById(stepId).value);
            if (isNaN(f)) return [];
            if (isNaN(t) || t <= f || isNaN(s) || s <= 0) return [f];
            const arr = [];
            for (let v = f; v <= t + s * 0.001; v += s) arr.push(Math.round(v * 1e8) / 1e8);
            return arr;
        }

        function gfUpdateLabels() {
            const task = document.getElementById('gfTask').value;
            document.getElementById('gfLabelDirectional').style.display = task === 'directional' ? '' : 'none';
            document.getElementById('gfLabelEntry').style.display = task !== 'directional' ? '' : 'none';
            gfCalcCombo();
        }

        function gfCalcCombo() {
            const task = document.getElementById('gfTask').value;
            let labelN = 1;
            if (task === 'directional') {
                labelN = gfRange('gfHsFrom','gfHsTo','gfHsStep').length * gfRange('gfThrFrom','gfThrTo','gfThrStep').length;
            } else {
                labelN = gfRange('gfHsFrom2','gfHsTo2','gfHsStep2').length
                       * gfRange('gfThrFrom2','gfThrTo2','gfThrStep2').length
                       * gfRange('gfMhFrom','gfMhTo','gfMhStep').length * gfRange('gfMpFrom','gfMpTo','gfMpStep').length
                       * gfRange('gfFeeFrom','gfFeeTo','gfFeeStep').length * gfRange('gfLdFrom','gfLdTo','gfLdStep').length;
            }
            const modelN = gfRange('gfMdFrom','gfMdTo','gfMdStep').length
                         * gfRange('gfLrFrom','gfLrTo','gfLrStep').length
                         * gfRange('gfNeFrom','gfNeTo','gfNeStep').length
                         * gfRange('gfSsFrom','gfSsTo','gfSsStep').length
                         * gfRange('gfCbFrom','gfCbTo','gfCbStep').length
                         * gfRange('gfRlFrom','gfRlTo','gfRlStep').length
                         * gfRange('gfMcwFrom','gfMcwTo','gfMcwStep').length
                         * gfRange('gfGmFrom','gfGmTo','gfGmStep').length
                         * gfRange('gfSpwFrom','gfSpwTo','gfSpwStep').length;
            document.getElementById('gfTotalCombo').textContent = labelN * modelN;
        }

        // ===== localStorage cache for grid fields =====
        const GF_CACHE_KEY = 'xgb_grid_cache';
        const GF_IDS = ['gfSymbol','gfTask','gfDirection','gfLimitCandles','gfEarlyStopping','gfKeepTopN',
            'gfHsFrom','gfHsTo','gfHsStep','gfThrFrom','gfThrTo','gfThrStep',
            'gfHsFrom2','gfHsTo2','gfHsStep2',
            'gfThrFrom2','gfThrTo2','gfThrStep2',
            'gfMhFrom','gfMhTo','gfMhStep','gfMpFrom','gfMpTo','gfMpStep',
            'gfFeeFrom','gfFeeTo','gfFeeStep','gfLdFrom','gfLdTo','gfLdStep',
            'gfMdFrom','gfMdTo','gfMdStep','gfLrFrom','gfLrTo','gfLrStep',
            'gfNeFrom','gfNeTo','gfNeStep','gfSsFrom','gfSsTo','gfSsStep',
            'gfCbFrom','gfCbTo','gfCbStep','gfRlFrom','gfRlTo','gfRlStep',
            'gfMcwFrom','gfMcwTo','gfMcwStep','gfGmFrom','gfGmTo','gfGmStep',
            'gfSpwFrom','gfSpwTo','gfSpwStep'];
        function gfSaveCache(){
            const d={};
            GF_IDS.forEach(id=>{ const el=document.getElementById(id); if(el) d[id]=el.value; });
            try{ localStorage.setItem(GF_CACHE_KEY, JSON.stringify(d)); }catch(_){}
        }
        function gfLoadCache(){
            try{
                const d=JSON.parse(localStorage.getItem(GF_CACHE_KEY));
                if(!d) return;
                GF_IDS.forEach(id=>{ const el=document.getElementById(id); if(el && d[id]!==undefined) el.value=d[id]; });
            }catch(_){}
        }
        gfLoadCache();

        // recalc on any input change + save cache
        document.querySelectorAll('.gf-range').forEach(el => el.addEventListener('input', ()=>{ gfCalcCombo(); gfSaveCache(); }));
        ['gfSymbol','gfTask','gfDirection','gfLimitCandles','gfEarlyStopping','gfKeepTopN'].forEach(id=>{
            const el=document.getElementById(id);
            if(el) el.addEventListener('change', gfSaveCache);
        });
        setTimeout(gfUpdateLabels, 100);

        async function startXgbGridFull() {
            const statusDiv = document.getElementById('gfStatus');
            const task = document.getElementById('gfTask').value;
            const payload = {
                symbol: document.getElementById('gfSymbol').value,
                direction: document.getElementById('gfDirection').value,
                task: task,
                limit_candles: parseInt(document.getElementById('gfLimitCandles').value) || 100000,
                early_stopping_rounds: parseInt(document.getElementById('gfEarlyStopping').value) || 50,
                keep_top_n: parseInt(document.getElementById('gfKeepTopN').value) || 20,
            };
            // labeling
            if (task === 'directional') {
                payload.horizon_steps_list = gfRange('gfHsFrom','gfHsTo','gfHsStep');
                payload.threshold_list = gfRange('gfThrFrom','gfThrTo','gfThrStep').map(v => v / 100);
            } else {
                payload.horizon_steps_list = gfRange('gfHsFrom2','gfHsTo2','gfHsStep2');
                payload.threshold_list = gfRange('gfThrFrom2','gfThrTo2','gfThrStep2').map(v => v / 100);
                payload.max_hold_steps_list = gfRange('gfMhFrom','gfMhTo','gfMhStep').map(v => Math.round(v));
                payload.min_profit_list = gfRange('gfMpFrom','gfMpTo','gfMpStep').map(v => v / 100);
                payload.fee_bps_list = gfRange('gfFeeFrom','gfFeeTo','gfFeeStep').map(v => v * 100);
                payload.label_delta_list = gfRange('gfLdFrom','gfLdTo','gfLdStep').map(v => v / 100);
            }
            // model
            payload.max_depth_list = gfRange('gfMdFrom','gfMdTo','gfMdStep').map(v => Math.round(v));
            payload.learning_rate_list = gfRange('gfLrFrom','gfLrTo','gfLrStep');
            payload.n_estimators_list = gfRange('gfNeFrom','gfNeTo','gfNeStep').map(v => Math.round(v));
            payload.subsample_list = gfRange('gfSsFrom','gfSsTo','gfSsStep');
            payload.colsample_bytree_list = gfRange('gfCbFrom','gfCbTo','gfCbStep');
            payload.reg_lambda_list = gfRange('gfRlFrom','gfRlTo','gfRlStep');
            payload.min_child_weight_list = gfRange('gfMcwFrom','gfMcwTo','gfMcwStep');
            payload.gamma_list = gfRange('gfGmFrom','gfGmTo','gfGmStep');
            payload.scale_pos_weight_list = gfRange('gfSpwFrom','gfSpwTo','gfSpwStep');

            const total = parseInt(document.getElementById('gfTotalCombo').textContent) || 0;
            statusDiv.innerHTML = '<div class="status info">‚è≥ –ó–∞–ø—É—Å–∫ Full Grid: ' + total + ' –∫–æ–º–±–∏–Ω–∞—Ü–∏–π‚Ä¶</div>';
            try {
                const resp = await fetch('/training/train_xgb_grid_full', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await resp.json().catch(() => null);
                if (data && data.success) {
                    statusDiv.innerHTML = '<div class="status success">‚úÖ Grid –∑–∞–ø—É—â–µ–Ω (celery: ' + data.task_id + '). ' + total + ' –∫–æ–º–±–∏–Ω–∞—Ü–∏–π. DQN –Ω–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ—Ç—Å—è.</div>';
                } else {
                    statusDiv.innerHTML = '<div class="status error">‚ùå ' + (data && data.error ? data.error : '–û—à–∏–±–∫–∞') + '</div>';
                }
            } catch (e) {
                statusDiv.innerHTML = '<div class="status error">‚ùå ' + (e.message || e) + '</div>';
            }
        }

        async function startXgbGridSelected(){
            const statusDiv = document.getElementById('xgbStatus');
            const symbol = (document.getElementById('xgbSymbolSelect')?.value || 'BTCUSDT').trim();
            const task = (document.getElementById('xgbTaskSelect')?.value || 'directional').trim().toLowerCase();
            const direction = (document.getElementById('xgbDirectionSelect')?.value || 'long').trim().toLowerCase();
            const limitFinal = document.getElementById('xgbLimitCandlesInput')?.value || 100000;
            const limitQuick = Math.min(50000, parseInt(limitFinal, 10) || 100000);
            const maxHold = document.getElementById('xgbMaxHoldStepsInput')?.value || 48;
            const feePct = document.getElementById('xgbFeePctInput')?.value || 0.06;
            const minProfitPct = document.getElementById('xgbMinProfitPctInput')?.value || 0.00;
            const labelDeltaPct = document.getElementById('xgbLabelDeltaPctInput')?.value || 0.05;
            statusDiv.innerHTML = '<div class="status info">‚è≥ –ó–∞–ø—É—Å–∫ XGB grid: ' + symbol + ' task=' + task + '...</div>';
            try {
                const fee_bps = (parseFloat(feePct) || 0.0) * 100.0; // % -> bps
                const min_profit = (parseFloat(minProfitPct) || 0.0) / 100.0;
                const label_delta = (parseFloat(labelDeltaPct) || 0.0) / 100.0;
                const payload = { symbol, task, direction, limit_candles_final: limitFinal, limit_candles_quick: limitQuick, max_hold_steps: maxHold, fee_bps, min_profit, label_delta };
                const resp = await fetch('/training/train_xgb_grid_task', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await resp.json().catch(() => null);
                if (data && data.success) {
                    const tname = data.task ? String(data.task) : task;
                    statusDiv.innerHTML = '<div class="status success">‚úÖ XGB grid –∑–∞–ø—É—â–µ–Ω: task=' + tname + ' (celery: ' + data.task_id + ')</div>';
                } else if (data && data.error) {
                    statusDiv.innerHTML = '<div class="status error">‚ùå ' + String(data.error) + '</div>';
                } else {
                    statusDiv.innerHTML = '<div class="status error">‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞</div>';
                }
            } catch (e) {
                statusDiv.innerHTML = '<div class="status error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ grid: ' + (e && e.message ? e.message : e) + '</div>';
            }
        }
    </script>
    <script src="/static/js/sidebar.js"></script>
</body>
</html>

