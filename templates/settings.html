<!DOCTYPE html>
<html lang="ru">
<head>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="/static/css/sidebar.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</title>
    <style>
        .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
        .grid3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; }
        .hint { color:#6c757d; font-size: 12px; }
        .table { width:100%; border-collapse: collapse; }
        .table th, .table td { border:1px solid #e1e1e1; padding:8px; text-align:left; vertical-align: top; }
        .table th { background:#f7f7f7; }
        @media (max-width: 1000px){ .grid3 { grid-template-columns: 1fr; } .grid2 { grid-template-columns: 1fr; } }
        .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
        tr.dirty { outline: 2px solid #f0ad4e; outline-offset: -2px; background: #fffaf2; }
        .small { font-size: 12px; }
        .w180 { min-width: 180px; }
        .w320 { min-width: 320px; }
    </style>
</head>
<body>
    {% include 'include/_sidebar.html' %}
    <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>

    <div class="container">
        <div class="main-content">
            <div class="header">
                <h1>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
                <p class="hint">–•—Ä–∞–Ω–µ–Ω–∏–µ –≤ Postgres (—Ç–∞–±–ª–∏—Ü–∞ <code>app_settings</code>).</p>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5>‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É</h5>
                </div>
                <div class="grid3">
                    <div class="form-group">
                        <label>Scope</label>
                        <input id="scope" class="form-control" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: analyzer" />
                    </div>
                    <div class="form-group">
                        <label>Group (optional)</label>
                        <input id="group" class="form-control" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: stage1" />
                    </div>
                    <div class="form-group">
                        <label>KEY</label>
                        <input id="key" class="form-control mono" placeholder="ANALYZER_MAX_POOLS_PER_SYMBOL" />
                    </div>
                </div>
                <div class="grid3" style="margin-top:10px;">
                    <div class="form-group">
                        <label>Type</label>
                        <select id="type" class="form-control">
                            <option value="string">string</option>
                            <option value="number">number</option>
                            <option value="bool">bool</option>
                            <option value="json">json</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Label (optional)</label>
                        <input id="label" class="form-control" placeholder="Max Pools Per Symbol" />
                    </div>
                    <div class="form-group">
                        <label>Secret</label>
                        <select id="secret" class="form-control">
                            <option value="0">no</option>
                            <option value="1">yes</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" style="margin-top:10px;">
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ (optional)</label>
                    <textarea id="description" class="form-control" rows="3" placeholder="–¢–µ–∫—Å—Ç –æ–ø–∏—Å–∞–Ω–∏—è..."></textarea>
                </div>
                <div class="form-group">
                    <label>Value</label>
                    <textarea id="value" class="form-control mono" rows="2" placeholder="50"></textarea>
                </div>
                <div style="margin-top:10px; display:flex; gap:10px;">
                    <button class="btn btn-primary" onclick="saveSetting()">–î–æ–±–∞–≤–∏—Ç—å</button>
                    <div id="saveStatus" class="status info" style="display:none;"></div>
                </div>
            </div>

            <div class="card" style="margin-top:16px;">
                <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;">
                    <h5>üìã –¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h5>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <button class="btn btn-primary" id="btnSaveDirty" onclick="saveDirty()" disabled>üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        <button class="btn btn-secondary" onclick="loadSettings()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                    </div>
                </div>
                <div id="listStatus" class="status info">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                <div style="overflow:auto;">
                    <table class="table" id="tbl" style="display:none;">
                        <thead>
                            <tr>
                                <th>Scope</th>
                                <th>Group</th>
                                <th>Key</th>
                                <th>Type</th>
                                <th>Label</th>
                                <th>Description</th>
                                <th>Value</th>
                                <th>Updated</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/sidebar.js"></script>
    <script>
        const dirtyIds = new Set();

        function showStatus(elementId, type, message) {
            const el = document.getElementById(elementId);
            if(!el) return;
            el.textContent = message;
            el.className = `status ${type}`;
            el.style.display = 'block';
            setTimeout(() => { try{ el.style.display = 'none'; }catch(_){ } }, 6000);
        }

        async function loadSettings(){
            const status = document.getElementById('listStatus');
            const tbl = document.getElementById('tbl');
            const body = document.getElementById('tbody');
            if(status){ status.style.display='block'; status.className='status info'; status.textContent='–ó–∞–≥—Ä—É–∑–∫–∞...'; }
            if(tbl) tbl.style.display='none';
            try{
                const r = await fetch('/api/settings/list');
                const j = await r.json();
                if(!j.success) throw new Error(j.error || 'load failed');
                const items = Array.isArray(j.items) ? j.items : [];
                if(items.length === 0){
                    if(status){ status.className='status info'; status.textContent='–ù–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫'; }
                    return;
                }
                dirtyIds.clear();
                const btnSave = document.getElementById('btnSaveDirty');
                if(btnSave) btnSave.disabled = true;

                body.innerHTML = items.map(it=>{
                    const desc = it.description ? String(it.description) : '';
                    const val = (it.value!=null) ? String(it.value) : '';
                    const upd = it.updated_at ? String(it.updated_at).replace('T',' ').split('.')[0] : '‚Äî';
                    const isSecret = !!it.secret;
                    const type = it.type || 'string';
                    const group = it.group || '';
                    const label = it.label || '';
                    const rowId = it.id;
                    return `<tr data-id="${rowId}">
                        <td>${it.scope||''}</td>
                        <td>${group}</td>
                        <td class="mono">${it.key||''}</td>
                        <td class="w180">
                            <select class="form-control js-type">
                                <option value="string" ${type==='string'?'selected':''}>string</option>
                                <option value="number" ${type==='number'?'selected':''}>number</option>
                                <option value="bool" ${type==='bool'?'selected':''}>bool</option>
                                <option value="json" ${type==='json'?'selected':''}>json</option>
                            </select>
                            <div class="small hint">secret: <input type="checkbox" class="js-secret" ${isSecret?'checked':''}></div>
                        </td>
                        <td class="w180">
                            <input class="form-control js-label" value="${label.replaceAll('"','&quot;')}" />
                        </td>
                        <td class="w320">
                            <textarea class="form-control js-desc" rows="2">${desc}</textarea>
                        </td>
                        <td class="mono w320">
                            ${isSecret
                                ? `<input class="form-control js-value" type="password" placeholder="(secret) –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —á—Ç–æ–±—ã –∑–∞–º–µ–Ω–∏—Ç—å" value="" />`
                                : `<textarea class="form-control js-value mono" rows="2">${val}</textarea>`
                            }
                            ${isSecret ? `<div class="hint small">–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å–∫—Ä—ã—Ç–æ.</div>` : ``}
                        </td>
                        <td>${upd}</td>
                        <td style="white-space:nowrap;">
                            <button class="btn btn-primary" onclick="saveRow(${rowId})">üíæ</button>
                            <button class="btn btn-danger" onclick="delSetting(${rowId})">‚úñ</button>
                        </td>
                    </tr>`;
                }).join('');
                // bind change listeners to mark dirty
                [...body.querySelectorAll('tr[data-id]')].forEach(tr => {
                    tr.querySelectorAll('input,textarea,select').forEach(el => {
                        el.addEventListener('input', () => markDirty(tr));
                        el.addEventListener('change', () => markDirty(tr));
                    });
                });
                if(status) status.style.display='none';
                if(tbl) tbl.style.display='table';
            }catch(e){
                if(status){ status.className='status error'; status.textContent='–û—à–∏–±–∫–∞: '+e.message; }
            }
        }

        function markDirty(tr){
            try{
                const id = Number(tr.getAttribute('data-id'));
                if(!Number.isFinite(id)) return;
                dirtyIds.add(id);
                tr.classList.add('dirty');
                const btnSave = document.getElementById('btnSaveDirty');
                if(btnSave) btnSave.disabled = (dirtyIds.size === 0);
            }catch(_){}
        }

        function rowToPayload(tr){
            const tds = tr.querySelectorAll('td');
            const scope = (tds[0]?.textContent || '').trim();
            const group = (tds[1]?.textContent || '').trim();
            const key = (tds[2]?.textContent || '').trim();
            const type = (tr.querySelector('.js-type')?.value || 'string').trim();
            const label = (tr.querySelector('.js-label')?.value || '').trim();
            const description = (tr.querySelector('.js-desc')?.value || '').trim();
            const secret = !!tr.querySelector('.js-secret')?.checked;
            const valueEl = tr.querySelector('.js-value');
            const valueRaw = valueEl ? String(valueEl.value || '') : '';
            const payload = { scope, group, key, type, label, description, secret };
            // –î–ª—è secret: –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º value, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ–≥–æ –Ω–µ –º–µ–Ω—è–ª
            if(!secret || valueRaw.trim() !== ''){
                payload.value = valueRaw;
            }
            return payload;
        }

        async function saveRow(id){
            const tr = document.querySelector(`tr[data-id="${id}"]`);
            if(!tr) return;
            await savePayloads([rowToPayload(tr)]);
        }

        async function saveDirty(){
            const rows = [...document.querySelectorAll('tr.dirty[data-id]')];
            if(rows.length === 0) return;
            const payloads = rows.map(rowToPayload);
            await savePayloads(payloads);
        }

        async function savePayloads(payloads){
            const btnSave = document.getElementById('btnSaveDirty');
            try{
                if(btnSave) btnSave.disabled = true;
                showStatus('saveStatus','info', `–°–æ—Ö—Ä–∞–Ω—è—é: ${payloads.length}...`);
                for(let i=0;i<payloads.length;i++){
                    const p = payloads[i];
                    const r = await fetch('/api/settings/upsert', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(p)});
                    const j = await r.json();
                    if(!j.success) throw new Error(j.error || 'save failed');
                }
                showStatus('saveStatus','success','–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
                await loadSettings();
            }catch(e){
                showStatus('saveStatus','error', e.message);
            }finally{
                if(btnSave) btnSave.disabled = (dirtyIds.size === 0);
            }
        }

        async function saveSetting(){
            try{
                const payload = {
                    scope: (document.getElementById('scope')?.value || '').trim(),
                    group: (document.getElementById('group')?.value || '').trim(),
                    key: (document.getElementById('key')?.value || '').trim(),
                    type: (document.getElementById('type')?.value || 'string'),
                    label: (document.getElementById('label')?.value || '').trim(),
                    description: (document.getElementById('description')?.value || '').trim(),
                    secret: (document.getElementById('secret')?.value || '0') === '1',
                    value: (document.getElementById('value')?.value || '')
                };
                const r = await fetch('/api/settings/upsert', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
                const j = await r.json();
                if(!j.success) throw new Error(j.error || 'save failed');
                showStatus('saveStatus','success','–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
                await loadSettings();
            }catch(e){
                showStatus('saveStatus','error', e.message);
            }
        }

        async function delSetting(id){
            try{
                if(!confirm('–£–¥–∞–ª–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É id='+id+'?')) return;
                const r = await fetch('/api/settings/delete', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id})});
                const j = await r.json();
                if(!j.success) throw new Error(j.error || 'delete failed');
                await loadSettings();
            }catch(e){
                showStatus('saveStatus','error', e.message);
            }
        }

        window.addEventListener('load', () => { loadSettings(); });
    </script>
</body>
</html>


