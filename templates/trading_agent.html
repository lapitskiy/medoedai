<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedoedAI - Торговый агент</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        .content {
            padding: 30px;
        }
        .section {
            margin-bottom: 40px;
            padding: 25px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: #fafafa;
        }
        .section h2 {
            color: #333;
            margin-top: 0;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
        }
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(86, 171, 47, 0.4);
        }
        .btn-danger {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            color: white;
        }
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 65, 108, 0.4);
        }
        .btn-info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }
        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(240, 147, 251, 0.4);
        }
        .status {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            font-weight: 600;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        .back-btn {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
            margin-bottom: 20px;
        }
        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.4);
        }
        .trading-status {
            background: #e8f5e8;
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .trading-status h3 {
            color: #28a745;
            margin-top: 0;
        }
        .trading-status p {
            margin: 10px 0;
            font-weight: 600;
        }
        .trading-history {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        .trading-history h3 {
            color: #495057;
            margin-top: 0;
        }
        .trade-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .trade-item .trade-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .trade-item.success {
            border-left: 4px solid #28a745;
        }
        
        .trade-item.error {
            border-left: 4px solid #dc3545;
        }
        
        .trade-action.buy {
            color: #28a745;
            font-weight: bold;
        }
        
        .trade-action.sell {
            color: #dc3545;
            font-weight: bold;
        }
        
        .trade-action.hold {
            color: #6c757d;
            font-weight: bold;
        }
        
        .statistics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .stat-label {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        
        .stat-value.success {
            color: #28a745;
        }
        
        .stat-value.error {
            color: #dc3545;
        }
        
        .stat-value.buy {
            color: #28a745;
        }
        
        .stat-value.sell {
            color: #dc3545;
        }
        
        .stat-value.hold {
            color: #6c757d;
        }
        
        .trade-action {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
        }
        .trade-action.buy {
            background: #d4edda;
            color: #155724;
        }
        .trade-action.sell {
            background: #f8d7da;
            color: #721c24;
        }
        .trade-action.success {
            background: #d4edda;
            color: #155724;
        }
        .trade-action.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .trade-confidence {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .trade-confidence.success {
            background: #d4edda;
            color: #155724;
        }
        
        .trade-confidence.info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .trade-confidence.warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .trade-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            font-size: 14px;
        }
        .trade-detail {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 5px;
            text-align: center;
        }
        .trade-detail .label {
            font-weight: 600;
            color: #495057;
            font-size: 12px;
            text-transform: uppercase;
        }
        .trade-detail .value {
            color: #333;
            margin-top: 5px;
        }
        .model-info {
            background: #e8f5e8;
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        .model-info h4 {
            color: #28a745;
            margin-top: 0;
            margin-bottom: 10px;
        }
        .model-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        .model-detail-item {
            background: white;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #c3e6cb;
        }
        .model-detail-label {
            font-weight: 600;
            color: #495057;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        .model-detail-value {
            color: #333;
            font-size: 14px;
        }
        
        /* Стили для стратегии оставшейся позиции */
        .strategy-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }
        
        .strategy-details {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .strategy-details p {
            margin: 8px 0;
            font-size: 14px;
        }
        
        .strategy-rules {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .strategy-rules h5 {
            margin: 0 0 15px 0;
            color: #0056b3;
        }
        
        .strategy-rules ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .strategy-rules li {
            margin: 8px 0;
            font-size: 14px;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>💰 Торговый агент</h1>
            <p>Управление торговлей на реальном рынке через обученную модель DQN</p>
        </div>

        <div class="content">
            <!-- Кнопка возврата -->
            <a href="/" class="btn back-btn">← Вернуться на главную</a>

            <!-- Секция управления торговлей -->
            <div class="section">
                <h2>🎯 Управление торговлей</h2>
                <p>Запуск и остановка торгового бота</p>
                
                <div class="form-group">
                    <label>Модель для торговли:</label>
                    <select id="modelSelect" class="form-control" onchange="showModelInfo()">
                        <option value="">Выберите модель...</option>
                    </select>
                </div>
                
                <div id="modelInfo" class="model-info" style="display: none;">
                    <h4>📊 Информация о модели</h4>
                    <div id="modelInfoContent"></div>
                </div>
                
                <div class="form-group">
                    <label>Торговая пара (Деривативы):</label>
                    <div>
                        <label><input type="checkbox" value="BTCUSDT" class="trading-symbol" checked> BTCUSDT (Фьючерсы)</label><br>
                        <label><input type="checkbox" value="ETHUSDT" class="trading-symbol"> ETHUSDT (Фьючерсы)</label><br>
                        <label><input type="checkbox" value="SOLUSDT" class="trading-symbol"> SOLUSDT (Фьючерсы)</label><br>
                        <label><input type="checkbox" value="TONUSDT" class="trading-symbol"> TONUSDT (Фьючерсы)</label><br>
                        <label><input type="checkbox" value="ADAUSDT" class="trading-symbol"> ADAUSDT (Фьючерсы)</label><br>
                        <label><input type="checkbox" value="BNBUSDT" class="trading-symbol"> BNBUSDT (Фьючерсы)</label>
                    </div>
                    <small style="color: #666; font-style: italic;">
                        ⚠️ Внимание: Торговля ведется на деривативах Bybit (фьючерсы), а не на споте
                    </small>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-success" onclick="startTrading()">
                        🚀 Запустить торговлю
                    </button>
                    <button class="btn btn-danger" onclick="stopTrading()">
                        🛑 Остановить торговлю
                    </button>
                </div>
                
                <div id="tradingResult" class="status" style="display: none;"></div>
            </div>

            <!-- Секция статуса торговли -->
            <div class="section">
                <h2>📊 Статус торговли</h2>
                <p>Текущее состояние торгового бота</p>
                
                <div class="button-group">
                    <button class="btn btn-info" onclick="getTradingStatus()">
                        🔍 Получить статус
                    </button>
                    <button class="btn btn-info" onclick="getBalance()">
                        💰 Баланс на бирже
                    </button>
                </div>
                
                <div id="tradingStatus" class="trading-status" style="display: none;">
                    <h3>📊 Статус торговли</h3>
                    <div id="statusContent"></div>
                </div>
                
                <div id="balanceStatus" class="trading-status" style="display: none;">
                    <h3>💰 Баланс на бирже</h3>
                    <div id="balanceContent"></div>
                </div>
            </div>

            <!-- Секция истории торговли -->
            <div class="section">
                <h2>📈 История торговли</h2>
                <p>Детальная информация о всех сделках</p>
                
                <div class="button-group">
                    <button class="btn btn-primary" onclick="getTradingHistory()">
                        📊 История сделок
                    </button>
                </div>
                
                <div id="tradingHistory" class="trading-history" style="display: none;">
                    <h3>📈 История сделок</h3>
                    <div id="historyContent"></div>
                </div>
            </div>

            <!-- Секция мониторинга -->
            <div class="section">
                <h2>🔍 Мониторинг</h2>
                <p>Автоматическое обновление статуса и результатов торговли каждые 30 секунд</p>
                
                <div class="button-group">
                    <button class="btn btn-info" onclick="startMonitoring()">
                        🔄 Запустить мониторинг
                    </button>
                    <button class="btn btn-warning" onclick="stopMonitoring()">
                        ⏸️ Остановить мониторинг
                    </button>
                    <button class="btn btn-primary" onclick="getModelPredictions()">
                        🧠 Предсказания ИИ
                    </button>
                    <button class="btn btn-primary" onclick="getPredictionStatistics()">
                        📊 Статистика предсказаний
                    </button>
                </div>
                
                <div id="monitoringStatus" class="status info" style="display: none;">
                    Мониторинг активен - статус обновляется каждые 30 секунд
                </div>
                
                <!-- Результаты торговли из Celery -->
                <div id="tradingResults" class="trading-history" style="display: none;">
                    <h3>📊 Последние результаты торговли (Celery)</h3>
                    <div id="tradingResultsContent"></div>
                </div>
                
                <!-- История сделок из базы данных -->
                <div id="tradeHistory" class="trading-history" style="display: none;">
                    <h3>📈 История сделок (База данных)</h3>
                    <div id="tradeHistoryContent"></div>
                </div>
                
                <!-- Статистика сделок -->
                <div id="tradeStatistics" class="trading-history" style="display: none;">
                    <h3>📊 Статистика сделок</h3>
                    <div id="tradeStatisticsContent"></div>
                </div>
                
                <!-- Стратегия для оставшейся позиции -->
                <div id="remainingPositionStrategy" class="trading-history" style="display: none;">
                    <h3>🎯 Стратегия для оставшейся позиции</h3>
                    <div id="remainingStrategyContent"></div>
                </div>
                
                <!-- Предсказания модели -->
                <div id="modelPredictions" class="trading-history" style="display: none;">
                    <h3>🧠 Предсказания модели ИИ</h3>
                    <div id="predictionsContent"></div>
                </div>
                
                <!-- Статистика предсказаний -->
                <div id="predictionStatistics" class="trading-history" style="display: none;">
                    <h3>📊 Статистика предсказаний</h3>
                    <div id="predictionStatsContent"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let monitoringInterval = null;

        let modelsData = [];

        // Загрузка списка моделей при загрузке страницы
        async function loadModels() {
            try {
                const response = await fetch('/get_models_list');
                const result = await response.json();
                
                if (result.success) {
                    modelsData = result.models;
                    const modelSelect = document.getElementById('modelSelect');
                    modelSelect.innerHTML = '<option value="">Выберите модель...</option>';
                    
                    result.models.forEach(model => {
                        const option = document.createElement('option');
                        // Полный путь для контейнера trading_agent
                        option.value = `/workspace/good_models/${model.files.model}`;
                        option.textContent = `${model.id} (${model.date})`;
                        option.dataset.modelId = model.id;
                        modelSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Ошибка загрузки моделей:', error);
            }
        }

        // Показать информацию о выбранной модели
        function showModelInfo() {
            const modelSelect = document.getElementById('modelSelect');
            const modelInfo = document.getElementById('modelInfo');
            const modelInfoContent = document.getElementById('modelInfoContent');
            
            if (modelSelect.value) {
                const selectedOption = modelSelect.selectedOptions[0];
                const modelId = selectedOption.dataset.modelId;
                const model = modelsData.find(m => m.id === modelId);
                
                if (model) {
                    const stats = model.stats || {};
                    modelInfoContent.innerHTML = `
                        <div class="model-details">
                            <div class="model-detail-item">
                                <div class="model-detail-label">ID модели</div>
                                <div class="model-detail-value">${model.id}</div>
                            </div>
                            <div class="model-detail-item">
                                <div class="model-detail-label">Дата создания</div>
                                <div class="model-detail-value">${model.date}</div>
                            </div>
                            <div class="model-detail-item">
                                <div class="model-detail-label">Размер модели</div>
                                <div class="model-detail-value">${model.files.model_size}</div>
                            </div>
                            ${stats.winrate ? `
                            <div class="model-detail-item">
                                <div class="model-detail-label">Winrate</div>
                                <div class="model-detail-value">${(stats.winrate * 100).toFixed(1)}%</div>
                            </div>
                            <div class="model-detail-item">
                                <div class="model-detail-label">P/L Ratio</div>
                                <div class="model-detail-value">${stats.pl_ratio?.toFixed(2) || 'N/A'}</div>
                            </div>
                            <div class="model-detail-item">
                                <div class="model-detail-label">Сделок</div>
                                <div class="model-detail-value">${stats.trades_count || 'N/A'}</div>
                            </div>
                            ` : '<div class="model-detail-item"><div class="model-detail-value">Статистика недоступна</div></div>'}
                        </div>
                    `;
                    modelInfo.style.display = 'block';
                } else {
                    modelInfo.style.display = 'none';
                }
            } else {
                modelInfo.style.display = 'none';
            }
        }

        // Запуск торговли
        async function startTrading() {
            const selectedSymbols = Array.from(document.querySelectorAll('.trading-symbol:checked')).map(checkbox => checkbox.value);
            const selectedModel = document.getElementById('modelSelect').value;
            
            if (!selectedModel) {
                showStatus('tradingResult', 'error', 'Пожалуйста, выберите модель для торговли');
                return;
            }
            
            if (selectedSymbols.length === 0) {
                showStatus('tradingResult', 'error', 'Пожалуйста, выберите хотя бы одну торговую пару');
                return;
            }
            
            try {
                const response = await fetch('/api/trading/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        symbols: selectedSymbols,
                        model_path: selectedModel
                    })
                });
                
                const result = await response.json();
                showStatus('tradingResult', result.success ? 'success' : 'error', 
                    result.success ? result.message : result.error);
                
                if (result.success) {
                    // Автоматически получаем статус после запуска
                    setTimeout(getTradingStatus, 1000);
                }
            } catch (error) {
                showStatus('tradingResult', 'error', 'Ошибка при запуске торговли: ' + error.message);
            }
        }

        // Остановка торговли
        async function stopTrading() {
            try {
                const response = await fetch('/api/trading/stop', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                showStatus('tradingResult', result.success ? 'success' : 'error', 
                    result.success ? result.message : result.error);
                
                if (result.success) {
                    // Автоматически получаем статус после остановки
                    setTimeout(getTradingStatus, 1000);
                }
            } catch (error) {
                showStatus('tradingResult', 'error', 'Ошибка при остановке торговли: ' + error.message);
            }
        }

        // Получение статуса торговли
        async function getTradingStatus() {
            try {
                const response = await fetch('/api/trading/status');
                const result = await response.json();
                
                if (result.success) {
                    const statusDiv = document.getElementById('tradingStatus');
                    const contentDiv = document.getElementById('statusContent');
                    
                    let statusHTML = `
                        <p><strong>Статус:</strong> ${result.trading_status || (result.is_trading ? '🟢 Активна ' : '🔴 Остановлена')}</p>
                        <p><strong>Пара:</strong> ${result.symbol_display || result.symbol || 'Не указана'}</p>
                        <p><strong>Количество:</strong> ${result.amount_display || result.amount || 'Не указано'}</p>
                        <p><strong>Количество USDT:</strong> ${result.amount_usdt ? '$' + result.amount_usdt.toFixed(2) : 'Не указано'}</p>
                        <p><strong>Позиция:</strong> ${result.position ? 'Открыта' : 'Нет'}</p>
                        <p><strong>Сделок:</strong> ${result.trades_count}</p>
                        <p><strong>Текущая цена:</strong> ${result.current_price ? '$' + result.current_price.toFixed(2) : 'Не указана'}</p>
                        ${result.last_model_prediction ? `<p><strong>Последнее предсказание:</strong> ${result.last_model_prediction}</p>` : ''}
                    `;
                    
                    // Показываем стратегию для оставшейся позиции, если есть
                    if (result.position && result.position.partial_sell_strategy) {
                        showRemainingPositionStrategy(result.position.partial_sell_strategy);
                    } else {
                        // Скрываем секцию стратегии, если нет
                        document.getElementById('remainingPositionStrategy').style.display = 'none';
                    }
                    
                    contentDiv.innerHTML = statusHTML;
                    statusDiv.style.display = 'block';
                } else {
                    showStatus('tradingResult', 'error', result.error);
                }
            } catch (error) {
                showStatus('tradingResult', 'error', 'Ошибка при получении статуса: ' + error.message);
            }
        }

        // Получение баланса
        async function getBalance() {
            try {
                const response = await fetch('/api/trading/balance');
                const result = await response.json();
                
                if (result.success) {
                    const balanceDiv = document.getElementById('balanceStatus');
                    const contentDiv = document.getElementById('balanceContent');
                    
                    contentDiv.innerHTML = `
                        <p><strong>USDT:</strong> ${result.balance.USDT.toFixed(2)}</p>
                        <p><strong>BTC:</strong> ${result.balance.BTC.toFixed(8)}</p>
                    `;
                    
                    balanceDiv.style.display = 'block';
                } else {
                    showStatus('tradingResult', 'error', result.error);
                }
            } catch (error) {
                showStatus('tradingResult', 'error', 'Ошибка при получении баланса: ' + error.message);
            }
        }

        // Получение истории торговли
        async function getTradingHistory() {
            try {
                const response = await fetch('/api/trading/history');
                const result = await response.json();
                
                if (result.success) {
                    const historyDiv = document.getElementById('tradingHistory');
                    const contentDiv = document.getElementById('historyContent');
                    
                    if (result.trades && result.trades.length > 0) {
                        let historyHTML = `<p><strong>Всего сделок:</strong> ${result.total_trades}</p>`;
                        
                        result.trades.forEach((trade, index) => {
                            const tradeTime = new Date(trade.time).toLocaleString('ru-RU');
                            const actionClass = trade.action === 'buy' ? 'buy' : 'sell';
                            
                            historyHTML += `
                                <div class="trade-item">
                                    <div class="trade-header">
                                        <span class="trade-action ${actionClass}">${trade.action.toUpperCase()}</span>
                                        <span>${tradeTime}</span>
                                    </div>
                                    <div class="trade-details">
                                        <div class="trade-detail">
                                            <div class="label">Цена</div>
                                            <div class="value">$${trade.price}</div>
                                        </div>
                                        <div class="trade-detail">
                                            <div class="label">Количество</div>
                                            <div class="value">${trade.amount}</div>
                                        </div>
                                        ${trade.pnl ? `
                                        <div class="trade-detail">
                                            <div class="label">P&L</div>
                                            <div class="value" style="color: ${trade.pnl >= 0 ? 'green' : 'red'}">
                                                ${trade.pnl >= 0 ? '+' : ''}$${trade.pnl.toFixed(4)}
                                            </div>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        });
                        
                        contentDiv.innerHTML = historyHTML;
                    } else {
                        contentDiv.innerHTML = '<p>📈 История сделок пока пуста</p><p><em>Сделки появятся после выполнения торговых операций</em></p>';
                    }
                    
                    historyDiv.style.display = 'block';
                } else {
                    showStatus('tradingResult', 'error', result.error);
                }
            } catch (error) {
                showStatus('tradingResult', 'error', 'Ошибка при получении истории: ' + error.message);
            }
        }

        // Получение последних результатов торговли из Celery
        async function getTradingResults() {
            try {
                const response = await fetch('/api/trading/latest_results');
                const result = await response.json();
                
                if (result.success) {
                    const resultsDiv = document.getElementById('tradingResults');
                    const contentDiv = document.getElementById('tradingResultsContent');
                    
                    if (result.latest_results && result.latest_results.length > 0) {
                        let resultsHTML = `<p><strong>Всего результатов:</strong> ${result.total_results}</p>`;
                        
                        result.latest_results.forEach((tradeResult, index) => {
                            const resultTime = new Date(tradeResult.timestamp).toLocaleString('ru-RU');
                            const successClass = tradeResult.exit_code === 0 ? 'success' : 'error';
                            
                            resultsHTML += `
                                <div class="trade-item">
                                    <div class="trade-header">
                                        <span class="trade-action ${successClass}">${tradeResult.exit_code === 0 ? '✅ УСПЕХ' : '❌ ОШИБКА'}</span>
                                        <span>${resultTime}</span>
                                    </div>
                                    <div class="trade-details">
                                        <div class="trade-detail">
                                            <div class="label">Символы</div>
                                            <div class="value">${tradeResult.symbols ? tradeResult.symbols.join(', ') : 'N/A'}</div>
                                        </div>
                                        <div class="trade-detail">
                                            <div class="label">Код выхода</div>
                                            <div class="value">${tradeResult.exit_code}</div>
                                        </div>
                                        ${tradeResult.parsed_result ? `
                                        <div class="trade-detail">
                                            <div class="label">Действие</div>
                                            <div class="value">${tradeResult.parsed_result.action || 'N/A'}</div>
                                        </div>
                                        <div class="trade-detail">
                                            <div class="label">Цена</div>
                                            <div class="value">$${tradeResult.parsed_result.price || 'N/A'}</div>
                                        </div>
                                        ${tradeResult.parsed_result.trade_executed ? `
                                        <div class="trade-detail">
                                            <div class="label">Выполнено</div>
                                            <div class="value">${tradeResult.parsed_result.trade_executed}</div>
                                        </div>
                                        ` : ''}
                                        ${tradeResult.parsed_result.position_pnl ? `
                                        <div class="trade-detail">
                                            <div class="label">P&L позиции</div>
                                            <div class="value" style="color: ${tradeResult.parsed_result.position_pnl >= 0 ? 'green' : 'red'}">
                                                ${tradeResult.parsed_result.position_pnl >= 0 ? '+' : ''}${tradeResult.parsed_result.position_pnl.toFixed(2)}%
                                            </div>
                                        </div>
                                        ` : ''}
                                        ` : ''}
                                    </div>
                                    ${tradeResult.parse_error ? `
                                    <div style="margin-top: 10px; padding: 10px; background: #f8d7da; border-radius: 5px; font-size: 12px;">
                                        <strong>Ошибка парсинга:</strong> ${tradeResult.parse_error}
                                    </div>
                                    ` : ''}
                                </div>
                            `;
                        });
                        
                        contentDiv.innerHTML = resultsHTML;
                    } else {
                        contentDiv.innerHTML = '<p>📊 Результаты торговли пока отсутствуют</p><p><em>Данные появятся после выполнения торговых операций через Celery</em></p>';
                    }
                    
                    resultsDiv.style.display = 'block';
                } else {
                    console.error('Ошибка получения результатов:', result.error);
                    // Показываем блок с ошибкой
                    const resultsDiv = document.getElementById('tradingResults');
                    const contentDiv = document.getElementById('tradingResultsContent');
                    contentDiv.innerHTML = '<p>❌ Ошибка получения результатов</p><p><em>' + (result.error || 'Неизвестная ошибка') + '</em></p>';
                    resultsDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Ошибка при получении результатов торговли:', error);
                // Показываем блок с ошибкой
                const resultsDiv = document.getElementById('tradingResults');
                const contentDiv = document.getElementById('tradingResultsContent');
                contentDiv.innerHTML = '<p>❌ Ошибка сети</p><p><em>' + error.message + '</em></p>';
                resultsDiv.style.display = 'block';
            }
        }

        // Получение истории сделок из базы данных
        async function getTradeHistory() {
            try {
                const response = await fetch('/api/trades/recent?limit=20');
                const result = await response.json();
                
                const historyDiv = document.getElementById('tradeHistory');
                const contentDiv = document.getElementById('tradeHistoryContent');
                
                if (result.success) {
                    if (result.trades && result.trades.length > 0) {
                        let historyHTML = '';
                        result.trades.forEach(trade => {
                            const statusClass = trade.is_successful ? 'success' : 'error';
                            const actionClass = trade.action === 'buy' ? 'buy' : trade.action === 'sell' ? 'sell' : 'hold';
                            
                            historyHTML += `
                                <div class="trade-item ${statusClass}">
                                    <div class="trade-header">
                                        <div class="trade-number">${trade.trade_number}</div>
                                        <div class="trade-symbol">${trade.symbol}</div>
                                        <div class="trade-action ${actionClass}">${trade.action.toUpperCase()}</div>
                                        <div class="trade-status">${trade.status}</div>
                                    </div>
                                    <div class="trade-details">
                                        <div class="trade-detail">
                                            <div class="label">Количество</div>
                                            <div class="value">${trade.quantity}</div>
                                        </div>
                                        <div class="trade-detail">
                                            <div class="label">Цена</div>
                                            <div class="value">$${trade.price}</div>
                                        </div>
                                        <div class="trade-detail">
                                            <div class="label">Стоимость</div>
                                            <div class="value">$${trade.total_value}</div>
                                        </div>
                                        ${trade.model_prediction ? `
                                        <div class="trade-detail">
                                            <div class="label">Предсказание модели</div>
                                            <div class="value">${trade.model_prediction}</div>
                                        </div>
                                        ` : ''}
                                        ${trade.position_pnl ? `
                                        <div class="trade-detail">
                                            <div class="label">P&L</div>
                                            <div class="value" style="color: ${trade.position_pnl >= 0 ? 'green' : 'red'}">
                                                ${trade.position_pnl >= 0 ? '+' : ''}${trade.position_pnl.toFixed(2)}
                                            </div>
                                        </div>
                                        ` : ''}
                                        <div class="trade-detail">
                                            <div class="label">Время создания</div>
                                            <div class="value">${new Date(trade.created_at).toLocaleString()}</div>
                                        </div>
                                        ${trade.error_message ? `
                                        <div class="trade-detail">
                                            <div class="label">Ошибка</div>
                                            <div class="value error">${trade.error_message}</div>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        });
                        
                        contentDiv.innerHTML = historyHTML;
                    } else {
                        contentDiv.innerHTML = '<p>История сделок пока отсутствует</p>';
                    }
                    
                    historyDiv.style.display = 'block';
                } else {
                    console.error('Ошибка получения истории сделок:', result.error);
                    // Показываем блок с ошибкой
                    contentDiv.innerHTML = '<p>❌ Ошибка получения истории сделок</p><p><em>' + (result.error || 'Неизвестная ошибка') + '</em></p>';
                    historyDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Ошибка при получении истории сделок:', error);
                // Показываем блок с ошибкой
                const historyDiv = document.getElementById('tradeHistory');
                const contentDiv = document.getElementById('tradeHistoryContent');
                contentDiv.innerHTML = '<p>❌ Ошибка сети</p><p><em>' + error.message + '</em></p>';
                historyDiv.style.display = 'block';
            }
        }

        // Получение статистики сделок
        async function getTradeStatistics() {
            try {
                const response = await fetch('/api/trades/statistics');
                const result = await response.json();
                
                const statsDiv = document.getElementById('tradeStatistics');
                const contentDiv = document.getElementById('tradeStatisticsContent');
                
                if (result.success) {
                    const stats = result.statistics;
                    const successRate = stats.success_rate || 0;
                    const successRateClass = successRate >= 50 ? 'success' : 'error';
                    
                    const statsHTML = `
                        <div class="statistics-grid">
                            <div class="stat-item">
                                <div class="stat-label">Всего сделок</div>
                                <div class="stat-value">${stats.total_trades}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Успешных сделок</div>
                                <div class="stat-value success">${stats.successful_trades}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Неудачных сделок</div>
                                <div class="stat-value error">${stats.failed_trades}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Процент успеха</div>
                                <div class="stat-value ${successRateClass}">${successRate}%</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Общий объем</div>
                                <div class="stat-value">${stats.total_volume.toFixed(6)}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Общая стоимость</div>
                                <div class="stat-value">$${stats.total_value.toFixed(2)}</div>
                            </div>
                        </div>
                    `;
                    
                    contentDiv.innerHTML = statsHTML;
                    statsDiv.style.display = 'block';
                } else {
                    console.error('Ошибка получения статистики:', result.error);
                    contentDiv.innerHTML = '<p>📊 Статистика недоступна</p><p><em>Ошибка: ' + (result.error || 'Неизвестная ошибка') + '</em></p>';
                    statsDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Ошибка при получении статистики:', error);
                // Показываем блок с ошибкой
                const statsDiv = document.getElementById('tradeStatistics');
                const contentDiv = document.getElementById('tradeStatisticsContent');
                contentDiv.innerHTML = '<p>❌ Ошибка сети</p><p><em>' + error.message + '</em></p>';
                statsDiv.style.display = 'block';
            }
        }

        // Запуск мониторинга
        function startMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
            }
            
            // Сразу получаем данные
            getTradingStatus();
            getBalance();
            getTradingResults();
            getTradeHistory();
            getTradeStatistics();
            getModelPredictions();
            getPredictionStatistics();
            
            monitoringInterval = setInterval(() => {
                getTradingStatus();
                getBalance();
                getTradingResults();
                getTradeHistory();
                getTradeStatistics();
                getModelPredictions();
                getPredictionStatistics();
            }, 300000); 
            
            document.getElementById('monitoringStatus').style.display = 'block';
            showStatus('tradingResult', 'info', 'Мониторинг запущен - данные обновляются каждые 30 секунд');
        }

        // Остановка мониторинга
        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
            }
            
            document.getElementById('monitoringStatus').style.display = 'none';
            showStatus('tradingResult', 'info', 'Мониторинг остановлен');
        }

        // Показать статус
        function showStatus(elementId, type, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
            element.style.display = 'block';
            
            // Автоскрытие через 5 секунд
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }

        // Получение предсказаний модели ИИ
        async function getModelPredictions() {
            try {
                const response = await fetch('/api/predictions/recent?limit=50');
                const result = await response.json();
                
                const predictionsDiv = document.getElementById('modelPredictions');
                const contentDiv = document.getElementById('predictionsContent');
                
                if (result.success) {
                    if (result.predictions && result.predictions.length > 0) {
                        let predictionsHTML = `<p><strong>Всего предсказаний:</strong> ${result.total_predictions}</p>`;
                        
                        result.predictions.forEach(prediction => {
                            const predictionTime = new Date(prediction.timestamp).toLocaleString('ru-RU');
                            const actionClass = prediction.action === 'buy' ? 'buy' : prediction.action === 'sell' ? 'sell' : 'hold';
                            const confidenceClass = prediction.confidence > 0.5 ? 'success' : prediction.confidence > 0.2 ? 'info' : 'warning';
                            
                            predictionsHTML += `
                                <div class="trade-item">
                                    <div class="trade-header">
                                        <span class="trade-action ${actionClass}">${prediction.action.toUpperCase()}</span>
                                        <span class="trade-confidence ${confidenceClass}">Уверенность: ${(prediction.confidence * 100).toFixed(1)}%</span>
                                        <span>${predictionTime}</span>
                                    </div>
                                    <div class="trade-details">
                                        <div class="trade-detail">
                                            <div class="label">Символ</div>
                                            <div class="value">${prediction.symbol}</div>
                                        </div>
                                        <div class="trade-detail">
                                            <div class="label">Цена</div>
                                            <div class="value">$${prediction.current_price?.toFixed(6) || 'N/A'}</div>
                                        </div>
                                        <div class="trade-detail">
                                            <div class="label">Позиция</div>
                                            <div class="value">${prediction.position_status}</div>
                                        </div>
                                        <div class="trade-detail">
                                            <div class="label">Q-Values</div>
                                            <div class="value">[${prediction.q_values.map(v => v.toFixed(3)).join(', ')}]</div>
                                        </div>
                                    </div>
                                    ${prediction.market_conditions && Object.keys(prediction.market_conditions).length > 0 ? `
                                    <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 12px;">
                                        <strong>Условия рынка:</strong><br>
                                        ${Object.entries(prediction.market_conditions).map(([key, value]) => 
                                            `${key}: ${value}`
                                        ).join(', ')}
                                    </div>
                                    ` : ''}
                                </div>
                            `;
                        });
                        
                        contentDiv.innerHTML = predictionsHTML;
                    } else {
                        contentDiv.innerHTML = '<p>🧠 Предсказания модели пока отсутствуют</p><p><em>Данные появятся после выполнения торговых операций</em></p>';
                    }
                    
                    predictionsDiv.style.display = 'block';
                } else {
                    console.error('Ошибка получения предсказаний:', result.error);
                    contentDiv.innerHTML = '<p>❌ Ошибка получения предсказаний</p><p><em>' + (result.error || 'Неизвестная ошибка') + '</em></p>';
                    predictionsDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Ошибка при получении предсказаний:', error);
                const predictionsDiv = document.getElementById('modelPredictions');
                const contentDiv = document.getElementById('predictionsContent');
                contentDiv.innerHTML = '<p>❌ Ошибка сети</p><p><em>' + error.message + '</em></p>';
                predictionsDiv.style.display = 'block';
            }
        }

        // Получение статистики предсказаний
        async function getPredictionStatistics() {
            try {
                const response = await fetch('/api/predictions/statistics');
                const result = await response.json();
                
                const statsDiv = document.getElementById('predictionStatistics');
                const contentDiv = document.getElementById('predictionStatsContent');
                
                if (result.success) {
                    const stats = result.statistics;
                    
                    const statsHTML = `
                        <div class="statistics-grid">
                            <div class="stat-item">
                                <div class="stat-label">Всего предсказаний</div>
                                <div class="stat-value">${stats.total_predictions}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">BUY сигналы</div>
                                <div class="stat-value buy">${stats.buy_predictions}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">SELL сигналы</div>
                                <div class="stat-value sell">${stats.sell_predictions}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">HOLD сигналы</div>
                                <div class="stat-value hold">${stats.hold_predictions}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Средняя уверенность BUY</div>
                                <div class="stat-value">${stats.avg_confidence_buy}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Средняя уверенность SELL</div>
                                <div class="stat-value">${stats.avg_confidence_sell}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Средняя уверенность HOLD</div>
                                <div class="stat-value">${stats.avg_confidence_hold}</div>
                            </div>
                        </div>
                    `;
                    
                    contentDiv.innerHTML = statsHTML;
                    statsDiv.style.display = 'block';
                } else {
                    console.error('Ошибка получения статистики предсказаний:', result.error);
                    contentDiv.innerHTML = '<p>📊 Статистика предсказаний недоступна</p><p><em>Ошибка: ' + (result.error || 'Неизвестная ошибка') + '</em></p>';
                    statsDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Ошибка при получении статистики предсказаний:', error);
                const statsDiv = document.getElementById('predictionStatistics');
                const contentDiv = document.getElementById('predictionStatsContent');
                contentDiv.innerHTML = '<p>❌ Ошибка сети</p><p><em>' + error.message + '</em></p>';
                statsDiv.style.display = 'block';
            }
        }

        // Функция для отображения стратегии оставшейся позиции
        function showRemainingPositionStrategy(strategy) {
            const contentDiv = document.getElementById('remainingStrategyContent');
            const strategyDiv = document.getElementById('remainingPositionStrategy');
            
            if (strategy && strategy.type === 'remaining_position') {
                const createdTime = new Date(strategy.created_at).toLocaleString('ru-RU');
                const timeThreshold = new Date(strategy.time_threshold).toLocaleString('ru-RU');
                
                let strategyHTML = `
                    <div class="strategy-info">
                        <h4>🎯 Стратегия для оставшейся позиции</h4>
                        <div class="strategy-details">
                            <p><strong>Тип:</strong> ${strategy.type}</p>
                            <p><strong>Создана:</strong> ${createdTime}</p>
                            <p><strong>Время истечения:</strong> ${timeThreshold}</p>
                            <p><strong>Порог убытка:</strong> <span class="negative">${strategy.sell_threshold}%</span></p>
                            <p><strong>Порог прибыли:</strong> <span class="positive">${strategy.profit_threshold}%</span></p>
                            <p><strong>Максимальное время ожидания:</strong> 24 часа</p>
                        </div>
                        <div class="strategy-rules">
                            <h5>📋 Правила автоматической продажи:</h5>
                            <ul>
                                <li>🚨 <strong>Убыток > ${strategy.sell_threshold}%</strong> → Продаем весь остаток</li>
                                <li>💰 <strong>Прибыль > ${strategy.profit_threshold}%</strong> → Продаем весь остаток</li>
                                <li>⏰ <strong>Время > 24 часа</strong> → Продаем весь остаток</li>
                            </ul>
                        </div>
                    </div>
                `;
                
                contentDiv.innerHTML = strategyHTML;
                strategyDiv.style.display = 'block';
            } else {
                strategyDiv.style.display = 'none';
            }
        }
        
        // Автоматически получаем статус при загрузке страницы
        window.addEventListener('load', () => {
            loadModels();
            getTradingStatus();
            getBalance();
        });
    </script>
</body>
</html>
