<!DOCTYPE html>
<html lang="ru">
<head>
    <link rel="stylesheet" href="/static/css/styles.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedoedAI - –¢–æ—Ä–≥–æ–≤—ã–π –∞–≥–µ–Ω—Ç</title>
    <style>
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ –¢–æ—Ä–≥–æ–≤—ã–π –∞–≥–µ–Ω—Ç</h1>
            <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤–ª–µ–π –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º —Ä—ã–Ω–∫–µ —á–µ—Ä–µ–∑ –æ–±—É—á–µ–Ω–Ω—É—é –º–æ–¥–µ–ª—å DQN</p>
        </div>

        <div class="content">
            <!-- –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ -->
            <a href="/" class="btn back-btn">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>

            <!-- –°–µ–∫—Ü–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–æ—Ä–≥–æ–≤–ª–µ–π -->
            <div class="section">
                <h2>üéØ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤–ª–µ–π</h2>
                <p>–ó–∞–ø—É—Å–∫ –∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–æ—Ä–≥–æ–≤–æ–≥–æ –±–æ—Ç–∞</p>
                
                <div class="form-group">
                    <label>–ê–Ω—Å–∞–º–±–ª—å –∏ –≤–µ—Ä—Å–∏–∏:</label>
                    <div style="display:grid; grid-template-columns: 1fr; gap: 12px; align-items:start;">
                        <div>
                            <label style="font-weight:600;">–°–∏–º–≤–æ–ª</label>
                            <select id="ensembleSymbolSelect" class="form-control" onchange="onEnsembleSymbolChange()">
                                <option value="BTCUSDT" selected>BTCUSDT</option>
                                <option value="ETHUSDT">ETHUSDT</option>
                                <option value="SOLUSDT">SOLUSDT</option>
                                <option value="TONUSDT">TONUSDT</option>
                                <option value="ADAUSDT">ADAUSDT</option>
                                <option value="BNBUSDT">BNBUSDT</option>
                                <option value="XMRUSDT">XMRUSDT</option>
                                <option value="XRPUSDT">XRPUSDT</option>
                            </select>
                            <label style="font-weight:600; margin-top:10px;">–ê–Ω—Å–∞–º–±–ª—å</label>
                            <select id="ensembleSelect" class="form-control" onchange="renderEnsembleVersions()">
                                <option value="ensemble-a" selected>ensemble-a</option>
                    </select>
                        </div>
                    </div>
                </div>
                <div class="form-group" style="margin-top:10px;">
                    <div id="ensembleVersions" style="max-height:320px; overflow:auto; border:1px solid #e0e0e0; border-radius:6px; padding:0;">
                        <div class="versions-table">
                            <div class="vt-row vt-head">
                                <div class="c-check">–í—ã–±.</div>
                                <div>–í–µ—Ä—Å–∏—è</div>
                                <div>–ú–æ–¥–µ–ª—å</div>
                                <div>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
                            </div>
                            <div class="vt-row">
                                <div class="c-check"><input type="checkbox" disabled></div>
                                <div>‚Äî</div>
                                <div><em>–í—ã–±–µ—Ä–∏—Ç–µ —Å–∏–º–≤–æ–ª –∏ –∞–Ω—Å–∞–º–±–ª—å</em></div>
                                <div>‚Äî</div>
                            </div>
                        </div>
                    </div>
                    <small style="color:#666; display:block; margin-top:6px;">–û—Ç–º–µ—Ç—å—Ç–µ –≥–∞–ª–æ—á–∫–∞–º–∏ –≤–µ—Ä—Å–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ —É—á–∞—Å—Ç–≤—É—é—Ç –≤ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏. –ù–∏–∂–µ ‚Äî –∫—Ä–∞—Ç–∫–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞.</small>
                    <div id="ensembleVersionsStats" style="margin-top:8px;"></div>
                </div>
                
                <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞ -->
                <div class="form-group" style="margin-top:20px; padding:15px; background:#f8f9fa; border-radius:8px; border:1px solid #e0e0e0;">
                    <label style="font-weight:600; margin-bottom:10px; display:block;">üéØ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞</label>
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
                        <div>
                            <label style="font-weight:500; margin-bottom:5px; display:block;">–ë–æ–∫–æ–≤–∏–∫ (flat/range)</label>
                            <div style="display:flex; align-items:center; gap:8px;">
                                <input type="range" id="flatConsensus" min="50" max="100" value="80" style="flex:1;">
                                <span id="flatConsensusValue" style="font-weight:600; color:#667eea; min-width:40px;">80%</span>
                            </div>
                            <small style="color:#666;">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ: 80-90% –∏–∑ 100% –º–æ–¥–µ–ª–µ–π</small>
                        </div>
                        
                        <div>
                            <label style="font-weight:500; margin-bottom:5px; display:block;">–¢—Ä–µ–Ω–¥ (—Å–∏–ª—å–Ω—ã–π –∞–ø/–¥–∞—É–Ω)</label>
                            <div style="display:flex; align-items:center; gap:8px;">
                                <input type="range" id="trendConsensus" min="50" max="100" value="65" style="flex:1;">
                                <span id="trendConsensusValue" style="font-weight:600; color:#667eea; min-width:40px;">65%</span>
                            </div>
                            <small style="color:#666;">–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: ‚â•60-70% –∏–∑ 100</small>
                        </div>
                    </div>
                    
                    <div style="background:white; padding:10px; border-radius:6px; border:1px solid #dee2e6;">
                        <div style="font-size:14px; color:#495057;">
                            <strong>–¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:</strong><br>
                            ‚Ä¢ –ë–æ–∫–æ–≤–∏–∫: <span id="flatConsensusDisplay">80%</span> –º–æ–¥–µ–ª–µ–π –¥–æ–ª–∂–Ω—ã —Å–æ–≥–ª–∞—Å–∏—Ç—å—Å—è<br>
                            ‚Ä¢ –¢—Ä–µ–Ω–¥: <span id="trendConsensusDisplay">65%</span> –º–æ–¥–µ–ª–µ–π –¥–æ–ª–∂–Ω—ã —Å–æ–≥–ª–∞—Å–∏—Ç—å—Å—è
                        </div>
                    </div>
                </div>
                
                <div id="modelInfo" class="model-info" style="display: none;">
                    <h4>üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–æ–¥–µ–ª–∏</h4>
                    <div id="modelInfoContent"></div>
                </div>
                
            <!-- –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å–∏–º–≤–æ–ª–∞ (–æ—Ç–¥–µ–ª—å–Ω—ã–π –±–ª–æ–∫) -->
            <div class="section">
                <h2>üîÄ –ü–µ—Ä–µ–π—Ç–∏ –∫ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å–∏–º–≤–æ–ª–∞</h2>
                <p>–ë—ã—Å—Ç—Ä—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –∞–≥–µ–Ω—Ç–∞ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Å–∏–º–≤–æ–ª—É</p>
                <div class="form-group">
                    <label style="font-weight:600;">–°–∏–º–≤–æ–ª</label>
                    <select id="agentSymbolSelect" class="form-control">
                        <option value="BTCUSDT" selected>BTCUSDT</option>
                        <option value="ETHUSDT">ETHUSDT</option>
                        <option value="SOLUSDT">SOLUSDT</option>
                        <option value="TONUSDT">TONUSDT</option>
                        <option value="ADAUSDT">ADAUSDT</option>
                        <option value="BNBUSDT">BNBUSDT</option>
                        <option value="XRPUSDT">XRPUSDT</option>
                    </select>
                </div>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="goToAgent()">–û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–∏–º–≤–æ–ª–∞</button>
                </div>
            </div>

            
                <div class="button-group">
                    <button class="btn btn-success" onclick="startTrading()">
                        üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ—Ä–≥–æ–≤–ª—é
                    </button>
                    <button class="btn btn-danger" onclick="stopTrading()">
                        üõë –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–æ—Ä–≥–æ–≤–ª—é
                    </button>
                </div>
                
                <div id="tradingResult" class="status" style="display: none;"></div>
            </div>

            

            
        </div>
    </div>

    <script>
        let monitoringInterval = null;

        let modelsData = [];
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã/–≤—Ä–µ–º–µ–Ω–∏ –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ
        function formatMoscowDateTime(value) {
            let date;
            if (typeof value === 'string') {
                // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –±–µ–∑ —è–≤–Ω–æ–π –≤—Ä–µ–º–µ–Ω–Ω–æ–π –∑–æ–Ω—ã ‚Äî —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ —ç—Ç–æ UTC –∏ –¥–æ–±–∞–≤–ª—è–µ–º 'Z'
                const hasTimezone = /[zZ]|[\+\-]\d{2}:?\d{2}$/.test(value);
                const isoBasic = /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d+)?$/;
                const src = (!hasTimezone && isoBasic.test(value)) ? (value + 'Z') : value;
                date = new Date(src);
            } else if (typeof value === 'number') {
                // –û–∂–∏–¥–∞–µ–º –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã
                date = new Date(value);
            } else {
                date = value;
            }
            if (!date || isNaN(date.getTime())) return 'N/A';
            return date.toLocaleString('ru-RU', {
                timeZone: 'Europe/Moscow',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        }

        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–∏–º–≤–æ–ª–∞ –ø–æ ID –º–æ–¥–µ–ª–∏ (—ç–≤—Ä–∏—Å—Ç–∏–∫–∞)
        function guessSymbolFromModelId(modelId) {
            try {
                if (!modelId || typeof modelId !== 'string') return '';
                const base = modelId.split('_')[0] || '';
                if (!base) return '';
                const low = base.toLowerCase();
                if (['multi', 'multicrypto', '–º—É–ª—å—Ç–∏–≤–∞–ª—é—Ç–∞'].includes(low)) return 'MULTI';
                // –ï—Å–ª–∏ —É–∂–µ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ USDT
                if (/usdt$/i.test(base)) return base.toUpperCase();
                // –ë–∞–∑–æ–≤—ã–µ —Ç–∏–∫–µ—Ä—ã
                const known = ['btc','eth','sol','ton','ada','bnb'];
                if (known.includes(low)) return low.toUpperCase() + 'USDT';
                // –û–±—â–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞: –∫–æ—Ä–æ—Ç–∫–∏–π –±—É–∫–≤–µ–Ω–Ω—ã–π –ø—Ä–µ—Ñ–∏–∫—Å ‚Üí –¥–æ–±–∞–≤–∏—Ç—å USDT
                if (/^[a-z]{2,6}$/i.test(base)) return base.toUpperCase() + 'USDT';
                return base.toUpperCase();
            } catch (_) {
                return '';
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω—Å–∞–º–±–ª–µ–π –∏ –≤–µ—Ä—Å–∏–π
        async function onEnsembleSymbolChange() {
            const symSel = document.getElementById('ensembleSymbolSelect');
            const symbol = symSel ? (symSel.value || 'BTCUSDT') : 'BTCUSDT';
            try {
                const resp = await fetch('/list_ensembles?symbol=' + encodeURIComponent(symbol));
                const data = await resp.json();
                const ensSel = document.getElementById('ensembleSelect');
                const box = document.getElementById('ensembleVersions');
                if (!ensSel || !box) return;
                if (!data.success) {
                    ensSel.innerHTML = '<option value="">–ù–µ—Ç –∞–Ω—Å–∞–º–±–ª–µ–π</option>';
                    box.innerHTML = '<em>–ê–Ω—Å–∞–º–±–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</em>';
                    return;
                }
                const names = Object.keys(data.ensembles || {});
                ensSel.innerHTML = names.length ? names.map(n => `<option value="${n}">${n}</option>`).join('') : '<option value="">–ù–µ—Ç –∞–Ω—Å–∞–º–±–ª–µ–π</option>';
                ensSel.value = names[0] || 'ensemble-a';
                ensSel.dataset.payload = JSON.stringify(data.ensembles || {});
                renderEnsembleVersions();
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ —Å–ø–∏—Å–∫–∞ –∞–Ω—Å–∞–º–±–ª–µ–π', e);
            }
        }

        function renderEnsembleVersions() {
            const ensSel = document.getElementById('ensembleSelect');
            const box = document.getElementById('ensembleVersions');
            if (!ensSel || !box) return;
            try {
                const ensembles = JSON.parse(ensSel.dataset.payload || '{}');
                const name = ensSel.value;
                const ens = ensembles[name] || { versions: [] };
                if (!ens.versions || ens.versions.length === 0) {
                    box.innerHTML = '<em>–í–µ—Ä—Å–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</em>';
                    return;
                }
                // –†–∏—Å—É–µ–º —á–µ–∫–±–æ–∫—Å—ã –≤–µ—Ä—Å–∏–π
                const header = `
                    <div class=\"vt-row vt-head\">
                        <div class=\"c-check\">–í—ã–±.</div>
                        <div>–í–µ—Ä—Å–∏—è</div>
                        <div>–ú–æ–¥–µ–ª—å</div>
                        <div>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
                    </div>`;
                const rows = ens.versions.map(v => {
                    const modelFile = v.files && v.files.model ? v.files.model : '';
                    const path = `${v.path}/${modelFile}`;
                    const id = `ver_${name}_${v.version}`;
                    const stats = v.stats || {};
                    const winrate = (typeof stats.winrate === 'number') ? (stats.winrate * 100).toFixed(1) + '%' : '‚Äî';
                    const plr = (typeof stats.pl_ratio === 'number') ? stats.pl_ratio.toFixed(2) : '‚Äî';
                    const trades = (typeof stats.trades_count === 'number') ? stats.trades_count : '‚Äî';
                    return `
                        <div class=\"vt-row\">
                            <div class=\"c-check\"><input type=\"checkbox\" class=\"verCheck\" value=\"${path}\" data-version=\"${v.version}\"></div>
                            <div><span style=\"font-weight:600;\">${v.version}</span></div>
                            <div><code>${modelFile || '‚Äî'}</code></div>
                            <div style=\"font-size:12px;color:#555;\">Winrate: ${winrate} ¬∑ P/L: ${plr} ¬∑ Trades: ${trades}</div>
                        </div>`;
                }).join('');
                box.innerHTML = `<div class=\"versions-table\">${header}${rows}</div>`;
            } catch (e) {
                box.innerHTML = '<em>–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤–µ—Ä—Å–∏–π</em>';
            }
        }

        // –ë—ã—Å—Ç—Ä—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∞–≥–µ–Ω—Ç–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
        function goToAgent(){
            const sym = document.getElementById('agentSymbolSelect')?.value || 'BTCUSDT';
            window.location.href = '/agent/' + encodeURIComponent(sym);
        }

        // –ó–∞–ø—É—Å–∫ —Ç–æ—Ä–≥–æ–≤–ª–∏
        async function startTrading() {
            const symbol = (document.getElementById('ensembleSymbolSelect')?.value) || 'BTCUSDT';
            const selectedSymbols = [symbol];
            // –°–æ–±–∏—Ä–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ –∏–∑ —á–µ–∫–±–æ–∫—Å–æ–≤
            const selectedPaths = Array.from(document.querySelectorAll('.verCheck:checked')).map(i => i.value).filter(Boolean);
            if (selectedPaths.length === 0) {
                showStatus('tradingResult', 'error', '–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –≤–µ—Ä—Å–∏—é –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è');
                return;
            }
            
            if (selectedSymbols.length === 0 || !selectedSymbols[0]) {
                showStatus('tradingResult', 'error', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Ç–æ—Ä–≥–æ–≤—É—é –ø–∞—Ä—É');
                return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞
            const consensusSettings = getConsensusSettings();
            
            try {
                const response = await fetch('/api/trading/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        symbols: selectedSymbols,
                        model_paths: selectedPaths,
                        consensus: consensusSettings
                    })
                });
                
                const result = await response.json();
                showStatus('tradingResult', result.success ? 'success' : 'error', 
                    result.success ? result.message : result.error);
                
                if (result.success) {
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞
                    setTimeout(getTradingStatus, 1000);
                }
            } catch (error) {
                showStatus('tradingResult', 'error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Ç–æ—Ä–≥–æ–≤–ª–∏: ' + error.message);
            }
        }

        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–æ—Ä–≥–æ–≤–ª–∏
        async function stopTrading() {
            try {
                const response = await fetch('/api/trading/stop', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                showStatus('tradingResult', result.success ? 'success' : 'error', 
                    result.success ? result.message : result.error);
                
                if (result.success) {
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
                    setTimeout(getTradingStatus, 1000);
                }
            } catch (error) {
                showStatus('tradingResult', 'error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ —Ç–æ—Ä–≥–æ–≤–ª–∏: ' + error.message);
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Ç–æ—Ä–≥–æ–≤–ª–∏ (–æ—Å—Ç–∞–≤–ª—è–µ–º –¥–ª—è —Å—Ç–∞—Ä—Ç/—Å—Ç–æ–ø –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏)
        async function getTradingStatus() {
            try {
                const response = await fetch('/api/trading/status');
                const result = await response.json();
                
                if (result.success) {
                    const statusDiv = document.getElementById('tradingStatus');
                    const contentDiv = document.getElementById('statusContent');
                    if (!statusDiv || !contentDiv) {
                        // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –Ω–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ ‚Äî —Ç–∏—Ö–æ –≤—ã—Ö–æ–¥–∏–º
                        return;
                    }

                    let statusHTML = `
                        <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${result.trading_status_full || result.trading_status || (result.is_trading ? 'üü¢ –ê–∫—Ç–∏–≤–Ω–∞' : 'üî¥ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞')}</p>
                        <p><strong>–ü–∞—Ä–∞:</strong> ${result.symbol_display || result.symbol || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</p>
                        <p><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</strong> ${result.amount_display || result.amount || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                        <p><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ USDT:</strong> ${result.amount_usdt ? '$' + result.amount_usdt.toFixed(2) : '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                        <p><strong>–ü–æ–∑–∏—Ü–∏—è:</strong> ${result.position ? '–û—Ç–∫—Ä—ã—Ç–∞' : '–ù–µ—Ç'}</p>
                        <p><strong>–°–¥–µ–ª–æ–∫:</strong> ${result.trades_count}</p>
                        <p><strong>–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞:</strong> ${result.current_price ? '$' + result.current_price.toFixed(2) : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</p>
                        ${result.last_model_prediction ? `<p><strong>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ:</strong> ${result.last_model_prediction}</p>` : ''}
                    `;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –¥–ª—è –æ—Å—Ç–∞–≤—à–µ–π—Å—è –ø–æ–∑–∏—Ü–∏–∏, –µ—Å–ª–∏ –µ—Å—Ç—å
                    if (result.position && result.position.partial_sell_strategy) {
                        showRemainingPositionStrategy(result.position.partial_sell_strategy);
                    } else {
                        // –°–∫—Ä—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏, –µ—Å–ª–∏ –µ—Å—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                        const rps = document.getElementById('remainingPositionStrategy');
                        if (rps) rps.style.display = 'none';
                    }
                    
                    contentDiv.innerHTML = statusHTML;
                    statusDiv.style.display = 'block';
                } else {
                    showStatus('tradingResult', 'error', result.error);
                }
            } catch (error) {
                showStatus('tradingResult', 'error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞: ' + error.message);
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
        async function getBalance() {
            try {
                const response = await fetch('/api/trading/balance');
                const result = await response.json();
                
                if (result.success) {
                    const balanceDiv = document.getElementById('balanceStatus');
                    const contentDiv = document.getElementById('balanceContent');
                    
                    contentDiv.innerHTML = `
                        <p><strong>USDT:</strong> ${result.balance.USDT.toFixed(2)}</p>
                        <p><strong>BTC:</strong> ${result.balance.BTC.toFixed(8)}</p>
                    `;
                    
                    balanceDiv.style.display = 'block';
                } else {
                    showStatus('tradingResult', 'error', result.error);
                }
            } catch (error) {
                showStatus('tradingResult', 'error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞: ' + error.message);
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Ç–æ—Ä–≥–æ–≤–ª–∏ (–±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ)
        async function getTradingHistory() {
            try {
                const response = await fetch('/api/trading/history');
                const result = await response.json();
                
                if (result.success) {
                    const historyDiv = document.getElementById('tradingHistory');
                    const contentDiv = document.getElementById('historyContent');
                    
                    // 1) –ü–æ–¥—Ç—è–Ω–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä—è–¥–æ–º —Å –∏—Å—Ç–æ—Ä–∏–µ–π
                    let positionHTML = '';
                    try {
                        const statusResp = await fetch('/api/trading/status');
                        const statusJson = await statusResp.json();
                        if (statusJson && (statusJson.success || statusJson.agent_status)) {
                            const agent = statusJson.agent_status || statusJson;
                            const position = agent.position;
                            const currentPrice = agent.current_price;
                            if (position && position.amount && position.amount > 0) {
                                const entryPrice = position.entry_price || 0;
                                const pnlAbs = currentPrice && entryPrice ? (currentPrice - entryPrice) * position.amount : 0;
                                const pnlPct = currentPrice && entryPrice ? ((currentPrice - entryPrice) / entryPrice) * 100 : 0;
                                const entryTime = position.entry_time ? formatMoscowDateTime(position.entry_time) : '';
                                positionHTML = `
                                    <div class="trade-item" style="border-left:4px solid #28a745;">
                                        <div class="trade-header">
                                            <span class="trade-action buy">–¢–ï–ö–£–©–ê–Ø –ü–û–ó–ò–¶–ò–Ø (${position.type?.toUpperCase() || 'LONG'})</span>
                                            ${entryTime ? `<span>–û—Ç–∫—Ä—ã—Ç–∞: ${entryTime}</span>` : ''}
                                        </div>
                                        <div class="trade-details">
                                            <div class="trade-detail">
                                                <div class="label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</div>
                                                <div class="value">${position.amount}</div>
                                            </div>
                                            <div class="trade-detail">
                                                <div class="label">–¶–µ–Ω–∞ –≤—Ö–æ–¥–∞</div>
                                                <div class="value">$${entryPrice ? entryPrice.toFixed(2) : 'N/A'}</div>
                                            </div>
                                            <div class="trade-detail">
                                                <div class="label">–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞</div>
                                                <div class="value">$${currentPrice ? currentPrice.toFixed(2) : 'N/A'}</div>
                                            </div>
                                            <div class="trade-detail">
                                                <div class="label">P&L</div>
                                                <div class="value" style="color:${pnlAbs >= 0 ? 'green' : 'red'}">
                                                    ${pnlAbs >= 0 ? '+' : ''}$${pnlAbs.toFixed(4)} (${pnlPct >= 0 ? '+' : ''}${pnlPct.toFixed(2)}%)
                                                </div>
                                            </div>
                                            ${position.trade_number ? `
                                            <div class="trade-detail">
                                                <div class="label">Trade #</div>
                                                <div class="value">${position.trade_number}</div>
                                            </div>` : ''}
                                        </div>
                                    </div>
                                `;
                            } else {
                                positionHTML = `
                                    <div class="trade-item" style="border-left:4px solid #6c757d;">
                                        <div class="trade-header">
                                            <span class="trade-action hold">–¢–ï–ö–£–©–ê–Ø –ü–û–ó–ò–¶–ò–Ø</span>
                                            <span>–Ω–µ—Ç –æ—Ç–∫—Ä—ã—Ç–æ–π –ø–æ–∑–∏—Ü–∏–∏</span>
                                        </div>
                                    </div>
                                `;
                            }
                        }
                    } catch (e) {
                        // –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —Å—Ç–∞—Ç—É—Å–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–∏—à—å –∏—Å—Ç–æ—Ä–∏—é
                    }

                    // 2) –ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫
                    if (result.trades && result.trades.length > 0) {
                        let historyHTML = `<p><strong>–í—Å–µ–≥–æ —Å–¥–µ–ª–æ–∫:</strong> ${result.total_trades}</p>`;
                        
                        result.trades.forEach((trade, index) => {
                            const tradeTime = formatMoscowDateTime(trade.time);
                            const actionClass = trade.action === 'buy' ? 'buy' : 'sell';
                            
                            historyHTML += `
                                <div class="trade-item">
                                    <div class="trade-header">
                                        <span class="trade-action ${actionClass}">${trade.action.toUpperCase()}</span>
                                        <span>${tradeTime}</span>
                                    </div>
                                    <div class="trade-details">
                                        <div class="trade-detail">
                                            <div class="label">–¶–µ–Ω–∞</div>
                                            <div class="value">$${trade.price}</div>
                                        </div>
                                        <div class="trade-detail">
                                            <div class="label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</div>
                                            <div class="value">${trade.amount}</div>
                                        </div>
                                        ${trade.pnl ? `
                                        <div class="trade-detail">
                                            <div class="label">P&L</div>
                                            <div class="value" style="color: ${trade.pnl >= 0 ? 'green' : 'red'}">
                                                ${trade.pnl >= 0 ? '+' : ''}$${trade.pnl.toFixed(4)}
                                            </div>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        });
                        
                        contentDiv.innerHTML = positionHTML + historyHTML;
                    } else {
                        const emptyHTML = '<p>üìà –ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫ –ø–æ–∫–∞ –ø—É—Å—Ç–∞</p><p><em>–°–¥–µ–ª–∫–∏ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–æ—Ä–≥–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π</em></p>';
                        contentDiv.innerHTML = positionHTML + emptyHTML;
                    }
                    
                    historyDiv.style.display = 'block';
                    try { historyDiv.scrollIntoView({ behavior: 'smooth' }); } catch (_) {}
                } else {
                    const historyDiv = document.getElementById('tradingHistory');
                    const contentDiv = document.getElementById('historyContent');
                    contentDiv.innerHTML = '<p>‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏</p><p><em>' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</em></p>';
                    historyDiv.style.display = 'block';
                    try { historyDiv.scrollIntoView({ behavior: 'smooth' }); } catch (_) {}
                }
            } catch (error) {
                const historyDiv = document.getElementById('tradingHistory');
                const contentDiv = document.getElementById('historyContent');
                contentDiv.innerHTML = '<p>‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏</p><p><em>' + error.message + '</em></p>';
                historyDiv.style.display = 'block';
                try { historyDiv.scrollIntoView({ behavior: 'smooth' }); } catch (_) {}
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–æ—Ä–≥–æ–≤–ª–∏ –∏–∑ Celery
        async function getTradingResults(showAll = false) {
            try {
                const response = await fetch('/api/trading/latest_results');
                const result = await response.json();
                
                if (result.success) {
                    const resultsDiv = document.getElementById('tradingResults');
                    const contentDiv = document.getElementById('tradingResultsContent');
                    const titleDiv = document.getElementById('tradingResultsTitle');
                    
                    if (result.latest_results && result.latest_results.length > 0) {
                        // –§–∏–ª—å—Ç—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ showAll
                        let filteredResults;
                        if (showAll) {
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                            filteredResults = result.latest_results;
                        } else {
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–µ —Ç–æ—Ä–≥–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏ –æ—à–∏–±–∫–∏
                            filteredResults = result.latest_results.filter(tradeResult => {
                                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏:
                                // 1. –ë—ã–ª–∞ —Ä–µ–∞–ª—å–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è (trade_executed === true)
                                // 2. –ò–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ (exit_code !== 0)
                                // 3. –ò–ª–∏ —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ HOLD –±–µ–∑ —Ç–æ—Ä–≥–æ–≤–ª–∏
                                return tradeResult.trade_executed === true || 
                                       tradeResult.exit_code !== 0 || 
                                       (tradeResult.parsed_result && tradeResult.parsed_result.action && 
                                        tradeResult.parsed_result.action !== 'hold');
                            });
                        }

                        const sectionTitle = showAll ? '–í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–æ—Ä–≥–æ–≤–ª–∏ (–≤–∫–ª—é—á–∞—è HOLD)' : '–†–µ–∞–ª—å–Ω—ã–µ —Ç–æ—Ä–≥–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏';
                        let resultsHTML = `<p><strong>–í—Å–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:</strong> ${result.total_results} | <strong>–ü–æ–∫–∞–∑–∞–Ω–æ:</strong> ${filteredResults.length}</p>`;
                        
                        if (filteredResults.length === 0) {
                            if (showAll) {
                                contentDiv.innerHTML = '<p>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p><p><em>–°–∏—Å—Ç–µ–º–∞ –µ—â–µ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–ª–∞ –Ω–∏–∫–∞–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π</em></p>';
                            } else {
                                contentDiv.innerHTML = '<p>üìä –†–µ–∞–ª—å–Ω—ã—Ö —Ç–æ—Ä–≥–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</p><p><em>–°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ä–µ–∂–∏–º–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞, –æ–∂–∏–¥–∞—è —Ç–æ—Ä–≥–æ–≤—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤</em></p><p><small>üí° –ù–∞–∂–º–∏—Ç–µ "üîç –í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (–≤–∫–ª—é—á–∞—è HOLD)" —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –≤—Å–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã</small></p>';
                            }
                            resultsDiv.style.display = 'block';
                            return;
                        }
                        
                        filteredResults.forEach((tradeResult, index) => {
                            const resultTime = formatMoscowDateTime(tradeResult.timestamp);
                            
                            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                            let resultType, resultClass, resultIcon;
                            if (tradeResult.exit_code !== 0) {
                                resultType = '–û–®–ò–ë–ö–ê';
                                resultClass = 'error';
                                resultIcon = '‚ùå';
                            } else if (tradeResult.trade_executed === true) {
                                resultType = '–°–î–ï–õ–ö–ê';
                                resultClass = 'success';
                                resultIcon = 'üí∞';
                            } else {
                                resultType = '–ê–ö–¢–ò–í–ù–û–°–¢–¨';
                                resultClass = 'info';
                                resultIcon = 'üîç';
                            }
                            
                            resultsHTML += `
                                <div class="trade-item">
                                    <div class="trade-header">
                                        <span class="trade-action ${resultClass}">${resultIcon} ${resultType}</span>
                                        <span>${resultTime}</span>
                                    </div>
                                    <div class="trade-details">
                                        <div class="trade-detail">
                                            <div class="label">–°–∏–º–≤–æ–ª—ã</div>
                                            <div class="value">${tradeResult.symbols ? tradeResult.symbols.join(', ') : 'N/A'}</div>
                                        </div>
                                        <div class="trade-detail">
                                            <div class="label">–ö–æ–¥ –≤—ã—Ö–æ–¥–∞</div>
                                            <div class="value">${tradeResult.exit_code}</div>
                                        </div>
                                        ${tradeResult.trade_type ? `
                                        <div class="trade-detail">
                                            <div class="label">–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏</div>
                                            <div class="value">${tradeResult.trade_type.toUpperCase()}</div>
                                        </div>
                                        ` : ''}
                                        ${tradeResult.parsed_result ? `
                                        <div class="trade-detail">
                                            <div class="label">–î–µ–π—Å—Ç–≤–∏–µ</div>
                                            <div class="value">${tradeResult.parsed_result.action || 'N/A'}</div>
                                        </div>
                                        <div class="trade-detail">
                                            <div class="label">–¶–µ–Ω–∞</div>
                                            <div class="value">$${tradeResult.parsed_result.price || 'N/A'}</div>
                                        </div>
                                        ${tradeResult.parsed_result.trade_executed ? `
                                        <div class="trade-detail">
                                            <div class="label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
                                            <div class="value">${tradeResult.parsed_result.trade_executed}</div>
                                        </div>
                                        ` : ''}
                                        ${tradeResult.parsed_result.position_pnl ? `
                                        <div class="trade-detail">
                                            <div class="label">P&L –ø–æ–∑–∏—Ü–∏–∏</div>
                                            <div class="value" style="color: ${tradeResult.parsed_result.position_pnl >= 0 ? 'green' : 'red'}">
                                                ${tradeResult.parsed_result.position_pnl >= 0 ? '+' : ''}${tradeResult.parsed_result.position_pnl.toFixed(2)}%
                                            </div>
                                        </div>
                                        ` : ''}
                                        ` : ''}
                                    </div>
                                    ${tradeResult.parse_error ? `
                                    <div style="margin-top: 10px; padding: 10px; background: #f8d7da; border-radius: 5px; font-size: 12px;">
                                        <strong>–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:</strong> ${tradeResult.parse_error}
                                    </div>
                                    ` : ''}
                                </div>
                            `;
                        });
                        
                        contentDiv.innerHTML = resultsHTML;
                        titleDiv.textContent = `üìä ${sectionTitle}`;
                    } else {
                        contentDiv.innerHTML = '<p>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–æ—Ä–≥–æ–≤–ª–∏ –ø–æ–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</p><p><em>–î–∞–Ω–Ω—ã–µ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–æ—Ä–≥–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —á–µ—Ä–µ–∑ Celery</em></p>';
                        titleDiv.textContent = 'üìä –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–æ—Ä–≥–æ–≤–ª–∏ (Celery)';
                    }
                    
                    resultsDiv.style.display = 'block';
                } else {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:', result.error);
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ —Å –æ—à–∏–±–∫–æ–π
                    const resultsDiv = document.getElementById('tradingResults');
                    const contentDiv = document.getElementById('tradingResultsContent');
                    const titleDiv = document.getElementById('tradingResultsTitle');
                    contentDiv.innerHTML = '<p>‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</p><p><em>' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</em></p>';
                    titleDiv.textContent = 'üìä –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–æ—Ä–≥–æ–≤–ª–∏ (Celery)';
                    resultsDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–æ—Ä–≥–æ–≤–ª–∏:', error);
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ —Å –æ—à–∏–±–∫–æ–π
                const resultsDiv = document.getElementById('tradingResults');
                const contentDiv = document.getElementById('tradingResultsContent');
                const titleDiv = document.getElementById('tradingResultsTitle');
                contentDiv.innerHTML = '<p>‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏</p><p><em>' + error.message + '</em></p>';
                titleDiv.textContent = 'üìä –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–æ—Ä–≥–æ–≤–ª–∏ (Celery)';
                resultsDiv.style.display = 'block';
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Å–¥–µ–ª–æ–∫ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        async function getTradeHistory() {
            try {
                const symSel = document.getElementById('ensembleSymbolSelect');
                const symbol = symSel ? (symSel.value || '') : '';
                const qs = new URLSearchParams({
                    limit_trades: '400',
                    limit_predictions: '2000',
                    tolerance_buckets: '2',
                    ...(symbol ? { symbol } : {})
                }).toString();
                const resp = await fetch('/api/trades/matched_full?' + qs);
                const data = await resp.json();
                const historyDiv = document.getElementById('tradeHistory');
                const contentDiv = document.getElementById('tradeHistoryContent');
                
                if (!data.success) {
                    contentDiv.innerHTML = '<p>‚ùå –û—à–∏–±–∫–∞ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è</p><p><em>' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</em></p>';
                    historyDiv.style.display = 'block';
                    return;
                }

                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º —Å—ã—Ä—ã–µ —Å–¥–µ–ª–∫–∏ –∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–π —Å–≤–µ—Ä–∫–∏
                const tradesUrl = symbol ? (`/api/trades/by_symbol/${encodeURIComponent(symbol)}?limit=200`) : '/api/trades/recent?limit=200';
                const predsUrl = '/api/predictions/recent?limit=500' + (symbol ? ('&symbol=' + encodeURIComponent(symbol)) : '');
                let tradesJson = { success: false }, predsJson = { success: false };
                try {
                    const [tResp, pResp] = await Promise.all([fetch(tradesUrl), fetch(predsUrl)]);
                    tradesJson = await tResp.json();
                    predsJson = await pResp.json();
                } catch (_) {}

                // –•–µ–ª–ø–µ—Ä—ã –¥–ª—è —Å–≤–µ—Ä–∫–∏
                const toMs = (v) => {
                    if (!v) return null;
                    try {
                        if (typeof v === 'number') return v;
                        const s = String(v);
                        const hasTimezone = /[zZ]|[\+\-]\d{2}:?\d{2}$/.test(s);
                        const isoBasic = /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d+)?$/;
                        const src = (!hasTimezone && isoBasic.test(s)) ? (s + 'Z') : s;
                        const d = new Date(src);
                        const t = d.getTime();
                        return isNaN(t) ? null : t;
                    } catch (_) { return null; }
                };
                const bucket5m = (ms) => (ms == null ? null : Math.floor(ms / 300000));

                // –ì–æ—Ç–æ–≤–∏–º —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–ø–∏—Å–∫–∏ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–π —Å–≤–µ—Ä–∫–∏
                const trades = (tradesJson && tradesJson.success && Array.isArray(tradesJson.trades)) ? tradesJson.trades : [];
                const tBuyLines = [];
                const tSellLines = [];
                for (const t of trades) {
                    const ts = toMs(t.executed_at) ?? toMs(t.created_at) ?? toMs(t.time);
                    const bk = bucket5m(ts);
                    const priceNum = Number(t.price);
                    const qtyNum = Number(t.quantity || t.amount || 0);
                    const act = (t.action || '').toLowerCase();
                    const actDisplay = act === 'sell_partial' ? 'SELL_PARTIAL' : (t.action?.toUpperCase());
                    const line = `${formatMoscowDateTime(ts)} | ${t.symbol} | ${actDisplay} | $${priceNum.toFixed(4)} | qty=${qtyNum} | b=${bk}`;
                    if (act === 'buy') tBuyLines.push(line);
                    if (act === 'sell' || act === 'sell_partial') tSellLines.push(line);
                }

                const predictions = (predsJson && predsJson.success && Array.isArray(predsJson.predictions)) ? predsJson.predictions : [];
                const pBuyLines = [];
                const pSellLines = [];
                for (const p of predictions) {
                    const ts = toMs(p.timestamp);
                    const bk = bucket5m(ts);
                    const conf = (typeof p.confidence === 'number') ? (p.confidence * 100).toFixed(1) + '%' : '‚Äî';
                    const line = `${formatMoscowDateTime(ts)} | ${p.symbol} | ${p.action?.toUpperCase()} | conf=${conf} | b=${bk}`;
                    if ((p.action || '').toLowerCase() === 'buy') pBuyLines.push(line);
                    if ((p.action || '').toLowerCase() === 'sell') pSellLines.push(line);
                }

                const debugHTML = `
                    <div class="trade-item">
                                    <div class="trade-header">
                            <span>–°–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö (—Å–∏–º–≤–æ–ª: ${symbol || '‚Äî'})</span>
                                    </div>
                        <div class="trade-details" style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                            <div>
                                <div class="label" style="font-weight:600; margin-bottom:6px;">–°–¥–µ–ª–∫–∏ (Bybit)</div>
                                <div style="font-size:12px; color:#444;">
                                    <div><strong>BUY (${tBuyLines.length})</strong></div>
                                    <pre style="white-space:pre-wrap; margin:6px 0;">${tBuyLines.join('\n')}</pre>
                                    <div><strong>SELL (${tSellLines.length})</strong></div>
                                    <pre style="white-space:pre-wrap; margin:6px 0;">${tSellLines.join('\n')}</pre>
                                        </div>
                                        </div>
                            <div>
                                <div class="label" style="font-weight:600; margin-bottom:6px;">–ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è (–ë–î)</div>
                                <div style="font-size:12px; color:#444;">
                                    <div><strong>BUY (${pBuyLines.length})</strong></div>
                                    <pre style="white-space:pre-wrap; margin:6px 0;">${pBuyLines.join('\n')}</pre>
                                    <div><strong>SELL (${pSellLines.length})</strong></div>
                                    <pre style="white-space:pre-wrap; margin:6px 0;">${pSellLines.join('\n')}</pre>
                                        </div>
                                        </div>
                                            </div>
                                        </div>
                `;

                const pairs = Array.isArray(data.pairs) ? data.pairs : [];
                if (pairs.length === 0) {
                    contentDiv.innerHTML = debugHTML + '<p>–ù–µ—Ç –ø–æ–ª–Ω—ã—Ö —Å–æ–≤–ø–∞–≤—à–∏—Ö —Å–¥–µ–ª–æ–∫ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.</p>';
                    historyDiv.style.display = 'block';
                    return;
                }

                let html = `<p><strong>–ù–∞–π–¥–µ–Ω–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π:</strong> ${pairs.length}</p>`;
                for (const d of pairs) {
                    const pnlColor = (d.pnl_abs || 0) >= 0 ? 'green' : 'red';
                    const buyConf = (d.pred_buy && typeof d.pred_buy.confidence === 'number') ? (d.pred_buy.confidence * 100).toFixed(1) + '%' : '‚Äî';
                    const sellConf = (d.pred_sell && typeof d.pred_sell.confidence === 'number') ? (d.pred_sell.confidence * 100).toFixed(1) + '%' : '‚Äî';
                    const buyQ = d.pred_buy && Array.isArray(d.pred_buy.q_values) ? d.pred_buy.q_values.map(v=>Number(v).toFixed(3)).join(', ') : '‚Äî';
                    const sellQ = d.pred_sell && Array.isArray(d.pred_sell.q_values) ? d.pred_sell.q_values.map(v=>Number(v).toFixed(3)).join(', ') : '‚Äî';

                    html += `
                        <div class="trade-item">
                            <div class="trade-header">
                                <span class="trade-action buy">BUY</span>
                                <span>${formatMoscowDateTime(d.entry_time)}</span>
                                <span class="trade-action sell">‚Üí SELL</span>
                                <span>${formatMoscowDateTime(d.exit_time)}</span>
                                        </div>
                            <div class="trade-details">
                                <div class="trade-detail"><div class="label">–°–∏–º–≤–æ–ª</div><div class="value">${d.symbol}</div></div>
                                <div class="trade-detail"><div class="label">–í—Ö–æ–¥</div><div class="value">$${Number(d.entry_price).toFixed(4)}</div></div>
                                <div class="trade-detail"><div class="label">–í—ã—Ö–æ–¥</div><div class="value">$${Number(d.exit_price).toFixed(4)}</div></div>
                                <div class="trade-detail"><div class="label">–ö–æ–ª-–≤–æ</div><div class="value">${d.qty}</div></div>
                                <div class="trade-detail"><div class="label">P&L</div><div class="value" style="color:${pnlColor}">${(d.pnl_abs||0) >= 0 ? '+' : ''}$${Number(d.pnl_abs||0).toFixed(4)} ${d.pnl_pct!=null?`(${Number(d.pnl_pct).toFixed(2)}%)`:''}</div></div>
                                <div class="trade-detail"><div class="label">BUY conf</div><div class="value">${buyConf}</div></div>
                                <div class="trade-detail"><div class="label">SELL conf</div><div class="value">${sellConf}</div></div>
                                <div class="trade-detail"><div class="label">BUY Q</div><div class="value">[${buyQ}]</div></div>
                                <div class="trade-detail"><div class="label">SELL Q</div><div class="value">[${sellQ}]</div></div>
                                    </div>
                                </div>
                            `;
                    }
                    
                contentDiv.innerHTML = debugHTML + html;
                    historyDiv.style.display = 'block';

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏ —Å–¥–µ–ª–æ–∫:', error);
                const historyDiv = document.getElementById('tradeHistory');
                const contentDiv = document.getElementById('tradeHistoryContent');
                contentDiv.innerHTML = '<p>‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏</p><p><em>' + error.message + '</em></p>';
                historyDiv.style.display = 'block';
            }
        }

        

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–¥–µ–ª–æ–∫
        async function getTradeStatistics() {
            try {
                const response = await fetch('/api/trades/statistics');
                const result = await response.json();
                
                const statsDiv = document.getElementById('tradeStatistics');
                const contentDiv = document.getElementById('tradeStatisticsContent');
                
                if (result.success) {
                    const stats = result.statistics;
                    const successRate = stats.success_rate || 0;
                    const successRateClass = successRate >= 50 ? 'success' : 'error';
                    
                    const statsHTML = `
                        <div class="statistics-grid">
                            <div class="stat-item">
                                <div class="stat-label">–í—Å–µ–≥–æ —Å–¥–µ–ª–æ–∫</div>
                                <div class="stat-value">${stats.total_trades}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">–£—Å–ø–µ—à–Ω—ã—Ö —Å–¥–µ–ª–æ–∫</div>
                                <div class="stat-value success">${stats.successful_trades}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">–ù–µ—É–¥–∞—á–Ω—ã—Ö —Å–¥–µ–ª–æ–∫</div>
                                <div class="stat-value error">${stats.failed_trades}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">–ü—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—Ö–∞</div>
                                <div class="stat-value ${successRateClass}">${successRate}%</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">–û–±—â–∏–π –æ–±—ä–µ–º</div>
                                <div class="stat-value">${stats.total_volume.toFixed(6)}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</div>
                                <div class="stat-value">$${stats.total_value.toFixed(2)}</div>
                            </div>
                        </div>
                    `;
                    
                    contentDiv.innerHTML = statsHTML;
                    statsDiv.style.display = 'block';
                } else {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', result.error);
                    contentDiv.innerHTML = '<p>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</p><p><em>–û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</em></p>';
                    statsDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ —Å –æ—à–∏–±–∫–æ–π
                const statsDiv = document.getElementById('tradeStatistics');
                const contentDiv = document.getElementById('tradeStatisticsContent');
                contentDiv.innerHTML = '<p>‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏</p><p><em>' + error.message + '</em></p>';
                statsDiv.style.display = 'block';
            }
        }

        // –ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
        function startMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
            }
            
            // –°—Ä–∞–∑—É –ø–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            getTradingStatus();
            getBalance();
            getTradingResults();
            getTradeHistory();
            getTradeStatistics();
            getModelPredictions();
            getPredictionStatistics();
            
            monitoringInterval = setInterval(() => {
                getTradingStatus();
                getBalance();
                getTradingResults();
                getTradeHistory();
                getTradeStatistics();
                getModelPredictions();
                getPredictionStatistics();
            }, 300000); 
            
            document.getElementById('monitoringStatus').style.display = 'block';
            showStatus('tradingResult', 'info', '–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω - –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç');
        }

        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
            }
            
            document.getElementById('monitoringStatus').style.display = 'none';
            showStatus('tradingResult', 'info', '–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å
        function showStatus(elementId, type, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
            element.style.display = 'block';
            
            // –ê–≤—Ç–æ—Å–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }

        // –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π —Ä–µ–∞–ª—å–Ω—ã–π –æ—Ä–¥–µ—Ä BUY/SELL –≤ –æ–±—Ö–æ–¥ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π
        async function sendInstantOrder(action) {
            try {
                const symbol = document.getElementById('symbolSelect').value || 'BTCUSDT';
                const body = {
                    action,
                    symbol
                    // quantity –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ; –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞—Ç—å ‚Äî –≤–æ–∑—å–º–µ—Ç—Å—è –º–∏–Ω–∏–º–∞–ª—å–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ä–∞–∑–º–µ—Ä
                };
                const response = await fetch('/api/trading/test_order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const result = await response.json();
                if (result.success) {
                    showStatus('tradingResult', 'success', `${action.toUpperCase()} –∏—Å–ø–æ–ª–Ω–µ–Ω: ${symbol}, qty=${result.quantity}`);
                    // –ù–∏—á–µ–≥–æ –Ω–µ –ø–∏—à–µ–º –≤ –ë–î/–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
                } else {
                    showStatus('tradingResult', 'error', `–û—à–∏–±–∫–∞: ${result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
                }
            } catch (error) {
                showStatus('tradingResult', 'error', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π –º–æ–¥–µ–ª–∏ –ò–ò
        async function getModelPredictions() {
            try {
                const response = await fetch('/api/predictions/recent?limit=150');
                const result = await response.json();
                
                const predictionsDiv = document.getElementById('modelPredictions');
                const contentDiv = document.getElementById('predictionsContent');
                
                if (result.success) {
                    if (result.predictions && result.predictions.length > 0) {
                        let predictionsHTML = `<p><strong>–í—Å–µ–≥–æ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π:</strong> ${result.total_predictions}</p>`;
                        
                        result.predictions.forEach(prediction => {
                            const predictionTime = formatMoscowDateTime(prediction.timestamp);
                            const actionClass = prediction.action === 'buy' ? 'buy' : prediction.action === 'sell' ? 'sell' : 'hold';
                            const confidenceClass = prediction.confidence > 0.5 ? 'success' : prediction.confidence > 0.2 ? 'info' : 'warning';
                            
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–æ –ª–∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ Q-gate
                            const isQgateFiltered = prediction.market_conditions && prediction.market_conditions.qgate_filtered;
                            const qgateReason = prediction.market_conditions && prediction.market_conditions.qgate_reason;
                            const qgateSide = prediction.market_conditions && prediction.market_conditions.qgate_side;
                            const qgateT1 = prediction.market_conditions && prediction.market_conditions.qgate_T1;
                            const qgateT2 = prediction.market_conditions && prediction.market_conditions.qgate_T2;
                            const qgateMaxQ = prediction.market_conditions && prediction.market_conditions.qgate_maxQ;
                            const qgateGapQ = prediction.market_conditions && prediction.market_conditions.qgate_gapQ;
                            
                            predictionsHTML += `
                                <div class="trade-item" style="border-left: 4px solid ${isQgateFiltered ? '#ffc107' : (actionClass === 'buy' ? '#28a745' : actionClass === 'sell' ? '#dc3545' : '#6c757d')};">
                                    <div class="trade-header">
                                        <span class="trade-action ${actionClass}">${prediction.action.toUpperCase()}</span>
                                        ${isQgateFiltered ? '<span class="trade-confidence warning">üö´ Q-gate –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ</span>' : `<span class="trade-confidence ${confidenceClass}">–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${(prediction.confidence * 100).toFixed(1)}%</span>`}
                                        <span>${predictionTime}</span>
                                    </div>
                                    <div class="trade-details">
                                        <div class="trade-detail">
                                            <div class="label">–°–∏–º–≤–æ–ª</div>
                                            <div class="value">${prediction.symbol}</div>
                                        </div>
                                        <div class="trade-detail">
                                            <div class="label">–¶–µ–Ω–∞</div>
                                            <div class="value">$${prediction.current_price?.toFixed(6) || 'N/A'}</div>
                                        </div>
                                        <div class="trade-detail">
                                            <div class="label">–ü–æ–∑–∏—Ü–∏—è</div>
                                            <div class="value">${prediction.position_status}</div>
                                        </div>
                                        <div class="trade-detail">
                                            <div class="label">Q-Values</div>
                                            <div class="value">[${prediction.q_values.map(v => v.toFixed(3)).join(', ')}]</div>
                                        </div>
                                    </div>
                                    ${isQgateFiltered ? `
                                    <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; font-size: 12px;">
                                        <strong>üö´ Q-gate —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è</strong>${qgateSide ? ` <span style="opacity:0.8">(${qgateSide.toUpperCase()})</span>` : ''}:<br>
                                        <div style="margin-top:6px; color:#856404;">
                                            ${qgateReason || '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏'}
                                        </div>
                                        <div style="margin-top:8px; display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:6px; color:#444;">
                                            ${typeof qgateT1 === 'number' ? `<div><strong>T1 (maxQ)</strong>: ${qgateT1.toFixed(3)}</div>` : ''}
                                            ${typeof qgateT2 === 'number' ? `<div><strong>T2 (gapQ)</strong>: ${qgateT2.toFixed(3)}</div>` : ''}
                                            ${typeof qgateMaxQ === 'number' ? `<div><strong>maxQ</strong>: ${qgateMaxQ.toFixed(3)}</div>` : ''}
                                            ${typeof qgateGapQ === 'number' ? `<div><strong>gapQ</strong>: ${qgateGapQ.toFixed(3)}</div>` : ''}
                                        </div>
                                    </div>
                                    ` : ''}
                                    ${prediction.market_conditions && Object.keys(prediction.market_conditions).length > 0 && !isQgateFiltered ? `
                                    <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 12px;">
                                        <strong>–£—Å–ª–æ–≤–∏—è —Ä—ã–Ω–∫–∞:</strong><br>
                                        ${Object.entries(prediction.market_conditions).filter(([key]) => !key.startsWith('qgate_')).map(([key, value]) => 
                                            `${key}: ${value}`
                                        ).join(', ')}
                                    </div>
                                    ` : ''}
                                </div>
                            `;
                        });
                        
                        contentDiv.innerHTML = predictionsHTML;
                    } else {
                        contentDiv.innerHTML = '<p>üß† –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –º–æ–¥–µ–ª–∏ –ø–æ–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</p><p><em>–î–∞–Ω–Ω—ã–µ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–æ—Ä–≥–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π</em></p>';
                    }
                    
                    predictionsDiv.style.display = 'block';
                } else {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π:', result.error);
                    contentDiv.innerHTML = '<p>‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π</p><p><em>' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</em></p>';
                    predictionsDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π:', error);
                const predictionsDiv = document.getElementById('modelPredictions');
                const contentDiv = document.getElementById('predictionsContent');
                contentDiv.innerHTML = '<p>‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏</p><p><em>' + error.message + '</em></p>';
                predictionsDiv.style.display = 'block';
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π
        async function getPredictionStatistics() {
            try {
                const response = await fetch('/api/predictions/statistics');
                const result = await response.json();
                
                const statsDiv = document.getElementById('predictionStatistics');
                const contentDiv = document.getElementById('predictionStatsContent');
                
                if (result.success) {
                    const stats = result.statistics;
                    
                    const statsHTML = `
                        <div class="statistics-grid">
                            <div class="stat-item">
                                <div class="stat-label">–í—Å–µ–≥–æ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π</div>
                                <div class="stat-value">${stats.total_predictions}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">BUY —Å–∏–≥–Ω–∞–ª—ã</div>
                                <div class="stat-value buy">${stats.buy_predictions}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">SELL —Å–∏–≥–Ω–∞–ª—ã</div>
                                <div class="stat-value sell">${stats.sell_predictions}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">HOLD —Å–∏–≥–Ω–∞–ª—ã</div>
                                <div class="stat-value hold">${stats.hold_predictions}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">–°—Ä–µ–¥–Ω—è—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å BUY</div>
                                <div class="stat-value">${stats.avg_confidence_buy}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">–°—Ä–µ–¥–Ω—è—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å SELL</div>
                                <div class="stat-value">${stats.avg_confidence_sell}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">–°—Ä–µ–¥–Ω—è—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å HOLD</div>
                                <div class="stat-value">${stats.avg_confidence_hold}</div>
                            </div>
                        </div>
                    `;
                    
                    contentDiv.innerHTML = statsHTML;
                    statsDiv.style.display = 'block';
                } else {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π:', result.error);
                    contentDiv.innerHTML = '<p>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</p><p><em>–û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</em></p>';
                    statsDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π:', error);
                const statsDiv = document.getElementById('predictionStatistics');
                const contentDiv = document.getElementById('predictionStatsContent');
                contentDiv.innerHTML = '<p>‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏</p><p><em>' + error.message + '</em></p>';
                statsDiv.style.display = 'block';
            }
        }

        // –ü–æ–¥–±–æ—Ä –ø–æ—Ä–æ–≥–æ–≤ Q-gate (–±–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π)
        async function suggestQGate(side='buy') {
            try {
                const symSel = document.getElementById('ensembleSymbolSelect');
                const symbol = symSel ? (symSel.value || '') : '';
                const baseParams = {
                    limit_trades: '600',
                    limit_predictions: '3000',
                    tolerance_buckets: '2',
                    min_n: '10',
                    grid_points: '21',
                    side,
                    ...(symbol ? { symbol } : {})
                };
                let qs = new URLSearchParams(baseParams).toString();
                let resp = await fetch('/api/analysis/qgate_suggest?' + qs);
                let data = await resp.json();
                const resultsDiv = document.getElementById('tradingResults');
                const contentDiv = document.getElementById('tradingResultsContent');
                if (data.success) {
                    const s = data.suggestion;
                    contentDiv.innerHTML = `
                        <div class="trade-item">
                            <div class="trade-header"><span class="trade-action success">Q-gate ${side.toUpperCase()} –ø–æ—Ä–æ–≥–∏</span></div>
                            <div class="trade-details">
                                <div class="trade-detail"><div class="label">T1 (maxQ)</div><div class="value">${s.T1.toFixed(6)}</div></div>
                                <div class="trade-detail"><div class="label">T2 (gapQ)</div><div class="value">${s.T2.toFixed(6)}</div></div>
                                <div class="trade-detail"><div class="label">Hit-rate</div><div class="value">${(s.hit_rate*100).toFixed(2)}% (${s.n} —Å–¥–µ–ª–æ–∫)</div></div>
                                <div class="trade-detail"><div class="label">.env</div><div class="value"><code>${data.env}</code></div></div>
                            </div>
                        </div>`;
                    resultsDiv.style.display = 'block';
                    try { resultsDiv.scrollIntoView({ behavior: 'smooth' }); } catch (_) {}
                } else {
                    // –ü–æ–≤—Ç–æ—Ä —Å –±–æ–ª–µ–µ –º—è–≥–∫–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏, –µ—Å–ª–∏ –º–∞–ª–æ –¥–∞–Ω–Ω—ã—Ö
                    const needRetry = (data && data.error && /–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö/i.test(data.error));
                    if (needRetry) {
                        const retryParams = {
                            ...baseParams,
                            tolerance_buckets: '3',
                            min_n: '5',
                            grid_points: '11'
                        };
                        qs = new URLSearchParams(retryParams).toString();
                        resp = await fetch('/api/analysis/qgate_suggest?' + qs);
                        data = await resp.json();
                        if (data.success) {
                            const s = data.suggestion;
                            contentDiv.innerHTML = `
                                <div class="trade-item">
                                    <div class="trade-header"><span class="trade-action success">Q-gate ${side.toUpperCase()} (–ø–æ–≤—Ç–æ—Ä —Å –º—è–≥–∫–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏)</span></div>
                                    <div class="trade-details">
                                        <div class="trade-detail"><div class="label">T1 (maxQ)</div><div class="value">${s.T1.toFixed(6)}</div></div>
                                        <div class="trade-detail"><div class="label">T2 (gapQ)</div><div class="value">${s.T2.toFixed(6)}</div></div>
                                        <div class="trade-detail"><div class="label">Hit-rate</div><div class="value">${(s.hit_rate*100).toFixed(2)}% (${s.n} —Å–¥–µ–ª–æ–∫)</div></div>
                                        <div class="trade-detail"><div class="label">.env</div><div class="value"><code>${data.env}</code></div></div>
                                    </div>
                                </div>`;
                            resultsDiv.style.display = 'block';
                            try { resultsDiv.scrollIntoView({ behavior: 'smooth' }); } catch (_) {}
                            return;
                        }
                    }
                    contentDiv.innerHTML = `<p>‚ùå –ü–æ–¥–±–æ—Ä –ø–æ—Ä–æ–≥–æ–≤ –Ω–µ —É–¥–∞–ª—Å—è</p><p><em>${(data && data.error) || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</em></p>`;
                    resultsDiv.style.display = 'block';
                }
            } catch (e) {
                const resultsDiv = document.getElementById('tradingResults');
                const contentDiv = document.getElementById('tradingResultsContent');
                contentDiv.innerHTML = `<p>‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏</p><p><em>${e.message}</em></p>`;
                resultsDiv.style.display = 'block';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –æ—Å—Ç–∞–≤—à–µ–π—Å—è –ø–æ–∑–∏—Ü–∏–∏
        function showRemainingPositionStrategy(strategy) {
            const contentDiv = document.getElementById('remainingStrategyContent');
            const strategyDiv = document.getElementById('remainingPositionStrategy');
            if (!strategyDiv || !contentDiv) {
                return; // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –Ω–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            }
            
            if (strategy && strategy.type === 'remaining_position') {
                const createdTime = formatMoscowDateTime(strategy.created_at);
                const timeThreshold = formatMoscowDateTime(strategy.time_threshold);
                
                let strategyHTML = `
                    <div class="strategy-info">
                        <h4>üéØ –°—Ç—Ä–∞—Ç–µ–≥–∏—è –¥–ª—è –æ—Å—Ç–∞–≤—à–µ–π—Å—è –ø–æ–∑–∏—Ü–∏–∏</h4>
                        <div class="strategy-details">
                            <p><strong>–¢–∏–ø:</strong> ${strategy.type}</p>
                            <p><strong>–°–æ–∑–¥–∞–Ω–∞:</strong> ${createdTime}</p>
                            <p><strong>–í—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è:</strong> ${timeThreshold}</p>
                            <p><strong>–ü–æ—Ä–æ–≥ —É–±—ã—Ç–∫–∞:</strong> <span class="negative">${strategy.sell_threshold}%</span></p>
                            <p><strong>–ü–æ—Ä–æ–≥ –ø—Ä–∏–±—ã–ª–∏:</strong> <span class="positive">${strategy.profit_threshold}%</span></p>
                            <p><strong>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è:</strong> 24 —á–∞—Å–∞</p>
                        </div>
                        <div class="strategy-rules">
                            <h5>üìã –ü—Ä–∞–≤–∏–ª–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–¥–∞–∂–∏:</h5>
                            <ul>
                                <li>üö® <strong>–£–±—ã—Ç–æ–∫ > ${strategy.sell_threshold}%</strong> ‚Üí –ü—Ä–æ–¥–∞–µ–º –≤–µ—Å—å –æ—Å—Ç–∞—Ç–æ–∫</li>
                                <li>üí∞ <strong>–ü—Ä–∏–±—ã–ª—å > ${strategy.profit_threshold}%</strong> ‚Üí –ü—Ä–æ–¥–∞–µ–º –≤–µ—Å—å –æ—Å—Ç–∞—Ç–æ–∫</li>
                                <li>‚è∞ <strong>–í—Ä–µ–º—è > 24 —á–∞—Å–∞</strong> ‚Üí –ü—Ä–æ–¥–∞–µ–º –≤–µ—Å—å –æ—Å—Ç–∞—Ç–æ–∫</li>
                            </ul>
                        </div>
                    </div>
                `;
                
                contentDiv.innerHTML = strategyHTML;
                strategyDiv.style.display = 'block';
            } else {
                if (strategyDiv) strategyDiv.style.display = 'none';
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å–ª–∞–π–¥–µ—Ä–æ–≤ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞
        function updateConsensusDisplay() {
            const flatValue = document.getElementById('flatConsensus').value;
            const trendValue = document.getElementById('trendConsensus').value;
            
            document.getElementById('flatConsensusValue').textContent = flatValue + '%';
            document.getElementById('trendConsensusValue').textContent = trendValue + '%';
            document.getElementById('flatConsensusDisplay').textContent = flatValue + '%';
            document.getElementById('trendConsensusDisplay').textContent = trendValue + '%';
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–ª–∞–π–¥–µ—Ä–æ–≤ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞
        function initConsensusSliders() {
            const flatSlider = document.getElementById('flatConsensus');
            const trendSlider = document.getElementById('trendConsensus');
            
            if (flatSlider) {
                flatSlider.addEventListener('input', updateConsensusDisplay);
            }
            if (trendSlider) {
                trendSlider.addEventListener('input', updateConsensusDisplay);
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–Ω–∞—á–µ–Ω–∏–π
            updateConsensusDisplay();
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞
        function getConsensusSettings() {
            return {
                flat: parseInt(document.getElementById('flatConsensus').value),
                trend: parseInt(document.getElementById('trendConsensus').value)
            };
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', () => {
            onEnsembleSymbolChange();
            getTradingStatus();
            getBalance();
            initConsensusSliders();
        });
    </script>
</body>
</html>
