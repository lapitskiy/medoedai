<!DOCTYPE html>
<html lang="ru">
<head>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="/static/css/sidebar.css">
    <link rel="stylesheet" href="/static/css/tabs.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedoedAI - –¢–æ—Ä–≥–æ–≤—ã–π –∞–≥–µ–Ω—Ç</title>
    <style>
        /* –°—Ç–∏–ª—å –∫—Ä–∞—Å–∏–≤—ã—Ö –ø–æ–ª–∑—É–Ω–∫–æ–≤ —Å–æ "—à–∞—Ä–∏–∫–æ–º" */
        .count-range {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 6px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            outline: none;
            opacity: 0.95;
            transition: opacity 0.2s;
        }
        .count-range:hover { opacity: 1; }
        .count-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #fff;
            border: 3px solid #667eea;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            cursor: pointer;
        }
        .count-range::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #fff;
            border: 3px solid #667eea;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            cursor: pointer;
        }
        .range-inline {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .range-badge {
            font-weight: 600;
            color: #667eea;
            background: #eef2ff;
            border: 1px solid #dfe4ff;
            padding: 2px 8px;
            border-radius: 999px;
            min-width: 80px;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Sidebar –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
    <nav class="sidebar">
        <h3>üìã –ù–∞–≤–∏–≥–∞—Ü–∏—è</h3>
        <ul class="sidebar-nav">
            <li><a href="/" class="back-link">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a></li>
            <li><a href="javascript:history.back()">‚Üê –ù–∞–∑–∞–¥</a></li>
            <li><a href="#agent-control" onclick="scrollToSection('agent-control')">üéØ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</a></li>
            <li><a href="#symbol-navigation" onclick="scrollToSection('symbol-navigation')">üîÄ –ü–µ—Ä–µ–π—Ç–∏ –∫ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å–∏–º–≤–æ–ª–∞</a></li>
        </ul>
    </nav>

    <!-- –ö–Ω–æ–ø–∫–∞ –º–æ–±–∏–ª—å–Ω–æ–≥–æ –º–µ–Ω—é -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>

    <div class="container">
        <div class="main-content">
            <div class="header">
                <h1>üí∞ –¢–æ—Ä–≥–æ–≤—ã–π –∞–≥–µ–Ω—Ç</h1>
                <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤–ª–µ–π –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º —Ä—ã–Ω–∫–µ —á–µ—Ä–µ–∑ –æ–±—É—á–µ–Ω–Ω—É—é –º–æ–¥–µ–ª—å DQN</p>
            </div>
            
            <div class="content">
            <div class="tabs" data-tabs="main">
                <div class="tabs-nav">
                    <button class="tab-btn active" data-tab-btn data-target="#agent-control">üéØ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</button>
                    <button class="tab-btn" data-tab-btn data-target="#symbol-navigation">üîÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–∏–º–≤–æ–ª–∞</button>
                    <button class="tab-btn" data-tab-btn data-target="#test-tab">üß™ –¢–µ—Å—Ç</button>
                </div>
                <div class="tabs-content">
                    <!-- –ü–∞–Ω–µ–ª–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç –ø–æ id —Å data-target -->
                    <div class="tab-panel" data-tab-panel id="agent-control">
                        <!-- –°–µ–∫—Ü–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–æ—Ä–≥–æ–≤–ª–µ–π (–ø–µ—Ä–µ–Ω–æ—Å –≤–Ω—É—Ç—Ä—å –ø–∞–Ω–µ–ª–∏) -->
                        
                        <!-- –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ -->
                        <a href="/" class="btn back-btn">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>
                        
                        <!-- –°–µ–∫—Ü–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–æ—Ä–≥–æ–≤–ª–µ–π -->
                        <div class="section">
                            <h2>üéØ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤–ª–µ–π</h2>
                            <p>–ó–∞–ø—É—Å–∫ –∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–æ—Ä–≥–æ–≤–æ–≥–æ –±–æ—Ç–∞</p>
            
                <h2>üéØ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤–ª–µ–π</h2>
                <p>–ó–∞–ø—É—Å–∫ –∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–æ—Ä–≥–æ–≤–æ–≥–æ –±–æ—Ç–∞</p>
                
                <div class="form-group">
                    <label style="font-weight:600;">–ê–∫–∫–∞—É–Ω—Ç Bybit</label>
                    <select id="bybitAccountSelect" class="form-control" onchange="onSelectBybitAccount(this.value)">
                        <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>–ê–Ω—Å–∞–º–±–ª—å –∏ –≤–µ—Ä—Å–∏–∏:</label>
                    <div style="display:grid; grid-template-columns: 1fr; gap: 12px; align-items:start;">
                        <div>
                            <label style="font-weight:600;">–°–∏–º–≤–æ–ª</label>
                            <select id="ensembleSymbolSelect" class="form-control" onchange="onEnsembleSymbolChange()">
                                <option value="BTCUSDT" selected>BTCUSDT</option>
                                <option value="ETHUSDT">ETHUSDT</option>
                                <option value="SOLUSDT">SOLUSDT</option>
                                <option value="TONUSDT">TONUSDT</option>
                                <option value="ADAUSDT">ADAUSDT</option>
                                <option value="BNBUSDT">BNBUSDT</option>
                                <option value="XMRUSDT">XMRUSDT</option>
                                <option value="XRPUSDT">XRPUSDT</option>
                            </select>
                            <label style="font-weight:600; margin-top:10px;">–ê–Ω—Å–∞–º–±–ª—å</label>
                            <select id="ensembleSelect" class="form-control" onchange="renderEnsembleVersions()">
                                <option value="ensemble-a" selected>ensemble-a</option>
                    </select>
                        </div>
                    </div>
                </div>
                <div class="form-group" style="margin-top:10px;">
                    <div id="ensembleVersions" style="max-height:320px; overflow:auto; border:1px solid #e0e0e0; border-radius:6px; padding:0;">
                        <div class="versions-table">
                            <div class="vt-row vt-head">
                                <div class="c-check">–í—ã–±.</div>
                                <div>–í–µ—Ä—Å–∏—è</div>
                                <div>–ú–æ–¥–µ–ª—å</div>
                                <div>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
                            </div>
                            <div class="vt-row">
                                <div class="c-check"><input type="checkbox" disabled></div>
                                <div>‚Äî</div>
                                <div><em>–í—ã–±–µ—Ä–∏—Ç–µ —Å–∏–º–≤–æ–ª –∏ –∞–Ω—Å–∞–º–±–ª—å</em></div>
                                <div>‚Äî</div>
                            </div>
                        </div>
                    </div>
                    <small style="color:#666; display:block; margin-top:6px;">–û—Ç–º–µ—Ç—å—Ç–µ –≥–∞–ª–æ—á–∫–∞–º–∏ –≤–µ—Ä—Å–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ —É—á–∞—Å—Ç–≤—É—é—Ç –≤ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏. –ù–∏–∂–µ ‚Äî –∫—Ä–∞—Ç–∫–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞.</small>
                    <div id="ensembleVersionsStats" style="margin-top:8px;"></div>
                </div>
                
                <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞ -->
                <div class="form-group" style="margin-top:20px; padding:15px; background:#f8f9fa; border-radius:8px; border:1px solid #e0e0e0;">
                    <label style="font-weight:600; margin-bottom:10px; display:block;">üéØ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞</label>
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
                        <div>
                            <label style="font-weight:500; margin-bottom:5px; display:block;">–ë–æ–∫–æ–≤–∏–∫ (flat/range)</label>
                            <select id="flatConsensusCount" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; background:white;">
                                <option value="1">1 –º–æ–¥–µ–ª—å</option>
                                <option value="2">2 –º–æ–¥–µ–ª–∏</option>
                                <option value="3">3 –º–æ–¥–µ–ª–∏</option>
                                <option value="4">4 –º–æ–¥–µ–ª–∏</option>
                                <option value="5">5 –º–æ–¥–µ–ª–µ–π</option>
                            </select>
                            <small id="flatConsensusPercentHint" style="color:#666; display:block; margin-top:6px;">‚âà 100% –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö</small>
                        </div>
                        
                        <div>
                            <label style="font-weight:500; margin-bottom:5px; display:block;">–¢—Ä–µ–Ω–¥ (—Å–∏–ª—å–Ω—ã–π –∞–ø/–¥–∞—É–Ω)</label>
                            <select id="trendConsensusCount" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; background:white;">
                                <option value="1">1 –º–æ–¥–µ–ª—å</option>
                                <option value="2">2 –º–æ–¥–µ–ª–∏</option>
                                <option value="3">3 –º–æ–¥–µ–ª–∏</option>
                                <option value="4">4 –º–æ–¥–µ–ª–∏</option>
                                <option value="5">5 –º–æ–¥–µ–ª–µ–π</option>
                            </select>
                            <small id="trendConsensusPercentHint" style="color:#666; display:block; margin-top:6px;">‚âà 100% –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö</small>
                        </div>
                    </div>
                    
                    <div style="background:white; padding:10px; border-radius:6px; border:1px solid #dee2e6;">
                        <div style="font-size:14px; color:#495057;">
                            <strong>–¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:</strong><br>
                            ‚Ä¢ –ë–æ–∫–æ–≤–∏–∫: <span id="flatConsensusDisplay">‚Äî</span><br>
                            ‚Ä¢ –¢—Ä–µ–Ω–¥: <span id="trendConsensusDisplay">‚Äî</span>
                        </div>
                    </div>
                </div>
                
                <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∏—Å–∫-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç–∞ -->
                <div class="form-group" style="margin-top:20px; padding:15px; background:#fff3cd; border-radius:8px; border:1px solid #ffeaa7;">
                    <label style="font-weight:600; margin-bottom:10px; display:block;">üõ°Ô∏è –†–∏—Å–∫-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç</label>
                    
                    <!-- –°–ø–æ—Å–æ–± —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∏—Å–∫–∞–º–∏ -->
                    <div style="margin-bottom:15px;">
                        <label style="font-weight:500; margin-bottom:5px; display:block;">–°–ø–æ—Å–æ–± —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∏—Å–∫–∞–º–∏</label>
                        <select id="riskManagementType" class="form-control" onchange="updateRiskManagementDisplay()">
                            <option value="exchange_orders" selected>üìã –û—Ä–¥–µ—Ä–∞ –Ω–∞ –±–∏—Ä–∂–µ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)</option>
                            <option value="bot_monitoring">ü§ñ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –±–æ—Ç–æ–º</option>
                            <option value="both">üîÑ –û–±–∞ —Å–ø–æ—Å–æ–±–∞</option>
                        </select>
                        <small style="color:#666; display:block; margin-top:4px;">–û—Ä–¥–µ—Ä–∞ –Ω–∞ –±–∏—Ä–∂–µ —Ä–∞–±–æ—Ç–∞—é—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –∏ 24/7</small>
                    </div>
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
                        <div>
                            <label style="font-weight:500; margin-bottom:5px; display:block;">–¢–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç (%)</label>
                            <div class="range-inline">
                                <input type="range" id="takeProfitPct" class="count-range" min="1" max="20" value="5" step="0.5" style="flex:1;" oninput="updateRiskManagementDisplay()">
                                <span id="takeProfitPctValue" class="range-badge">5.0%</span>
                            </div>
                            <small style="color:#666; display:block; margin-top:6px;">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–¥–∞–∂–∞ –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –ø—Ä–∏–±—ã–ª–∏</small>
                        </div>
                        
                        <div>
                            <label style="font-weight:500; margin-bottom:5px; display:block;">–°—Ç–æ–ø-–ª–æ—Å—Å (%)</label>
                            <div class="range-inline">
                                <input type="range" id="stopLossPct" class="count-range" min="1" max="10" value="3" step="0.5" style="flex:1;" oninput="updateRiskManagementDisplay()">
                                <span id="stopLossPctValue" class="range-badge">-3.0%</span>
                            </div>
                            <small style="color:#666; display:block; margin-top:6px;">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–¥–∞–∂–∞ –ø—Ä–∏ —É–±—ã—Ç–∫–µ</small>
                        </div>
                    </div>
                    
                    <div style="background:white; padding:10px; border-radius:6px; border:1px solid #dee2e6;">
                        <div style="font-size:14px; color:#495057;">
                            <strong>–¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∏—Å–∫-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç–∞:</strong><br>
                            ‚Ä¢ –°–ø–æ—Å–æ–±: <span id="riskTypeDisplay">–û—Ä–¥–µ—Ä–∞ –Ω–∞ –±–∏—Ä–∂–µ</span><br>
                            ‚Ä¢ –¢–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç: <span id="takeProfitDisplay">5.0%</span><br>
                            ‚Ä¢ –°—Ç–æ–ø-–ª–æ—Å—Å: <span id="stopLossDisplay">-3.0%</span>
                        </div>
                    </div>
                </div>
                
                <div id="modelInfo" class="model-info" style="display: none;">
                    <h4>üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–æ–¥–µ–ª–∏</h4>
                    <div id="modelInfoContent"></div>
                </div>
                
                <div class="button-group" id="monitoring">
                    <button class="btn btn-success" onclick="startTrading()">
                        üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ—Ä–≥–æ–≤–ª—é
                    </button>
                    <button class="btn btn-danger" onclick="stopTrading()">
                        üõë –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–æ—Ä–≥–æ–≤–ª—é
                    </button>
                </div>
                
                <div id="tradingResult" class="status" style="display: none;"></div>
                
                <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ –∞–≥–µ–Ω—Ç—ã -->
                <div class="section" style="margin-top:18px;">
                    <h2>üåê –ê–∫—Ç–∏–≤–Ω—ã–µ –∞–≥–µ–Ω—Ç—ã</h2>
                    <div id="agentsTable"></div>
                </div>
            </div>
            </div><!-- /agent-control tab-panel -->

            <!-- –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å–∏–º–≤–æ–ª–∞ –∫–∞–∫ —Ç–∞–±-–ø–∞–Ω–µ–ª—å -->
            <div class="tab-panel" data-tab-panel id="symbol-navigation">
                <div class="section">
                    <h2>üîÄ –ü–µ—Ä–µ–π—Ç–∏ –∫ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å–∏–º–≤–æ–ª–∞</h2>
                    <p>–ë—ã—Å—Ç—Ä—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –∞–≥–µ–Ω—Ç–∞ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Å–∏–º–≤–æ–ª—É</p>
                    <div class="form-group">
                        <label style="font-weight:600;">–°–∏–º–≤–æ–ª</label>
                        <select id="agentSymbolSelect" class="form-control">
                            <option value="BTCUSDT" selected>BTCUSDT</option>
                            <option value="ETHUSDT">ETHUSDT</option>
                            <option value="SOLUSDT">SOLUSDT</option>
                            <option value="TONUSDT">TONUSDT</option>
                            <option value="ADAUSDT">ADAUSDT</option>
                            <option value="BNBUSDT">BNBUSDT</option>
                            <option value="XRPUSDT">XRPUSDT</option>
                        </select>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="goToAgent()">–û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–∏–º–≤–æ–ª–∞</button>
                    </div>
                </div>
            </div>
            
            <!-- –¢–µ—Å—Ç–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
            <div class="tab-panel" data-tab-panel id="test-tab">
                <div class="section">
                    <h2>üß™ –¢–µ—Å—Ç–æ–≤–∞—è –≤–∫–ª–∞–¥–∫–∞</h2>
                    <p>–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–∞—è –≤–∫–ª–∞–¥–∫–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã —Ç–∞–±–æ–≤.</p>
                </div>
            </div>
            </div><!-- /tabs-content -->
        </div><!-- /tabs -->

            

            
            </div>
        </div>
    </div>

    <script>
        // –°–≤—è–∑—ã–≤–∞–µ–º –ø–µ—Ä–µ—Ö–æ–¥ –∏–∑ —Å–∞–π–¥–±–∞—Ä–∞ —Å –∞–∫—Ç–∏–≤–∞—Ü–∏–µ–π —Ç–∞–±–æ–≤
        document.addEventListener('DOMContentLoaded', function(){
            try{
                document.querySelectorAll('.sidebar-nav a[href^="#"]').forEach(a => {
                    a.addEventListener('click', function(){
                        const href = a.getAttribute('href');
                        if(href){
                            try{ window.__tabs && window.__tabs.activateTabByAnchor('[data-tabs="main"]', href); }catch(_){ }
                        }
                    });
                });
            }catch(_){ }
        });
        let monitoringInterval = null;
        let previousSymbol = 'BTCUSDT'; // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Å–∏–º–≤–æ–ª
        let modelsData = [];
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã/–≤—Ä–µ–º–µ–Ω–∏ –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ
        function formatMoscowDateTime(value) {
            let date;
            if (typeof value === 'string') {
                // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –±–µ–∑ —è–≤–Ω–æ–π –≤—Ä–µ–º–µ–Ω–Ω–æ–π –∑–æ–Ω—ã ‚Äî —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ —ç—Ç–æ UTC –∏ –¥–æ–±–∞–≤–ª—è–µ–º 'Z'
                const hasTimezone = /[zZ]|[\+\-]\d{2}:?\d{2}$/.test(value);
                const isoBasic = /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d+)?$/;
                const src = (!hasTimezone && isoBasic.test(value)) ? (value + 'Z') : value;
                date = new Date(src);
            } else if (typeof value === 'number') {
                // –û–∂–∏–¥–∞–µ–º –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã
                date = new Date(value);
            } else {
                date = value;
            }
            if (!date || isNaN(date.getTime())) return 'N/A';
            return date.toLocaleString('ru-RU', {
                timeZone: 'Europe/Moscow',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        }

        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–∏–º–≤–æ–ª–∞ –ø–æ ID –º–æ–¥–µ–ª–∏ (—ç–≤—Ä–∏—Å—Ç–∏–∫–∞)
        function guessSymbolFromModelId(modelId) {
            try {
                if (!modelId || typeof modelId !== 'string') return '';
                const base = modelId.split('_')[0] || '';
                if (!base) return '';
                const low = base.toLowerCase();
                if (['multi', 'multicrypto', '–º—É–ª—å—Ç–∏–≤–∞–ª—é—Ç–∞'].includes(low)) return 'MULTI';
                // –ï—Å–ª–∏ —É–∂–µ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ USDT
                if (/usdt$/i.test(base)) return base.toUpperCase();
                // –ë–∞–∑–æ–≤—ã–µ —Ç–∏–∫–µ—Ä—ã
                const known = ['btc','eth','sol','ton','ada','bnb'];
                if (known.includes(low)) return low.toUpperCase() + 'USDT';
                // –û–±—â–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞: –∫–æ—Ä–æ—Ç–∫–∏–π –±—É–∫–≤–µ–Ω–Ω—ã–π –ø—Ä–µ—Ñ–∏–∫—Å ‚Üí –¥–æ–±–∞–≤–∏—Ç—å USDT
                if (/^[a-z]{2,6}$/i.test(base)) return base.toUpperCase() + 'USDT';
                return base.toUpperCase();
            } catch (_) {
                return '';
            }
        }

        // –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Å–∏–º–≤–æ–ª
        function getPreviousSymbol() {
            return previousSymbol;
        }

        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞ –¥–ª—è —Å–∏–º–≤–æ–ª–∞
        function saveConsensusSettingsForSymbol(symbol) {
            if (!symbol) return;
            
            try {
                const flatCount = parseInt(document.getElementById('flatConsensusCount')?.value || '1', 10);
                const trendCount = parseInt(document.getElementById('trendConsensusCount')?.value || '1', 10);
                const selectedPaths = Array.from(document.querySelectorAll('.verCheck:checked')).map(i => i.value).filter(Boolean);
                
                const settings = {
                    flatCount: flatCount,
                    trendCount: trendCount,
                    selectedPaths: selectedPaths,
                    timestamp: Date.now()
                };
                
                localStorage.setItem(`consensus_${symbol}`, JSON.stringify(settings));
                console.log(`–°–æ—Ö—Ä–∞–Ω–µ–Ω—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞ –¥–ª—è ${symbol}:`, settings);
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞:', e);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞ –¥–ª—è —Å–∏–º–≤–æ–ª–∞
        function loadConsensusSettingsForSymbol(symbol) {
            if (!symbol) return;
            
            try {
                const saved = localStorage.getItem(`consensus_${symbol}`);
                if (saved) {
                    const settings = JSON.parse(saved);
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ select'–æ–≤
                    const flatSelect = document.getElementById('flatConsensusCount');
                    const trendSelect = document.getElementById('trendConsensusCount');
                    
                    if (flatSelect && typeof settings.flatCount === 'number') {
                        flatSelect.value = settings.flatCount;
                    }
                    if (trendSelect && typeof settings.trendCount === 'number') {
                        trendSelect.value = settings.trendCount;
                    }
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏ –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏
                    // (—á—Ç–æ–±—ã DOM —É—Å–ø–µ–ª –æ–±–Ω–æ–≤–∏—Ç—å—Å—è –ø–æ—Å–ª–µ renderEnsembleVersions)
                    setTimeout(() => {
                        if (settings.selectedPaths && Array.isArray(settings.selectedPaths)) {
                            // –°–Ω–∏–º–∞–µ–º –≤—Å–µ –≥–∞–ª–æ—á–∫–∏
                            document.querySelectorAll('.verCheck').forEach(checkbox => {
                                checkbox.checked = false;
                            });
                            
                            // –°—Ç–∞–≤–∏–º –≥–∞–ª–æ—á–∫–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –ø—É—Ç–µ–π
                            settings.selectedPaths.forEach(path => {
                                const checkbox = document.querySelector(`.verCheck[value="${path}"]`);
                                if (checkbox) {
                                    checkbox.checked = true;
                                }
                            });
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞ –ë–ï–ó –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Redis
                            // (—á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏)
                            syncConsensusSelectsMax();
                            const selectedCount = Math.max(1, Array.from(document.querySelectorAll('.verCheck:checked')).length);
                            const flatSelect = document.getElementById('flatConsensusCount');
                            const trendSelect = document.getElementById('trendConsensusCount');
                            if (!flatSelect || !trendSelect) return;
                            const flatCount = parseInt(flatSelect.value || '1', 10);
                            const trendCount = parseInt(trendSelect.value || '1', 10);
                            const toPct = (count) => Math.round((count / selectedCount) * 100);
                            const flatPct = toPct(flatCount);
                            const trendPct = toPct(trendCount);
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º UI –±–µ–∑ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Redis
                            const plural = (n) => (n === 1 ? '–º–æ–¥–µ–ª—å' : (n >= 2 && n <= 4 ? '–º–æ–¥–µ–ª–∏' : '–º–æ–¥–µ–ª–µ–π'));
                            const flatBadge = document.getElementById('flatConsensusCountValue');
                            const trendBadge = document.getElementById('trendConsensusCountValue');
                            if (flatBadge) flatBadge.textContent = `${flatCount} ${plural(flatCount)}`;
                            if (trendBadge) trendBadge.textContent = `${trendCount} ${plural(trendCount)}`;
                            
                            const flatHint = document.getElementById('flatConsensusPercentHint');
                            const trendHint = document.getElementById('trendConsensusPercentHint');
                            if (flatHint) flatHint.textContent = `‚âà ${flatPct}% –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö`;
                            if (trendHint) trendHint.textContent = `‚âà ${trendPct}% –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö`;
                            
                            const flatDisp = document.getElementById('flatConsensusDisplay');
                            const trendDisp = document.getElementById('trendConsensusDisplay');
                            if (flatDisp) flatDisp.textContent = `${flatCount} –∏–∑ ${selectedCount} –º–æ–¥–µ–ª–µ–π (${flatPct}%)`;
                            if (trendDisp) trendDisp.textContent = `${trendCount} –∏–∑ ${selectedCount} –º–æ–¥–µ–ª–µ–π (${trendPct}%)`;
                            
                            console.log(`UI –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è ${symbol}: flat=${flatCount}, trend=${trendCount}, selected=${selectedCount}`);
                            
                            // –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Redis –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ - —Ç–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–ª—è–µ–º UI
                        }
                    }, 100);
                    
                    console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞ –¥–ª—è ${symbol}:`, settings);
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞:', e);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω—Å–∞–º–±–ª–µ–π –∏ –≤–µ—Ä—Å–∏–π
        async function onEnsembleSymbolChange() {
            const symSel = document.getElementById('ensembleSymbolSelect');
            const symbol = symSel ? (symSel.value || 'BTCUSDT') : 'BTCUSDT';
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞ –¥–ª—è –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–∏–º–≤–æ–ª–∞
            saveConsensusSettingsForSymbol(getPreviousSymbol());
            
            try {
                const resp = await fetch('/list_ensembles?symbol=' + encodeURIComponent(symbol));
                const data = await resp.json();
                const ensSel = document.getElementById('ensembleSelect');
                const box = document.getElementById('ensembleVersions');
                if (!ensSel || !box) return;
                if (!data.success) {
                    ensSel.innerHTML = '<option value="">–ù–µ—Ç –∞–Ω—Å–∞–º–±–ª–µ–π</option>';
                    box.innerHTML = '<em>–ê–Ω—Å–∞–º–±–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</em>';
                    return;
                }
                const names = Object.keys(data.ensembles || {});
                ensSel.innerHTML = names.length ? names.map(n => `<option value="${n}">${n}</option>`).join('') : '<option value="">–ù–µ—Ç –∞–Ω—Å–∞–º–±–ª–µ–π</option>';
                ensSel.value = names[0] || 'ensemble-a';
                ensSel.dataset.payload = JSON.stringify(data.ensembles || {});
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
                loadConsensusSettingsForSymbol(symbol);
                
                renderEnsembleVersions();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Å–∏–º–≤–æ–ª
                previousSymbol = symbol;
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ —Å–ø–∏—Å–∫–∞ –∞–Ω—Å–∞–º–±–ª–µ–π', e);
            }
        }

        function renderEnsembleVersions() {
            const ensSel = document.getElementById('ensembleSelect');
            const box = document.getElementById('ensembleVersions');
            if (!ensSel || !box) return;
            try {
                const ensembles = JSON.parse(ensSel.dataset.payload || '{}');
                const name = ensSel.value;
                const ens = ensembles[name] || { versions: [] };
                if (!ens.versions || ens.versions.length === 0) {
                    box.innerHTML = '<em>–í–µ—Ä—Å–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</em>';
                    return;
                }
                // –†–∏—Å—É–µ–º —á–µ–∫–±–æ–∫—Å—ã –≤–µ—Ä—Å–∏–π
                const header = `
                    <div class=\"vt-row vt-head\">
                        <div class=\"c-check\">–í—ã–±.</div>
                        <div>–í–µ—Ä—Å–∏—è</div>
                        <div>–ú–æ–¥–µ–ª—å</div>
                        <div>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
                    </div>`;
                const rows = ens.versions.map(v => {
                    const modelFile = v.files && v.files.model ? v.files.model : '';
                    const path = `${v.path}/${modelFile}`;
                    const id = `ver_${name}_${v.version}`;
                    const stats = v.stats || {};
                    const winrate = (typeof stats.winrate === 'number') ? (stats.winrate * 100).toFixed(1) + '%' : '‚Äî';
                    const plr = (typeof stats.pl_ratio === 'number') ? stats.pl_ratio.toFixed(2) : '‚Äî';
                    const trades = (typeof stats.trades_count === 'number') ? stats.trades_count : '‚Äî';
                    
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º ID –º–æ–¥–µ–ª–∏ –∏–∑ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω, –∏–Ω–∞—á–µ –∏–º—è —Ñ–∞–π–ª–∞
                    const modelDisplay = (v.manifest_id && v.manifest_id !== '') ? v.manifest_id : (modelFile || '‚Äî');
                    
                    return `
                        <div class=\"vt-row\">
                            <div class=\"c-check\"><input type=\"checkbox\" class=\"verCheck\" value=\"${path}\" data-version=\"${v.version}\" onchange=\"updateConsensusDisplay(); saveConsensusSettingsForSymbol(document.getElementById('ensembleSymbolSelect')?.value || 'BTCUSDT')\"></div>
                            <div><span style=\"font-weight:600;\">${v.version}</span></div>
                            <div><code>${modelDisplay}</code></div>
                            <div style=\"font-size:12px;color:#555;\">Winrate: ${winrate} ¬∑ P/L: ${plr} ¬∑ Trades: ${trades}</div>
                        </div>`;
                }).join('');
                box.innerHTML = `<div class=\"versions-table\">${header}${rows}</div>`;
                updateConsensusDisplay();
            } catch (e) {
                box.innerHTML = '<em>–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤–µ—Ä—Å–∏–π</em>';
            }
        }

        // –ë—ã—Å—Ç—Ä—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∞–≥–µ–Ω—Ç–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
        function goToAgent(){
            const sym = document.getElementById('agentSymbolSelect')?.value || 'BTCUSDT';
            window.location.href = '/agent/' + encodeURIComponent(sym);
        }

        // –ó–∞–ø—É—Å–∫ —Ç–æ—Ä–≥–æ–≤–ª–∏
        async function startTrading() {
            const symbol = (document.getElementById('ensembleSymbolSelect')?.value) || 'BTCUSDT';
            const selectedSymbols = [symbol];
            
            // –°–æ–±–∏—Ä–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ –∏–∑ —á–µ–∫–±–æ–∫—Å–æ–≤
            const selectedPaths = Array.from(document.querySelectorAll('.verCheck:checked')).map(i => i.value).filter(Boolean);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º
            saveConsensusSettingsForSymbol(symbol);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞ –≤ Redis –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Ç–æ—Ä–≥–æ–≤–ª–∏
            try {
                const consensusSettings = getConsensusSettings();
                console.log('[UI] Sending to Redis on START:', { 
                    symbols: [symbol],
                    model_paths: selectedPaths,
                    consensus: consensusSettings
                });
                await fetch('/api/trading/save_config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        symbols: [symbol],
                        model_paths: selectedPaths,
                        consensus: consensusSettings
                    })
                });
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞ –≤ Redis:', e);
            }
            if (selectedPaths.length === 0) {
                showStatus('tradingResult', 'error', '–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –≤–µ—Ä—Å–∏—é –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è');
                return;
            }
            
            if (selectedSymbols.length === 0 || !selectedSymbols[0]) {
                showStatus('tradingResult', 'error', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Ç–æ—Ä–≥–æ–≤—É—é –ø–∞—Ä—É');
                return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ /api/trading/start
            const consensusSettings = getConsensusSettings();
            const accountSel = document.getElementById('bybitAccountSelect');
            const accountId = accountSel ? (accountSel.value || '') : '';
            
            // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∏—Å–∫-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç–∞
            const takeProfitPct = parseFloat(document.getElementById('takeProfitPct')?.value || '5');
            const stopLossPct = parseFloat(document.getElementById('stopLossPct')?.value || '3');
            const riskType = document.getElementById('riskManagementType')?.value || 'exchange_orders';
            
            try {
                const response = await fetch('/api/trading/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        symbols: selectedSymbols,
                        model_paths: selectedPaths,
                        consensus: consensusSettings,
                        account_id: accountId,
                        take_profit_pct: takeProfitPct,
                        stop_loss_pct: stopLossPct,
                        risk_management_type: riskType
                    })
                });
                
                const result = await response.json();
                showStatus('tradingResult', result.success ? 'success' : 'error', 
                    result.success ? result.message : result.error);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
                if (result.success) {
                    setTimeout(loadAgents, 1000);
                }
                
                if (result.success) {
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞
                    setTimeout(getTradingStatus, 1000);
                    // –ò –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤
                    try { setTimeout(loadAgents, 800); } catch(_) {}
                }
            } catch (error) {
                showStatus('tradingResult', 'error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Ç–æ—Ä–≥–æ–≤–ª–∏: ' + error.message);
            }
        }

        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–æ—Ä–≥–æ–≤–ª–∏
        async function stopTrading() {
            try {
                const symbol = (document.getElementById('ensembleSymbolSelect')?.value) || 'BTCUSDT';
                const response = await fetch('/api/trading/stop_symbol', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol })
                });
                const result = await response.json();
                showStatus('tradingResult', result.success ? 'success' : 'error', result.success ? '–¢–æ—Ä–≥–æ–≤–ª—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞' : (result.error||'–û—à–∏–±–∫–∞'));
                if (result.success) {
                    setTimeout(()=>{ getTradingStatus(); loadAgents(); }, 800);
                }
            } catch (error) {
                showStatus('tradingResult', 'error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ —Ç–æ—Ä–≥–æ–≤–ª–∏: ' + error.message);
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Ç–æ—Ä–≥–æ–≤–ª–∏ (–æ—Å—Ç–∞–≤–ª—è–µ–º –¥–ª—è —Å—Ç–∞—Ä—Ç/—Å—Ç–æ–ø –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏)
        async function getTradingStatus() {
            try {
                const response = await fetch('/api/trading/status');
                const result = await response.json();
                
                if (result.success) {
                    const statusDiv = document.getElementById('tradingStatus');
                    const contentDiv = document.getElementById('statusContent');
                    if (!statusDiv || !contentDiv) {
                        // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –Ω–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ ‚Äî —Ç–∏—Ö–æ –≤—ã—Ö–æ–¥–∏–º
                        return;
                    }

                    let statusHTML = `
                        <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${result.trading_status_full || result.trading_status || (result.is_trading ? 'üü¢ –ê–∫—Ç–∏–≤–Ω–∞' : 'üî¥ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞')}</p>
                        <p><strong>–ü–∞—Ä–∞:</strong> ${result.symbol_display || result.symbol || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</p>
                        <p><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</strong> ${result.amount_display || result.amount || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                        <p><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ USDT:</strong> ${result.amount_usdt ? '$' + result.amount_usdt.toFixed(2) : '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                        <p><strong>–ü–æ–∑–∏—Ü–∏—è:</strong> ${result.position ? '–û—Ç–∫—Ä—ã—Ç–∞' : '–ù–µ—Ç'}</p>
                        <p><strong>–°–¥–µ–ª–æ–∫:</strong> ${result.trades_count}</p>
                        <p><strong>–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞:</strong> ${result.current_price ? '$' + result.current_price.toFixed(2) : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</p>
                        ${result.last_model_prediction ? `<p><strong>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ:</strong> ${result.last_model_prediction}</p>` : ''}
                    `;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –¥–ª—è –æ—Å—Ç–∞–≤—à–µ–π—Å—è –ø–æ–∑–∏—Ü–∏–∏, –µ—Å–ª–∏ –µ—Å—Ç—å
                    if (result.position && result.position.partial_sell_strategy) {
                        showRemainingPositionStrategy(result.position.partial_sell_strategy);
                    } else {
                        // –°–∫—Ä—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏, –µ—Å–ª–∏ –µ—Å—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                        const rps = document.getElementById('remainingPositionStrategy');
                        if (rps) rps.style.display = 'none';
                    }
                    
                    contentDiv.innerHTML = statusHTML;
                    statusDiv.style.display = 'block';
                } else {
                    showStatus('tradingResult', 'error', result.error);
                }
            } catch (error) {
                showStatus('tradingResult', 'error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞: ' + error.message);
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
        async function getBalance() {
            try {
                const response = await fetch('/api/trading/balance');
                const result = await response.json();
                
                if (result.success) {
                    const balanceDiv = document.getElementById('balanceStatus');
                    const contentDiv = document.getElementById('balanceContent');
                    
                    contentDiv.innerHTML = `
                        <p><strong>USDT:</strong> ${result.balance.USDT.toFixed(2)}</p>
                        <p><strong>BTC:</strong> ${result.balance.BTC.toFixed(8)}</p>
                    `;
                    
                    balanceDiv.style.display = 'block';
                } else {
                    showStatus('tradingResult', 'error', result.error);
                }
            } catch (error) {
                showStatus('tradingResult', 'error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞: ' + error.message);
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Ç–æ—Ä–≥–æ–≤–ª–∏ (–±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ)
        async function getTradingHistory() {
            try {
                const response = await fetch('/api/trading/history');
                const result = await response.json();
                
                if (result.success) {
                    const historyDiv = document.getElementById('tradingHistory');
                    const contentDiv = document.getElementById('historyContent');
                    
                    // 1) –ü–æ–¥—Ç—è–Ω–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä—è–¥–æ–º —Å –∏—Å—Ç–æ—Ä–∏–µ–π
                    let positionHTML = '';
                    try {
                        const statusResp = await fetch('/api/trading/status');
                        const statusJson = await statusResp.json();
                        if (statusJson && (statusJson.success || statusJson.agent_status)) {
                            const agent = statusJson.agent_status || statusJson;
                            const position = agent.position;
                            const currentPrice = agent.current_price;
                            if (position && position.amount && position.amount > 0) {
                                const entryPrice = position.entry_price || 0;
                                const pnlAbs = currentPrice && entryPrice ? (currentPrice - entryPrice) * position.amount : 0;
                                const pnlPct = currentPrice && entryPrice ? ((currentPrice - entryPrice) / entryPrice) * 100 : 0;
                                const entryTime = position.entry_time ? formatMoscowDateTime(position.entry_time) : '';
                                positionHTML = `
                                    <div class="trade-item" style="border-left:4px solid #28a745;">
                                        <div class="trade-header">
                                            <span class="trade-action buy">–¢–ï–ö–£–©–ê–Ø –ü–û–ó–ò–¶–ò–Ø (${position.type?.toUpperCase() || 'LONG'})</span>
                                            ${entryTime ? `<span>–û—Ç–∫—Ä—ã—Ç–∞: ${entryTime}</span>` : ''}
                                        </div>
                                        <div class="trade-details">
                                            <div class="trade-detail">
                                                <div class="label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</div>
                                                <div class="value">${position.amount}</div>
                                            </div>
                                            <div class="trade-detail">
                                                <div class="label">–¶–µ–Ω–∞ –≤—Ö–æ–¥–∞</div>
                                                <div class="value">$${entryPrice ? entryPrice.toFixed(2) : 'N/A'}</div>
                                            </div>
                                            <div class="trade-detail">
                                                <div class="label">–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞</div>
                                                <div class="value">$${currentPrice ? currentPrice.toFixed(2) : 'N/A'}</div>
                                            </div>
                                            <div class="trade-detail">
                                                <div class="label">P&L</div>
                                                <div class="value" style="color:${pnlAbs >= 0 ? 'green' : 'red'}">
                                                    ${pnlAbs >= 0 ? '+' : ''}$${pnlAbs.toFixed(4)} (${pnlPct >= 0 ? '+' : ''}${pnlPct.toFixed(2)}%)
                                                </div>
                                            </div>
                                            ${position.trade_number ? `
                                            <div class="trade-detail">
                                                <div class="label">Trade #</div>
                                                <div class="value">${position.trade_number}</div>
                                            </div>` : ''}
                                        </div>
                                    </div>
                                `;
                            } else {
                                positionHTML = `
                                    <div class="trade-item" style="border-left:4px solid #6c757d;">
                                        <div class="trade-header">
                                            <span class="trade-action hold">–¢–ï–ö–£–©–ê–Ø –ü–û–ó–ò–¶–ò–Ø</span>
                                            <span>–Ω–µ—Ç –æ—Ç–∫—Ä—ã—Ç–æ–π –ø–æ–∑–∏—Ü–∏–∏</span>
                                        </div>
                                    </div>
                                `;
                            }
                        }
                    } catch (e) {
                        // –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —Å—Ç–∞—Ç—É—Å–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–∏—à—å –∏—Å—Ç–æ—Ä–∏—é
                    }

                    // 2) –ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫
                    if (result.trades && result.trades.length > 0) {
                        let historyHTML = `<p><strong>–í—Å–µ–≥–æ —Å–¥–µ–ª–æ–∫:</strong> ${result.total_trades}</p>`;
                        
                        result.trades.forEach((trade, index) => {
                            const tradeTime = formatMoscowDateTime(trade.time);
                            const actionClass = trade.action === 'buy' ? 'buy' : 'sell';
                            
                            historyHTML += `
                                <div class="trade-item">
                                    <div class="trade-header">
                                        <span class="trade-action ${actionClass}">${trade.action.toUpperCase()}</span>
                                        <span>${tradeTime}</span>
                                    </div>
                                    <div class="trade-details">
                                        <div class="trade-detail">
                                            <div class="label">–¶–µ–Ω–∞</div>
                                            <div class="value">$${trade.price}</div>
                                        </div>
                                        <div class="trade-detail">
                                            <div class="label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</div>
                                            <div class="value">${trade.amount}</div>
                                        </div>
                                        ${trade.pnl ? `
                                        <div class="trade-detail">
                                            <div class="label">P&L</div>
                                            <div class="value" style="color: ${trade.pnl >= 0 ? 'green' : 'red'}">
                                                ${trade.pnl >= 0 ? '+' : ''}$${trade.pnl.toFixed(4)}
                                            </div>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        });
                        
                        contentDiv.innerHTML = positionHTML + historyHTML;
                    } else {
                        const emptyHTML = '<p>üìà –ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫ –ø–æ–∫–∞ –ø—É—Å—Ç–∞</p><p><em>–°–¥–µ–ª–∫–∏ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–æ—Ä–≥–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π</em></p>';
                        contentDiv.innerHTML = positionHTML + emptyHTML;
                    }
                    
                    historyDiv.style.display = 'block';
                } else {
                    const historyDiv = document.getElementById('tradingHistory');
                    const contentDiv = document.getElementById('historyContent');
                    contentDiv.innerHTML = '<p>‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏</p><p><em>' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</em></p>';
                    historyDiv.style.display = 'block';
                }
            } catch (error) {
                const historyDiv = document.getElementById('tradingHistory');
                const contentDiv = document.getElementById('historyContent');
                contentDiv.innerHTML = '<p>‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏</p><p><em>' + error.message + '</em></p>';
                historyDiv.style.display = 'block';
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–æ—Ä–≥–æ–≤–ª–∏ –∏–∑ Celery
        async function getTradingResults(showAll = false) {
            try {
                const response = await fetch('/api/trading/latest_results');
                const result = await response.json();
                
                if (result.success) {
                    const resultsDiv = document.getElementById('tradingResults');
                    const contentDiv = document.getElementById('tradingResultsContent');
                    const titleDiv = document.getElementById('tradingResultsTitle');
                    
                    if (result.latest_results && result.latest_results.length > 0) {
                        // –§–∏–ª—å—Ç—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ showAll
                        let filteredResults;
                        if (showAll) {
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                            filteredResults = result.latest_results;
                        } else {
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–µ —Ç–æ—Ä–≥–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏ –æ—à–∏–±–∫–∏
                            filteredResults = result.latest_results.filter(tradeResult => {
                                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏:
                                // 1. –ë—ã–ª–∞ —Ä–µ–∞–ª—å–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è (trade_executed === true)
                                // 2. –ò–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ (exit_code !== 0)
                                // 3. –ò–ª–∏ —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ HOLD –±–µ–∑ —Ç–æ—Ä–≥–æ–≤–ª–∏
                                return tradeResult.trade_executed === true || 
                                       tradeResult.exit_code !== 0 || 
                                       (tradeResult.parsed_result && tradeResult.parsed_result.action && 
                                        tradeResult.parsed_result.action !== 'hold');
                            });
                        }

                        const sectionTitle = showAll ? '–í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–æ—Ä–≥–æ–≤–ª–∏ (–≤–∫–ª—é—á–∞—è HOLD)' : '–†–µ–∞–ª—å–Ω—ã–µ —Ç–æ—Ä–≥–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏';
                        let resultsHTML = `<p><strong>–í—Å–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:</strong> ${result.total_results} | <strong>–ü–æ–∫–∞–∑–∞–Ω–æ:</strong> ${filteredResults.length}</p>`;
                        
                        if (filteredResults.length === 0) {
                            if (showAll) {
                                contentDiv.innerHTML = '<p>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p><p><em>–°–∏—Å—Ç–µ–º–∞ –µ—â–µ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–ª–∞ –Ω–∏–∫–∞–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π</em></p>';
                            } else {
                                contentDiv.innerHTML = '<p>üìä –†–µ–∞–ª—å–Ω—ã—Ö —Ç–æ—Ä–≥–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</p><p><em>–°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ä–µ–∂–∏–º–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞, –æ–∂–∏–¥–∞—è —Ç–æ—Ä–≥–æ–≤—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤</em></p><p><small>üí° –ù–∞–∂–º–∏—Ç–µ "üîç –í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (–≤–∫–ª—é—á–∞—è HOLD)" —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –≤—Å–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã</small></p>';
                            }
                            resultsDiv.style.display = 'block';
                            return;
                        }
                        
                        filteredResults.forEach((tradeResult, index) => {
                            const resultTime = formatMoscowDateTime(tradeResult.timestamp);
                            
                            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                            let resultType, resultClass, resultIcon;
                            if (tradeResult.exit_code !== 0) {
                                resultType = '–û–®–ò–ë–ö–ê';
                                resultClass = 'error';
                                resultIcon = '‚ùå';
                            } else if (tradeResult.trade_executed === true) {
                                resultType = '–°–î–ï–õ–ö–ê';
                                resultClass = 'success';
                                resultIcon = 'üí∞';
                            } else {
                                resultType = '–ê–ö–¢–ò–í–ù–û–°–¢–¨';
                                resultClass = 'info';
                                resultIcon = 'üîç';
                            }
                            
                            // –ë–ª–æ–∫ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π –ø–æ –º–æ–¥–µ–ª—è–º (–µ—Å–ª–∏ –µ—Å—Ç—å)
                            let predsBlock = '';
                            try {
                                const preds = Array.isArray(tradeResult.predictions) ? tradeResult.predictions : [];
                                if (preds.length > 0) {
                                    const rows = preds.map(p => {
                                        const qvals = Array.isArray(p.q_values) ? '[' + p.q_values.map(v => Number(v).toFixed(3)).join(', ') + ']' : '‚Äî';
                                        const conf = (typeof p.confidence === 'number') ? (p.confidence * 100).toFixed(1) + '%' : '‚Äî';
                                        const fname = (p.model_path || '').split('/').pop();
                                        return `<div class="vt-row"><div><code>${fname || 'model.pth'}</code></div><div>${(p.action||'').toUpperCase()}</div><div>${conf}</div><div>${qvals}</div></div>`;
                                    }).join('');
                                    predsBlock = `
                                        <div style="margin-top:10px;">
                                            <div style="font-weight:600; margin-bottom:6px;">–ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –ø–æ –º–æ–¥–µ–ª—è–º (${preds.length})</div>
                                            <div class="versions-table">
                                                <div class="vt-row vt-head"><div>–ú–æ–¥–µ–ª—å</div><div>–î–µ–π—Å—Ç–≤–∏–µ</div><div>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å</div><div>Q-Values</div></div>
                                                ${rows}
                                            </div>
                                        </div>`;
                                }
                            } catch(_) {}

                            // –ö–æ–Ω—Å–µ–Ω—Å—É—Å (–µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–≤–∞–ª–∏)
                            let consensusBlock = '';
                            try {
                                const c = tradeResult.consensus || {};
                                const counts = c.counts || {};
                                const perc = c.percents || {};
                                if (counts.flat || counts.trend) {
                                    const total = counts.total_selected || (Array.isArray(tradeResult.model_paths) ? tradeResult.model_paths.length : null);
                                    const flatLine = (counts.flat && total) ? `${counts.flat} –∏–∑ ${total} (${perc.flat!=null?perc.flat+'%':'~'})` : '';
                                    const trendLine = (counts.trend && total) ? `${counts.trend} –∏–∑ ${total} (${perc.trend!=null?perc.trend+'%':'~'})` : '';
                                    consensusBlock = `
                                        <div style="margin-top:8px; font-size:12px; color:#555;">
                                            <div><strong>–ö–æ–Ω—Å–µ–Ω—Å—É—Å:</strong></div>
                                            ${flatLine ? `<div>–ë–æ–∫–æ–≤–∏–∫: ${flatLine}</div>` : ''}
                                            ${trendLine ? `<div>–¢—Ä–µ–Ω–¥: ${trendLine}</div>` : ''}
                                        </div>`;
                                }
                            } catch(_) {}

                            resultsHTML += `
                                <div class="trade-item">
                                    <div class="trade-header">
                                        <span class="trade-action ${resultClass}">${resultIcon} ${resultType}</span>
                                        <span>${resultTime}</span>
                                    </div>
                                    <div class="trade-details">
                                        <div class="trade-detail">
                                            <div class="label">–°–∏–º–≤–æ–ª—ã</div>
                                            <div class="value">${tradeResult.symbols ? tradeResult.symbols.join(', ') : 'N/A'}</div>
                                        </div>
                                        <div class="trade-detail">
                                            <div class="label">–ö–æ–¥ –≤—ã—Ö–æ–¥–∞</div>
                                            <div class="value">${tradeResult.exit_code}</div>
                                        </div>
                                        ${tradeResult.trade_type ? `
                                        <div class="trade-detail">
                                            <div class="label">–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏</div>
                                            <div class="value">${tradeResult.trade_type.toUpperCase()}</div>
                                        </div>
                                        ` : ''}
                                        ${tradeResult.parsed_result ? `
                                        <div class="trade-detail">
                                            <div class="label">–î–µ–π—Å—Ç–≤–∏–µ</div>
                                            <div class="value">${tradeResult.parsed_result.action || 'N/A'}</div>
                                        </div>
                                        <div class="trade-detail">
                                            <div class="label">–¶–µ–Ω–∞</div>
                                            <div class="value">$${tradeResult.parsed_result.price || 'N/A'}</div>
                                        </div>
                                        ${tradeResult.parsed_result.trade_executed ? `
                                        <div class="trade-detail">
                                            <div class="label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
                                            <div class="value">${tradeResult.parsed_result.trade_executed}</div>
                                        </div>
                                        ` : ''}
                                        ${tradeResult.parsed_result.position_pnl ? `
                                        <div class="trade-detail">
                                            <div class="label">P&L –ø–æ–∑–∏—Ü–∏–∏</div>
                                            <div class="value" style="color: ${tradeResult.parsed_result.position_pnl >= 0 ? 'green' : 'red'}">
                                                ${tradeResult.parsed_result.position_pnl >= 0 ? '+' : ''}${tradeResult.parsed_result.position_pnl.toFixed(2)}%
                                            </div>
                                        </div>
                                        ` : ''}
                                        ` : ''}
                                    </div>
                                    ${consensusBlock}
                                    ${predsBlock}
                                    ${tradeResult.parse_error ? `
                                    <div style="margin-top: 10px; padding: 10px; background: #f8d7da; border-radius: 5px; font-size: 12px;">
                                        <strong>–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:</strong> ${tradeResult.parse_error}
                                    </div>
                                    ` : ''}
                                </div>
                            `;
                        });
                        
                        contentDiv.innerHTML = resultsHTML;
                        titleDiv.textContent = `üìä ${sectionTitle}`;
                    } else {
                        contentDiv.innerHTML = '<p>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–æ—Ä–≥–æ–≤–ª–∏ –ø–æ–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</p><p><em>–î–∞–Ω–Ω—ã–µ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–æ—Ä–≥–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —á–µ—Ä–µ–∑ Celery</em></p>';
                        titleDiv.textContent = 'üìä –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–æ—Ä–≥–æ–≤–ª–∏ (Celery)';
                    }
                    
                    resultsDiv.style.display = 'block';
                } else {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:', result.error);
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ —Å –æ—à–∏–±–∫–æ–π
                    const resultsDiv = document.getElementById('tradingResults');
                    const contentDiv = document.getElementById('tradingResultsContent');
                    const titleDiv = document.getElementById('tradingResultsTitle');
                    contentDiv.innerHTML = '<p>‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</p><p><em>' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</em></p>';
                    titleDiv.textContent = 'üìä –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–æ—Ä–≥–æ–≤–ª–∏ (Celery)';
                    resultsDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–æ—Ä–≥–æ–≤–ª–∏:', error);
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ —Å –æ—à–∏–±–∫–æ–π
                const resultsDiv = document.getElementById('tradingResults');
                const contentDiv = document.getElementById('tradingResultsContent');
                const titleDiv = document.getElementById('tradingResultsTitle');
                contentDiv.innerHTML = '<p>‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏</p><p><em>' + error.message + '</em></p>';
                titleDiv.textContent = 'üìä –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–æ—Ä–≥–æ–≤–ª–∏ (Celery)';
                resultsDiv.style.display = 'block';
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Å–¥–µ–ª–æ–∫ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        async function getTradeHistory() {
            try {
                const symSel = document.getElementById('ensembleSymbolSelect');
                const symbol = symSel ? (symSel.value || '') : '';
                const qs = new URLSearchParams({
                    limit_trades: '400',
                    limit_predictions: '2000',
                    tolerance_buckets: '2',
                    ...(symbol ? { symbol } : {})
                }).toString();
                const resp = await fetch('/api/trades/matched_full?' + qs);
                const data = await resp.json();
                const historyDiv = document.getElementById('tradeHistory');
                const contentDiv = document.getElementById('tradeHistoryContent');
                
                if (!data.success) {
                    contentDiv.innerHTML = '<p>‚ùå –û—à–∏–±–∫–∞ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è</p><p><em>' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</em></p>';
                    historyDiv.style.display = 'block';
                    return;
                }

                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º —Å—ã—Ä—ã–µ —Å–¥–µ–ª–∫–∏ –∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–π —Å–≤–µ—Ä–∫–∏
                const tradesUrl = symbol ? (`/api/trades/by_symbol/${encodeURIComponent(symbol)}?limit=200`) : '/api/trades/recent?limit=200';
                const predsUrl = '/api/predictions/recent?limit=500' + (symbol ? ('&symbol=' + encodeURIComponent(symbol)) : '');
                let tradesJson = { success: false }, predsJson = { success: false };
                try {
                    const [tResp, pResp] = await Promise.all([fetch(tradesUrl), fetch(predsUrl)]);
                    tradesJson = await tResp.json();
                    predsJson = await pResp.json();
                } catch (_) {}

                // –•–µ–ª–ø–µ—Ä—ã –¥–ª—è —Å–≤–µ—Ä–∫–∏
                const toMs = (v) => {
                    if (!v) return null;
                    try {
                        if (typeof v === 'number') return v;
                        const s = String(v);
                        const hasTimezone = /[zZ]|[\+\-]\d{2}:?\d{2}$/.test(s);
                        const isoBasic = /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d+)?$/;
                        const src = (!hasTimezone && isoBasic.test(s)) ? (s + 'Z') : s;
                        const d = new Date(src);
                        const t = d.getTime();
                        return isNaN(t) ? null : t;
                    } catch (_) { return null; }
                };
                const bucket5m = (ms) => (ms == null ? null : Math.floor(ms / 300000));

                // –ì–æ—Ç–æ–≤–∏–º —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–ø–∏—Å–∫–∏ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–π —Å–≤–µ—Ä–∫–∏
                const trades = (tradesJson && tradesJson.success && Array.isArray(tradesJson.trades)) ? tradesJson.trades : [];
                const tBuyLines = [];
                const tSellLines = [];
                for (const t of trades) {
                    const ts = toMs(t.executed_at) ?? toMs(t.created_at) ?? toMs(t.time);
                    const bk = bucket5m(ts);
                    const priceNum = Number(t.price);
                    const qtyNum = Number(t.quantity || t.amount || 0);
                    const act = (t.action || '').toLowerCase();
                    const actDisplay = act === 'sell_partial' ? 'SELL_PARTIAL' : (t.action?.toUpperCase());
                    const line = `${formatMoscowDateTime(ts)} | ${t.symbol} | ${actDisplay} | $${priceNum.toFixed(4)} | qty=${qtyNum} | b=${bk}`;
                    if (act === 'buy') tBuyLines.push(line);
                    if (act === 'sell' || act === 'sell_partial') tSellLines.push(line);
                }

                const predictions = (predsJson && predsJson.success && Array.isArray(predsJson.predictions)) ? predsJson.predictions : [];
                const pBuyLines = [];
                const pSellLines = [];
                for (const p of predictions) {
                    const ts = toMs(p.timestamp);
                    const bk = bucket5m(ts);
                    const conf = (typeof p.confidence === 'number') ? (p.confidence * 100).toFixed(1) + '%' : '‚Äî';
                    const line = `${formatMoscowDateTime(ts)} | ${p.symbol} | ${p.action?.toUpperCase()} | conf=${conf} | b=${bk}`;
                    if ((p.action || '').toLowerCase() === 'buy') pBuyLines.push(line);
                    if ((p.action || '').toLowerCase() === 'sell') pSellLines.push(line);
                }

                const debugHTML = `
                    <div class="trade-item">
                                    <div class="trade-header">
                            <span>–°–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö (—Å–∏–º–≤–æ–ª: ${symbol || '‚Äî'})</span>
                                    </div>
                        <div class="trade-details" style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                            <div>
                                <div class="label" style="font-weight:600; margin-bottom:6px;">–°–¥–µ–ª–∫–∏ (Bybit)</div>
                                <div style="font-size:12px; color:#444;">
                                    <div><strong>BUY (${tBuyLines.length})</strong></div>
                                    <pre style="white-space:pre-wrap; margin:6px 0;">${tBuyLines.join('\n')}</pre>
                                    <div><strong>SELL (${tSellLines.length})</strong></div>
                                    <pre style="white-space:pre-wrap; margin:6px 0;">${tSellLines.join('\n')}</pre>
                                        </div>
                                        </div>
                            <div>
                                <div class="label" style="font-weight:600; margin-bottom:6px;">–ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è (–ë–î)</div>
                                <div style="font-size:12px; color:#444;">
                                    <div><strong>BUY (${pBuyLines.length})</strong></div>
                                    <pre style="white-space:pre-wrap; margin:6px 0;">${pBuyLines.join('\n')}</pre>
                                    <div><strong>SELL (${pSellLines.length})</strong></div>
                                    <pre style="white-space:pre-wrap; margin:6px 0;">${pSellLines.join('\n')}</pre>
                                        </div>
                                        </div>
                                            </div>
                                        </div>
                `;

                const pairs = Array.isArray(data.pairs) ? data.pairs : [];
                if (pairs.length === 0) {
                    contentDiv.innerHTML = debugHTML + '<p>–ù–µ—Ç –ø–æ–ª–Ω—ã—Ö —Å–æ–≤–ø–∞–≤—à–∏—Ö —Å–¥–µ–ª–æ–∫ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.</p>';
                    historyDiv.style.display = 'block';
                    return;
                }

                let html = `<p><strong>–ù–∞–π–¥–µ–Ω–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π:</strong> ${pairs.length}</p>`;
                for (const d of pairs) {
                    const pnlColor = (d.pnl_abs || 0) >= 0 ? 'green' : 'red';
                    const buyConf = (d.pred_buy && typeof d.pred_buy.confidence === 'number') ? (d.pred_buy.confidence * 100).toFixed(1) + '%' : '‚Äî';
                    const sellConf = (d.pred_sell && typeof d.pred_sell.confidence === 'number') ? (d.pred_sell.confidence * 100).toFixed(1) + '%' : '‚Äî';
                    const buyQ = d.pred_buy && Array.isArray(d.pred_buy.q_values) ? d.pred_buy.q_values.map(v=>Number(v).toFixed(3)).join(', ') : '‚Äî';
                    const sellQ = d.pred_sell && Array.isArray(d.pred_sell.q_values) ? d.pred_sell.q_values.map(v=>Number(v).toFixed(3)).join(', ') : '‚Äî';

                    html += `
                        <div class="trade-item">
                            <div class="trade-header">
                                <span class="trade-action buy">BUY</span>
                                <span>${formatMoscowDateTime(d.entry_time)}</span>
                                <span class="trade-action sell">‚Üí SELL</span>
                                <span>${formatMoscowDateTime(d.exit_time)}</span>
                                        </div>
                            <div class="trade-details">
                                <div class="trade-detail"><div class="label">–°–∏–º–≤–æ–ª</div><div class="value">${d.symbol}</div></div>
                                <div class="trade-detail"><div class="label">–í—Ö–æ–¥</div><div class="value">$${Number(d.entry_price).toFixed(4)}</div></div>
                                <div class="trade-detail"><div class="label">–í—ã—Ö–æ–¥</div><div class="value">$${Number(d.exit_price).toFixed(4)}</div></div>
                                <div class="trade-detail"><div class="label">–ö–æ–ª-–≤–æ</div><div class="value">${d.qty}</div></div>
                                <div class="trade-detail"><div class="label">P&L</div><div class="value" style="color:${pnlColor}">${(d.pnl_abs||0) >= 0 ? '+' : ''}$${Number(d.pnl_abs||0).toFixed(4)} ${d.pnl_pct!=null?`(${Number(d.pnl_pct).toFixed(2)}%)`:''}</div></div>
                                <div class="trade-detail"><div class="label">BUY conf</div><div class="value">${buyConf}</div></div>
                                <div class="trade-detail"><div class="label">SELL conf</div><div class="value">${sellConf}</div></div>
                                <div class="trade-detail"><div class="label">BUY Q</div><div class="value">[${buyQ}]</div></div>
                                <div class="trade-detail"><div class="label">SELL Q</div><div class="value">[${sellQ}]</div></div>
                                    </div>
                                </div>
                            `;
                    }
                    
                contentDiv.innerHTML = debugHTML + html;
                    historyDiv.style.display = 'block';

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏ —Å–¥–µ–ª–æ–∫:', error);
                const historyDiv = document.getElementById('tradeHistory');
                const contentDiv = document.getElementById('tradeHistoryContent');
                contentDiv.innerHTML = '<p>‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏</p><p><em>' + error.message + '</em></p>';
                historyDiv.style.display = 'block';
            }
        }

        

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–¥–µ–ª–æ–∫
        async function getTradeStatistics() {
            try {
                const response = await fetch('/api/trades/statistics');
                const result = await response.json();
                
                const statsDiv = document.getElementById('tradeStatistics');
                const contentDiv = document.getElementById('tradeStatisticsContent');
                
                if (result.success) {
                    const stats = result.statistics;
                    const successRate = stats.success_rate || 0;
                    const successRateClass = successRate >= 50 ? 'success' : 'error';
                    
                    const statsHTML = `
                        <div class="statistics-grid">
                            <div class="stat-item">
                                <div class="stat-label">–í—Å–µ–≥–æ —Å–¥–µ–ª–æ–∫</div>
                                <div class="stat-value">${stats.total_trades}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">–£—Å–ø–µ—à–Ω—ã—Ö —Å–¥–µ–ª–æ–∫</div>
                                <div class="stat-value success">${stats.successful_trades}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">–ù–µ—É–¥–∞—á–Ω—ã—Ö —Å–¥–µ–ª–æ–∫</div>
                                <div class="stat-value error">${stats.failed_trades}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">–ü—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—Ö–∞</div>
                                <div class="stat-value ${successRateClass}">${successRate}%</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">–û–±—â–∏–π –æ–±—ä–µ–º</div>
                                <div class="stat-value">${stats.total_volume.toFixed(6)}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</div>
                                <div class="stat-value">$${stats.total_value.toFixed(2)}</div>
                            </div>
                        </div>
                    `;
                    
                    contentDiv.innerHTML = statsHTML;
                    statsDiv.style.display = 'block';
                } else {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', result.error);
                    contentDiv.innerHTML = '<p>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</p><p><em>–û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</em></p>';
                    statsDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ —Å –æ—à–∏–±–∫–æ–π
                const statsDiv = document.getElementById('tradeStatistics');
                const contentDiv = document.getElementById('tradeStatisticsContent');
                contentDiv.innerHTML = '<p>‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏</p><p><em>' + error.message + '</em></p>';
                statsDiv.style.display = 'block';
            }
        }

        // –ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
        function startMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
            }
            
            // –°—Ä–∞–∑—É –ø–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            getTradingStatus();
            getBalance();
            getTradingResults();
            getTradeHistory();
            getTradeStatistics();
            getModelPredictions();
            getPredictionStatistics();
            
            monitoringInterval = setInterval(() => {
                getTradingStatus();
                getBalance();
                getTradingResults();
                getTradeHistory();
                getTradeStatistics();
                getModelPredictions();
                getPredictionStatistics();
            }, 300000); 
            
            document.getElementById('monitoringStatus').style.display = 'block';
            showStatus('tradingResult', 'info', '–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω - –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç');
        }

        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
            }
            
            document.getElementById('monitoringStatus').style.display = 'none';
            showStatus('tradingResult', 'info', '–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å
        function showStatus(elementId, type, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
            element.style.display = 'block';
            
            // –ê–≤—Ç–æ—Å–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }

        // –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π —Ä–µ–∞–ª—å–Ω—ã–π –æ—Ä–¥–µ—Ä BUY/SELL –≤ –æ–±—Ö–æ–¥ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π
        async function sendInstantOrder(action) {
            try {
                const symbol = document.getElementById('symbolSelect').value || 'BTCUSDT';
                const body = {
                    action,
                    symbol
                    // quantity –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ; –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞—Ç—å ‚Äî –≤–æ–∑—å–º–µ—Ç—Å—è –º–∏–Ω–∏–º–∞–ª—å–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ä–∞–∑–º–µ—Ä
                };
                const response = await fetch('/api/trading/test_order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const result = await response.json();
                if (result.success) {
                    showStatus('tradingResult', 'success', `${action.toUpperCase()} –∏—Å–ø–æ–ª–Ω–µ–Ω: ${symbol}, qty=${result.quantity}`);
                    // –ù–∏—á–µ–≥–æ –Ω–µ –ø–∏—à–µ–º –≤ –ë–î/–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
                } else {
                    showStatus('tradingResult', 'error', `–û—à–∏–±–∫–∞: ${result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
                }
            } catch (error) {
                showStatus('tradingResult', 'error', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π –º–æ–¥–µ–ª–∏ –ò–ò
        async function getModelPredictions() {
            try {
                const response = await fetch('/api/predictions/recent?limit=1500');
                const result = await response.json();
                
                const predictionsDiv = document.getElementById('modelPredictions');
                const contentDiv = document.getElementById('predictionsContent');
                
                if (result.success) {
                    if (result.predictions && result.predictions.length > 0) {
                        let predictionsHTML = `<p><strong>–í—Å–µ–≥–æ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π:</strong> ${result.total_predictions}</p>`;
                        
                        result.predictions.forEach(prediction => {
                            const predictionTime = formatMoscowDateTime(prediction.timestamp);
                            const actionClass = prediction.action === 'buy' ? 'buy' : prediction.action === 'sell' ? 'sell' : 'hold';
                            const confidenceClass = prediction.confidence > 0.5 ? 'success' : prediction.confidence > 0.2 ? 'info' : 'warning';
                            
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–æ –ª–∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ Q-gate
                            const isQgateFiltered = prediction.market_conditions && prediction.market_conditions.qgate_filtered;
                            const qgateReason = prediction.market_conditions && prediction.market_conditions.qgate_reason;
                            const qgateSide = prediction.market_conditions && prediction.market_conditions.qgate_side;
                            const qgateT1 = prediction.market_conditions && prediction.market_conditions.qgate_T1;
                            const qgateT2 = prediction.market_conditions && prediction.market_conditions.qgate_T2;
                            const qgateMaxQ = prediction.market_conditions && prediction.market_conditions.qgate_maxQ;
                            const qgateGapQ = prediction.market_conditions && prediction.market_conditions.qgate_gapQ;
                            
                            predictionsHTML += `
                                <div class="trade-item" style="border-left: 4px solid ${isQgateFiltered ? '#ffc107' : (actionClass === 'buy' ? '#28a745' : actionClass === 'sell' ? '#dc3545' : '#6c757d')};">
                                    <div class="trade-header">
                                        <span class="trade-action ${actionClass}">${prediction.action.toUpperCase()}</span>
                                        ${isQgateFiltered ? '<span class="trade-confidence warning">üö´ Q-gate –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ</span>' : `<span class="trade-confidence ${confidenceClass}">–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${(prediction.confidence * 100).toFixed(1)}%</span>`}
                                        <span>${predictionTime}</span>
                                    </div>
                                    <div class="trade-details">
                                        <div class="trade-detail">
                                            <div class="label">–°–∏–º–≤–æ–ª</div>
                                            <div class="value">${prediction.symbol}</div>
                                        </div>
                                        <div class="trade-detail">
                                            <div class="label">–¶–µ–Ω–∞</div>
                                            <div class="value">$${prediction.current_price?.toFixed(6) || 'N/A'}</div>
                                        </div>
                                        <div class="trade-detail">
                                            <div class="label">–ü–æ–∑–∏—Ü–∏—è</div>
                                            <div class="value">${prediction.position_status}</div>
                                        </div>
                                        <div class="trade-detail">
                                            <div class="label">Q-Values</div>
                                            <div class="value">[${prediction.q_values.map(v => v.toFixed(3)).join(', ')}]</div>
                                        </div>
                                    </div>
                                    ${isQgateFiltered ? `
                                    <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; font-size: 12px;">
                                        <strong>üö´ Q-gate —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è</strong>${qgateSide ? ` <span style="opacity:0.8">(${qgateSide.toUpperCase()})</span>` : ''}:<br>
                                        <div style="margin-top:6px; color:#856404;">
                                            ${qgateReason || '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏'}
                                        </div>
                                        <div style="margin-top:8px; display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:6px; color:#444;">
                                            ${typeof qgateT1 === 'number' ? `<div><strong>MAXQ</strong>: ${qgateT1.toFixed(3)}</div>` : ''}
                                            ${typeof qgateT2 === 'number' ? `<div><strong>GAPQ</strong>: ${qgateT2.toFixed(3)}</div>` : ''}
                                            ${typeof qgateMaxQ === 'number' ? `<div><strong>maxQ</strong>: ${qgateMaxQ.toFixed(3)}</div>` : ''}
                                            ${typeof qgateGapQ === 'number' ? `<div><strong>gapQ</strong>: ${qgateGapQ.toFixed(3)}</div>` : ''}
                                        </div>
                                    </div>
                                    ` : ''}
                                    ${prediction.market_conditions && Object.keys(prediction.market_conditions).length > 0 && !isQgateFiltered ? `
                                    <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 12px;">
                                        <strong>–£—Å–ª–æ–≤–∏—è —Ä—ã–Ω–∫–∞:</strong><br>
                                        ${Object.entries(prediction.market_conditions).filter(([key]) => !key.startsWith('qgate_')).map(([key, value]) => 
                                            `${key}: ${value}`
                                        ).join(', ')}
                                    </div>
                                    ` : ''}
                                </div>
                            `;
                        });
                        
                        contentDiv.innerHTML = predictionsHTML;
                    } else {
                        contentDiv.innerHTML = '<p>üß† –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –º–æ–¥–µ–ª–∏ –ø–æ–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</p><p><em>–î–∞–Ω–Ω—ã–µ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–æ—Ä–≥–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π</em></p>';
                    }
                    
                    predictionsDiv.style.display = 'block';
                } else {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π:', result.error);
                    contentDiv.innerHTML = '<p>‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π</p><p><em>' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</em></p>';
                    predictionsDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π:', error);
                const predictionsDiv = document.getElementById('modelPredictions');
                const contentDiv = document.getElementById('predictionsContent');
                contentDiv.innerHTML = '<p>‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏</p><p><em>' + error.message + '</em></p>';
                predictionsDiv.style.display = 'block';
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π
        async function getPredictionStatistics() {
            try {
                const response = await fetch('/api/predictions/statistics');
                const result = await response.json();
                
                const statsDiv = document.getElementById('predictionStatistics');
                const contentDiv = document.getElementById('predictionStatsContent');
                
                if (result.success) {
                    const stats = result.statistics;
                    
                    const statsHTML = `
                        <div class="statistics-grid">
                            <div class="stat-item">
                                <div class="stat-label">–í—Å–µ–≥–æ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π</div>
                                <div class="stat-value">${stats.total_predictions}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">BUY —Å–∏–≥–Ω–∞–ª—ã</div>
                                <div class="stat-value buy">${stats.buy_predictions}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">SELL —Å–∏–≥–Ω–∞–ª—ã</div>
                                <div class="stat-value sell">${stats.sell_predictions}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">HOLD —Å–∏–≥–Ω–∞–ª—ã</div>
                                <div class="stat-value hold">${stats.hold_predictions}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">–°—Ä–µ–¥–Ω—è—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å BUY</div>
                                <div class="stat-value">${stats.avg_confidence_buy}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">–°—Ä–µ–¥–Ω—è—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å SELL</div>
                                <div class="stat-value">${stats.avg_confidence_sell}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">–°—Ä–µ–¥–Ω—è—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å HOLD</div>
                                <div class="stat-value">${stats.avg_confidence_hold}</div>
                            </div>
                        </div>
                    `;
                    
                    contentDiv.innerHTML = statsHTML;
                    statsDiv.style.display = 'block';
                } else {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π:', result.error);
                    contentDiv.innerHTML = '<p>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</p><p><em>–û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</em></p>';
                    statsDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π:', error);
                const statsDiv = document.getElementById('predictionStatistics');
                const contentDiv = document.getElementById('predictionStatsContent');
                contentDiv.innerHTML = '<p>‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏</p><p><em>' + error.message + '</em></p>';
                statsDiv.style.display = 'block';
            }
        }

        // –ü–æ–¥–±–æ—Ä –ø–æ—Ä–æ–≥–æ–≤ Q-gate (–±–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π)
        async function suggestQGate(side='buy') {
            try {
                const symSel = document.getElementById('ensembleSymbolSelect');
                const symbol = symSel ? (symSel.value || '') : '';
                const baseParams = {
                    limit_trades: '600',
                    limit_predictions: '3000',
                    tolerance_buckets: '2',
                    min_n: '10',
                    grid_points: '21',
                    side,
                    ...(symbol ? { symbol } : {})
                };
                let qs = new URLSearchParams(baseParams).toString();
                let resp = await fetch('/api/analysis/qgate_suggest?' + qs);
                let data = await resp.json();
                const resultsDiv = document.getElementById('tradingResults');
                const contentDiv = document.getElementById('tradingResultsContent');
                if (data.success) {
                    const s = data.suggestion;
                    contentDiv.innerHTML = `
                        <div class="trade-item">
                            <div class="trade-header"><span class="trade-action success">Q-gate ${side.toUpperCase()} –ø–æ—Ä–æ–≥–∏</span></div>
                            <div class="trade-details">
                                <div class="trade-detail"><div class="label">MAXQ</div><div class="value">${s.T1.toFixed(6)}</div></div>
                                <div class="trade-detail"><div class="label">GAPQ</div><div class="value">${s.T2.toFixed(6)}</div></div>
                                <div class="trade-detail"><div class="label">Hit-rate</div><div class="value">${(s.hit_rate*100).toFixed(2)}% (${s.n} —Å–¥–µ–ª–æ–∫)</div></div>
                                <div class="trade-detail"><div class="label">.env</div><div class="value"><code>${data.env}</code></div></div>
                            </div>
                        </div>`;
                    resultsDiv.style.display = 'block';
                } else {
                    // –ü–æ–≤—Ç–æ—Ä —Å –±–æ–ª–µ–µ –º—è–≥–∫–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏, –µ—Å–ª–∏ –º–∞–ª–æ –¥–∞–Ω–Ω—ã—Ö
                    const needRetry = (data && data.error && /–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö/i.test(data.error));
                    if (needRetry) {
                        const retryParams = {
                            ...baseParams,
                            tolerance_buckets: '3',
                            min_n: '5',
                            grid_points: '11'
                        };
                        qs = new URLSearchParams(retryParams).toString();
                        resp = await fetch('/api/analysis/qgate_suggest?' + qs);
                        data = await resp.json();
                        if (data.success) {
                            const s = data.suggestion;
                            contentDiv.innerHTML = `
                                <div class="trade-item">
                                    <div class="trade-header"><span class="trade-action success">Q-gate ${side.toUpperCase()} (–ø–æ–≤—Ç–æ—Ä —Å –º—è–≥–∫–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏)</span></div>
                                    <div class="trade-details">
                                        <div class="trade-detail"><div class="label">MAXQ</div><div class="value">${s.T1.toFixed(6)}</div></div>
                                        <div class="trade-detail"><div class="label">GAPQ</div><div class="value">${s.T2.toFixed(6)}</div></div>
                                        <div class="trade-detail"><div class="label">Hit-rate</div><div class="value">${(s.hit_rate*100).toFixed(2)}% (${s.n} —Å–¥–µ–ª–æ–∫)</div></div>
                                        <div class="trade-detail"><div class="label">.env</div><div class="value"><code>${data.env}</code></div></div>
                                    </div>
                                </div>`;
                            resultsDiv.style.display = 'block';
                            return;
                        }
                    }
                    contentDiv.innerHTML = `<p>‚ùå –ü–æ–¥–±–æ—Ä –ø–æ—Ä–æ–≥–æ–≤ –Ω–µ —É–¥–∞–ª—Å—è</p><p><em>${(data && data.error) || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</em></p>`;
                    resultsDiv.style.display = 'block';
                }
            } catch (e) {
                const resultsDiv = document.getElementById('tradingResults');
                const contentDiv = document.getElementById('tradingResultsContent');
                contentDiv.innerHTML = `<p>‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏</p><p><em>${e.message}</em></p>`;
                resultsDiv.style.display = 'block';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –æ—Å—Ç–∞–≤—à–µ–π—Å—è –ø–æ–∑–∏—Ü–∏–∏
        function showRemainingPositionStrategy(strategy) {
            const contentDiv = document.getElementById('remainingStrategyContent');
            const strategyDiv = document.getElementById('remainingPositionStrategy');
            if (!strategyDiv || !contentDiv) {
                return; // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –Ω–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            }
            
            if (strategy && strategy.type === 'remaining_position') {
                const createdTime = formatMoscowDateTime(strategy.created_at);
                const timeThreshold = formatMoscowDateTime(strategy.time_threshold);
                
                let strategyHTML = `
                    <div class="strategy-info">
                        <h4>üéØ –°—Ç—Ä–∞—Ç–µ–≥–∏—è –¥–ª—è –æ—Å—Ç–∞–≤—à–µ–π—Å—è –ø–æ–∑–∏—Ü–∏–∏</h4>
                        <div class="strategy-details">
                            <p><strong>–¢–∏–ø:</strong> ${strategy.type}</p>
                            <p><strong>–°–æ–∑–¥–∞–Ω–∞:</strong> ${createdTime}</p>
                            <p><strong>–í—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è:</strong> ${timeThreshold}</p>
                            <p><strong>–ü–æ—Ä–æ–≥ —É–±—ã—Ç–∫–∞:</strong> <span class="negative">${strategy.sell_threshold}%</span></p>
                            <p><strong>–ü–æ—Ä–æ–≥ –ø—Ä–∏–±—ã–ª–∏:</strong> <span class="positive">${strategy.profit_threshold}%</span></p>
                            <p><strong>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è:</strong> 24 —á–∞—Å–∞</p>
                        </div>
                        <div class="strategy-rules">
                            <h5>üìã –ü—Ä–∞–≤–∏–ª–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–¥–∞–∂–∏:</h5>
                            <ul>
                                <li>üö® <strong>–£–±—ã—Ç–æ–∫ > ${strategy.sell_threshold}%</strong> ‚Üí –ü—Ä–æ–¥–∞–µ–º –≤–µ—Å—å –æ—Å—Ç–∞—Ç–æ–∫</li>
                                <li>üí∞ <strong>–ü—Ä–∏–±—ã–ª—å > ${strategy.profit_threshold}%</strong> ‚Üí –ü—Ä–æ–¥–∞–µ–º –≤–µ—Å—å –æ—Å—Ç–∞—Ç–æ–∫</li>
                                <li>‚è∞ <strong>–í—Ä–µ–º—è > 24 —á–∞—Å–∞</strong> ‚Üí –ü—Ä–æ–¥–∞–µ–º –≤–µ—Å—å –æ—Å—Ç–∞—Ç–æ–∫</li>
                            </ul>
                        </div>
                    </div>
                `;
                
                contentDiv.innerHTML = strategyHTML;
                strategyDiv.style.display = 'block';
            } else {
                if (strategyDiv) strategyDiv.style.display = 'none';
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏ –ª–æ–≥–∏–∫–∞ –¥–ª—è —Å–ª–∞–π–¥–µ—Ä–æ–≤ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞ (–ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –º–æ–¥–µ–ª–µ–π)
        function syncConsensusSelectsMax() {
            const selectedCount = Math.max(1, Array.from(document.querySelectorAll('.verCheck:checked')).length);
            const flatSelect = document.getElementById('flatConsensusCount');
            const trendSelect = document.getElementById('trendConsensusCount');
            if (!flatSelect || !trendSelect) return;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ–ø—Ü–∏–∏ –≤ select'–∞—Ö
            [flatSelect, trendSelect].forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '';
                for (let i = 1; i <= Math.max(selectedCount, 1); i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${i} ${i === 1 ? '–º–æ–¥–µ–ª—å' : (i >= 2 && i <= 4 ? '–º–æ–¥–µ–ª–∏' : '–º–æ–¥–µ–ª–µ–π')}`;
                    select.appendChild(option);
                }
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –µ—Å–ª–∏ –æ–Ω–æ –≤–∞–ª–∏–¥–Ω–æ
                if (currentValue && parseInt(currentValue) <= selectedCount) {
                    select.value = currentValue;
                } else {
                    select.value = Math.min(selectedCount, 1);
                }
            });
        }

        function updateConsensusDisplay() {
            syncConsensusSelectsMax();
            const selectedCount = Math.max(1, Array.from(document.querySelectorAll('.verCheck:checked')).length);
            const flatSelect = document.getElementById('flatConsensusCount');
            const trendSelect = document.getElementById('trendConsensusCount');
            if (!flatSelect || !trendSelect) return;
            const flatCount = parseInt(flatSelect.value || '1', 10);
            const trendCount = parseInt(trendSelect.value || '1', 10);
            
            // –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç (–¥–ª—è –ø–æ–¥—Å–∫–∞–∑–∫–∏)
            const toPct = (count) => Math.round((count / selectedCount) * 100);
            const flatPct = toPct(flatCount);
            const trendPct = toPct(trendCount);

            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏ —Å –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º–∏
            const flatHint = document.getElementById('flatConsensusPercentHint');
            const trendHint = document.getElementById('trendConsensusPercentHint');
            if (flatHint) flatHint.textContent = `‚âà ${flatPct}% –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö`;
            if (trendHint) trendHint.textContent = `‚âà ${trendPct}% –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö`;

            // –°–≤–æ–¥–∫–∞ –Ω–∏–∂–µ
            const flatDisp = document.getElementById('flatConsensusDisplay');
            const trendDisp = document.getElementById('trendConsensusDisplay');
            if (flatDisp) flatDisp.textContent = `${flatCount} –∏–∑ ${selectedCount} –º–æ–¥–µ–ª–µ–π (${flatPct}%)`;
            if (trendDisp) trendDisp.textContent = `${trendCount} –∏–∑ ${selectedCount} –º–æ–¥–µ–ª–µ–π (${trendPct}%)`;
            
            // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage (–ë–ï–ó –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Redis)
            const currentSymbol = document.getElementById('ensembleSymbolSelect')?.value || 'BTCUSDT';
            saveConsensusSettingsForSymbol(currentSymbol);
        }

        function initConsensusSelects() {
            const flatSelect = document.getElementById('flatConsensusCount');
            const trendSelect = document.getElementById('trendConsensusCount');
            if (flatSelect) flatSelect.addEventListener('change', updateConsensusDisplay);
            if (trendSelect) trendSelect.addEventListener('change', updateConsensusDisplay);
            updateConsensusDisplay();
        }

        // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–µ–π –∏ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞ –≤ Redis
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ç–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç–∞ –∏ —Å—Ç–æ–ø-–ª–æ—Å—Å–∞
        function updateRiskManagementDisplay() {
            const takeProfitSlider = document.getElementById('takeProfitPct');
            const stopLossSlider = document.getElementById('stopLossPct');
            const riskTypeSelect = document.getElementById('riskManagementType');
            
            if (takeProfitSlider) {
                const value = parseFloat(takeProfitSlider.value);
                const badge = document.getElementById('takeProfitPctValue');
                const display = document.getElementById('takeProfitDisplay');
                if (badge) badge.textContent = `${value.toFixed(1)}%`;
                if (display) display.textContent = `${value.toFixed(1)}%`;
            }
            
            if (stopLossSlider) {
                const value = parseFloat(stopLossSlider.value);
                const badge = document.getElementById('stopLossPctValue');
                const display = document.getElementById('stopLossDisplay');
                if (badge) badge.textContent = `-${value.toFixed(1)}%`;
                if (display) display.textContent = `-${value.toFixed(1)}%`;
            }
            
            if (riskTypeSelect) {
                const typeDisplay = document.getElementById('riskTypeDisplay');
                const typeMap = {
                    'exchange_orders': '–û—Ä–¥–µ—Ä–∞ –Ω–∞ –±–∏—Ä–∂–µ',
                    'bot_monitoring': '–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –±–æ—Ç–æ–º',
                    'both': '–û–±–∞ —Å–ø–æ—Å–æ–±–∞'
                };
                if (typeDisplay) typeDisplay.textContent = typeMap[riskTypeSelect.value] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
            }
            
            // –ù–ï –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ - —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
        }

        function initRiskManagementSliders() {
            const takeProfitSlider = document.getElementById('takeProfitPct');
            const stopLossSlider = document.getElementById('stopLossPct');
            const riskTypeSelect = document.getElementById('riskManagementType');
            
            if (takeProfitSlider) {
                takeProfitSlider.addEventListener('input', () => {
                    updateRiskManagementDisplay();
                    autoSaveTradingConfig();
                });
            }
            if (stopLossSlider) {
                stopLossSlider.addEventListener('input', () => {
                    updateRiskManagementDisplay();
                    autoSaveTradingConfig();
                });
            }
            if (riskTypeSelect) {
                riskTypeSelect.addEventListener('change', () => {
                    updateRiskManagementDisplay();
                    autoSaveTradingConfig();
                });
            }
            
            updateRiskManagementDisplay();
        }

        async function autoSaveTradingConfig(){
            try{
                const symbol = (document.getElementById('ensembleSymbolSelect')?.value) || 'BTCUSDT';
                const selectedPaths = Array.from(document.querySelectorAll('.verCheck:checked')).map(i => i.value).filter(Boolean);
                const consensusSettings = getConsensusSettings();
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∏—Å–∫-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç–∞
                const takeProfitPct = parseFloat(document.getElementById('takeProfitPct')?.value || '5');
                const stopLossPct = parseFloat(document.getElementById('stopLossPct')?.value || '3');
                const riskType = document.getElementById('riskManagementType')?.value || 'exchange_orders';
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Redis —á–µ—Ä–µ–∑ API
                await fetch('/api/trading/save_config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        symbols: [symbol], 
                        model_paths: selectedPaths, 
                        consensus: consensusSettings,
                        take_profit_pct: takeProfitPct,
                        stop_loss_pct: stopLossPct,
                        risk_management_type: riskType
                    })
                });
                
                console.log(`–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–ª—è ${symbol}:`, {
                    consensus: consensusSettings,
                    models: selectedPaths.length,
                    risk: { takeProfitPct, stopLossPct, riskType }
                });
            }catch(e){ 
                console.error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e);
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞ (–∏ –≤ —à—Ç—É–∫–∞—Ö, –∏ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö)
        function getConsensusSettings() {
            const selectedCount = Array.from(document.querySelectorAll('.verCheck:checked')).length;
            const flatCount = parseInt(document.getElementById('flatConsensusCount').value || '1', 10);
            const trendCount = parseInt(document.getElementById('trendConsensusCount').value || '1', 10);
            const toPct = (count) => selectedCount > 0 ? Math.round((count / selectedCount) * 100) : 0;
            const result = {
                counts: {
                    flat: flatCount,
                    trend: trendCount,
                    total_selected: selectedCount
                },
                percents: {
                    flat: toPct(flatCount),
                    trend: toPct(trendCount)
                }
            };
            console.log('[UI] getConsensusSettings result:', result);
            return result;
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', () => {
            onEnsembleSymbolChange();
            getTradingStatus();
            getBalance();
            loadAgents();
            initConsensusSelects();
            initRiskManagementSliders(); // –î–æ–±–∞–≤–∏—Ç—å —ç—Ç—É —Å—Ç—Ä–æ–∫—É
            loadBybitAccounts();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞ –¥–ª—è BTCUSDT –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            loadConsensusSettingsForSymbol('BTCUSDT');
        });

        async function loadAgents(){
            try{
                const box = document.getElementById('agentsTable'); if(!box) return;
                const r = await fetch('/api/trading/agents');
                const j = await r.json();
                if(!j.success){ box.innerHTML = '<div class="status error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>'; return; }
                const agents = Array.isArray(j.agents)? j.agents: [];
                if(agents.length===0){ box.innerHTML = '<div class="status info">üì≠ –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>'; return; }
                const rows = agents.filter(a=>a.active).map(a=>{
                    const c = a.consensus||{}; const counts = c.counts||{};
                    const regime = (a.status&&a.status.market_regime) || 'flat';
                    return `
                    <div class="trade-item" style="border-left:4px solid ${a.active?'#28a745':'#6c757d'};">
                        <div class="trade-header">
                            <span class="trade-action ${a.active?'success':'hold'}">${a.symbol}</span>
                            <span>${a.active? 'üü¢ –ê–∫—Ç–∏–≤–µ–Ω' : 'üî¥ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}</span>
                        </div>
                        <div class="trade-details" style="display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px;">
                            <div class="trade-detail"><div class="label">–†–µ–∂–∏–º</div><div class="value">${regime}</div></div>
                            <div class="trade-detail"><div class="label">–ú–æ–¥–µ–ª–µ–π</div><div class="value">${a.total_models}</div></div>
                            <div class="trade-detail"><div class="label">–¢—Ä–µ–±—É–µ—Ç—Å—è</div><div class="value">${a.required} (${a.required_type})</div></div>
                            <div class="trade-detail"><div class="label">–ö–æ–Ω—Å–µ–Ω—Å—É—Å</div><div class="value">flat=${counts.flat??'‚Äî'}, trend=${counts.trend??'‚Äî'}</div></div>
                            <div class="trade-detail"><div class="label">BUY/SELL/HOLD</div><div class="value">‚Äî</div></div>
                            <div class="trade-detail"><div class="label">TTL –ª–æ–∫</div><div class="value">${a.lock_ttl??'‚Äî'}</div></div>
                        </div>
                        <div style="text-align:right;margin-top:8px;">
                            <button class="btn btn-danger" onclick="stopAgent('${a.symbol}')">üõë –°—Ç–æ–ø</button>
                        </div>
                    </div>`;
                }).join('');
                box.innerHTML = rows || '<div class="status info">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤</div>';
            }catch(e){
                const box = document.getElementById('agentsTable'); if(box) box.innerHTML = '<div class="status error">‚ùå –û—à–∏–±–∫–∞: '+e.message+'</div>';
            }
        }

        async function stopAgent(symbol){
            try{
                const r = await fetch('/api/trading/stop_symbol', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({symbol})});
                const j = await r.json();
                showStatus('tradingResult', j.success?'success':'error', j.success?'–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω '+symbol : (j.error||'–û—à–∏–±–∫–∞'));
                if(j.success){ loadAgents(); getTradingStatus(); }
            }catch(e){ showStatus('tradingResult','error','–°–µ—Ç—å: '+e.message); }
        }

        async function loadBybitAccounts(){
            try{
                const resp = await fetch('/api/bybit/accounts');
                const data = await resp.json();
                const sel = document.getElementById('bybitAccountSelect');
                if(!sel) return;
                if(!data.success){ sel.innerHTML = '<option value="">–û—à–∏–±–∫–∞</option>'; return; }
                if(!Array.isArray(data.accounts) || data.accounts.length===0){ sel.innerHTML = '<option value="">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–æ–≤</option>'; return; }
                sel.innerHTML = data.accounts.map(a=>`<option value="${a.id}">${a.label}${a.api_key_masked?` (${a.api_key_masked})`:''}</option>`).join('');
                try{
                    const cur = localStorage.getItem('bybit:account');
                    if(cur){ sel.value = cur; }
                }catch(_){ }
            }catch(e){
                const sel = document.getElementById('bybitAccountSelect');
                if(sel) sel.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
            }
        }

        async function onSelectBybitAccount(id){
            try{
                await fetch('/api/bybit/select', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id})});
                try{ localStorage.setItem('bybit:account', id); }catch(_){ }
                showStatus('tradingResult', 'success', '–ê–∫–∫–∞—É–Ω—Ç –≤—ã–±—Ä–∞–Ω');
            }catch(e){
                showStatus('tradingResult', 'error', '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–±—Ä–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç: '+e.message);
            }
        }
    </script>
    <script src="/static/js/sidebar.js"></script>
    <script src="/static/js/tabs.js"></script>
</body>
</html>
