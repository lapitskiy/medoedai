<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedoedAI - üìä XGB —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="/static/css/sidebar.css">
</head>
<body>
    {% include 'include/_sidebar.html' %}
    <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>

    <div class="container">
        <div class="main-content">
            <div class="header">
                <h1>üìä XGB ‚Äî –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h1>
                <p>–°–≤–æ–¥–∫–∞ –ø–æ –≤—Å–µ–º XGB run‚Äô–∞–º –∏–∑ <code>result/xgb/*/runs/*</code></p>
                <div class="button-group" style="margin-top: 12px;">
                    <a href="/xgb_models" class="btn btn-secondary">üß† –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–±—É—á–µ–Ω–∏—é XGB</a>
                </div>
            </div>

            <div class="content">
                <div class="section">
                    <h2>–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏</h2>
                    <div class="status info" style="margin-bottom:10px;">
                        <b>y_counts_val</b>: <code>[hold, buy, sell]</code> ‚Ä¢ <b>y_non_hold</b>: –¥–æ–ª—è non-hold –≤ label –Ω–∞ val ‚Ä¢ <b>pred_non_hold</b>: –¥–æ–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π non-hold –Ω–∞ val
                    </div>
                    <div class="form-group" style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; margin-bottom:12px;">
                        <div style="min-width:220px;">
                            <label>–§–∏–ª—å—Ç—Ä: Symbol</label>
                            <select id="xgbFilterSymbol" class="form-control">
                                <option value="">–í—Å–µ</option>
                            </select>
                        </div>
                        <div style="min-width:220px;">
                            <label>–§–∏–ª—å—Ç—Ä: Task</label>
                            <select id="xgbFilterTask" class="form-control">
                                <option value="">–í—Å–µ</option>
                            </select>
                        </div>
                        <div style="min-width:260px;">
                            <label>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
                            <select id="xgbSortMode" class="form-control">
                                <option value="best" selected>Best first (–ø–æ –∫–∞—á–µ—Å—Ç–≤—É)</option>
                                <option value="mtime">–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
                                <option value="val_acc">val_acc</option>
                                <option value="f1_buy_sell">f1_buy_sell (directional)</option>
                                <option value="f1_pos">f1(1) (entry/exit)</option>
                                <option value="precision_pos">precision(1) (entry/exit)</option>
                                <option value="recall_pos">recall(1) (entry/exit)</option>
                                <option value="y_non_hold">y_non_hold (label coverage)</option>
                                <option value="pred_non_hold">pred_non_hold</option>
                            </select>
                        </div>
                        <div>
                            <button class="btn btn-info" onclick="applyXgbFilters()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                        </div>
                        <div>
                            <button class="btn btn-warning" onclick="deleteSelectedXgbRuns()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
                        </div>
                    </div>
                    <div id="xgbDeleteStatus" class="status info" style="display:none; margin-bottom:10px; white-space: pre-wrap;"></div>
                    {% if not runs %}
                        <div class="status info">–ù–µ—Ç XGB run‚Äô–æ–≤. –°–Ω–∞—á–∞–ª–∞ –æ–±—É—á–∏—Ç–µ –º–æ–¥–µ–ª—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ <code>/xgb_models</code>.</div>
                    {% else %}
                        <div style="overflow-x:auto;">
                            <table class="table" style="width:100%; border-collapse: collapse;">
                                <thead>
                                    <tr>
                                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">
                                            <input type="checkbox" id="xgbSelectAll" />
                                        </th>
                                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Symbol</th>
                                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Run</th>
                                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Manifest</th>
                                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Dir</th>
                                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Task</th>
                                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Source</th>
                                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">H</th>
                                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Thr</th>
                                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">max_hold</th>
                                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">min_profit, %</th>
                                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">val_acc</th>
                                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">f1_buy_sell</th>
                                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">f1(1)</th>
                                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">prec(1)</th>
                                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">recall(1)</th>
                                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">y_counts_val</th>
                                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">y_non_hold</th>
                                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">pred_non_hold</th>
                                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Path</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for r in runs %}
                                        {% set m = r.metrics or {} %}
                                        {% set f1pos = (m.get('f1_val')[1] if (m.get('f1_val') and (m.get('f1_val')|length) > 1) else '') %}
                                        {% set ppos = (m.get('precision_val')[1] if (m.get('precision_val') and (m.get('precision_val')|length) > 1) else '') %}
                                        {% set rpos = (m.get('recall_val')[1] if (m.get('recall_val') and (m.get('recall_val')|length) > 1) else '') %}
                                        {% set yNonHold = m.get('y_non_hold_rate_val', '') %}
                                        {% set predNonHold = m.get('pred_non_hold_rate_val', '') %}
                                        <tr>
                                        <tr class="xgb-row"
                                            data-symbol="{{ r.symbol }}"
                                            data-task="{{ r.task or '' }}"
                                            data-source="{{ r.source or '' }}"
                                            data-mtime="{{ r.mtime or 0 }}"
                                            data-val-acc="{{ m.get('val_acc', '') }}"
                                            data-f1-buy-sell="{{ m.get('f1_buy_sell_val', '') }}"
                                            data-f1-pos="{{ f1pos }}"
                                            data-precision-pos="{{ ppos }}"
                                            data-recall-pos="{{ rpos }}"
                                            data-y-non-hold="{{ yNonHold }}"
                                            data-pred-non-hold="{{ predNonHold }}"
                                            data-path="{{ r.result_dir }}"
                                        >
                                            <td style="padding:8px; border-bottom:1px solid #f0f0f0;">
                                                <input type="checkbox" class="xgb-row-check" />
                                            </td>
                                            <td style="padding:8px; border-bottom:1px solid #f0f0f0;">{{ r.symbol }}</td>
                                            <td style="padding:8px; border-bottom:1px solid #f0f0f0;"><code>{{ r.run_name }}</code></td>
                                            <td style="padding:8px; border-bottom:1px solid #f0f0f0;">
                                                <a href="/analitika/xgb/manifest?path={{ (r.result_dir ~ '/manifest.json') | urlencode }}" target="_blank">open</a>
                                            </td>
                                            <td style="padding:8px; border-bottom:1px solid #f0f0f0;">{{ r.direction or '‚Äî' }}</td>
                                            <td style="padding:8px; border-bottom:1px solid #f0f0f0;"><code>{{ r.task or '‚Äî' }}</code></td>
                                            <td style="padding:8px; border-bottom:1px solid #f0f0f0;"><code>{{ r.source or '‚Äî' }}</code></td>
                                            <td style="padding:8px; border-bottom:1px solid #f0f0f0;">{{ r.horizon_steps or '‚Äî' }}</td>
                                            <td style="padding:8px; border-bottom:1px solid #f0f0f0;">{{ r.threshold or '‚Äî' }}</td>
                                            <td style="padding:8px; border-bottom:1px solid #f0f0f0;">{{ r.max_hold_steps or '‚Äî' }}</td>
                                            <td style="padding:8px; border-bottom:1px solid #f0f0f0;">
                                                {% if r.min_profit is not none %}
                                                    {{ '%.3f' % (r.min_profit * 100.0) }}
                                                {% else %}
                                                    ‚Äî
                                                {% endif %}
                                            </td>
                                            <td style="padding:8px; border-bottom:1px solid #f0f0f0;">{{ m.get('val_acc', '‚Äî') }}</td>
                                            <td style="padding:8px; border-bottom:1px solid #f0f0f0;">{{ m.get('f1_buy_sell_val', '‚Äî') }}</td>
                                            <td style="padding:8px; border-bottom:1px solid #f0f0f0;">{{ f1pos if f1pos != '' else '‚Äî' }}</td>
                                            <td style="padding:8px; border-bottom:1px solid #f0f0f0;">{{ ppos if ppos != '' else '‚Äî' }}</td>
                                            <td style="padding:8px; border-bottom:1px solid #f0f0f0;">{{ rpos if rpos != '' else '‚Äî' }}</td>
                                            <td style="padding:8px; border-bottom:1px solid #f0f0f0;"><code>{{ m.get('y_counts_val', '‚Äî') }}</code></td>
                                            <td style="padding:8px; border-bottom:1px solid #f0f0f0;">{{ yNonHold if yNonHold != '' else '‚Äî' }}</td>
                                            <td style="padding:8px; border-bottom:1px solid #f0f0f0;">{{ m.get('pred_non_hold_rate_val', '‚Äî') }}</td>
                                            <td style="padding:8px; border-bottom:1px solid #f0f0f0;"><code>{{ r.result_dir }}</code></td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script>
        function _num(v){
            const x = parseFloat(String(v ?? '').replace(',', '.'));
            return Number.isFinite(x) ? x : null;
        }

        function _taskType(task){
            const t = String(task || '').toLowerCase();
            if(t.startsWith('entry') || t.startsWith('exit')) return 'binary';
            if(t === 'directional') return 'directional';
            return 'unknown';
        }

        function _bestScore(row){
            const task = row.dataset.task || '';
            const kind = _taskType(task);
            if(kind === 'directional'){
                const v = _num(row.dataset.f1BuySell);
                return (v !== null) ? v : -1e9;
            }
            if(kind === 'binary'){
                const v = _num(row.dataset.f1Pos);
                return (v !== null) ? v : -1e9;
            }
            // fallback
            const acc = _num(row.dataset.valAcc);
            return (acc !== null) ? acc : -1e9;
        }

        function applyXgbFilters(){
            const sym = (document.getElementById('xgbFilterSymbol')?.value || '').trim();
            const task = (document.getElementById('xgbFilterTask')?.value || '').trim().toLowerCase();
            const sortMode = (document.getElementById('xgbSortMode')?.value || 'best').trim();
            const rows = Array.from(document.querySelectorAll('tr.xgb-row'));

            // filter
            rows.forEach(r=>{
                const okSym = !sym || String(r.dataset.symbol||'') === sym;
                const okTask = !task || String(r.dataset.task||'').toLowerCase() === task;
                r.style.display = (okSym && okTask) ? '' : 'none';
            });

            // sort visible rows
            const tbody = rows.length ? rows[0].parentElement : null;
            if(!tbody) return;

            const visible = rows.filter(r => r.style.display !== 'none');
            const keyFn = (r)=>{
                if(sortMode === 'mtime') return _num(r.dataset.mtime) ?? 0;
                if(sortMode === 'val_acc') return _num(r.dataset.valAcc) ?? -1e9;
                if(sortMode === 'f1_buy_sell') return _num(r.dataset.f1BuySell) ?? -1e9;
                if(sortMode === 'f1_pos') return _num(r.dataset.f1Pos) ?? -1e9;
                if(sortMode === 'precision_pos') return _num(r.dataset.precisionPos) ?? -1e9;
                if(sortMode === 'recall_pos') return _num(r.dataset.recallPos) ?? -1e9;
                if(sortMode === 'y_non_hold') return _num(r.dataset.yNonHold) ?? -1e9;
                if(sortMode === 'pred_non_hold') return _num(r.dataset.predNonHold) ?? -1e9;
                return _bestScore(r);
            };
            visible.sort((a,b)=> (keyFn(b) - keyFn(a)));
            visible.forEach(r=>tbody.appendChild(r));
        }

        async function deleteSelectedXgbRuns(){
            const status = document.getElementById('xgbDeleteStatus');
            const rows = Array.from(document.querySelectorAll('tr.xgb-row'));
            const selected = rows.filter(r=>{
                const cb = r.querySelector('input.xgb-row-check');
                return cb && cb.checked;
            });
            if(!selected.length){
                if(status){ status.style.display='block'; status.className='status info'; status.textContent='–ù–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ.'; }
                return;
            }
            const paths = selected.map(r=>String(r.dataset.path||'')).filter(Boolean);
            if(!paths.length) return;
            const ok = confirm('–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ run –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏?\n' + paths.slice(0,5).join('\n') + (paths.length>5 ? `\n... (+${paths.length-5})` : ''));
            if(!ok) return;
            if(status){ status.style.display='block'; status.className='status info'; status.textContent='–£–¥–∞–ª—è—é...'; }
            try{
                const resp = await fetch('/analitika/xgb/delete_runs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify({ paths })
                });
                const data = await resp.json().catch(()=>null);
                if(data && data.success){
                    // remove rows from table
                    selected.forEach(r=>{ try{ r.remove(); }catch(_){} });
                    if(status){
                        status.className='status success';
                        status.textContent = `–£–¥–∞–ª–µ–Ω–æ: ${data.deleted_count || 0}` + ((data.errors && data.errors.length) ? `\n–û—à–∏–±–∫–∏: ${data.errors.length}` : '');
                    }
                }else{
                    if(status){ status.className='status error'; status.textContent = '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + (data && data.error ? data.error : 'unknown'); }
                }
            }catch(e){
                if(status){ status.className='status error'; status.textContent = '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + (e && e.message ? e.message : e); }
            }
        }

        document.addEventListener('DOMContentLoaded', function(){
            const rows = Array.from(document.querySelectorAll('tr.xgb-row'));
            const symSel = document.getElementById('xgbFilterSymbol');
            const taskSel = document.getElementById('xgbFilterTask');
            if(symSel){
                const set = new Set(rows.map(r=>String(r.dataset.symbol||'')).filter(Boolean));
                Array.from(set).sort().forEach(s=>{
                    const o=document.createElement('option'); o.value=s; o.textContent=s; symSel.appendChild(o);
                });
            }
            if(taskSel){
                const set = new Set(rows.map(r=>String(r.dataset.task||'')).filter(Boolean));
                Array.from(set).sort().forEach(t=>{
                    const o=document.createElement('option'); o.value=t; o.textContent=t; taskSel.appendChild(o);
                });
            }
            try{
                const all = document.getElementById('xgbSelectAll');
                if(all){
                    all.addEventListener('change', function(){
                        const cbs = Array.from(document.querySelectorAll('input.xgb-row-check'));
                        cbs.forEach(cb=>{ cb.checked = !!all.checked; });
                    });
                }
            }catch(_){}
            applyXgbFilters();
        });
    </script>
    <script src="/static/js/sidebar.js"></script>
</body>
</html>

