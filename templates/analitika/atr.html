<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MedoedAI - ATR</title>
  <link rel="stylesheet" href="/static/css/styles.css">
  <link rel="stylesheet" href="/static/css/sidebar.css">
  <link rel="stylesheet" href="/static/css/tabs.css">
</head>
<body>
  {% include 'include/_sidebar.html' %}

  <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>

  <div class="container">
    <div class="main-content">
      <div class="header">
        <h1>ATR (1h)</h1>
        <p>–†–∞—Å—á—ë—Ç ATR –ø–æ 1h —Å–≤–µ—á–∞–º. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –±–µ—Ä—ë–º –¥–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–≥–æ –∏–∑ Postgres (–±–µ–∑ –¥–æ–∫–∞—á–∫–∏).</p>
        <div class="button-group" style="margin-top: 12px;">
          <a href="/analitika" class="btn btn-secondary">‚¨Ö –ù–∞–∑–∞–¥</a>
        </div>
      </div>

      <div class="content">
        <div class="section">
          <div class="form-group">
            <label>–°–∏–º–≤–æ–ª—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
            <input id="symbolsInput" class="form-control" value="BTCUSDT,ETHUSDT,SOLUSDT,TONUSDT" />
            <small style="color:#666; display:block; margin-top:6px;">–ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º ‚Äî –±—É–¥—É—Ç –¥–µ—Ñ–æ–ª—Ç—ã –∫–∞–∫ –≤ —Å–∞–π–¥–±–∞—Ä–µ.</small>
          </div>
          <div class="form-group">
            <label>ATR length</label>
            <input id="lengthInput" type="number" min="2" step="1" class="form-control" value="21" />
          </div>
          <div class="form-group">
            <label><input id="dbOnlyCheckbox" type="checkbox" checked /> —Ç–æ–ª—å–∫–æ –∏–∑ –ë–î (db_only=1)</label>
          </div>
          <div class="button-group">
            <button class="btn btn-info" onclick="loadSymbolsFromAgents()">üì• –í–∑—è—Ç—å —Å–∏–º–≤–æ–ª—ã –∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤</button>
            <button class="btn btn-primary" onclick="loadAtr()">üîÑ –ü–æ—Å—á–∏—Ç–∞—Ç—å ATR</button>
          </div>
        </div>

        <div class="section">
          <div id="atrStatus" class="status" style="display:none;"></div>
          <div id="atrTableWrap" class="results" style="display:none;"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    async function loadSymbolsFromAgents(){
      const status = document.getElementById('atrStatus');
      status.style.display='block';
      status.className='status running';
      status.textContent='‚è≥ –ü–æ–ª—É—á–∞—é —Å–ø–∏—Å–æ–∫ —Å–∏–º–≤–æ–ª–æ–≤...';
      try{
        const r = await fetch('/api/trading/status_all');
        const data = await r.json();
        const agents = Array.isArray(data.active_agents)? data.active_agents: [];
        const set = new Set();
        agents.forEach(a=>{ if(a && a.symbol) set.add(String(a.symbol).toUpperCase().replace('/','')); });
        const list = Array.from(set);
        document.getElementById('symbolsInput').value = list.join(',');
        status.className='status success';
        status.textContent = list.length ? `‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${list.length} —Å–∏–º–≤–æ–ª–æ–≤` : '‚ö†Ô∏è –ê–∫—Ç–∏–≤–Ω—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤ –Ω–µ—Ç';
      }catch(e){
        status.className='status error';
        status.textContent='‚ùå –û—à–∏–±–∫–∞: ' + e.message;
      }
    }

    function escapeHtml(s){
      return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    async function loadAtr(){
      const status = document.getElementById('atrStatus');
      const wrap = document.getElementById('atrTableWrap');
      status.style.display='block';
      status.className='status running';
      status.textContent='‚è≥ –°—á–∏—Ç–∞—é ATR...';
      wrap.style.display='none';
      wrap.innerHTML='';
      try{
        const symbols = (document.getElementById('symbolsInput').value || '').trim();
        const length = parseInt(document.getElementById('lengthInput').value || '21', 10);
        const dbOnly = document.getElementById('dbOnlyCheckbox').checked ? 1 : 0;
        const url = `/api/atr/1h?symbols=${encodeURIComponent(symbols)}&length=${encodeURIComponent(length)}&db_only=${dbOnly}`;
        const r = await fetch(url);
        const data = await r.json();
        if(!data || data.success !== true) throw new Error((data && data.error) ? data.error : 'bad response');
        const rows = Array.isArray(data.rows)? data.rows: [];
        const html = [
          '<table class="table" style="width:100%; border-collapse: collapse;">',
          '<thead><tr><th>symbol</th><th>ATR</th><th>ATR%</th><th>close</th><th>status</th></tr></thead>',
          '<tbody>',
          ...rows.map(r=>{
            if(r.ok){
              const atr = Number(r.atr_abs);
              const atrp = Number(r.atr_norm) * 100.0;
              const close = Number(r.last_close);
              return `<tr>
                <td>${escapeHtml(r.symbol)}</td>
                <td>${isFinite(atr)? atr.toFixed(6): ''}</td>
                <td>${isFinite(atrp)? atrp.toFixed(3)+'%': ''}</td>
                <td>${isFinite(close)? close.toFixed(6): ''}</td>
                <td>‚úÖ</td>
              </tr>`;
            }
            return `<tr>
              <td>${escapeHtml(r.symbol)}</td>
              <td colspan="3"></td>
              <td title="${escapeHtml(r.error)}">‚ùå ${escapeHtml((r.error||'err').slice(0,60))}</td>
            </tr>`;
          }),
          '</tbody></table>'
        ].join('');
        wrap.innerHTML = html;
        wrap.style.display='block';
        status.className='status success';
        status.textContent=`‚úÖ –ì–æ—Ç–æ–≤–æ: ${rows.length} —Å–∏–º–≤–æ–ª–æ–≤`;
      }catch(e){
        status.className='status error';
        status.textContent='‚ùå –û—à–∏–±–∫–∞: ' + e.message;
      }
    }
  </script>
  <script src="/static/js/sidebar.js"></script>
</body>
</html>

