<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedoedAI - üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="/static/css/sidebar.css">
    <link rel="stylesheet" href="/static/css/tabs.css">
    <script src="/static/js/lightweight-charts.standalone.production.js"></script>
</head>
<body>
    {% include 'include/_sidebar.html' %}

    <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>

    <div class="container">
        <div class="main-content">
            <div class="header">
                <h1>üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</h1>
                <p>–í—ã–±–µ—Ä–∏—Ç–µ —Å–∏–º–≤–æ–ª –∏ run (result/&lt;SYMBOL&gt;/runs/&lt;run_id&gt;)</p>
                <div class="button-group" style="margin-top: 12px;">
                    <a href="/" class="btn btn-secondary">‚¨Ö –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
                </div>
            </div>

            <div class="content">
                <div id="analytics-section" class="section">
                    <div class="form-group">
                        <label>–¢–∏–ø –º–æ–¥–µ–ª–∏</label>
                        <select id="modelTypeSelect" onchange="reloadSymbolsForModelType()">
                            <option value="dqn" selected>ü§ñ DQN</option>
                            <option value="sac">üåå SAC</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>–°–∏–º–≤–æ–ª</label>
                        <select id="indexSymbolSelect"></select>
                    </div>
                    <div class="form-group">
                        <label>Run (UUID)</label>
                        <select id="indexRunSelect"></select>
                    </div>
                    <div class="form-group" style="display: none;">
                        <label>–§–∞–π–ª—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (legacy)</label>
                        <select id="resultsFileSelect"></select>
                    </div>
                    <div class="button-group">
                        <button id="listResultsBtn" class="btn btn-info" onclick="loadIndexSymbols()">üìã –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
                        <button id="analyzeResultsBtn" class="btn btn-primary" onclick="analyzeTrainingResultsSelected()">üìà –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</button>
                        <button id="analyzeBadTradesBtn" class="btn btn-warning" onclick="analyzeBadTradesSelected()">üîç –ü–ª–æ—Ö–∏–µ —Å–¥–µ–ª–∫–∏</button>
                    </div>
                </div>

                <div class="section">
                    <div id="indexRunInfo" class="status info" style="display:none; white-space: pre-line;"></div>
                    <div id="winrateChartContainer" class="results" style="display:none;"></div>
                    <div id="epsChartContainer" class="results" style="display:none;"></div>
                    <div id="marketStateChartContainer" class="results" style="display:none;"></div>
                    <div id="equityChartContainer" class="results" style="display:none;"></div>
                    <div id="drawdownChartContainer" class="results" style="display:none;"></div>
                    <div id="rollingChartContainer" class="results" style="display:none;"></div>
                    <div id="roiHistContainer" class="results" style="display:none;"></div>
                    <div id="actionsStatsContainer" class="results" style="display:none;"></div>
                    <div id="churnStatsContainer" class="results" style="display:none;"></div>
                    <div id="analysisStatus" class="status" style="display: none;"></div>
                    <div id="analysisResults" class="results no-scroll" style="display: none;"></div>
                    <div id="filesList" class="results" style="display: none;"></div>
                </div>

                <div class="section">
                    <div id="badTradesStatus" class="status" style="display: none;"></div>
                    <div id="badTradesSummary" class="results" style="display: none;"></div>
                    <div id="badTradesResults" class="results" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ–±—É—á–µ–Ω–∏—è –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã —Å –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        let indexRunsBySymbol = {};

        async function parseJsonResponse(response) {
            const text = await response.text();
            const trimmed = (typeof text === 'string') ? text.trim() : '';
            if (!response.ok) {
                // –ü–æ–¥—Ä–æ–±–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ 404 –¥–ª—è SAC API
                if (response.status === 404 && trimmed.startsWith('<!doctype')) {
                    throw new Error('–≠–Ω–¥–ø–æ–∏–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω (404). –í–æ–∑–º–æ–∂–Ω–æ, —Å–µ—Ä–≤–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç SAC-–∞–Ω–∞–ª–∏—Ç–∏–∫—É.');
                }
                const detail = trimmed ? trimmed.slice(0, 200) : (response.statusText || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                throw new Error(`HTTP ${response.status}: ${detail}`);
            }
            try {
                return JSON.parse(text);
            } catch (err) {
                const detail = trimmed.slice(0, 200);
                throw new Error(`–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON${detail ? `: ${detail}` : ''}`);
            }
        }

        function reloadSymbolsForModelType(){
            indexRunsBySymbol = {};
            const runSel = document.getElementById('indexRunSelect');
            if(runSel){ runSel.innerHTML = '<option value="">‚Äî</option>'; }
            loadIndexSymbols();
        }

        function getSelectedModelType(){
            return (document.getElementById('modelTypeSelect')?.value || 'dqn').trim().toLowerCase();
        }

        async function loadIndexSymbols(){
            const sel = document.getElementById('indexSymbolSelect');
            const runSel = document.getElementById('indexRunSelect');
            if(!sel) return;
            try{
                const modelType = getSelectedModelType();
                const apiBase = (modelType === 'sac') ? '/api/sac' : '';
                const resp = await fetch(`${apiBase}/api/runs/symbols?model_type=${encodeURIComponent(modelType)}`);
                const data = await resp.json();
                const symbols = (data && data.success && Array.isArray(data.symbols))? data.symbols: [];
                sel.innerHTML = symbols.length?
                    symbols.map(s=>{
                        const value = typeof s === 'string' ? s : (s.value || s.label || '');
                        if(!value) return '';
                        let label = typeof s === 'string' ? s : (s.label || s.value);
                        if(value.toUpperCase().startsWith('SAC:')){
                            label = value.split(':')[1] || label;
                        }
                        return `<option value="${value}">${label}</option>`;
                    }).filter(Boolean).join('')
                    : '<option value="">–ù–µ—Ç —Å–∏–º–≤–æ–ª–æ–≤</option>';
                if(symbols.length){ await loadIndexRuns(); }
                else if(runSel){ runSel.innerHTML = '<option value="">‚Äî</option>'; }
            }catch(e){ if(sel) sel.innerHTML = '<option value="">–û—à–∏–±–∫–∞</option>'; }
        }

        async function loadIndexRuns(){
            const selEl = document.getElementById('indexSymbolSelect');
            const rawSymbol = selEl ? selEl.value : '';
            let sym = (rawSymbol || '').trim();
            const modelType = getSelectedModelType();
            if (modelType === 'sac' && sym.toUpperCase().startsWith('SAC:')) {
                sym = sym.split(':', 2)[1] || sym;
            }
            const runSel = document.getElementById('indexRunSelect');
            if(!sym || !runSel) return;
            try{
                const apiBase = (modelType === 'sac') ? '/api/sac' : '';
                const resp = await fetch(`${apiBase}/api/runs/list?model_type=${encodeURIComponent(modelType)}&symbol=${encodeURIComponent(sym)}`);
                const data = await resp.json();
                const runs = (data && data.success && Array.isArray(data.runs))? data.runs: [];
                const symbolDir = runs.length ? (runs[0].symbol_dir || sym) : sym;
                indexRunsBySymbol[rawSymbol] = { list: runs, modelType, symbolDir };
                runSel.innerHTML = runs.length ? runs.map(r=>{
                    const dir = (r && r.direction ? String(r.direction).trim().toLowerCase() : '');
                    const suffix = (dir === 'long' || dir === 'short') ? ` (${dir})` : '';
                    return `<option value="${r.run_id}">${r.run_id}${suffix}</option>`;
                }).join('') : '<option value="">–ù–µ—Ç run–æ–≤</option>';
                try{ await showIndexRunInfo(); }catch(_){ }
            }catch(e){ runSel.innerHTML = '<option value="">–û—à–∏–±–∫–∞</option>'; }
        }

        function getSelectedTrainResultPath(){
            const symRaw = document.getElementById('indexSymbolSelect')?.value || '';
            const sym = symRaw.trim();
            const runId = (document.getElementById('indexRunSelect')?.value||'').trim();
            const entry = indexRunsBySymbol[symRaw] || indexRunsBySymbol[sym.replace(/^SAC:/i, '')] || null;
            const runs = entry?.list || [];
            const modelType = getSelectedModelType();
            const symbolDir = entry?.symbolDir || sym.replace(/^SAC:/i, '');
            const found = runs.find(r=>r.run_id===runId);
            if(found && found.result_path){ return found.result_path; }
            if(sym && runId){
                if(modelType === 'sac'){
                    return `result/sac/${symbolDir.toLowerCase()}/runs/${runId}/train_result.pkl`;
                }
                return `result/dqn/${symbolDir}/runs/${runId}/train_result.pkl`;
            }
            return '';
        }

        async function showIndexRunInfo(){
            const infoDiv = document.getElementById('indexRunInfo');
            if(!infoDiv) return;
            const chartWrap = document.getElementById('winrateChartContainer');
            const epsWrap = document.getElementById('epsChartContainer');
            const msWrap = document.getElementById('marketStateChartContainer');
            const eqWrap = document.getElementById('equityChartContainer');
            const ddWrap = document.getElementById('drawdownChartContainer');
            const rollWrap = document.getElementById('rollingChartContainer');
            const histWrap = document.getElementById('roiHistContainer');
            const actionsWrap = document.getElementById('actionsStatsContainer');
            const churnWrap = document.getElementById('churnStatsContainer');
            const symRaw = document.getElementById('indexSymbolSelect')?.value || '';
            const sym = symRaw.trim();
            const runId = (document.getElementById('indexRunSelect')?.value||'').trim();
            if(!sym || !runId){
                infoDiv.style.display='none';
                if(chartWrap) chartWrap.style.display='none';
                if(epsWrap) epsWrap.style.display='none';
                if(msWrap) msWrap.style.display='none';
                if(eqWrap) eqWrap.style.display='none';
                if(ddWrap) ddWrap.style.display='none';
                if(rollWrap) rollWrap.style.display='none';
                if(histWrap) histWrap.style.display='none';
                if(actionsWrap) actionsWrap.style.display='none';
                if(churnWrap) churnWrap.style.display='none';
                return;
            }
            const entry = indexRunsBySymbol[symRaw] || indexRunsBySymbol[sym.replace(/^SAC:/i, '')] || null;
            const modelType = getSelectedModelType();
            const symbolDir = entry?.symbolDir || sym.replace(/^SAC:/i, '');
            const basePath = modelType === 'sac' ? `result/sac/${symbolDir.toLowerCase()}` : `result/dqn/${symbolDir}`;
            const runs = entry?.list || [];
            const found = runs.find(r=>r.run_id===runId);
            const modelPath = found?.model_path || `${basePath}/runs/${runId}/model.pth`;
            try{
                const resp = await fetch('/get_result_model_info', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ filename: modelPath, model_type: modelType }) });
                const result = await resp.json();
                if(!result.success){
                    infoDiv.className = 'status error';
                    infoDiv.textContent = '‚ùå ' + (result.error || '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏');
                    infoDiv.style.display = 'block';
                    if(chartWrap) chartWrap.style.display='none';
                    if(epsWrap) epsWrap.style.display='none';
                    if(msWrap) msWrap.style.display='none';
                    if(eqWrap) eqWrap.style.display='none';
                    if(ddWrap) ddWrap.style.display='none';
                    if(rollWrap) rollWrap.style.display='none';
                    if(histWrap) histWrap.style.display='none';
                    if(actionsWrap) actionsWrap.style.display='none';
                    if(churnWrap) churnWrap.style.display='none';
                    return;
                }
                const stats = result.stats || {};
                const winrate = typeof stats.winrate === 'number' ? (stats.winrate * 100).toFixed(1) + '%' : 'N/A';
                const plr = typeof stats.pl_ratio === 'number' ? stats.pl_ratio.toFixed(2) : 'N/A';
                const trades = (stats.trades_count != null) ? stats.trades_count : 'N/A';
                const episodes = (result.episodes != null) ? result.episodes : 'N/A';
                const plannedEpisodes = (result.episodes_planned != null) ? result.episodes_planned : '‚Äî';
                const episodeLength = (result.episode_length != null) ? result.episode_length : null;
                const bestWinrate = (typeof result.best_winrate === 'number') ? (result.best_winrate * 100).toFixed(1) + '%' : 'N/A';
                const episodeWinrateSummary = result.episode_winrate_summary || null;
                const validationSummary = result.validation_summary || null;
                const seedFromList = found?.seed;
                const seed = seedFromList != null
                    ? seedFromList
                    : (result.train_metadata && result.train_metadata.seed != null)
                        ? result.train_metadata.seed
                        : (result.cfg_snapshot && result.cfg_snapshot.seed != null)
                            ? result.cfg_snapshot.seed
                            : (result.seed ?? '‚Äî');
                const cfgSeed = (result.cfg_snapshot && result.cfg_snapshot.seed != null) ? result.cfg_snapshot.seed : null;
                const gpu = (result.cuda_available===true) ? (result.gpu_name || 'GPU') : (result.cuda_available===false ? 'CPU' : '‚Äî');
                const totalTime = (typeof result.total_training_time === 'number') ? result.total_training_time : null;
                const avgTime = (typeof result.avg_time_per_episode_sec === 'number') ? result.avg_time_per_episode_sec : (totalTime && episodes ? (totalTime/episodes) : null);
                const fmtSec = (s)=>{ if(!s && s!==0) return 'N/A'; try{ const m=Math.floor(s/60), r=Math.round(s%60); return (m>0?`${m}–º `:'')+`${r}—Å`; }catch(_){ return s.toFixed? s.toFixed(1)+'—Å' : String(s); } };

                const lines = [];
                const setPlaceholder = (wrap, title, note)=>{
                    try{
                        if(!wrap) return;
                        wrap.style.display = 'block';
                        wrap.innerHTML = `<div class="muted" style="margin-bottom:6px;">${title}</div><div class="status info" style="margin:0;">${note || '–î–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –∏–ª–∏ –æ–Ω–∏ –µ—â—ë –Ω–µ —Å–æ–±—Ä–∞–Ω—ã –¥–ª—è —ç—Ç–æ–≥–æ run.'}</div>`;
                    }catch(_){}
                };
                // --- DQN model / encoder provenance (first lines in green block) ---
                try{
                    const mt = (result.model_training_type || '').toString().trim().toLowerCase();
                    const pr = (result.parent_run_id != null) ? String(result.parent_run_id) : '';
                    lines.push(mt === 'continued' ? `–ú–æ–¥–µ–ª—å DQN: –¥–æ–æ–±—É—á–µ–Ω–∏–µ${pr?` (parent: ${pr})`:''}` : '–ú–æ–¥–µ–ª—å DQN: –æ–±—É—á–∞–ª–∞—Å—å —Å –Ω—É–ª—è');
                    const enc = (result.encoder_info && typeof result.encoder_info === 'object') ? result.encoder_info : null;
                    if(enc && enc.path){
                        const v = enc.version_str || enc.version || '';
                        const frozen = (enc.frozen === true);
                        lines.push(`–≠–Ω–∫–æ–¥–µ—Ä: ${v?`—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π ${v}`:'—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π'}${frozen?' (frozen)':' (unfrozen, –¥–æ–æ–±—É—á–µ–Ω–∏–µ)'}`);
                    }
                    lines.push('');
                }catch(_){}
                lines.push(`–°–∏–º–≤–æ–ª: ${symbolDir.toUpperCase()}`);
                lines.push(`Run: ${runId}`);
                const dir = (result.direction || found?.direction || '').toString().trim().toLowerCase();
                if (dir === 'long' || dir === 'short') {
                    lines.push(`–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ${dir.toUpperCase()}`);
                }
                lines.push(`Seed: ${seed}`);
                if (episodeLength !== null && episodeLength !== undefined) {
                    lines.push(`–î–ª–∏–Ω–∞ —ç–ø–∏–∑–æ–¥–∞ (—à–∞–≥–æ–≤): ${episodeLength}`);
                }
                lines.push(`–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${gpu}`);
                // Risk-management –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–±—É—á–µ–Ω–∏—è (TP/SL/min_hold/volume_threshold)
                try{
                    const rm = (result.risk_management && typeof result.risk_management === 'object') ? result.risk_management : null;
                    if(rm){
                        const tp = rm.TAKE_PROFIT_PCT != null ? rm.TAKE_PROFIT_PCT : '‚Äî';
                        const sl = rm.STOP_LOSS_PCT != null ? rm.STOP_LOSS_PCT : '‚Äî';
                        const mh = rm.min_hold_steps != null ? rm.min_hold_steps : '‚Äî';
                        const vt = rm.volume_threshold != null ? rm.volume_threshold : '‚Äî';
                        const trm = rm.atr_trail_mult != null ? rm.atr_trail_mult : '‚Äî';
                        lines.push(`TP: ${tp} | SL: ${sl} | min_hold_steps: ${mh} | volume_threshold: ${vt} | trail_mult: ${trm}`);
                    }
                }catch(_){}
                // Real run config (cfg_snapshot from train_result.pkl) ‚Äî —ç—Ç–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–æ–≥–æ–Ω–∞
                try{
                    const cs = (result.cfg_snapshot && typeof result.cfg_snapshot === 'object') ? result.cfg_snapshot : null;
                    if(cs){
                        const hs = Array.isArray(cs.hidden_sizes) ? `(${cs.hidden_sizes.join(', ')})` : '‚Äî';
                        const lr = (cs.learning_rate != null) ? cs.learning_rate : (cs.lr != null ? cs.lr : '‚Äî');
                        lines.push(`DQN cfg: batch_size=${cs.batch_size ?? '‚Äî'}, memory_size=${cs.memory_size ?? '‚Äî'}, hidden_sizes=${hs}`);
                        lines.push(`DQN cfg: train_repeats=${cs.train_repeats ?? '‚Äî'}, use_amp=${cs.use_amp ?? cs.use_mixed_precision ?? '‚Äî'}, use_gpu_storage=${cs.use_gpu_storage ?? '‚Äî'}`);
                        lines.push(`DQN cfg: learning_rate=${lr}, torch_compile=${cs.torch_compile ?? cs.use_torch_compile ?? '‚Äî'}, eps_decay_steps=${cs.eps_decay_steps ?? '‚Äî'}, dropout_rate=${cs.dropout_rate ?? '‚Äî'}`);
                    }
                }catch(_){}
                // GPU config profile (gpu_configs.py) ‚Äî —Å–ø—Ä–∞–≤–æ—á–Ω–æ, –º–æ–∂–µ—Ç –Ω–µ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å —Ä–µ–∞–ª—å–Ω—ã–º cfg_snapshot
                try{
                    const gp = (result.gpu_config_profile && typeof result.gpu_config_profile === 'object') ? result.gpu_config_profile : null;
                    if(gp){
                        lines.push(`GPU profile: ${gp.name || gp.key || '‚Äî'}`);
                    }
                }catch(_){}
                lines.push(`–≠–ø–∏–∑–æ–¥–æ–≤ (—Ñ–∞–∫—Ç/–ø–ª–∞–Ω): ${episodes} / ${plannedEpisodes}`);
                lines.push(`Winrate: ${winrate}`);
                lines.push(`–õ—É—á—à–∏–π winrate: ${bestWinrate}`);
                if (episodeWinrateSummary && typeof episodeWinrateSummary.count === 'number') {
                    const avgWr = (typeof episodeWinrateSummary.avg === 'number') ? (episodeWinrateSummary.avg * 100).toFixed(1) + '%' : 'N/A';
                    const lastWr = (typeof episodeWinrateSummary.last === 'number') ? (episodeWinrateSummary.last * 100).toFixed(1) + '%' : 'N/A';
                    lines.push(`Winrate —ç–ø–∏–∑–æ–¥–æ–≤: avg ${avgWr}, last ${lastWr} (${episodeWinrateSummary.count} —ç–ø.)`);
                }
                lines.push(`P/L Ratio: ${plr}`);
                lines.push(`–°–¥–µ–ª–æ–∫: ${trades}`);
                if (validationSummary && typeof validationSummary.count === 'number') {
                    const avgVal = (typeof validationSummary.avg === 'number') ? validationSummary.avg.toFixed(2) : 'N/A';
                    const lastVal = (typeof validationSummary.last === 'number') ? validationSummary.last.toFixed(2) : 'N/A';
                    lines.push(`–í–∞–ª–∏–¥–∞—Ü–∏—è: avg ${avgVal}, last ${lastVal} (${validationSummary.count} —á–µ–∫–æ–≤)`);
                }
                lines.push(`–ë—É—Ñ–µ—Ä: ${result.replay_exists ? '‚úÖ –µ—Å—Ç—å' : '‚ùå –Ω–µ—Ç'}`);
                lines.push(`–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—É—á–µ–Ω–∏—è: ${result.train_result_exists ? '‚úÖ –µ—Å—Ç—å' : '‚ùå –Ω–µ—Ç'}`);
                lines.push(`–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –∑–∞ —ç–ø–∏–∑–æ–¥: ${fmtSec(avgTime)}`);
                lines.push(`–û–±—â–µ–µ –≤—Ä–µ–º—è –æ–±—É—á–µ–Ω–∏—è: ${totalTime ? fmtSec(totalTime) : 'N/A'}`);
                lines.push(`–ú–æ–¥–µ–ª—å: ${result.model_file ? result.model_file.split('/').pop().split('\\').pop() : 'N/A'}`);
                lines.push(`–ü—É—Ç—å –∫ –º–æ–¥–µ–ª–∏: ${result.model_path || result.model_file || '‚Äî'}`);
                lines.push(`–ü—É—Ç—å –∫ –±—É—Ñ–µ—Ä—É: ${result.buffer_path || result.replay_file || '‚Äî'}`);
                lines.push(`–†–µ–∑—É–ª—å—Ç–∞—Ç—ã: ${result.train_result_file ? result.train_result_file.split('/').pop().split('\\').pop() : '‚Äî'}`);
                infoDiv.className = 'status info';
                infoDiv.innerText = lines.join('\n');
                infoDiv.style.display = 'block';

                // --- Winrate –ø–æ —ç–ø–∏–∑–æ–¥–∞–º (–≥—Ä–∞—Ñ–∏–∫) ---
                try{
                    if(chartWrap){ chartWrap.innerHTML = ''; chartWrap.style.display='none'; }
                    const series = Array.isArray(result.episode_winrates) ? result.episode_winrates : [];
                    const offset = Number.isFinite(result.episode_winrates_offset) ? Number(result.episode_winrates_offset) : 0;
                    // –§–æ–ª–ª–±–µ–∫: –µ—Å–ª–∏ –Ω–µ—Ç –ø–æ–ª–Ω–æ–≥–æ —Ä—è–¥–∞, –Ω–æ –µ—Å—Ç—å winrate_trend.snapshots ‚Äî —Ä–∏—Å—É–µ–º –ø–æ –Ω–∏–º
                    const wt = (result.winrate_trend && typeof result.winrate_trend === 'object') ? result.winrate_trend : null;
                    const snaps = (wt && Array.isArray(wt.snapshots)) ? wt.snapshots : [];

                    if(chartWrap && (series.length || snaps.length)){
                        chartWrap.style.display = 'block';
                        const title = series.length
                            ? `Winrate –ø–æ —ç–ø–∏–∑–æ–¥–∞–º (–ø–æ—Å–ª–µ–¥–Ω–∏–µ ${series.length}${offset?`, offset=${offset}`:''})`
                            : `Winrate trend (snapshots every ${wt?.snapshot_every ?? 'N/A'}, window=${wt?.window_size ?? 'N/A'})`;
                        chartWrap.innerHTML = `<div class="muted" style="margin-bottom:6px;">${title}</div><div id="winrateChart" style="width:100%;height:280px;"></div>`;
                        const el = document.getElementById('winrateChart');
                        if(el && typeof LightweightCharts !== 'undefined'){
                            const chart = LightweightCharts.createChart(el, {
                                width: el.clientWidth,
                                height: 280,
                                layout: { backgroundColor: '#ffffff', textColor: '#333' },
                                grid: { vertLines: { color: '#e1e2e4' }, horzLines: { color: '#e1e2e4' } },
                                timeScale: { visible: false },
                                rightPriceScale: { visible: true },
                            });
                            const addLineSeriesCompat = (ch, opts) => {
                                if (ch && typeof ch.addLineSeries === 'function') return ch.addLineSeries(opts);
                                if (ch && typeof ch.addSeries === 'function' && LightweightCharts && LightweightCharts.LineSeries) {
                                    return ch.addSeries(LightweightCharts.LineSeries, opts);
                                }
                                throw new Error('Line series API is not available');
                            };
                            const line = addLineSeriesCompat(chart, { color:'#2563eb', lineWidth:2 });
                            if (series.length) {
                                const data = series.map((wr, i)=>({ time: i+1, value: Math.max(0, Math.min(100, Number(wr)*100.0)) }));
                                line.setData(data);
                            } else if (snaps.length) {
                                const data = snaps.map((s)=>{
                                    const ep = Number(s.episode ?? s.epoch ?? 0);
                                    const wr = Number(s.winrate ?? 0);
                                    return { time: ep + 1, value: Math.max(0, Math.min(100, wr*100.0)) };
                                });
                                line.setData(data);
                                // EMA –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω–∞—è –ª–∏–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
                                if (snaps.some(s => s.ema != null)) {
                                    const emaLine = addLineSeriesCompat(chart, { color:'#16a34a', lineWidth:2 });
                                    const emaData = snaps
                                        .filter(s => s.ema != null)
                                        .map(s => ({ time: Number(s.episode ?? s.epoch ?? 0) + 1, value: Math.max(0, Math.min(100, Number(s.ema)*100.0)) }));
                                    emaLine.setData(emaData);
                                }
                            }
                            chart.timeScale().fitContent();
                            new ResizeObserver(()=>{ chart.applyOptions({ width: el.clientWidth }); }).observe(el);
                        } else if (el) {
                            // Fallback: –µ—Å–ª–∏ –≥—Ä–∞—Ñ–∏–∫ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è, –ø–æ–∫–∞–∂–µ–º —Ç–µ–∫—Å—Ç–æ–º
                            if (series.length) {
                                el.innerHTML = `<pre>Winrate points: ${series.length}\nfirst=${(series[0]*100).toFixed(1)}% last=${(series[series.length-1]*100).toFixed(1)}%</pre>`;
                            } else if (snaps.length) {
                                const first = snaps[0], last = snaps[snaps.length-1];
                                el.innerHTML = `<pre>Winrate trend snapshots: ${snaps.length}\nfirst=${((first.winrate||0)*100).toFixed(1)}% last=${((last.winrate||0)*100).toFixed(1)}%</pre>`;
                            }
                        }
                    }
                }catch(e){ /* ignore chart errors */ }

                // --- Epsilon –ø–æ —ç–ø–∏–∑–æ–¥–∞–º (–≥—Ä–∞—Ñ–∏–∫ –Ω–∏–∂–µ) ---
                try{
                    if(epsWrap){ epsWrap.innerHTML=''; epsWrap.style.display='none'; }
                    const eps = Array.isArray(result.episode_epsilons) ? result.episode_epsilons : [];
                    const epsOff = Number.isFinite(result.episode_epsilons_offset) ? Number(result.episode_epsilons_offset) : 0;
                    if(epsWrap && eps.length){
                        epsWrap.style.display = 'block';
                        epsWrap.innerHTML = `<div class="muted" style="margin-bottom:6px;">Epsilon –ø–æ —ç–ø–∏–∑–æ–¥–∞–º (–ø–æ—Å–ª–µ–¥–Ω–∏–µ ${eps.length}${epsOff?`, offset=${epsOff}`:''})</div><div id="epsChart" style="width:100%;height:220px;"></div>`;
                        const el = document.getElementById('epsChart');
                        if(el && typeof LightweightCharts !== 'undefined'){
                            const chart = LightweightCharts.createChart(el, {
                                width: el.clientWidth,
                                height: 220,
                                layout: { backgroundColor: '#ffffff', textColor: '#333' },
                                grid: { vertLines: { color: '#e1e2e4' }, horzLines: { color: '#e1e2e4' } },
                                timeScale: { visible: false },
                                rightPriceScale: { visible: true },
                            });
                            const addLineSeriesCompat = (ch, opts) => {
                                if (ch && typeof ch.addLineSeries === 'function') return ch.addLineSeries(opts);
                                if (ch && typeof ch.addSeries === 'function' && LightweightCharts && LightweightCharts.LineSeries) {
                                    return ch.addSeries(LightweightCharts.LineSeries, opts);
                                }
                                throw new Error('Line series API is not available');
                            };
                            const line = addLineSeriesCompat(chart, { color:'#7c3aed', lineWidth:2 });
                            const data = eps.map((v, i)=>({ time: i+1, value: Number(v) }));
                            line.setData(data);
                            chart.timeScale().fitContent();
                            new ResizeObserver(()=>{ chart.applyOptions({ width: el.clientWidth }); }).observe(el);
                        }
                    }
                }catch(e){ /* ignore */ }

                // --- Market state distribution (bar) ---
                try{
                    if(msWrap){ msWrap.innerHTML=''; msWrap.style.display='none'; }
                    const msTotal = (result.market_state_counts_total && typeof result.market_state_counts_total === 'object') ? result.market_state_counts_total : null;
                    const msEp = (result.market_state_counts_episode && typeof result.market_state_counts_episode === 'object') ? result.market_state_counts_episode : null;
                    const keys = ['NORMAL','HIGH_VOL','PANIC','DRAWDOWN'];
                    const sum = (obj)=> keys.reduce((s,k)=>s + Number(obj?.[k]||0), 0);
                    const totalN = msTotal ? sum(msTotal) : 0;
                    if(msWrap && msTotal && totalN>0){
                        msWrap.style.display='block';
                        const lines = keys.map(k=>{
                            const v = Number(msTotal[k]||0);
                            const pct = ((v/totalN)*100).toFixed(1);
                            const epv = msEp ? Number(msEp[k]||0) : null;
                            return `${k}: ${v} (${pct}%)${epv!=null?` | episode: ${epv}`:''}`;
                        }).join('\n');
                        msWrap.innerHTML = `<div class="muted" style="margin-bottom:6px;">MARKET_STATE —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ (total + last episode)</div><pre>${lines}</pre>`;
                    }
                }catch(e){ /* ignore */ }

                // --- Equity curve (cumulative ROI, %) ---
                try{
                    if(eqWrap){ eqWrap.innerHTML=''; eqWrap.style.display='none'; }
                    const eq = Array.isArray(result.equity_curve) ? result.equity_curve : [];
                    if(eqWrap && eq.length){
                        eqWrap.style.display='block';
                        eqWrap.innerHTML = `<div class="muted" style="margin-bottom:6px;">Equity curve (cum ROI, %), points=${eq.length}</div><div id="equityChart" style="width:100%;height:260px;"></div>`;
                        const el = document.getElementById('equityChart');
                        if(el && typeof LightweightCharts !== 'undefined'){
                            const chart = LightweightCharts.createChart(el, {
                                width: el.clientWidth,
                                height: 260,
                                layout: { backgroundColor: '#ffffff', textColor: '#333' },
                                grid: { vertLines: { color: '#e1e2e4' }, horzLines: { color: '#e1e2e4' } },
                                timeScale: { visible: false },
                                rightPriceScale: { visible: true },
                            });
                            const addLineSeriesCompat = (ch, opts) => {
                                if (ch && typeof ch.addLineSeries === 'function') return ch.addLineSeries(opts);
                                if (ch && typeof ch.addSeries === 'function' && LightweightCharts && LightweightCharts.LineSeries) {
                                    return ch.addSeries(LightweightCharts.LineSeries, opts);
                                }
                                throw new Error('Line series API is not available');
                            };
                            const line = addLineSeriesCompat(chart, { color:'#0ea5e9', lineWidth:2 });
                            const data = eq.map((p)=>({ time: Number(p.i||0), value: Number(p.v||0) }));
                            line.setData(data);
                            chart.timeScale().fitContent();
                            new ResizeObserver(()=>{ chart.applyOptions({ width: el.clientWidth }); }).observe(el);
                        }
                    }
                }catch(e){ /* ignore */ }

                // --- Drawdown / underwater curve (%, <=0) ---
                try{
                    if(ddWrap){ ddWrap.innerHTML=''; ddWrap.style.display='none'; }
                    const uw = Array.isArray(result.underwater_curve) ? result.underwater_curve : [];
                    if(ddWrap && uw.length){
                        ddWrap.style.display='block';
                        ddWrap.innerHTML = `<div class="muted" style="margin-bottom:6px;">–ü—Ä–æ—Å–∞–¥–∫–∞ / Underwater (%, points=${uw.length})</div><div id="ddChart" style="width:100%;height:220px;"></div>`;
                        const el = document.getElementById('ddChart');
                        if(el && typeof LightweightCharts !== 'undefined'){
                            const chart = LightweightCharts.createChart(el, {
                                width: el.clientWidth,
                                height: 220,
                                layout: { backgroundColor: '#ffffff', textColor: '#333' },
                                grid: { vertLines: { color: '#e1e2e4' }, horzLines: { color: '#e1e2e4' } },
                                timeScale: { visible: false },
                                rightPriceScale: { visible: true },
                            });
                            const addLineSeriesCompat = (ch, opts) => {
                                if (ch && typeof ch.addLineSeries === 'function') return ch.addLineSeries(opts);
                                if (ch && typeof ch.addSeries === 'function' && LightweightCharts && LightweightCharts.LineSeries) {
                                    return ch.addSeries(LightweightCharts.LineSeries, opts);
                                }
                                throw new Error('Line series API is not available');
                            };
                            const line = addLineSeriesCompat(chart, { color:'#ef4444', lineWidth:2 });
                            const data = uw.map(p=>({ time: Number(p.i||0), value: Number(p.v||0) }));
                            line.setData(data);
                            chart.timeScale().fitContent();
                            new ResizeObserver(()=>{ chart.applyOptions({ width: el.clientWidth }); }).observe(el);
                        }
                    } else if (ddWrap) {
                        setPlaceholder(ddWrap, '–ü—Ä–æ—Å–∞–¥–∫–∞ / Underwater', '–î–∞–Ω–Ω—ã—Ö –Ω–µ—Ç (underwater_curve –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –ø—É—Å—Ç–æ–π).');
                    }
                }catch(e){ /* ignore */ }

                // --- Rolling quality: avg ROI% + profit factor (last N trades) ---
                try{
                    if(rollWrap){ rollWrap.innerHTML=''; rollWrap.style.display='none'; }
                    const rollAvg = Array.isArray(result.rolling_avg_roi) ? result.rolling_avg_roi : [];
                    const rollPf = Array.isArray(result.rolling_profit_factor) ? result.rolling_profit_factor : [];
                    const wN = Number.isFinite(result.rolling_window_trades) ? Number(result.rolling_window_trades) : 50;
                    if(rollWrap && (rollAvg.length || rollPf.length)){
                        rollWrap.style.display='block';
                        rollWrap.innerHTML = `<div class="muted" style="margin-bottom:6px;">–°–∫–æ–ª—å–∑—è—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–¥–µ–ª–æ–∫), N=${wN}</div><div id="rollAvgChart" style="width:100%;height:220px;margin-bottom:10px;"></div><div id="rollPfChart" style="width:100%;height:220px;"></div>`;
                        const el1 = document.getElementById('rollAvgChart');
                        const el2 = document.getElementById('rollPfChart');
                        if(typeof LightweightCharts !== 'undefined'){
                            const addLineSeriesCompat = (ch, opts) => {
                                if (ch && typeof ch.addLineSeries === 'function') return ch.addLineSeries(opts);
                                if (ch && typeof ch.addSeries === 'function' && LightweightCharts && LightweightCharts.LineSeries) {
                                    return ch.addSeries(LightweightCharts.LineSeries, opts);
                                }
                                throw new Error('Line series API is not available');
                            };
                            if(el1 && rollAvg.length){
                                const chart = LightweightCharts.createChart(el1, {
                                    width: el1.clientWidth,
                                    height: 220,
                                    layout: { backgroundColor: '#ffffff', textColor: '#333' },
                                    grid: { vertLines: { color: '#e1e2e4' }, horzLines: { color: '#e1e2e4' } },
                                    timeScale: { visible: false },
                                    rightPriceScale: { visible: true },
                                });
                                const line = addLineSeriesCompat(chart, { color:'#0ea5e9', lineWidth:2 });
                                line.setData(rollAvg.map(p=>({ time: Number(p.i||0), value: Number(p.v||0) })));
                                chart.timeScale().fitContent();
                                new ResizeObserver(()=>{ chart.applyOptions({ width: el1.clientWidth }); }).observe(el1);
                            }
                            if(el2 && rollPf.length){
                                const chart = LightweightCharts.createChart(el2, {
                                    width: el2.clientWidth,
                                    height: 220,
                                    layout: { backgroundColor: '#ffffff', textColor: '#333' },
                                    grid: { vertLines: { color: '#e1e2e4' }, horzLines: { color: '#e1e2e4' } },
                                    timeScale: { visible: false },
                                    rightPriceScale: { visible: true },
                                });
                                const line = addLineSeriesCompat(chart, { color:'#16a34a', lineWidth:2 });
                                line.setData(rollPf.map(p=>({ time: Number(p.i||0), value: Number(p.v||0) })));
                                chart.timeScale().fitContent();
                                new ResizeObserver(()=>{ chart.applyOptions({ width: el2.clientWidth }); }).observe(el2);
                            }
                        }
                    } else if (rollWrap) {
                        setPlaceholder(rollWrap, `–°–∫–æ–ª—å–∑—è—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–¥–µ–ª–æ–∫), N=${wN}`, '–î–∞–Ω–Ω—ã—Ö –Ω–µ—Ç (rolling_avg_roi / rolling_profit_factor –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∏–ª–∏ –ø—É—Å—Ç—ã–µ).');
                    }
                }catch(e){ /* ignore */ }

                // --- ROI histogram (counts by ROI%, rendered as text bars) ---
                try{
                    if(histWrap){ histWrap.innerHTML=''; histWrap.style.display='none'; }
                    const h = (result.roi_histogram && typeof result.roi_histogram === 'object') ? result.roi_histogram : null;
                    if(histWrap && h && Array.isArray(h.centers) && Array.isArray(h.counts) && h.centers.length){
                        histWrap.style.display='block';
                        // Render compact histogram as ascii bars (fast, no extra libs)
                        const centers = h.centers;
                        const counts = h.counts;
                        const maxC = Math.max(...counts.map(x=>Number(x)||0), 1);
                        const lines = [];
                        const step = Math.max(1, Math.floor(centers.length / 30)); // compress to ~30 lines
                        for(let i=0;i<centers.length;i+=step){
                            const c = Number(centers[i]||0);
                            const v = Number(counts[i]||0);
                            const barLen = Math.round((v/maxC)*20);
                            lines.push(`${c.toFixed(2)}% | ${'#'.repeat(barLen)} ${v}`);
                        }
                        histWrap.innerHTML = `<div class="muted" style="margin-bottom:6px;">–ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞ ROI (‚âà${h.lo?.toFixed?.(2)??h.lo}%..${h.hi?.toFixed?.(2)??h.hi}%, bins=${h.bins})</div><pre>${lines.join('\n')}</pre>`;
                    } else if (histWrap) {
                        setPlaceholder(histWrap, '–ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞ ROI', '–î–∞–Ω–Ω—ã—Ö –Ω–µ—Ç (roi_histogram –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –ø—É—Å—Ç–æ–π).');
                    }
                }catch(e){ /* ignore */ }

                // --- Action counts (BUY/HOLD/SELL) ---
                try{
                    if(actionsWrap){ actionsWrap.innerHTML=''; actionsWrap.style.display='none'; }
                    const ac = (result.action_counts_total && typeof result.action_counts_total === 'object') ? result.action_counts_total : null;
                    if(actionsWrap && ac){
                        const hold = Number(ac['0'] ?? 0);
                        const buy  = Number(ac['1'] ?? 0);
                        const sell = Number(ac['2'] ?? 0);
                        const total = (Number.isFinite(hold)?hold:0) + (Number.isFinite(buy)?buy:0) + (Number.isFinite(sell)?sell:0);
                        actionsWrap.style.display = 'block';
                        const ms = (result.market_state_counts_total && typeof result.market_state_counts_total === 'object') ? result.market_state_counts_total : null;
                        const msKeys = ['NORMAL','HIGH_VOL','PANIC','DRAWDOWN'];
                        const msTotal = ms ? msKeys.reduce((s,k)=>s + Number(ms[k]||0), 0) : 0;
                        const msText = ms ? msKeys.map(k=>{
                            const v = Number(ms[k]||0);
                            const pct = msTotal ? ` (${((v/msTotal)*100).toFixed(1)}%)` : '';
                            return `${k}: ${v}${pct}`;
                        }).join('\n') : 'N/A';
                        actionsWrap.innerHTML = `<div class="muted" style="margin-bottom:6px;">Action counts + MARKET_STATE</div>
 <pre>HOLD(0): ${hold}\nBUY(1):  ${buy}\nSELL(2): ${sell}\nTOTAL:   ${total}\n\nMARKET_STATE:\n${msText}</pre>`;
                    }
                }catch(e){ /* ignore */ }

                // --- Churn + filters stats (text) ---
                try{
                    if(churnWrap){ churnWrap.innerHTML=''; churnWrap.style.display='none'; }
                    const tpe = (typeof result.trades_per_episode === 'number') ? result.trades_per_episode : null;
                    const bar = (typeof result.buy_accept_rate === 'number') ? result.buy_accept_rate : null;
                    const mb = (typeof result.avg_minutes_between_buys === 'number') ? result.avg_minutes_between_buys : null;
                    const bs = (result.buy_stats_total && typeof result.buy_stats_total === 'object') ? result.buy_stats_total : null;
                    if(churnWrap && (tpe!=null || bar!=null || mb!=null || bs)){
                        churnWrap.style.display='block';
                        const lines = [];
                        if(tpe!=null) lines.push(`trades_per_episode: ${tpe.toFixed(3)}`);
                        if(bar!=null) lines.push(`buy_accept_rate: ${(bar*100).toFixed(1)}%`);
                        if(mb!=null) lines.push(`avg_minutes_between_buys: ${mb.toFixed(1)} min`);
                        if(bs){
                            const keys = Object.keys(bs).sort();
                            lines.push('');
                            lines.push('buy_stats_total:');
                            keys.forEach(k=>{ lines.push(`  ${k}: ${Number(bs[k]||0)}`); });
                        }
                        churnWrap.innerHTML = `<div class="muted" style="margin-bottom:6px;">Churn + filters</div><pre>${lines.join('\n')}</pre>`;
                    }
                }catch(e){ /* ignore */ }
            }catch(e){
                infoDiv.className = 'status error';
                infoDiv.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + e.message;
                infoDiv.style.display = 'block';
                if(chartWrap) chartWrap.style.display='none';
                if(epsWrap) epsWrap.style.display='none';
                if(msWrap) msWrap.style.display='none';
                if(eqWrap) eqWrap.style.display='none';
                if(ddWrap) ddWrap.style.display='none';
                if(rollWrap) rollWrap.style.display='none';
                if(histWrap) histWrap.style.display='none';
                if(actionsWrap) actionsWrap.style.display='none';
                if(churnWrap) churnWrap.style.display='none';
            }
        }

        async function listTrainingResults() {
            const statusDiv = document.getElementById('analysisStatus');
            const filesDiv = document.getElementById('filesList');
            const selectEl = document.getElementById('resultsFileSelect');
            const listBtn = document.getElementById('listResultsBtn');
            
            listBtn.disabled = true;
            listBtn.textContent = '‚è≥ –ü–æ–∏—Å–∫ —Ñ–∞–π–ª–æ–≤...';
            statusDiv.style.display = 'block';
            statusDiv.className = 'status running';
            statusDiv.textContent = 'üîç –ü–æ–∏—Å–∫ —Ñ–∞–π–ª–æ–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ–±—É—á–µ–Ω–∏—è...';
            
            try {
                const response = await fetch('/list_training_results', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                const result = await parseJsonResponse(response);
                
                if (result.success) {
                    statusDiv.className = 'status success';
                    statusDiv.textContent = '‚úÖ ' + result.message;
                    filesDiv.style.display = 'block';
                    
                    let filesText = `üìã –î–û–°–¢–£–ü–ù–´–ï –§–ê–ô–õ–´ –†–ï–ó–£–õ–¨–¢–ê–¢–û–í:\n`;
                    filesText += `=====================================\n\n`;
                    
                    if (result.files && result.files.length > 0) {
                        selectEl.innerHTML = '';
                        for (const file of result.files) {
                            const opt = document.createElement('option');
                            opt.value = file.filename;
                            const date = new Date(file.created * 1000).toLocaleString();
                            const sizeKB = (file.size / 1024).toFixed(1);
                            opt.textContent = `${file.filename} (${sizeKB} KB, ${date})`;
                            selectEl.appendChild(opt);
                        }
                        for (const file of result.files) {
                            const date = new Date(file.created * 1000).toLocaleString();
                            const sizeKB = (file.size / 1024).toFixed(1);
                            filesText += `üìÑ ${file.filename}\n`;
                            filesText += `   üìÖ –°–æ–∑–¥–∞–Ω: ${date}\n`;
                            filesText += `   üìè –†–∞–∑–º–µ—Ä: ${sizeKB} KB\n\n`;
                        }
                    } else {
                        if (selectEl) {
                            selectEl.innerHTML = '';
                            const opt = document.createElement('option');
                            opt.value = '';
                            opt.textContent = '–ù–µ—Ç —Ñ–∞–π–ª–æ–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤';
                            selectEl.appendChild(opt);
                        }
                        filesText += `‚ùå –§–∞–π–ª—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã\n`;
                        filesText += `üí° –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –æ–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏\n`;
                    }
                    
                    filesDiv.innerHTML = `<pre>${filesText}</pre>`;
                    
                } else {
                    throw new Error(result.message);
                }
                
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ —Ñ–∞–π–ª–æ–≤: ' + error.message;
            } finally {
                listBtn.disabled = false;
                listBtn.textContent = 'üìã –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫';
            }
        }

        async function analyzeTrainingResultsSelected() {
            let file = getSelectedTrainResultPath();
            if(!file){
                const selectEl = document.getElementById('resultsFileSelect');
                file = selectEl? (selectEl.value||'') : '';
            }

            const modelType = getSelectedModelType();
            const analyzeBtn = document.getElementById('analyzeResultsBtn');
            const statusDiv = document.getElementById('analysisStatus');
            const resultsDiv = document.getElementById('analysisResults');
            analyzeBtn.disabled = true;
            statusDiv.style.display = 'block';
            statusDiv.className = 'status running';
            statusDiv.textContent = 'üìä –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ–±—É—á–µ–Ω–∏—è...';

            console.log('[Analytics] modelType =', modelType, 'file =', file);

            try {
                let url;
                let payload;

                if (modelType === 'sac') {
                    url = '/api/sac/analyze_training_results';
                    payload = { file };
                    console.log('[Analytics] SAC endpoint', url);
                } else {
                    url = '/analyze_training_results';
                    payload = { file, model_type: modelType };
                    console.log('[Analytics] DQN endpoint', url);
                }

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                console.log('[Analytics] Response status =', response.status);

                const result = await parseJsonResponse(response);
                if (result.success) {
                    statusDiv.className = 'status success';
                    statusDiv.textContent = '‚úÖ ' + result.message;
                    resultsDiv.style.display = 'block';
                    const ru = (result.report_ru && typeof result.report_ru === 'object') ? result.report_ru : null;
                    const raw = (result.output && result.output.trim()) ? result.output : '';

                    const esc = (s)=> String(s ?? '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
                    const fmt = (v)=>{
                        if(v === null || v === undefined || v === '') return '‚Äî';
                        if(typeof v === 'number') return Number.isFinite(v) ? String(v) : '‚Äî';
                        if(Array.isArray(v)) return esc(JSON.stringify(v));
                        if(typeof v === 'object') return esc(JSON.stringify(v));
                        return esc(String(v));
                    };
                    const row = (k,v)=> `<tr><td style="padding:6px 8px; font-weight:600; width:260px;">${esc(k)}</td><td style="padding:6px 8px;">${fmt(v)}</td></tr>`;

                    let html = '';
                    html += `<div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-start;">`;
                    html += `<div style="flex:1; min-width:420px;">`;
                    html += `<div style="font-weight:700; margin:4px 0 8px 0;">üìä –û—Ç—á—ë—Ç (—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–æ)</div>`;
                    if(ru){
                        html += `<table style="width:100%; border-collapse: collapse; background:#fff; border:1px solid #e5e7eb; border-radius:10px; overflow:hidden;">`;
                        const topKeys = ["–§–∞–π–ª","–°–∏–º–≤–æ–ª","Run ID","–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ","–≠–ø–∏–∑–æ–¥–æ–≤ (–ø–ª–∞–Ω)","–≠–ø–∏–∑–æ–¥–æ–≤ (—Ñ–∞–∫—Ç)","–î–ª–∏–Ω–∞ —ç–ø–∏–∑–æ–¥–∞ (—à–∞–≥–æ–≤)","Seed","–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ","–í—Ä–µ–º—è –æ–±—É—á–µ–Ω–∏—è (—Å–µ–∫)"];
                        topKeys.forEach(k=>{ if(Object.prototype.hasOwnProperty.call(ru,k)) html += row(k, ru[k]); });
                        html += `</table>`;

                        const sections = [
                            ["–ö–æ–Ω—Ñ–∏–≥ (—Ä–µ–∞–ª—å–Ω—ã–π, cfg_snapshot)","‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥"],
                            ["–ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (final_stats)","üèÅ –ò—Ç–æ–≥–∏"],
                            ["–î–µ–π—Å—Ç–≤–∏—è –∞–≥–µ–Ω—Ç–∞ (–≤—Å–µ–≥–æ)","üéÆ –î–µ–π—Å—Ç–≤–∏—è"],
                            ["–†—ã–Ω–æ—á–Ω—ã–µ —Ä–µ–∂–∏–º—ã (–≤—Å–µ–≥–æ)","üå¶Ô∏è –†—ã–Ω–æ–∫ (–≤—Å–µ–≥–æ)"],
                            ["–†—ã–Ω–æ—á–Ω—ã–µ —Ä–µ–∂–∏–º—ã (–ø–æ—Å–ª–µ–¥–Ω–∏–π —ç–ø–∏–∑–æ–¥)","üå¶Ô∏è –†—ã–Ω–æ–∫ (–ø–æ—Å–ª–µ–¥–Ω–∏–π —ç–ø–∏–∑–æ–¥)"],
                            ["–§–∏–ª—å—Ç—Ä—ã –ø–æ–∫—É–ø–æ–∫ (–∏—Ç–æ–≥–æ)","üß± –§–∏–ª—å—Ç—Ä—ã –ø–æ–∫—É–ø–æ–∫"],
                            ["–°–¥–µ–ª–∫–∏ (—Ö—Ä–∞–Ω–µ–Ω–∏–µ)","üì¶ –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–¥–µ–ª–æ–∫"],
                            ["–ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã","üìÅ –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã"],
                        ];
                        html += `<div style="margin-top:10px; display:grid; gap:8px;">`;
                        sections.forEach(([key,title])=>{
                            if(!ru || !Object.prototype.hasOwnProperty.call(ru,key)) return;
                            html += `<details open style="background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px;">`;
                            html += `<summary style="cursor:pointer; font-weight:700;">${esc(title)}</summary>`;
                            html += `<div class="mono" style="margin-top:6px; font-size:12px;"><pre>${esc(JSON.stringify(ru[key], null, 2))}</pre></div>`;
                            html += `</details>`;
                        });
                        html += `</div>`;
                    }else{
                        html += `<div class="status info">–ù–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –æ—Ç—á—ë—Ç–∞ (report_ru).</div>`;
                    }
                    html += `</div>`;
                    html += `<div style="flex:1; min-width:420px;">`;
                    html += `<div style="font-weight:700; margin:4px 0 8px 0;">üßæ –°—ã—Ä–æ–π –≤—ã–≤–æ–¥ (–ª–æ–≥)</div>`;
                    html += `<details ${raw ? '' : 'open'} style="background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px;">`;
                    html += `<summary style="cursor:pointer; font-weight:700;">–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å</summary>`;
                    html += raw ? `<pre>${esc(raw)}</pre>` : `<div class="muted">–ù–µ—Ç —Å—ã—Ä–æ–≥–æ –≤—ã–≤–æ–¥–∞.</div>`;
                    html += `</details>`;
                    html += `</div>`;
                    html += `</div>`;
                    resultsDiv.innerHTML = html;
                } else {
                    throw new Error(result.message);
                }
            } catch (e) {
                console.error('[Analytics] –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞:', e);
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + e.message;
            } finally {
                analyzeBtn.disabled = false;
            }
        }

        async function analyzeBadTradesSelected() {
            let file = getSelectedTrainResultPath();
            if(!file){
                const selectEl = document.getElementById('resultsFileSelect');
                file = selectEl? (selectEl.value||'') : '';
            }
            const entry = indexRunsBySymbol[document.getElementById('indexSymbolSelect')?.value || ''];
            const modelType = entry?.modelType || getSelectedModelType();
            const analyzeBtn = document.getElementById('analyzeBadTradesBtn');
            const statusDiv = document.getElementById('badTradesStatus');
            const resultsDiv = document.getElementById('badTradesResults');
            const summaryDiv = document.getElementById('badTradesSummary');
            analyzeBtn.disabled = true;
            statusDiv.style.display = 'block';
            statusDiv.className = 'status running';
            statusDiv.textContent = 'üîç –ê–Ω–∞–ª–∏–∑ –ø–ª–æ—Ö–∏—Ö —Å–¥–µ–ª–æ–∫...';
            resultsDiv.style.display = 'none';
            summaryDiv.style.display = 'none';
            try {
                const response = await fetch('/analyze_bad_trades', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ file, model_type: modelType })
                });
                const result = await parseJsonResponse(response);
                if (result.success) {
                    statusDiv.className = 'status success';
                    statusDiv.textContent = '‚úÖ ' + result.message;
                    summaryDiv.style.display = 'block';
                    let summaryText = `üìä –°–í–û–î–ö–ê –ü–õ–û–•–ò–• –°–î–ï–õ–û–ö\n===============================\n\n`;
                    summaryText += `üìÑ –§–∞–π–ª: ${result.file_analyzed.split('/').pop()}\n`;
                    summaryText += `üî¢ –ü–ª–æ—Ö–∏—Ö —Å–¥–µ–ª–æ–∫: ${result.bad_trades_count} (${result.bad_trades_percentage.toFixed(2)}%)\n`;
                    summaryDiv.innerHTML = `<pre>${summaryText}</pre>`;
                    resultsDiv.style.display = 'block';
                    const badTradesOutput = (result.output && result.output.trim()) ? result.output : '–ù–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–µ—Ç–∞–ª–µ–π.';
                    resultsDiv.innerHTML = `<pre>${badTradesOutput}</pre>`;
                } else {
                    throw new Error(result.message);
                }
            } catch (e) {
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + e.message;
            } finally {
                analyzeBtn.disabled = false;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            try {
                loadIndexSymbols();
                const symSel = document.getElementById('indexSymbolSelect');
                if (symSel) { symSel.addEventListener('change', loadIndexRuns); }
                const runSel = document.getElementById('indexRunSelect');
                if (runSel) { runSel.addEventListener('change', showIndexRunInfo); }
            } catch (e) {
                console.error(e);
            }
        });
    </script>
    <script src="/static/js/sidebar.js"></script>
</body>
</html>
