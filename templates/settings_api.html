<!DOCTYPE html>
<html lang="ru">
<head>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="/static/css/sidebar.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ API</title>
    <style>
        .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
        .hint { color:#6c757d; font-size: 12px; }
        .table { width:100%; border-collapse: collapse; }
        .table th, .table td { border:1px solid #e1e1e1; padding:8px; text-align:left; }
        .table th { background:#f7f7f7; }
        @media (max-width: 900px){ .grid2 { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    {% include 'include/_sidebar.html' %}
    <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>

    <div class="container">
        <div class="main-content">
            <div class="header">
                <h1>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí üîë API</h1>
                <p class="hint">–ö–ª—é—á–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ Postgres (—Ç–∞–±–ª–∏—Ü–∞ <code>app_settings</code>) –∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è —Å—Ä–∞–∑—É.</p>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5>‚ûï –î–æ–±–∞–≤–∏—Ç—å / –æ–±–Ω–æ–≤–∏—Ç—å API</h5>
                </div>
                <div class="grid2">
                    <div class="form-group">
                        <label>–ë–∏—Ä–∂–∞</label>
                        <select id="exSel" class="form-control">
                            <option value="bybit">Bybit</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Account ID (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                        <input id="accId" class="form-control" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 2 (–µ—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî –±—É–¥–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π)" />
                    </div>
                    <div class="form-group">
                        <label>Label</label>
                        <input id="accLabel" class="form-control" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: aiBNB" />
                    </div>
                    <div class="form-group">
                        <label>API KEY</label>
                        <input id="apiKey" class="form-control" placeholder="BYBIT_<id>_API_KEY" />
                    </div>
                    <div class="form-group">
                        <label>SECRET KEY</label>
                        <input id="secretKey" class="form-control" placeholder="BYBIT_<id>_SECRET_KEY" />
                    </div>
                </div>
                <div style="margin-top:10px; display:flex; gap:10px;">
                    <button class="btn btn-primary" onclick="saveAccount()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <div id="saveStatus" class="status info" style="display:none;"></div>
                </div>
            </div>

            <div class="card" style="margin-top:16px;">
                <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;">
                    <h5>üìã –¢–µ–∫—É—â–∏–µ –∞–∫–∫–∞—É–Ω—Ç—ã</h5>
                    <button class="btn btn-secondary" onclick="loadAccounts()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
                <div id="listStatus" class="status info">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                <div style="overflow:auto;">
                    <table class="table" id="accTable" style="display:none;">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Label</th>
                                <th>API key</th>
                                <th>Secret</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="accTbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/sidebar.js"></script>
    <script>
        function showStatus(elementId, type, message) {
            const el = document.getElementById(elementId);
            if(!el) return;
            el.textContent = message;
            el.className = `status ${type}`;
            el.style.display = 'block';
            setTimeout(() => { try{ el.style.display = 'none'; }catch(_){ } }, 6000);
        }

        async function loadAccounts(){
            const status = document.getElementById('listStatus');
            const tbl = document.getElementById('accTable');
            const body = document.getElementById('accTbody');
            if(status){ status.style.display = 'block'; status.className='status info'; status.textContent='–ó–∞–≥—Ä—É–∑–∫–∞...'; }
            if(tbl) tbl.style.display = 'none';
            try{
                const ex = document.getElementById('exSel')?.value || 'bybit';
                const r = await fetch(`/api/settings/api/accounts?exchange=${encodeURIComponent(ex)}`);
                const j = await r.json();
                if(!j.success) throw new Error(j.error || 'load failed');
                const items = Array.isArray(j.accounts) ? j.accounts : [];
                if(items.length === 0){
                    if(status){ status.className='status info'; status.textContent='–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –≤ .env'; }
                    return;
                }
                body.innerHTML = items.map(a=>{
                    const hasSecret = a.has_secret ? 'yes' : 'no';
                    const api = a.api_key_masked || '‚Äî';
                    const label = a.label || '‚Äî';
                    return `<tr>
                        <td>${a.id}</td>
                        <td>${label}</td>
                        <td>${api}</td>
                        <td>${hasSecret}</td>
                        <td><button class="btn btn-danger" onclick="deleteAccount('${a.id}')">üóëÔ∏è</button></td>
                    </tr>`;
                }).join('');
                if(status) status.style.display='none';
                if(tbl) tbl.style.display='table';
            }catch(e){
                if(status){ status.className='status error'; status.textContent='–û—à–∏–±–∫–∞: '+e.message; }
            }
        }

        async function saveAccount(){
            try{
                const ex = document.getElementById('exSel')?.value || 'bybit';
                const id = (document.getElementById('accId')?.value || '').trim();
                const label = (document.getElementById('accLabel')?.value || '').trim();
                const api_key = (document.getElementById('apiKey')?.value || '').trim();
                const secret_key = (document.getElementById('secretKey')?.value || '').trim();
                const payload = { exchange: ex, id, label, api_key, secret_key };
                const r = await fetch('/api/settings/api/accounts/save', {
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body: JSON.stringify(payload)
                });
                const j = await r.json();
                if(!j.success) throw new Error(j.error || 'save failed');
                showStatus('saveStatus','success', '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ Postgres');
                // –æ—á–∏—Å—Ç–∏–º —Å–µ–∫—Ä–µ—Ç
                try{ document.getElementById('secretKey').value=''; }catch(_){}
                await loadAccounts();
            }catch(e){
                showStatus('saveStatus','error', e.message);
            }
        }

        async function deleteAccount(id){
            try{
                if(!confirm('–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç id='+id+' –∏–∑ .env?')) return;
                const ex = document.getElementById('exSel')?.value || 'bybit';
                const r = await fetch('/api/settings/api/accounts/delete', {
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({exchange: ex, id})
                });
                const j = await r.json();
                if(!j.success) throw new Error(j.error || 'delete failed');
                showStatus('saveStatus','success', '–£–¥–∞–ª–µ–Ω–æ –∏–∑ Postgres');
                await loadAccounts();
            }catch(e){
                showStatus('saveStatus','error', e.message);
            }
        }

        window.addEventListener('load', () => { loadAccounts(); });
    </script>
</body>
</html>


