<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search App</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #007bff;
            border-radius: 8px;
            background-color: #f8f9fa;
        }
        
        .test-button {
            background-color: #28a745;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        
        .test-button:hover {
            background-color: #218838;
        }
        
        .test-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .test-status {
            margin: 15px 0;
            padding: 15px;
            border-radius: 6px;
            font-weight: bold;
        }
        
        .status-running {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        
        .status-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .status-error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .test-results {
            margin: 15px 0;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 6px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #007bff;
            transition: width 0.3s ease;
            width: 0%;
        }
    </style>
</head>
<body>
    <h1>Welcome to Search App</h1>

    <form action="/train_dqn" method="post">
        <input type="hidden" name="query" value="test_query">
        <button type="submit">–ó–∞–ø—É—Å—Ç–∏—Ç—å DQN –æ–±—É—á–µ–Ω–∏–µ</button>
    </form><br>
    
    <!-- –°–µ–∫—Ü–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è DQN —É–ª—É—á—à–µ–Ω–∏–π -->
    <div class="test-section">
        <h2>üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ DQN –£–ª—É—á—à–µ–Ω–∏–π</h2>
        <p>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ DQN –∞–≥–µ–Ω—Ç–∞ –ø–µ—Ä–µ–¥ –æ–±—É—á–µ–Ω–∏–µ–º</p>
        
        <button id="testDqnBtn" class="test-button" onclick="startDqnTesting()">
            üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ DQN
        </button>
        
        <button id="checkStatusBtn" class="test-button" onclick="checkDqnStatus()" style="display: none;">
            üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –°—Ç–∞—Ç—É—Å
        </button>
        
        <button id="viewResultsBtn" class="test-button" onclick="viewDqnResults()" style="display: none;">
            üìä –ü–æ–∫–∞–∑–∞—Ç—å –†–µ–∑—É–ª—å—Ç–∞—Ç—ã
        </button>
        
        <div id="testStatus" class="test-status" style="display: none;"></div>
        
        <div class="progress-bar" id="progressBar" style="display: none;">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        
        <div id="testResults" class="test-results" style="display: none;"></div>
    </div>

    <form action="/clean_data" method="post">
        <input type="hidden" name="query" value="test_query">
        <button type="submit">–ó–∞–ø—É—Å—Ç–∏—Ç—å –æ—á–∏—Å—Ç–∫—É postgers –æ—Ç –ø–∏–∫–æ–≤<</button>
    </form>    
    <br>
    <form action="/clean_db" method="post">
        <input type="hidden" name="query" value="test_query">
        <button type="submit">–ó–∞–ø—É—Å—Ç–∏—Ç—å –æ—á–∏—Å—Ç–∫—É postgers –æ—Çc—Å–≤–µ—á–µ–π<</button>
    </form>      
    <br>
    <form action="/parser" method="post">
        <input type="hidden" name="query" value="test_query">
        <button type="submit">–°–∫–∞—á–∞—Ç—å —Å–≤–µ—á–∏<</button>
    </form>   <br>   
        <form action="/task-start-search" method="post">
        <input type="hidden" name="query" value="test_query">
        <button type="submit">–ó–∞–ø—É—Å—Ç–∏—Ç—å RandomSearch</button>
    </form>

    <h2>–°—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á</h2>
    <table>
        <thead>
            <tr>
                <th>Task ID</th>
                <th>State</th>
                <th>Result</th>
            </tr>
        </thead>
        <tbody>
            {% for task in tasks %}
            <tr>
                <td>{{ task.task_id }}</td>
                <td>{{ task.state }}</td>
                <td>{{ task.result if task.result else "–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è..." }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
        let testInterval = null;
        let progressInterval = null;
        
        async function startDqnTesting() {
            const testBtn = document.getElementById('testDqnBtn');
            const statusBtn = document.getElementById('checkStatusBtn');
            const statusDiv = document.getElementById('testStatus');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            
            // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
            testBtn.disabled = true;
            testBtn.textContent = '‚è≥ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ...';
            statusDiv.style.display = 'block';
            statusDiv.className = 'test-status status-running';
            statusDiv.textContent = 'üöÄ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è DQN —É–ª—É—á—à–µ–Ω–∏–π...';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä
            progressBar.style.display = 'block';
            progressFill.style.width = '0%';
            
            try {
                // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
                const response = await fetch('/test_dqn_improvements', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    statusDiv.textContent = '‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ! –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å...';
                    
                    // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                    let progress = 0;
                    progressInterval = setInterval(() => {
                        progress += Math.random() * 15;
                        if (progress > 90) progress = 90;
                        progressFill.style.width = progress + '%';
                    }, 500);
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞
                    statusBtn.style.display = 'inline-block';
                    
                    // –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞—Ç—É—Å–∞
                    startStatusChecking();
                    
                } else {
                    throw new Error(result.message);
                }
                
            } catch (error) {
                statusDiv.className = 'test-status status-error';
                statusDiv.textContent = '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: ' + error.message;
                testBtn.disabled = false;
                testBtn.textContent = 'üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ DQN';
                progressBar.style.display = 'none';
            }
        }
        
        function startStatusChecking() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
            testInterval = setInterval(async () => {
                try {
                    const response = await fetch('/test_dqn_status');
                    const status = await response.json();
                    
                    const statusDiv = document.getElementById('testStatus');
                    const progressFill = document.getElementById('progressFill');
                    const viewResultsBtn = document.getElementById('viewResultsBtn');
                    
                    if (status.status === 'completed') {
                        // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ
                        clearInterval(testInterval);
                        clearInterval(progressInterval);
                        
                        progressFill.style.width = '100%';
                        statusDiv.className = 'test-status status-success';
                        statusDiv.textContent = '‚úÖ ' + status.message;
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                        viewResultsBtn.style.display = 'inline-block';
                        
                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
                        const testBtn = document.getElementById('testDqnBtn');
                        testBtn.disabled = false;
                        testBtn.textContent = 'üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ DQN';
                        
                    } else if (status.status === 'failed') {
                        // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —Å –æ—à–∏–±–∫–∞–º–∏
                        clearInterval(testInterval);
                        clearInterval(progressInterval);
                        
                        progressFill.style.width = '100%';
                        statusDiv.className = 'test-status status-error';
                        statusDiv.textContent = '‚ùå ' + status.message;
                        
                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
                        const testBtn = document.getElementById('testDqnBtn');
                        testBtn.disabled = false;
                        testBtn.textContent = 'üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ DQN';
                        
                    } else if (status.status === 'error') {
                        // –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
                        clearInterval(testInterval);
                        clearInterval(progressInterval);
                        
                        statusDiv.className = 'test-status status-error';
                        statusDiv.textContent = '‚ùå ' + status.message;
                        
                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
                        const testBtn = document.getElementById('testDqnBtn');
                        testBtn.disabled = false;
                        testBtn.textContent = 'üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ DQN';
                        
                    } else if (status.status === 'running') {
                        // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
                        statusDiv.textContent = '‚è≥ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è... –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ.';
                    }
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞:', error);
                }
            }, 2000);
        }
        
        async function checkDqnStatus() {
            try {
                const response = await fetch('/test_dqn_status');
                const status = await response.json();
                
                const statusDiv = document.getElementById('testStatus');
                statusDiv.style.display = 'block';
                
                if (status.status === 'running') {
                    statusDiv.className = 'test-status status-running';
                    statusDiv.textContent = '‚è≥ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...';
                } else if (status.status === 'completed') {
                    statusDiv.className = 'test-status status-success';
                    statusDiv.textContent = '‚úÖ ' + status.message;
                } else if (status.status === 'failed') {
                    statusDiv.className = 'test-status status-error';
                    statusDiv.textContent = '‚ùå ' + status.message;
                } else if (status.status === 'error') {
                    statusDiv.className = 'test-status status-error';
                    statusDiv.textContent = '‚ùå ' + status.message;
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞:', error);
            }
        }
        
        async function viewDqnResults() {
            try {
                const response = await fetch('/test_dqn_results');
                const results = await response.json();
                
                const resultsDiv = document.getElementById('testResults');
                resultsDiv.style.display = 'block';
                
                if (results.status === 'completed' || results.status === 'failed') {
                    let resultsText = `üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø DQN\n`;
                    resultsText += `================================\n\n`;
                    resultsText += `–°—Ç–∞—Ç—É—Å: ${results.status}\n`;
                    resultsText += `–°–æ–æ–±—â–µ–Ω–∏–µ: ${results.message}\n`;
                    resultsText += `–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ${results.duration ? results.duration.toFixed(2) + ' —Å–µ–∫' : 'N/A'}\n\n`;
                    
                    if (results.tests) {
                        resultsText += `–î–ï–¢–ê–õ–¨–ù–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´:\n`;
                        resultsText += `===================\n\n`;
                        
                        for (const [testName, testResult] of Object.entries(results.tests)) {
                            const emoji = testResult.success ? '‚úÖ' : '‚ùå';
                            const status = testResult.success ? '–£–°–ü–ï–•' : '–û–®–ò–ë–ö–ê';
                            resultsText += `${emoji} ${testName.toUpperCase()}: ${status}\n`;
                            resultsText += `   –°–æ–æ–±—â–µ–Ω–∏–µ: ${testResult.message}\n\n`;
                        }
                    }
                    
                    if (results.overall_success) {
                        resultsText += `üéØ –í–°–ï –¢–ï–°–¢–´ –ü–†–û–ô–î–ï–ù–´ –£–°–ü–ï–®–ù–û!\n`;
                        resultsText += `DQN –∞–≥–µ–Ω—Ç –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.\n\n`;
                        resultsText += `üìà –û–ñ–ò–î–ê–ï–ú–´–ï –£–õ–£–ß–®–ï–ù–ò–Ø:\n`;
                        resultsText += `   - Winrate: 50.23% ‚Üí 55-65%\n`;
                        resultsText += `   - P/L Ratio: 1.01 ‚Üí 1.3-1.5\n`;
                        resultsText += `   - Bad Trades: 31,352 ‚Üí 15,000-20,000\n`;
                        resultsText += `   - –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å: –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–ª—É—á—à–µ–Ω–∞\n`;
                    } else {
                        resultsText += `‚ö†Ô∏è –ù–ï–ö–û–¢–û–†–´–ï –¢–ï–°–¢–´ –ù–ï –ü–†–û–ô–î–ï–ù–´!\n`;
                        resultsText += `–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –∏ –∏—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏.\n`;
                    }
                    
                    resultsDiv.textContent = resultsText;
                } else {
                    resultsDiv.textContent = '–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤—ã.';
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:', error);
                const resultsDiv = document.getElementById('testResults');
                resultsDiv.style.display = 'block';
                resultsDiv.textContent = '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: ' + error.message;
            }
        }
    </script>
</body>
</html>

