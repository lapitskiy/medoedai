<!DOCTYPE html>
<html lang="ru">
<head>
    <link rel="stylesheet" href="/static/css/styles.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedoedAI - DQN Trading Bot</title>
    <!-- Styles moved to /static/css/styles.css -->
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ MedoedAI - DQN Trading Bot</h1>
            <p>–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ç–æ—Ä–≥–æ–≤–ª–∏ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞–º–∏</p>
        </div>
        
        <div class="content">
            

            <!-- –°–µ–∫—Ü–∏—è —Ç–æ—Ä–≥–æ–≤–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ -->
            <div class="section">
                <h2>üí∞ –¢–æ—Ä–≥–æ–≤—ã–π –∞–≥–µ–Ω—Ç</h2>
                <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤–ª–µ–π –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º —Ä—ã–Ω–∫–µ —á–µ—Ä–µ–∑ –æ–±—É—á–µ–Ω–Ω—É—é –º–æ–¥–µ–ª—å</p>
                
                <div class="button-group">
                    <a href="/trading_agent" class="btn btn-primary">
                        üöÄ –¢–æ—Ä–≥–æ–≤—ã–π –∞–≥–µ–Ω—Ç
                    </a>
                </div>
                
                <!-- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å—Ç–∞—Ç—É—Å–∞ –∞–≥–µ–Ω—Ç–∞ -->
                <div class="card">
                    <div class="card-header">
                        <h5>üìä –°—Ç–∞—Ç—É—Å —Ç–æ—Ä–≥–æ–≤–æ–≥–æ –∞–≥–µ–Ω—Ç–∞</h5>
                    </div>
                    <div id="agentStatus" class="status info">
                        üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞...
                    </div>
                    <div id="agentDetails" style="display: none;">
                        <div class="form-group">
                            <label>üéØ –¢–µ–∫—É—â–∞—è –ø–∞—Ä–∞:</label>
                            <div id="currentSymbol" class="status info">-</div>
                        </div>
                        <div class="form-group">
                            <label>üí∞ –ë–∞–ª–∞–Ω—Å USDT:</label>
                            <div id="currentBalance" class="status info">-</div>
                        </div>
                        <div class="form-group">
                            <label>üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è —Ç–æ—Ä–≥–æ–≤–ª–∏:</label>
                            <div id="currentAmount" class="status info">-</div>
                        </div>
                        <div class="form-group">
                            <label>üìà –ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ:</label>
                            <div id="lastPrediction" class="status info">-</div>
                        </div>
                        <div class="form-group">
                            <label>üïí –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:</label>
                            <div id="lastUpdate" class="status info">-</div>
                        </div>
                    </div>
                    <div class="button-group">
                        <button id="refreshAgentStatus" class="btn btn-info" onclick="refreshAgentStatus()">
                            üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å
                        </button>
                        <button id="startAgentMonitoring" class="btn btn-success" onclick="startAgentMonitoring()">
                            üì° –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
                        </button>
                        <button id="stopAgentMonitoring" class="btn btn-warning" onclick="stopAgentMonitoring()" style="display: none;">
                            ‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
                        </button>
                    </div>
                </div>
            </div>

            <!-- –û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω–∞—è —Å–µ–∫—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∞ -->
            <div class="section">
                <h2>üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</h2>
                <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –Ω—É–∂–Ω—ã–π –∞–Ω–∞–ª–∏–∑</p>
                <div class="form-group">
                    <label>–§–∞–π–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (result/train_result_*.pkl)</label>
                    <select id="resultsFileSelect"></select>
                </div>
                <div class="button-group">
                    <button id="listResultsBtn" class="btn btn-info" onclick="listTrainingResults()">üìã –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
                    <button id="analyzeResultsBtn" class="btn btn-primary" onclick="analyzeTrainingResultsSelected()">üìà –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</button>
                    <button id="analyzeBadTradesBtn" class="btn btn-warning" onclick="analyzeBadTradesSelected()">üîç –ü–ª–æ—Ö–∏–µ —Å–¥–µ–ª–∫–∏</button>
                </div>
                <div id="analysisStatus" class="status" style="display: none;"></div>
                <div id="analysisResults" class="results" style="display: none;"></div>
                <div id="filesList" class="results" style="display: none;"></div>
                <div id="badTradesStatus" class="status" style="display: none;"></div>
                <div id="badTradesResults" class="results" style="display: none;"></div>
                <div id="badTradesSummary" class="results" style="display: none;"></div>
            </div>

            <!-- –°–µ–∫—Ü–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–æ–¥–µ–ª—è–º–∏ -->
            <div class="section">
                <h2>ü§ñ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª—è–º–∏</h2>
                <p>–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—É—á–µ–Ω–Ω—ã–º–∏ –º–æ–¥–µ–ª—è–º–∏ DQN</p>
                
                <div class="button-group">
                    <a href="/models" class="btn btn-success">
                        üöÄ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª—è–º–∏
                    </a>
                </div>
            </div>



            <!-- –°–µ–∫—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (—Å—Å—ã–ª–∫–∞ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É) -->
            <div class="section">
                <h2>üì• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏</h2>
                <p>–°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏ –æ—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±—É—á–µ–Ω–∏—è</p>
                <div class="button-group">
                    <a href="/data" class="btn btn-info">üìÇ –û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã–º–∏</a>
                </div>
            </div>

            <!-- –°–µ–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ -->
            <div class="section">
                <h2>üßπ –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö</h2>
                <p>–û—á–∏—Å—Ç–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –æ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</p>
                
                <div class="button-group">
                    <form action="/clean_data" method="post" style="display: inline;">
                        <input type="hidden" name="query" value="test_query">
                        <button type="submit" class="btn btn-warning">
                            üßπ –û—á–∏—Å—Ç–∏—Ç—å –æ—Ç –ø–∏–∫–æ–≤
                        </button>
                    </form>
                    
                    <form action="/clean_db" method="post" style="display: inline;">
                        <input type="hidden" name="query" value="test_query">
                        <button type="submit" class="btn btn-danger">
                            üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –æ—Ç —Å–≤–µ—á–µ–π
                        </button>
                    </form>
                </div>
            </div>

            <!-- –°–µ–∫—Ü–∏—è RandomSearch -->
            <div class="section">
                <h2>üîç RandomSearch</h2>
                <p>–ó–∞–ø—É—Å–∫ –ø–æ–∏—Å–∫–∞ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤</p>
                
                <div class="button-group">
                    <form action="/task-start-search" method="post" style="display: inline;">
                        <input type="hidden" name="query" value="test_query">
                        <button type="submit" class="btn btn-primary">
                            üîç –ó–∞–ø—É—Å—Ç–∏—Ç—å RandomSearch
                        </button>
                    </form>
                </div>
            </div>

            <!-- –°–µ–∫—Ü–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–æ–π -->
            <div class="section">
                <h2>üîß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–æ–π</h2>
                <p>–°–∏—Å—Ç–µ–º–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</p>
                
                <div class="button-group">
                    <button class="btn btn-warning" onclick="clearRedis()">
                        üßπ –û—á–∏—Å—Ç–∏—Ç—å Redis
                    </button>
                </div>
                
                <div id="clearRedisResult" class="status" style="display: none;"></div>
            </div>

            <!-- –°–µ–∫—Ü–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á -->
            <div class="section">
                <h2>üìã –°—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á</h2>
                <p>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á Celery</p>
                
                <table class="tasks-table">
                    <thead>
                        <tr>
                            <th>Task ID</th>
                            <th>State</th>
                            <th>Result</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for task in tasks %}
                        <tr>
                            <td>{{ task.task_id }}</td>
                            <td>{{ task.state }}</td>
                            <td>{{ task.result if task.result else "–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è..." }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –º—É–ª—å—Ç–∏–≤–∞–ª—é—Ç–Ω–æ–≥–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
        async function startMultiCryptoDownload() {
            const downloadBtn = document.querySelector('form[action="/parser_multi_crypto"] button');
            const originalText = downloadBtn.textContent;
            
            // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            downloadBtn.disabled = true;
            downloadBtn.textContent = '‚è≥ –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ...';
            
            try {
                // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
                const response = await fetch('/parser_multi_crypto', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (result.status === '–ú—É–ª—å—Ç–∏–≤–∞–ª—é—Ç–Ω–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ') {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                    let message = `‚úÖ –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!\n\n`;
                    message += `üìä –°–≤–æ–¥–∫–∞:\n`;
                    message += `‚Ä¢ –í—Å–µ–≥–æ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç: ${result.summary.total_cryptos}\n`;
                    message += `‚Ä¢ –£—Å–ø–µ—à–Ω–æ: ${result.summary.successful}\n`;
                    message += `‚Ä¢ –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è: ${result.summary.warnings}\n`;
                    message += `‚Ä¢ –û—à–∏–±–∫–∏: ${result.summary.failed}\n\n`;
                    message += `üìà –î–µ—Ç–∞–ª–∏:\n`;
                    
                    result.results.forEach(r => {
                        const statusIcon = r.status === 'success' ? '‚úÖ' : r.status === 'warning' ? '‚ö†Ô∏è' : '‚ùå';
                        message += `${statusIcon} ${r.symbol}: ${r.message}\n`;
                    });
                    
                    alert(message);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                    location.reload();
                    
                } else {
                    throw new Error('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏:', error);
                alert(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏: ${error.message}`);
            } finally {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                downloadBtn.disabled = false;
                downloadBtn.textContent = originalText;
            }
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –º—É–ª—å—Ç–∏–≤–∞–ª—é—Ç–Ω–æ–≥–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            const multiCryptoForm = document.querySelector('form[action="/parser_multi_crypto"]');
            if (multiCryptoForm) {
                multiCryptoForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    startMultiCryptoDownload();
                });
            }
        });

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ–±—É—á–µ–Ω–∏—è
        async function listTrainingResults() {
            const statusDiv = document.getElementById('analysisStatus');
            const filesDiv = document.getElementById('filesList');
            const selectEl = document.getElementById('resultsFileSelect');
            const listBtn = document.getElementById('listResultsBtn');
            
            // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
            listBtn.disabled = true;
            listBtn.textContent = '‚è≥ –ü–æ–∏—Å–∫ —Ñ–∞–π–ª–æ–≤...';
            statusDiv.style.display = 'block';
            statusDiv.className = 'status running';
            statusDiv.textContent = 'üîç –ü–æ–∏—Å–∫ —Ñ–∞–π–ª–æ–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ–±—É—á–µ–Ω–∏—è...';
            
            try {
                const response = await fetch('/list_training_results', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    statusDiv.className = 'status success';
                    statusDiv.textContent = '‚úÖ ' + result.message;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
                    filesDiv.style.display = 'block';
                    
                    let filesText = `üìã –î–û–°–¢–£–ü–ù–´–ï –§–ê–ô–õ–´ –†–ï–ó–£–õ–¨–¢–ê–¢–û–í:\n`;
                    filesText += `=====================================\n\n`;
                    
                    if (result.files && result.files.length > 0) {
                        // –æ–±–Ω–æ–≤–ª—è–µ–º select
                        selectEl.innerHTML = '';
                        for (const file of result.files) {
                            const opt = document.createElement('option');
                            opt.value = file.filename;
                            const date = new Date(file.created * 1000).toLocaleString();
                            const sizeKB = (file.size / 1024).toFixed(1);
                            opt.textContent = `${file.filename} (${sizeKB} KB, ${date})`;
                            selectEl.appendChild(opt);
                        }
                        for (const file of result.files) {
                            const date = new Date(file.created * 1000).toLocaleString();
                            const sizeKB = (file.size / 1024).toFixed(1);
                            filesText += `üìÑ ${file.filename}\n`;
                            filesText += `   üìÖ –°–æ–∑–¥–∞–Ω: ${date}\n`;
                            filesText += `   üìè –†–∞–∑–º–µ—Ä: ${sizeKB} KB\n\n`;
                        }
                    } else {
                        // –û–±–Ω–æ–≤–ª—è–µ–º select –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–æ–º
                        if (selectEl) {
                            selectEl.innerHTML = '';
                            const opt = document.createElement('option');
                            opt.value = '';
                            opt.textContent = '–ù–µ—Ç —Ñ–∞–π–ª–æ–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤';
                            selectEl.appendChild(opt);
                        }
                        filesText += `‚ùå –§–∞–π–ª—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã\n`;
                        filesText += `üí° –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –æ–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏\n`;
                    }
                    
                    filesDiv.textContent = filesText;
                    
                } else {
                    throw new Error(result.message);
                }
                
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ —Ñ–∞–π–ª–æ–≤: ' + error.message;
            } finally {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                listBtn.disabled = false;
                listBtn.textContent = 'üìã –°–ø–∏—Å–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤';
            }
        }

        async function analyzeTrainingResultsSelected() {
            const selectEl = document.getElementById('resultsFileSelect');
            const file = selectEl.value;
            const analyzeBtn = document.getElementById('analyzeResultsBtn');
            const statusDiv = document.getElementById('analysisStatus');
            const resultsDiv = document.getElementById('analysisResults');
            analyzeBtn.disabled = true;
            statusDiv.style.display = 'block';
            statusDiv.className = 'status running';
            statusDiv.textContent = 'üìä –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ–±—É—á–µ–Ω–∏—è...';
            try {
                const response = await fetch('/analyze_training_results', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ file })
                });
                const result = await response.json();
                if (result.success) {
                    statusDiv.className = 'status success';
                    statusDiv.textContent = '‚úÖ ' + result.message;
                    resultsDiv.style.display = 'block';
                    let analysisText = `üìä –ê–ù–ê–õ–ò–ó –§–ê–ô–õ–ê\n===============================\n\n`;
                    analysisText += `üìÑ –§–∞–π–ª: ${result.file_analyzed}\n`;
                    analysisText += result.output || '';
                    resultsDiv.textContent = analysisText;
                } else {
                    throw new Error(result.message);
                }
            } catch (e) {
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + e.message;
            } finally {
                analyzeBtn.disabled = false;
            }
        }

        async function analyzeBadTradesSelected() {
            const selectEl = document.getElementById('resultsFileSelect');
            const file = selectEl.value;
            const analyzeBtn = document.getElementById('analyzeBadTradesBtn');
            const statusDiv = document.getElementById('badTradesStatus');
            const resultsDiv = document.getElementById('badTradesResults');
            const summaryDiv = document.getElementById('badTradesSummary');
            analyzeBtn.disabled = true;
            statusDiv.style.display = 'block';
            statusDiv.className = 'status running';
            statusDiv.textContent = 'üîç –ê–Ω–∞–ª–∏–∑ –ø–ª–æ—Ö–∏—Ö —Å–¥–µ–ª–æ–∫...';
            resultsDiv.style.display = 'none';
            summaryDiv.style.display = 'none';
            try {
                const response = await fetch('/analyze_bad_trades', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ file })
                });
                const result = await response.json();
                if (result.success) {
                    statusDiv.className = 'status success';
                    statusDiv.textContent = '‚úÖ ' + result.message;
                    summaryDiv.style.display = 'block';
                    let summaryText = `üìä –°–í–û–î–ö–ê –ü–õ–û–•–ò–• –°–î–ï–õ–û–ö\n===============================\n\n`;
                    summaryText += `üìÑ –§–∞–π–ª: ${result.file_analyzed.split('/').pop()}\n`;
                    summaryText += `üî¢ –ü–ª–æ—Ö–∏—Ö —Å–¥–µ–ª–æ–∫: ${result.bad_trades_count} (${result.bad_trades_percentage.toFixed(2)}%)\n`;
                    summaryDiv.textContent = summaryText;
                    resultsDiv.style.display = 'block';
                    resultsDiv.textContent = result.output;
                } else {
                    throw new Error(result.message);
                }
            } catch (e) {
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + e.message;
            } finally {
                analyzeBtn.disabled = false;
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ç–æ—Ä–≥–æ–≤–æ–≥–æ –∞–≥–µ–Ω—Ç–∞
        let agentMonitoringInterval = null;

        async function refreshAgentStatus() {
            const statusDiv = document.getElementById('agentStatus');
            const detailsDiv = document.getElementById('agentDetails');
            const refreshBtn = document.getElementById('refreshAgentStatus');
            
            // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            refreshBtn.disabled = true;
            refreshBtn.textContent = '‚è≥ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
            statusDiv.className = 'status running';
            statusDiv.textContent = 'üîÑ –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∞–≥–µ–Ω—Ç–∞...';
            
            try {
                const response = await fetch('/api/trading/status', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const agentData = result.agent_status;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Å—Ç–∞—Ç—É—Å
                    if (agentData.trading_status_full) {
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–æ—Ç–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å —Å —ç–º–æ–¥–∑–∏
                        statusDiv.className = agentData.is_trading ? 'status success' : 'status info';
                        statusDiv.textContent = agentData.trading_status_full;
                    } else if (agentData.trading_status) {
                        // –§–æ–ª–±—ç–∫ –Ω–∞ –ø—Ä–æ—Å—Ç–æ–π —Å—Ç–∞—Ç—É—Å
                        statusDiv.className = agentData.is_trading ? 'status success' : 'status info';
                        statusDiv.textContent = agentData.trading_status;
                    } else if (agentData.is_trading) {
                        statusDiv.className = 'status success';
                        statusDiv.textContent = '‚úÖ –ê–≥–µ–Ω—Ç –∞–∫—Ç–∏–≤–µ–Ω –∏ —Ç–æ—Ä–≥—É–µ—Ç';
                    } else {
                        statusDiv.className = 'status info';
                        statusDiv.textContent = '‚è∏Ô∏è –ê–≥–µ–Ω—Ç –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω';
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏
                    detailsDiv.style.display = 'block';
                    
                    // –¢–µ–∫—É—â–∞—è –ø–∞—Ä–∞
                    const symbolDiv = document.getElementById('currentSymbol');
                    if (agentData.symbol_display || agentData.symbol) {
                        symbolDiv.className = 'status success';
                        symbolDiv.textContent = agentData.symbol_display || agentData.symbol;
                    } else {
                        symbolDiv.className = 'status info';
                        symbolDiv.textContent = '–ù–µ –≤—ã–±—Ä–∞–Ω–∞';
                    }
                    
                    // –ë–∞–ª–∞–Ω—Å USDT
                    const balanceDiv = document.getElementById('currentBalance');
                    if (agentData.balance && agentData.balance.USDT) {
                        balanceDiv.className = 'status success';
                        balanceDiv.textContent = `${parseFloat(agentData.balance.USDT).toFixed(2)} USDT`;
                    } else {
                        balanceDiv.className = 'status info';
                        balanceDiv.textContent = '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ';
                    }
                    
                    // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è —Ç–æ—Ä–≥–æ–≤–ª–∏
                    const amountDiv = document.getElementById('currentAmount');
                    if (agentData.amount_display || agentData.amount) {
                        amountDiv.className = 'status success';
                        amountDiv.textContent = agentData.amount_display || agentData.amount;
                        if (agentData.amount_usdt) {
                            amountDiv.textContent += ` ($${agentData.amount_usdt.toFixed(2)})`;
                        }
                    } else {
                        amountDiv.className = 'status info';
                        amountDiv.textContent = '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
                    }
                    
                    // –ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ
                    const predictionDiv = document.getElementById('lastPrediction');
                    if (agentData.last_model_prediction) {
                        predictionDiv.className = 'status success';
                        predictionDiv.textContent = agentData.last_model_prediction;
                    } else {
                        predictionDiv.className = 'status info';
                        predictionDiv.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                    }
                    
                    // –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                    const updateDiv = document.getElementById('lastUpdate');
                    updateDiv.className = 'status info';
                    updateDiv.textContent = new Date().toLocaleString();
                    
                } else {
                    throw new Error(result.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å');
                }
                
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: ' + error.message;
                detailsDiv.style.display = 'none';
            } finally {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å';
            }
        }

        function startAgentMonitoring() {
            const startBtn = document.getElementById('startAgentMonitoring');
            const stopBtn = document.getElementById('stopAgentMonitoring');
            const statusDiv = document.getElementById('agentStatus');
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
            agentMonitoringInterval = setInterval(refreshAgentStatus, 30000); // –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            startBtn.style.display = 'none';
            stopBtn.style.display = 'inline-block';
            statusDiv.className = 'status running';
            statusDiv.textContent = 'üì° –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞–∫—Ç–∏–≤–µ–Ω - —Å—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥';
            
            // –°—Ä–∞–∑—É –ø–æ–ª—É—á–∞–µ–º –ø–µ—Ä–≤—ã–π —Å—Ç–∞—Ç—É—Å
            refreshAgentStatus();
        }

        function stopAgentMonitoring() {
            const startBtn = document.getElementById('startAgentMonitoring');
            const stopBtn = document.getElementById('stopAgentMonitoring');
            const statusDiv = document.getElementById('agentStatus');
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
            if (agentMonitoringInterval) {
                clearInterval(agentMonitoringInterval);
                agentMonitoringInterval = null;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            startBtn.style.display = 'inline-block';
            stopBtn.style.display = 'none';
            statusDiv.className = 'status info';
            statusDiv.textContent = '‚è∏Ô∏è –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
            document.getElementById('agentDetails').style.display = 'none';
        }

        // –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            try { 
                listTrainingResults(); 
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞–≥–µ–Ω—Ç–∞
                startAgentMonitoring();
            } catch (e) { 
                console.error(e); 
            }
        });

        async function analyzeTrainingResults() {
            const statusDiv = document.getElementById('analysisStatus');
            const resultsDiv = document.getElementById('analysisResults');
            const analyzeBtn = document.getElementById('analyzeResultsBtn');
            
            // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
            analyzeBtn.disabled = true;
            analyzeBtn.textContent = '‚è≥ –ê–Ω–∞–ª–∏–∑...';
            statusDiv.style.display = 'block';
            statusDiv.className = 'status running';
            statusDiv.textContent = 'üìä –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ–±—É—á–µ–Ω–∏—è...';
            
            try {
                const response = await fetch('/analyze_training_results', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    statusDiv.className = 'status success';
                    statusDiv.textContent = '‚úÖ ' + result.message;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞
                    resultsDiv.style.display = 'block';
                    
                    let analysisText = `üìä –ê–ù–ê–õ–ò–ó –†–ï–ó–£–õ–¨–¢–ê–¢–û–í –û–ë–£–ß–ï–ù–ò–Ø\n`;
                    analysisText += `=====================================\n\n`;
                    analysisText += `üìÑ –§–∞–π–ª: ${result.file_analyzed}\n`;
                    analysisText += `üìÖ –í—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∞: ${new Date().toLocaleString()}\n\n`;
                    
                    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ø–∏–∑–æ–¥–æ–≤ –∏ early stopping
                    let actualEpisodes = result.actual_episodes;
                    let earlyStoppingDetected = false;
                    
                    // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ early stopping –≤ –≤—ã–≤–æ–¥–µ
                    if (result.output && result.output.includes('Early stopping triggered after')) {
                        const earlyStoppingMatch = result.output.match(/Early stopping triggered after (\d+) episodes/);
                        if (earlyStoppingMatch) {
                            actualEpisodes = parseInt(earlyStoppingMatch[1]);
                            earlyStoppingDetected = true;
                            analysisText += `üîÑ Early Stopping —Å—Ä–∞–±–æ—Ç–∞–ª! –û–±—É—á–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ ${actualEpisodes} —ç–ø–∏–∑–æ–¥–µ –∏–∑ ${result.episodes}\n`;
                            analysisText += `üìä –ü—Ä–∏—á–∏–Ω–∞: –î–æ—Å—Ç–∏–≥–Ω—É—Ç —Å—Ç–∞–±–∏–ª—å–Ω—ã–π winrate –∏–ª–∏ —Å—Ä–∞–±–æ—Ç–∞–ª–∏ –¥—Ä—É–≥–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏\n`;
                            analysisText += `üí° –û–±—É—á–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏—è\n\n`;
                        }
                    }
                    // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ actual_episodes –∏ episode_winrates
                    else if (result.actual_episodes && result.episode_winrates_count) {
                        if (result.actual_episodes !== result.episode_winrates_count) {
                            actualEpisodes = result.episode_winrates_count;
                            earlyStoppingDetected = true;
                            analysisText += `üîÑ Early Stopping —Å—Ä–∞–±–æ—Ç–∞–ª! –û–±—É—á–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ ${actualEpisodes} —ç–ø–∏–∑–æ–¥–µ –∏–∑ ${result.episodes}\n`;
                            analysisText += `üìä –ü—Ä–∏—á–∏–Ω–∞: –î–æ—Å—Ç–∏–≥–Ω—É—Ç —Å—Ç–∞–±–∏–ª—å–Ω—ã–π winrate –∏–ª–∏ —Å—Ä–∞–±–æ—Ç–∞–ª–∏ –¥—Ä—É–≥–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏\n`;
                            analysisText += `üí° –û–±—É—á–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏—è\n\n`;
                        }
                    }
                    // 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å–ª–∏ actual_episodes –º–µ–Ω—å—à–µ –ø–ª–∞–Ω–∏—Ä—É–µ–º—ã—Ö
                    else if (result.actual_episodes && result.episodes && result.actual_episodes < result.episodes) {
                        actualEpisodes = result.actual_episodes;
                        earlyStoppingDetected = true;
                        analysisText += `üîÑ Early Stopping —Å—Ä–∞–±–æ—Ç–∞–ª! –û–±—É—á–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ ${actualEpisodes} —ç–ø–∏–∑–æ–¥–µ –∏–∑ ${result.episodes}\n`;
                        analysisText += `üìä –ü—Ä–∏—á–∏–Ω–∞: –î–æ—Å—Ç–∏–≥–Ω—É—Ç —Å—Ç–∞–±–∏–ª—å–Ω—ã–π winrate –∏–ª–∏ —Å—Ä–∞–±–æ—Ç–∞–ª–∏ –¥—Ä—É–≥–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏\n`;
                        analysisText += `üí° –û–±—É—á–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏—è\n\n`;
                    }
                    // 4. –ï—Å–ª–∏ –Ω–µ—Ç early stopping, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
                    else if (result.actual_episodes && result.episodes) {
                        actualEpisodes = result.actual_episodes;
                        analysisText += `‚úÖ –û–±—É—á–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é: ${actualEpisodes} —ç–ø–∏–∑–æ–¥–æ–≤\n\n`;
                    }
                    // 5. Fallback - –∏—â–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –≤—ã–≤–æ–¥–µ
                    else if (result.output && result.output.includes('–†–µ–∞–ª—å–Ω—ã–µ —ç–ø–∏–∑–æ–¥—ã:')) {
                        const realEpisodesMatch = result.output.match(/–†–µ–∞–ª—å–Ω—ã–µ —ç–ø–∏–∑–æ–¥—ã: (\d+)/);
                        if (realEpisodesMatch) {
                            actualEpisodes = parseInt(realEpisodesMatch[1]);
                            analysisText += `‚úÖ –û–±—É—á–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ: ${actualEpisodes} —ç–ø–∏–∑–æ–¥–æ–≤\n\n`;
                        }
                    } else if (result.output && result.output.includes('Early Stopping —Å—Ä–∞–±–æ—Ç–∞–ª')) {
                        analysisText += `üîÑ Early Stopping —Å—Ä–∞–±–æ—Ç–∞–ª! –û–±—É—á–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏\n`;
                        analysisText += `üìä –ü—Ä–∏—á–∏–Ω–∞: –î–æ—Å—Ç–∏–≥–Ω—É—Ç —Å—Ç–∞–±–∏–ª—å–Ω—ã–π winrate –∏–ª–∏ —Å—Ä–∞–±–æ—Ç–∞–ª–∏ –¥—Ä—É–≥–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏\n\n`;
                        earlyStoppingDetected = true;
                    } else {
                        analysisText += `‚ö†Ô∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ–∞–ª—å–Ω—ã—Ö —ç–ø–∏–∑–æ–¥–∞—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–∞\n\n`;
                    }
                    
                    if (result.output) {
                        analysisText += result.output;
                    } else {
                        analysisText += `‚ö†Ô∏è –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã\n`;
                    }
                    
                    if (result.available_files && result.available_files.length > 1) {
                        analysisText += `\nüìã –î—Ä—É–≥–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–∞–π–ª—ã:\n`;
                        for (const file of result.available_files) {
                            if (file !== result.file_analyzed) {
                                analysisText += `   ‚Ä¢ ${file}\n`;
                            }
                        }
                    }
                    
                    resultsDiv.textContent = analysisText;
                    
                } else {
                    throw new Error(result.message);
                }
                
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ: ' + error.message;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏
                resultsDiv.style.display = 'block';
                resultsDiv.textContent = `‚ùå –û–®–ò–ë–ö–ê –ê–ù–ê–õ–ò–ó–ê:\n${error.message}\n\nüí° –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ:\n‚Ä¢ –û–±—É—á–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ\n‚Ä¢ –§–∞–π–ª—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å—É—â–µ—Å—Ç–≤—É—é—Ç\n‚Ä¢ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã matplotlib –∏ numpy`;
            } finally {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'üìà –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã';
            }
        }

        async function analyzeBadTrades() {
            const statusDiv = document.getElementById('badTradesStatus');
            const resultsDiv = document.getElementById('badTradesResults');
            const summaryDiv = document.getElementById('badTradesSummary');
            const analyzeBtn = document.getElementById('analyzeBadTradesBtn');
            
            // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
            analyzeBtn.disabled = true;
            analyzeBtn.textContent = '‚è≥ –ê–Ω–∞–ª–∏–∑...';
            statusDiv.style.display = 'block';
            statusDiv.className = 'status running';
            statusDiv.textContent = 'üîç –ê–Ω–∞–ª–∏–∑ –ø–ª–æ—Ö–∏—Ö —Å–¥–µ–ª–æ–∫...';
            
            // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            resultsDiv.style.display = 'none';
            summaryDiv.style.display = 'none';
            
            try {
                const response = await fetch('/analyze_bad_trades', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    statusDiv.className = 'status success';
                    statusDiv.textContent = '‚úÖ ' + result.message;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—Ä–∞—Ç–∫—É—é —Å–≤–æ–¥–∫—É
                    summaryDiv.style.display = 'block';
                    let summaryText = `üìä –°–í–û–î–ö–ê –ê–ù–ê–õ–ò–ó–ê –ü–õ–û–•–ò–• –°–î–ï–õ–û–ö\n`;
                    summaryText += `=====================================\n\n`;
                    summaryText += `üìÑ –§–∞–π–ª: ${result.file_analyzed.split('/').pop()}\n`;
                    summaryText += `üìÖ –í—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∞: ${new Date().toLocaleString()}\n\n`;
                    
                    if (result.analysis_summary) {
                        const summary = result.analysis_summary;
                        summaryText += `üí∞ –°–¢–ê–¢–ò–°–¢–ò–ö–ê –°–î–ï–õ–û–ö:\n`;
                        summaryText += `   ‚Ä¢ –í—Å–µ–≥–æ —Å–¥–µ–ª–æ–∫: ${summary.total_trades}\n`;
                        summaryText += `   ‚Ä¢ –ü–ª–æ—Ö–∏—Ö —Å–¥–µ–ª–æ–∫: ${summary.bad_trades} (${result.bad_trades_percentage.toFixed(2)}%)\n`;
                        summaryText += `   ‚Ä¢ –°—Ä–µ–¥–Ω–∏–π ROI –ø–ª–æ—Ö–∏—Ö —Å–¥–µ–ª–æ–∫: ${(summary.avg_bad_roi * 100).toFixed(4)}%\n`;
                        summaryText += `   ‚Ä¢ –°—Ä–µ–¥–Ω—è—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–ª–æ—Ö–∏—Ö —Å–¥–µ–ª–æ–∫: ${summary.avg_bad_duration.toFixed(1)} –º–∏–Ω\n\n`;
                        
                        if (summary.loss_distribution) {
                            const dist = summary.loss_distribution;
                            summaryText += `üìà –†–ê–°–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ü–û –¢–ò–ü–ê–ú:\n`;
                            summaryText += `   ‚Ä¢ –û—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–µ —É–±—ã—Ç–∫–∏: ${dist.very_small_losses || 0}\n`;
                            summaryText += `   ‚Ä¢ –û—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–µ –ø—Ä–∏–±—ã–ª–∏: ${dist.very_small_profits || 0}\n`;
                            summaryText += `   ‚Ä¢ –ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ —Å–¥–µ–ª–∫–∏: ${dist.neutral_trades || 0}\n\n`;
                        }
                        
                        // –û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞
                        if (result.bad_trades_percentage > 5) {
                            summaryText += `‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –í—ã—Å–æ–∫–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç –ø–ª–æ—Ö–∏—Ö —Å–¥–µ–ª–æ–∫ (${result.bad_trades_percentage.toFixed(2)}%)\n`;
                            summaryText += `   –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–∏\n\n`;
                        } else if (result.bad_trades_percentage > 3) {
                            summaryText += `üü° –°—Ä–µ–¥–Ω–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç –ø–ª–æ—Ö–∏—Ö —Å–¥–µ–ª–æ–∫ (${result.bad_trades_percentage.toFixed(2)}%)\n`;
                            summaryText += `   –ï—Å—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è\n\n`;
                        } else {
                            summaryText += `‚úÖ –ù–∏–∑–∫–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç –ø–ª–æ—Ö–∏—Ö —Å–¥–µ–ª–æ–∫ (${result.bad_trades_percentage.toFixed(2)}%)\n`;
                            summaryText += `   –•–æ—Ä–æ—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç!\n\n`;
                        }
                    }
                    
                    summaryDiv.textContent = summaryText;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                    resultsDiv.style.display = 'block';
                    resultsDiv.textContent = result.output;
                    
                } else {
                    throw new Error(result.message);
                }
                
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ: ' + error.message;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏
                resultsDiv.style.display = 'block';
                resultsDiv.textContent = `‚ùå –û–®–ò–ë–ö–ê –ê–ù–ê–õ–ò–ó–ê –ü–õ–û–•–ò–• –°–î–ï–õ–û–ö:\n${error.message}\n\nüí° –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ:\n‚Ä¢ –û–±—É—á–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ\n‚Ä¢ –§–∞–π–ª—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å—É—â–µ—Å—Ç–≤—É—é—Ç\n‚Ä¢ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞`;
            } finally {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'üîç –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–ª–æ—Ö–∏–µ —Å–¥–µ–ª–∫–∏';
            }
        }

        async function clearRedis() {
            const resultDiv = document.getElementById('clearRedisResult');
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'üßπ –û—á–∏—Å—Ç–∫–∞ Redis...';
            resultDiv.className = 'status running';
            
            try {
                const response = await fetch('/clear_redis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                const result = await response.json();
                if (result.success) {
                    resultDiv.textContent = '‚úÖ Redis —É—Å–ø–µ—à–Ω–æ –æ—á–∏—â–µ–Ω!';
                    resultDiv.className = 'status success';
                } else {
                    resultDiv.textContent = '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ Redis: ' + result.message;
                    resultDiv.className = 'status error';
                }
            } catch (error) {
                resultDiv.textContent = '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ Redis: ' + error.message;
                resultDiv.className = 'status error';
            }
        }
    </script>
</body>
</html>

