<!DOCTYPE html>
<html lang="ru">
<head>
  <link rel="stylesheet" href="/static/css/styles.css">
  <link rel="stylesheet" href="/static/css/sidebar.css">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üß© –†–∞–±–æ—Ç–∞ —Å —ç–Ω–∫–æ–¥–µ—Ä–∞–º–∏</title>
</head>
<body>
  {% include 'include/_sidebar.html' %}
  <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>

  <div class="container">
    <div class="main-content">
      <div class="header">
        <h1>üß© –†–∞–±–æ—Ç–∞ —Å —ç–Ω–∫–æ–¥–µ—Ä–∞–º–∏</h1>
        <p>–°–ø–∏—Å–æ–∫ —ç–Ω–∫–æ–¥–µ—Ä–æ–≤ –∏–∑ <code>result/dqn/&lt;SYMBOL&gt;/encoder</code> + —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ —á–µ–∫–±–æ–∫—Å–∞–º</p>
      </div>

      <div class="content">
        <a href="/" class="back-link">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>

        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0;">
          <label>Symbol:
            <select id="symSel" class="form-control" style="width:auto;display:inline-block;min-width:140px;"></select>
          </label>
          <button class="btn btn-info" id="loadBtn">–û–±–Ω–æ–≤–∏—Ç—å</button>
          <button class="btn btn-danger" id="delBtn" disabled>–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
          <span class="muted" id="selCount"></span>
        </div>

        <div id="status" class="status" style="display:none;"></div>

        <div class="section">
          <h2>–ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü–∞</h2>
          <p>–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —ç–Ω–∫–æ–¥–µ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –ª–µ–∂–∞—Ç –≤ <code>result</code>. –£–¥–∞–ª–µ–Ω–∏–µ —É–¥–∞–ª—è–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–∞–ø–∫–∏ <code>vN</code>.</p>
          <p class="muted">–í–∞–∂–Ω–æ: —É–¥–∞–ª—è–π—Ç–µ —Ç–æ–ª—å–∫–æ —Ç–µ –≤–µ—Ä—Å–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ç–æ—á–Ω–æ –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω—ã –≤ –æ–±—É—á–µ–Ω–∏–∏/—Ç–æ—Ä–≥–æ–≤–ª–µ.</p>
        </div>

        <div class="section">
          <h2>–°–ø–∏—Å–æ–∫ —ç–Ω–∫–æ–¥–µ—Ä–æ–≤</h2>
          <div style="width:100%;max-height:70vh;overflow:auto;border:1px solid #e5e7eb;border-radius:8px;padding:8px;">
            <table style="width:100%;border-collapse:collapse;font-size:12px;min-width:920px;">
              <thead>
                <tr>
                  <th style="text-align:left;padding:4px 6px;border-bottom:1px solid #eee;"></th>
                  <th style="text-align:left;padding:4px 6px;border-bottom:1px solid #eee;">ID</th>
                  <th style="text-align:left;padding:4px 6px;border-bottom:1px solid #eee;">direction</th>
                  <th style="text-align:left;padding:4px 6px;border-bottom:1px solid #eee;">created</th>
                  <th style="text-align:left;padding:4px 6px;border-bottom:1px solid #eee;">winrate</th>
                  <th style="text-align:left;padding:4px 6px;border-bottom:1px solid #eee;">pnl</th>
                  <th style="text-align:left;padding:4px 6px;border-bottom:1px solid #eee;">episodes</th>
                </tr>
              </thead>
              <tbody id="encT"></tbody>
            </table>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    function toggleSidebar(){ document.body.classList.toggle('sidebar-open'); }
    const symSel = document.getElementById('symSel');
    const loadBtn = document.getElementById('loadBtn');
    const delBtn = document.getElementById('delBtn');
    const st = document.getElementById('status');
    const encT = document.getElementById('encT');
    const selCount = document.getElementById('selCount');

    function setStatus(kind, text){
      st.style.display = 'block';
      st.className = 'status ' + (kind || 'info');
      st.textContent = text || '';
    }
    function esc(s){
      return String(s ?? '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    }
    function fmtNum(v, digits){
      try{
        if(typeof v !== 'number' || !isFinite(v)) return '';
        const d = (typeof digits === 'number') ? digits : 2;
        return v.toFixed(d);
      }catch(_){ return ''; }
    }
    function selectedIds(){
      const boxes = Array.from(document.querySelectorAll('input[data-enc-id]'));
      return boxes.filter(b=>b.checked).map(b=>b.getAttribute('data-enc-id')).filter(Boolean);
    }
    function refreshSelUi(){
      const ids = selectedIds();
      delBtn.disabled = ids.length === 0;
      selCount.textContent = ids.length ? (`–≤—ã–±—Ä–∞–Ω–æ: ${ids.length}`) : '';
    }
    function render(encoders){
      const arr = Array.isArray(encoders) ? encoders : [];
      encT.innerHTML = arr.map(it=>{
        const id = esc(it.id);
        const m = it.manifest || {};
        const dir = esc(m.direction || m.trained_as || '');
        const created = esc(m.created_at || m.created_at_utc || m.created_at_utc_str || '');
        const s = it.stats || {};
        const wr = (typeof s.winrate === 'number' && isFinite(s.winrate)) ? (s.winrate * 100).toFixed(1) + '%' : '';
        const pnl = (typeof s.pnl === 'number' && isFinite(s.pnl)) ? fmtNum(s.pnl, 4) : '';
        const eps = (typeof s.episodes === 'number' && isFinite(s.episodes)) ? String(Math.trunc(s.episodes)) : '';
        return `<tr>
          <td style="padding:4px 6px;border-bottom:1px solid #f3f4f6;vertical-align:top;">
            <input type="checkbox" data-enc-id="${id}">
          </td>
          <td style="padding:4px 6px;border-bottom:1px solid #f3f4f6;vertical-align:top;"><code>${id}</code></td>
          <td style="padding:4px 6px;border-bottom:1px solid #f3f4f6;vertical-align:top;"><code>${dir}</code></td>
          <td style="padding:4px 6px;border-bottom:1px solid #f3f4f6;vertical-align:top;"><code>${created}</code></td>
          <td style="padding:4px 6px;border-bottom:1px solid #f3f4f6;vertical-align:top;"><code>${esc(wr)}</code></td>
          <td style="padding:4px 6px;border-bottom:1px solid #f3f4f6;vertical-align:top;"><code>${esc(pnl)}</code></td>
          <td style="padding:4px 6px;border-bottom:1px solid #f3f4f6;vertical-align:top;"><code>${esc(eps)}</code></td>
        </tr>`;
      }).join('');
      Array.from(document.querySelectorAll('input[data-enc-id]')).forEach(b=>b.addEventListener('change', refreshSelUi));
      refreshSelUi();
    }

    async function loadSymbols(){
      try{
        setStatus('info','–ó–∞–≥—Ä—É–∂–∞—é symbols...');
        const resp = await fetch('/api/runs/symbols?model_type=dqn');
        const data = await resp.json();
        if(!data.success){ setStatus('error', data.error || '–û—à–∏–±–∫–∞ symbols'); return; }
        const list = Array.isArray(data.symbols) ? data.symbols : [];
        symSel.innerHTML = list.map(s=>`<option value="${esc(s)}">${esc(s)}</option>`).join('');
        setStatus('success','–ì–æ—Ç–æ–≤–æ');
      }catch(e){
        setStatus('error','–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ symbols');
      }
    }

    async function loadEncoders(){
      try{
        const sym = symSel.value || '';
        if(!sym){ setStatus('error','–í—ã–±–µ—Ä–∏—Ç–µ symbol'); return; }
        setStatus('info','–ó–∞–≥—Ä—É–∂–∞—é —ç–Ω–∫–æ–¥–µ—Ä—ã...');
        const resp = await fetch('/api/encoders?symbol=' + encodeURIComponent(sym));
        const data = await resp.json();
        if(!data.success){ setStatus('error', data.error || '–û—à–∏–±–∫–∞'); return; }
        render(data.encoders);
        setStatus('success', `OK: ${sym}`);
      }catch(e){
        setStatus('error','–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —ç–Ω–∫–æ–¥–µ—Ä–æ–≤');
      }
    }

    async function deleteSelected(){
      const sym = symSel.value || '';
      const ids = selectedIds();
      if(!sym || ids.length === 0) return;
      if(!confirm(`–£–¥–∞–ª–∏—Ç—å ${ids.length} —ç–Ω–∫–æ–¥–µ—Ä(–æ–≤)?`)) return;
      delBtn.disabled = true;
      try{
        setStatus('info','–£–¥–∞–ª—è—é...');
        const resp = await fetch('/api/encoders/delete', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ symbol: sym, ids })
        });
        const data = await resp.json();
        if(!data.success){ setStatus('error', data.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è'); return; }
        setStatus('success', `–£–¥–∞–ª–µ–Ω–æ: ${(data.deleted||[]).length}`);
        await loadEncoders();
      }catch(e){
        setStatus('error','–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
      }finally{
        delBtn.disabled = false;
      }
    }

    loadBtn?.addEventListener('click', loadEncoders);
    delBtn?.addEventListener('click', deleteSelected);
    symSel?.addEventListener('change', loadEncoders);
    (async ()=>{ await loadSymbols(); await loadEncoders(); })();
  </script>
</body>
</html>

