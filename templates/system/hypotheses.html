<!DOCTYPE html>
<html lang="ru">
<head>
  <link rel="stylesheet" href="/static/css/styles.css">
  <link rel="stylesheet" href="/static/css/sidebar.css">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üß† –ì–∏–ø–æ—Ç–µ–∑—ã</title>
</head>
<body>
  {% include 'include/_sidebar.html' %}
  <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>

  <div class="container">
    <div class="main-content">
      <div class="header">
        <h1>üß† –ì–∏–ø–æ—Ç–µ–∑—ã</h1>
        <p>–≠–∫—Å–ø–æ—Ä—Ç –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ runs (CSV) + —Ç–µ–∫—Å—Ç–æ–≤—ã–π summary –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≥–∏–ø–æ—Ç–µ–∑ –≤ ChatGPT.</p>
      </div>

      <div class="content">
        <a href="/" class="back-link">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>

        <div class="section">
          <h2>‚öôÔ∏è –≠–∫—Å–ø–æ—Ä—Ç</h2>
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
            <label>Model type:
              <select id="modelType" class="form-control" style="width:140px;">
                <option value="all" selected>ALL (DQN/SAC)</option>
                <option value="dqn">DQN</option>
                <option value="sac">SAC</option>
                <option value="xgb">XGB</option>
              </select>
            </label>
            <label>Token:
              <select id="symbol" class="form-control" style="width:160px;"></select>
            </label>
            <label>Limit runs:
              <input id="limitRuns" class="form-control" style="width:120px;" value="200">
            </label>
            <button class="btn btn-info" id="genBtn">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
            <label style="display:inline-flex;align-items:center;gap:4px;margin-left:6px;cursor:pointer;">
              <input type="checkbox" id="removeDupCols" checked> –£–±—Ä–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã
            </label>
            <button class="btn btn-secondary" id="dlCsvBtn" disabled>–°–∫–∞—á–∞—Ç—å CSV</button>
            <button class="btn btn-secondary" id="dlTxtBtn" disabled>–°–∫–∞—á–∞—Ç—å TXT</button>
          </div>
          <div id="status" class="status" style="margin-top:10px;display:none;"></div>
        </div>

        <div class="section">
          <h2>üìÑ –¢–µ–∫—Å—Ç –¥–ª—è ChatGPT</h2>
          <textarea id="promptOut" class="form-control" style="width:100%;min-height:320px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,'Liberation Mono','Courier New',monospace;"></textarea>
        </div>
      </div>
    </div>
  </div>

  <script>
    function toggleSidebar(){ document.body.classList.toggle('sidebar-open'); }
    const st = document.getElementById('status');
    const btn = document.getElementById('genBtn');
    const dlCsv = document.getElementById('dlCsvBtn');
    const dlTxt = document.getElementById('dlTxtBtn');
    const promptOut = document.getElementById('promptOut');
    let _csvText = '';
    let _txtText = '';

    function stripConstCols(csv){
      if(!csv) return csv;
      const lines = csv.trim().split('\n');
      if(lines.length < 3) return csv; // header + min 2 rows needed
      const header = lines[0].split(',');
      const rows = lines.slice(1).map(l=>l.split(','));
      const keep = [];
      for(let i=0;i<header.length;i++){
        const vals = new Set(rows.map(r=>(r[i]||'').trim()));
        if(vals.size > 1) keep.push(i);
      }
      if(keep.length === header.length) return csv;
      const hdr2 = keep.map(i=>header[i]).join(',');
      const rows2 = rows.map(r=>keep.map(i=>r[i]).join(','));
      return [hdr2, ...rows2].join('\n');
    }

    async function loadSymbols(){
      const mt = document.getElementById('modelType')?.value || 'all';
      try{
        const resp = await fetch(`/api/system/hypotheses_symbols?model_type=${encodeURIComponent(mt)}`);
        const data = await resp.json();
        const sel = document.getElementById('symbol');
        const list = (data && data.success && Array.isArray(data.symbols)) ? data.symbols : [];
        sel.innerHTML = list.map(s=>`<option value="${s}">${s}</option>`).join('');
      }catch(_){}
    }

    function setStatus(kind, text){
      st.style.display = 'block';
      st.className = 'status ' + (kind || 'info');
      st.textContent = text || '';
    }
    function download(name, text, mime){
      const blob = new Blob([text], {type: (mime||'text/plain') + ';charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = name; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 500);
    }

    btn?.addEventListener('click', async ()=>{
      btn.disabled = true; dlCsv.disabled = true; dlTxt.disabled = true;
      setStatus('info','–°–æ–±–∏—Ä–∞—é –¥–∞–Ω–Ω—ã–µ...');
      try{
        const sym = document.getElementById('symbol')?.value || '';
        const mt = document.getElementById('modelType')?.value || 'all';
        const lim = document.getElementById('limitRuns')?.value || '200';
        const ep = mt === 'xgb' ? '/api/system/hypotheses_export_xgb' : '/api/system/hypotheses_export';
        const resp = await fetch(`${ep}?symbol=${encodeURIComponent(sym)}&limit_runs=${encodeURIComponent(lim)}&model_type=${encodeURIComponent(mt)}`);
        const data = await resp.json();
        if(!data.success){ setStatus('error', data.error || '–û—à–∏–±–∫–∞'); return; }
        const removeDup = document.getElementById('removeDupCols')?.checked;
        _csvText = removeDup ? stripConstCols(data.csv || '') : (data.csv || '');
        _txtText = data.prompt || '';
        promptOut.value = _txtText;
        dlCsv.disabled = !_csvText;
        dlTxt.disabled = !_txtText;
        setStatus('success', `OK: runs=${data.runs_count}`);
      }catch(e){
        setStatus('error','–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
      }finally{
        btn.disabled = false;
      }
    });
    dlCsv?.addEventListener('click', ()=>{
      const sym = (document.getElementById('symbol')?.value || 'symbol').toUpperCase();
      const mt = (document.getElementById('modelType')?.value || 'all').toLowerCase();
      download(`hypotheses_${mt}_${sym}.csv`, _csvText, 'text/csv');
    });
    dlTxt?.addEventListener('click', ()=>{
      const sym = (document.getElementById('symbol')?.value || 'symbol').toUpperCase();
      const mt = (document.getElementById('modelType')?.value || 'all').toLowerCase();
      download(`hypotheses_${mt}_${sym}.txt`, _txtText, 'text/plain');
    });

    document.addEventListener('DOMContentLoaded', async ()=>{
      await loadSymbols();
      document.getElementById('modelType')?.addEventListener('change', loadSymbols);
    });
  </script>
</body>
</html>

