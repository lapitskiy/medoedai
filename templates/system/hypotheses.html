<!DOCTYPE html>
<html lang="ru">
<head>
  <link rel="stylesheet" href="/static/css/styles.css">
  <link rel="stylesheet" href="/static/css/sidebar.css">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üß† –ì–∏–ø–æ—Ç–µ–∑—ã</title>
</head>
<body>
  {% include 'include/_sidebar.html' %}
  <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>

  <div class="container">
    <div class="main-content">
      <div class="header">
        <h1>üß† –ì–∏–ø–æ—Ç–µ–∑—ã</h1>
        <p>–≠–∫—Å–ø–æ—Ä—Ç –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ runs (CSV) + —Ç–µ–∫—Å—Ç–æ–≤—ã–π summary –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≥–∏–ø–æ—Ç–µ–∑ –≤ ChatGPT.</p>
      </div>

      <div class="content">
        <a href="/" class="back-link">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>

        <div class="section">
          <h2>‚öôÔ∏è –≠–∫—Å–ø–æ—Ä—Ç</h2>
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
            <label>Symbol:
              <input id="symbol" class="form-control" style="width:140px;" value="XRPUSDT">
            </label>
            <label>Limit runs:
              <input id="limitRuns" class="form-control" style="width:120px;" value="200">
            </label>
            <button class="btn btn-info" id="genBtn">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
            <button class="btn btn-secondary" id="dlCsvBtn" disabled>–°–∫–∞—á–∞—Ç—å CSV</button>
            <button class="btn btn-secondary" id="dlTxtBtn" disabled>–°–∫–∞—á–∞—Ç—å TXT</button>
          </div>
          <div id="status" class="status" style="margin-top:10px;display:none;"></div>
        </div>

        <div class="section">
          <h2>üìÑ –¢–µ–∫—Å—Ç –¥–ª—è ChatGPT</h2>
          <textarea id="promptOut" class="form-control" style="width:100%;min-height:320px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,'Liberation Mono','Courier New',monospace;"></textarea>
        </div>
      </div>
    </div>
  </div>

  <script>
    function toggleSidebar(){ document.body.classList.toggle('sidebar-open'); }
    const st = document.getElementById('status');
    const btn = document.getElementById('genBtn');
    const dlCsv = document.getElementById('dlCsvBtn');
    const dlTxt = document.getElementById('dlTxtBtn');
    const promptOut = document.getElementById('promptOut');
    let _csvText = '';
    let _txtText = '';

    function setStatus(kind, text){
      st.style.display = 'block';
      st.className = 'status ' + (kind || 'info');
      st.textContent = text || '';
    }
    function download(name, text, mime){
      const blob = new Blob([text], {type: (mime||'text/plain') + ';charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = name; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 500);
    }

    btn?.addEventListener('click', async ()=>{
      btn.disabled = true; dlCsv.disabled = true; dlTxt.disabled = true;
      setStatus('info','–°–æ–±–∏—Ä–∞—é –¥–∞–Ω–Ω—ã–µ...');
      try{
        const sym = document.getElementById('symbol')?.value || '';
        const lim = document.getElementById('limitRuns')?.value || '200';
        const resp = await fetch(`/api/system/hypotheses_export?symbol=${encodeURIComponent(sym)}&limit_runs=${encodeURIComponent(lim)}`);
        const data = await resp.json();
        if(!data.success){ setStatus('error', data.error || '–û—à–∏–±–∫–∞'); return; }
        _csvText = data.csv || '';
        _txtText = data.prompt || '';
        promptOut.value = _txtText;
        dlCsv.disabled = !_csvText;
        dlTxt.disabled = !_txtText;
        setStatus('success', `OK: runs=${data.runs_count}`);
      }catch(e){
        setStatus('error','–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
      }finally{
        btn.disabled = false;
      }
    });
    dlCsv?.addEventListener('click', ()=>{
      const sym = (document.getElementById('symbol')?.value || 'symbol').toUpperCase();
      download(`hypotheses_${sym}.csv`, _csvText, 'text/csv');
    });
    dlTxt?.addEventListener('click', ()=>{
      const sym = (document.getElementById('symbol')?.value || 'symbol').toUpperCase();
      download(`hypotheses_${sym}.txt`, _txtText, 'text/plain');
    });
  </script>
</body>
</html>

