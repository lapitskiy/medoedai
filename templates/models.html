<!DOCTYPE html>
<html lang="ru">
<head>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="/static/css/sidebar.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>!–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª—è–º–∏ DQN</title>
</head>
<body>
    <!-- Sidebar –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
    <nav class="sidebar">
        <h3>üìã –ù–∞–≤–∏–≥–∞—Ü–∏—è</h3>
        <ul class="sidebar-nav">
            <li><a href="/" class="back-link">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a></li>
            <li><a href="javascript:history.back()">‚Üê –ù–∞–∑–∞–¥</a></li>
            <li><a href="#create-model" onclick="scrollToSection('create-model')">üì¶ –°–æ–∑–¥–∞—Ç—å –≤–µ—Ä—Å–∏—é</a></li>
            <li><a href="#training" onclick="scrollToSection('training')">üéØ –û–±—É—á–µ–Ω–∏–µ DQN</a></li>
            <li><a href="#continue-training" onclick="scrollToSection('continue-training')">üîÅ –î–æ–æ–±—É—á–∏—Ç—å –º–æ–¥–µ–ª—å</a></li>
            <li><a href="/oos">üìà OOS —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</a></li>
        </ul>
    </nav>

    <!-- –ö–Ω–æ–ø–∫–∞ –º–æ–±–∏–ª—å–Ω–æ–≥–æ –º–µ–Ω—é -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>

    <div class="container">
        <div class="main-content">
            <div class="header">
                <h1>ü§ñ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª—è–º–∏ DQN</h1>
                <p>–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—É—á–µ–Ω–Ω—ã–º–∏ –º–æ–¥–µ–ª—è–º–∏</p>
            </div>
            
            <div class="content">
            <a href="/" class="back-link">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>
            
            <!-- –°–µ–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π –º–æ–¥–µ–ª–∏ -->
            <div class="section" id="create-model">
                <h2>üì¶ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é –º–æ–¥–µ–ª–∏</h2>
                <p>–°–∫–æ–ø–∏—Ä—É–µ—Ç –≤–µ—Å–∞/–±—É—Ñ–µ—Ä/—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–∑ <code>result/</code> –≤ <code>models/&lt;symbol&gt;/ensemble-a/vN</code> (—Å <code>manifest.yaml</code> –∏ —Å—Å—ã–ª–∫–æ–π <code>current</code>)</p>
                <div class="form-group">
                    <label>–°–∏–º–≤–æ–ª</label>
                    <select id="resultSymbolSelect" class="form-control" onchange="loadResultFilesForCreate()">
                        <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–∏–º–≤–æ–ª–æ–≤...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å –∏–∑ –ø–∞–ø–∫–∏ result</label>
                    <select id="resultFileSelect" class="form-control">
                        <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å–∏–º–≤–æ–ª...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–ê–Ω—Å–∞–º–±–ª—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è</label>
                    <select id="resultEnsembleSelect" class="form-control">
                        <option value="ensemble-a" selected>ensemble-a</option>
                        <option value="ensemble-b">ensemble-b</option>
                        <option value="ensemble-c">ensemble-c</option>
                    </select>
                </div>
                <div class="button-group">
                    <button class="btn btn-success" onclick="createModelVersion()">üöÄ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é</button>
                </div>
            </div>

            <!-- –°–µ–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –æ–±—É—á–µ–Ω–∏—è DQN -->
            <div class="section" id="training">
                <h2>üéØ –û–±—É—á–µ–Ω–∏–µ DQN –º–æ–¥–µ–ª–∏</h2>
                <p>–ó–∞–ø—É—Å—Ç–∏—Ç–µ –æ–±—É—á–µ–Ω–∏–µ Deep Q-Network –º–æ–¥–µ–ª–∏ –¥–ª—è —Ç–æ—Ä–≥–æ–≤–ª–∏ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞–º–∏</p>
                <div class="form-group">
                    <label>–≠–ø–∏–∑–æ–¥—ã –æ–±—É—á–µ–Ω–∏—è</label>
                    <input id="episodesInput" class="form-control" type="number" min="1" step="1" value="1000">
                </div>
                <div class="form-group">
                    <label>–î–ª–∏–Ω–∞ —ç–ø–∏–∑–æ–¥–∞ (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–≤–µ—á–µ–π)</label>
                    <input id="episodeLengthInput" class="form-control" type="number" min="1" step="1" value="2000">
                </div>
                <div class="form-group">
                    <label>Seed (–µ—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π)</label>
                    <input id="trainSeedInput" class="form-control" type="number" min="1" step="1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 42">
                </div>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="startTrainingForSymbol('BTCUSDT')">üöÄ –û–±—É—á–∏—Ç—å BTC</button>
                    <button class="btn btn-primary" onclick="startTrainingForSymbol('TONUSDT')">üöÄ –û–±—É—á–∏—Ç—å TON</button>
                    <button class="btn btn-primary" onclick="startTrainingForSymbol('ETHUSDT')">üöÄ –û–±—É—á–∏—Ç—å ETH</button>
                    <button class="btn btn-primary" onclick="startTrainingForSymbol('SOLUSDT')">üöÄ –û–±—É—á–∏—Ç—å SOL</button>
                    <button class="btn btn-primary" onclick="startTrainingForSymbol('ADAUSDT')">üöÄ –û–±—É—á–∏—Ç—å ADA</button>
                    <button class="btn btn-primary" onclick="startTrainingForSymbol('BNBUSDT')">üöÄ –û–±—É—á–∏—Ç—å BNB</button>
                    <button class="btn btn-primary" onclick="startTrainingForSymbol('XMRUSDT')">üöÄ –û–±—É—á–∏—Ç—å XMR</button>
                    <button class="btn btn-primary" onclick="startTrainingForSymbol('XRPUSDT')">üöÄ –û–±—É—á–∏—Ç—å XRP</button>
                    <button class="btn btn-success" onclick="startTrainingMulti()">üåü –û–±—É—á–∏—Ç—å –º—É–ª—å—Ç–∏–≤–∞–ª—é—Ç–Ω—É—é</button>
                </div>
                <div id="trainStatus"></div>
            </div>

            <!-- –°–µ–∫—Ü–∏—è –¥–æ–æ–±—É—á–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –º–æ–¥–µ–ª–∏ -->
            <div class="section" id="continue-training">
                <h2>üîÅ –î–æ–æ–±—É—á–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –º–æ–¥–µ–ª—å</h2>
                <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –≤–µ—Å–æ–≤ –∏–∑ <code>result/</code> (—Ñ–æ—Ä–º–∞—Ç <code>dqn_model_*.pth</code>). –ï—Å–ª–∏ –Ω–∞–π–¥–µ—Ç—Å—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π <code>replay_buffer_*.pkl</code>, –æ–Ω —Ç–∞–∫–∂–µ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω. –î–æ–æ–±—É—á–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–∞–∫ –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é.</p>

                <div class="form-group">
                    <label>–°–∏–º–≤–æ–ª</label>
                    <select id="runsSymbolSelect" class="form-control" onchange="loadRunsForSymbol()">
                        <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–∏–º–≤–æ–ª–æ–≤...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>–í—ã–±–µ—Ä–∏—Ç–µ –≤–µ—Å–∞ –º–æ–¥–µ–ª–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, dqn_model_ton_ed10.pth)</label>
                    <select id="continueModelSelect" class="form-control" onchange="showSelectedContinueModelInfo()">
                        <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞...</option>
                    </select>
                </div>

                <div id="continueModelInfo" class="status info" style="display:none; white-space: pre-line;"></div>

                <div class="form-group">
                    <label>–≠–ø–∏–∑–æ–¥—ã –¥–æ–æ–±—É—á–µ–Ω–∏—è</label>
                    <input id="continueEpisodesInput" class="form-control" type="number" min="1" step="1" value="1000" oninput="updateEstimatedTime()">
                    <div id="episodesEstimate" class="status info" style="display:none; margin-top:6px;"></div>
                </div>
                <div class="form-group">
                    <label>Seed –¥–ª—è –¥–æ–æ–±—É—á–µ–Ω–∏—è (–µ—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî —Å–ª—É—á–∞–π–Ω—ã–π)</label>
                    <input id="continueSeedInput" class="form-control" type="number" min="1" step="1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 2024">
                </div>

                <div class="button-group">
                    <button class="btn btn-success" onclick="continueTraining()">üîÅ –ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–æ–æ–±—É—á–µ–Ω–∏–µ</button>
                </div>

                <div id="continueStatus"></div>
            </div>
                <div id="createStatus"></div>
            </div>

            
            </div>
        </div>
    </div>

    <script>
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            try{ loadResultSymbolsForCreate(); }catch(_){ }
            loadContinueModels();
            loadRunsSymbols();
        });

        // –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é –º–æ–¥–µ–ª–∏
        async function createModelVersion() {
            const statusDiv = document.getElementById('createStatus');
            const button = event.target;
            const fileSelect = document.getElementById('resultFileSelect');
            const symbolSelect = document.getElementById('resultSymbolSelect');
            const selectedFile = fileSelect ? fileSelect.value : '';
            const selectedSymbol = symbolSelect ? symbolSelect.value : '';
            const ensSelect = document.getElementById('resultEnsembleSelect');
            const selectedEns = ensSelect ? ensSelect.value : 'ensemble-a';
            
            if (!selectedFile) {
                statusDiv.innerHTML = '<div class="status error">‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å –∏–∑ result</div>';
                return;
            }
            
            button.disabled = true;
            button.textContent = '‚è≥ –°–æ–∑–¥–∞–Ω–∏–µ...';
            statusDiv.innerHTML = '<div class="status info">–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ –º–æ–¥–µ–ª–∏...</div>';
            
            try {
                const response = await fetch('/create_model_version', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ file: selectedFile, symbol: selectedSymbol, ensemble: selectedEns })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    statusDiv.innerHTML = `<div class="status success">
                        ‚úÖ –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è —Å–æ–∑–¥–∞–Ω–∞!<br>
                        ID: ${result.model_id}<br>
                        –§–∞–π–ª—ã: ${result.files.join(', ')}
                    </div>`;
                    // –°–µ–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π —É–¥–∞–ª–µ–Ω–∞
                } else {
                    statusDiv.innerHTML = `<div class="status error">
                        ‚ùå –û—à–∏–±–∫–∞: ${result.error}
                    </div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">
                    ‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}
                </div>`;
            } finally {
                button.disabled = false;
                button.textContent = 'üöÄ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é';
            }
        }

        // === Runs UI ===
        async function loadRunsSymbols(){
            const sel = document.getElementById('runsSymbolSelect');
            if(!sel) return;
            try{
                const resp = await fetch('/api/runs/symbols');
                const data = await resp.json();
                if(!data.success){ sel.innerHTML = '<option value="">–û—à–∏–±–∫–∞</option>'; return; }
                const list = Array.isArray(data.symbols)? data.symbols: [];
                if(list.length===0){ sel.innerHTML = '<option value="">–ù–µ—Ç —Å–∏–º–≤–æ–ª–æ–≤</option>'; return; }
                sel.innerHTML = list.map(s=>`<option value="${s}">${s}</option>`).join('');
                try{ loadRunsForSymbol(); }catch(_){ }
            }catch(e){ if(sel) sel.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>'; }
        }

        async function loadRunsForSymbol(){
            const sym = (document.getElementById('runsSymbolSelect')?.value||'').trim();
            if(!sym) return;
            try{
                const resp = await fetch('/api/runs/list?symbol='+encodeURIComponent(sym));
                const data = await resp.json();
                if(!data.success) return;
                // –ó–∞–ø–æ–ª–Ω—è–µ–º continueModelSelect —Ñ–∞–π–ª–∞–º–∏ model.pth –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
                const select = document.getElementById('continueModelSelect');
                if(!select) return;
                const runs = Array.isArray(data.runs)? data.runs: [];
                if(runs.length===0){ select.innerHTML = '<option value="">–ù–µ—Ç –∑–∞–ø—É—Å–∫–æ–≤</option>'; return; }
                // –æ—Ç–æ–±—Ä–∞–∑–∏–º –¥—Ä–µ–≤–æ–≤–∏–¥–Ω–æ: parent ‚Üí child (—É–ø—Ä–æ—Å—Ç–∏–º: –ø—Ä–µ—Ñ–∏–∫—Å ‚ñ∏)
                const idToChildren = {};
                const idToNode = {};
                runs.forEach(r=>{ idToChildren[r.run_id]=[]; idToNode[r.run_id]=r; });
                runs.forEach(r=>{ if(r.parent_run_id && idToChildren[r.parent_run_id]) idToChildren[r.parent_run_id].push(r.run_id); });
                function renderRun(runId, depth){
                    const r = idToNode[runId]; if(!r) return '';
                    const label = `${'‚ñ∏'.repeat(depth)} ${r.run_id}`;
                    const file = r.model_path || '';
                    const opt = `<option value="${file}">${label}</option>`;
                    const children = (idToChildren[runId]||[]).map(cid=>renderRun(cid, depth+1)).join('');
                    return opt+children;
                }
                // –∫–æ—Ä–Ω–∏: –±–µ–∑ parent
                const roots = runs.filter(r=>!r.parent_run_id).map(r=>r.run_id);
                const html = roots.map(rt=>renderRun(rt,0)).join('');
                select.innerHTML = html;
                try{ showSelectedContinueModelInfo(); }catch(_){ }
            }catch(e){ /* noop */ }
        }

        // –ì–ª–æ–±–∞–ª—å–Ω–æ —Ö—Ä–∞–Ω–∏–º —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –∑–∞ —ç–ø–∏–∑–æ–¥ (—Å–µ–∫)
        let avgTimePerEpisodeSec = null;

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è —Å–µ–∫—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω–∏—è –≤–µ—Ä—Å–∏–∏
        async function loadResultSymbolsForCreate(){
            const sel = document.getElementById('resultSymbolSelect');
            if(!sel) return;
            try{
                const resp = await fetch('/api/runs/symbols');
                const data = await resp.json();
                if(!data.success){ sel.innerHTML = '<option value="">–û—à–∏–±–∫–∞</option>'; return; }
                const list = Array.isArray(data.symbols)? data.symbols: [];
                if(list.length===0){ sel.innerHTML = '<option value="">–ù–µ—Ç —Å–∏–º–≤–æ–ª–æ–≤</option>'; return; }
                sel.innerHTML = list.map(s=>`<option value="${s}">${s}</option>`).join('');
                try{ loadResultFilesForCreate(); }catch(_){ }
            }catch(e){ sel.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>'; }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–µ–π (–≤–µ—Å–æ–≤) –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞ –∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã runs
        async function loadResultFilesForCreate(){
            const sym = (document.getElementById('resultSymbolSelect')?.value||'').trim();
            const select = document.getElementById('resultFileSelect');
            if(!select) return;
            if(!sym){ select.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å–∏–º–≤–æ–ª...</option>'; return; }
            try{
                const resp = await fetch('/api/runs/list?symbol='+encodeURIComponent(sym));
                const data = await resp.json();
                if(!data.success){ select.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>'; return; }
                const runs = Array.isArray(data.runs)? data.runs: [];
                const options = [];
                for(const r of runs){
                    const path = r.model_path || '';
                    if(path && path.toLowerCase().endsWith('.pth')){
                        const fname = path.split('/').pop().split('\\').pop();
                        const label = `${r.run_id || 'run'} ‚Äî ${fname}`;
                        options.push(`<option value="${path}">${label}</option>`);
                    }
                }
                select.innerHTML = options.length? options.join('') : '<option value="">–ù–µ—Ç –æ–±—É—á–µ–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π</option>';
            }catch(e){ select.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>'; }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –≤–µ—Å–æ–≤ –¥–ª—è –¥–æ–æ–±—É—á–µ–Ω–∏—è (–≤—Å–µ dqn_model_*.pth)
        async function loadContinueModels() {
            const select = document.getElementById('continueModelSelect');
            if (!select) return;
            try {
                const resp = await fetch('/list_result_models');
                const data = await resp.json();
                if (!data.success || !data.files || data.files.length === 0) {
                    select.innerHTML = '<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤</option>';
                    return;
                }
                // –í—Å–µ dqn_model_* (–±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ —Å–∏–º–≤–æ–ª—É)
                const opts = data.files.map(f => {
                    const filename = (f.filename || '').split('/').pop().split('\\').pop();
                    return `<option value="${f.filename}">${filename}</option>`;
                }).join('');
                select.innerHTML = opts;
                // –ê–≤—Ç–æ-–ø–æ–∫–∞–∑ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
                try { showSelectedContinueModelInfo(); } catch(e){}
            } catch (e) {
                select.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞</option>';
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∫—Ä–∞—Ç–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –≤–µ—Å–∞—Ö –¥–ª—è –¥–æ–æ–±—É—á–µ–Ω–∏—è
        async function showSelectedContinueModelInfo() {
            const select = document.getElementById('continueModelSelect');
            const infoDiv = document.getElementById('continueModelInfo');
            if (!select || !infoDiv) return;
            const filename = select.value;
            if (!filename) { infoDiv.style.display = 'none'; return; }
            try {
                const resp = await fetch('/get_result_model_info', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename })
                });
                const result = await resp.json();
                if (!result.success) {
                    infoDiv.className = 'status error';
                    infoDiv.textContent = '‚ùå ' + (result.error || '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏');
                    infoDiv.style.display = 'block';
                    return;
                }
                const stats = result.stats || {};
                const winrate = typeof stats.winrate === 'number' ? (stats.winrate * 100).toFixed(1) + '%' : 'N/A';
                const plr = typeof stats.pl_ratio === 'number' ? stats.pl_ratio.toFixed(2) : 'N/A';
                const trades = (stats.trades_count != null) ? stats.trades_count : 'N/A';
                const episodes = (result.episodes != null) ? result.episodes : 'N/A';
                const seed = (result.seed != null) ? result.seed : null;
                const gpu = (result.cuda_available===true) ? (result.gpu_name || 'GPU') : 'CPU';
                const totalTime = (typeof result.total_training_time === 'number') ? result.total_training_time : null;
                const avgTime = (typeof result.avg_time_per_episode_sec === 'number') ? result.avg_time_per_episode_sec : (totalTime && episodes ? (totalTime/episodes) : null);
                const fmtSec = (s)=>{
                    if(!s && s!==0) return 'N/A';
                    try{ const m=Math.floor(s/60), r=Math.round(s%60); return (m>0?`${m}–º `:'')+`${r}—Å`; }catch(_){ return s.toFixed? s.toFixed(1)+'—Å' : String(s); }
                };
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –æ–Ω–ª–∞–π–Ω-–æ—Ü–µ–Ω–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏ –≤–≤–æ–¥–µ
                try { avgTimePerEpisodeSec = (typeof avgTime === 'number' && avgTime > 0) ? avgTime : null; } catch(_) { avgTimePerEpisodeSec = null; }
                // –ö–æ–¥ –º–æ–∂–µ—Ç –≤–∫–ª—é—á–∞—Ç—å —Å–∏–º–≤–æ–ª, –ø–æ–ø—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å
                const code = (result.code || '').toUpperCase();
                const symbolOut = (result.symbol || '').toUpperCase();
                let symbolGuess = '';
                if (code) {
                    // –ß–∞—Å—Ç–æ –∫–æ–¥ –≤–∏–¥–∞ btc_xxxx -> –¥–æ–±–∞–≤–∏–º USDT
                    const base = code.split('_')[0];
                    if (base && base.length <= 6) symbolGuess = base + 'USDT';
                }
                infoDiv.className = 'status info';
                infoDiv.innerHTML = `
–í—ã–±—Ä–∞–Ω–æ: ${filename.split('/').pop().split('\\').pop()}
–ö–æ–¥/—Å–∏–º–≤–æ–ª: ${code || 'N/A'} / ${symbolOut || symbolGuess || 'N/A'}
Seed: ${seed !== null ? seed : '‚Äî'}
–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${gpu}
Winrate: ${winrate}
P/L Ratio: ${plr}
–°–¥–µ–ª–æ–∫: ${trades}
–≠–ø–∏–∑–æ–¥–æ–≤: ${episodes}
–î–ª–∏–Ω–∞ —ç–ø–∏–∑–æ–¥–∞: ${result.episode_length != null ? result.episode_length : 'N/A'}
–ë—É—Ñ–µ—Ä: ${result.replay_exists ? '‚úÖ –µ—Å—Ç—å' : '‚ùå –Ω–µ—Ç'}
–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—É—á–µ–Ω–∏—è: ${result.train_result_exists ? '‚úÖ –µ—Å—Ç—å' : '‚ùå –Ω–µ—Ç'}
–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –∑–∞ —ç–ø–∏–∑–æ–¥: ${fmtSec(avgTime)}
–û–±—â–µ–µ –≤—Ä–µ–º—è –æ–±—É—á–µ–Ω–∏—è: ${totalTime ? fmtSec(totalTime) : 'N/A'}
`;
                infoDiv.style.display = 'block';
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–ª–∏–Ω—É —ç–ø–∏–∑–æ–¥–∞
                const continueEpisodeLengthInput = document.getElementById('continueEpisodeLengthInput');
                if (continueEpisodeLengthInput && result.episode_length != null) {
                    continueEpisodeLengthInput.value = result.episode_length;
                }
                // –û–±–Ω–æ–≤–∏–º –ø–æ–¥—Å–∫–∞–∑–∫—É –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏
                try { updateEstimatedTime(); } catch(_) {}
            } catch (e) {
                infoDiv.className = 'status error';
                infoDiv.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + e.message;
                infoDiv.style.display = 'block';
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ü–µ–Ω–∫–∏ –æ–±—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏ –≤–≤–æ–¥–µ —ç–ø–∏–∑–æ–¥–æ–≤
        function updateEstimatedTime(){
            const estDiv = document.getElementById('episodesEstimate');
            const inp = document.getElementById('continueEpisodesInput');
            if(!estDiv || !inp){ return; }
            const n = Math.max(1, parseInt(inp.value || '0', 10) || 0);
            if (avgTimePerEpisodeSec && n > 0){
                const totalSec = n * avgTimePerEpisodeSec;
                const hours = Math.floor(totalSec/3600);
                const minutes = Math.round((totalSec%3600)/60);
                const human = (hours>0? `${hours} —á `: '') + `${minutes} –º–∏–Ω`;
                // –û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è
                try {
                    const finish = new Date(Date.now() + totalSec*1000);
                    const hh = String(finish.getHours()).padStart(2,'0');
                    const mm = String(finish.getMinutes()).padStart(2,'0');
                    estDiv.textContent = `‚âà ${human} (–æ–∫–æ–Ω—á–∞–Ω–∏–µ –≤ ${hh}:${mm})`;
                } catch(_) {
                    estDiv.textContent = `‚âà ${human}`;
                }
                estDiv.style.display = 'block';
            } else {
                estDiv.textContent = '–í—Ä–µ–º—è –±—É–¥–µ—Ç —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–æ –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏ —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π';
                estDiv.style.display = 'block';
            }
        }

        // –ó–∞–ø—É—Å–∫ –¥–æ–æ–±—É—á–µ–Ω–∏—è
        async function continueTraining() {
            const statusDiv = document.getElementById('continueStatus');
            const fileSelect = document.getElementById('continueModelSelect');
            const episodes = document.getElementById('continueEpisodesInput').value;
            const seedVal = (document.getElementById('continueSeedInput')?.value || '').trim();
            const selectedFile = fileSelect ? fileSelect.value : '';

            if (!selectedFile) {
                statusDiv.innerHTML = '<div class="status error">‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≤–µ—Å–∞ dqn_model_*.pth</div>';
                return;
            }
            const episodeLength = document.getElementById('continueEpisodeLengthInput').value;

            statusDiv.innerHTML = '<div class="status info">‚è≥ –ó–∞–ø—É—Å–∫ –¥–æ–æ–±—É—á–µ–Ω–∏—è...</div>';
            try {
                const resp = await fetch('/continue_training', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: selectedFile, episodes, episode_length: episodeLength, seed: seedVal })
                });
                const result = await resp.json();
                if (result.success) {
                    statusDiv.innerHTML = `<div class=\"status success\">‚úÖ –î–æ–æ–±—É—á–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ (task: ${result.task_id}). –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—è–≤–∏—Ç—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ –º–æ–¥–µ–ª–µ–π.</div>`;
                } else {
                    statusDiv.innerHTML = `<div class=\"status error\">‚ùå –û—à–∏–±–∫–∞: ${result.error}</div>`;
                }
            } catch (e) {
                statusDiv.innerHTML = `<div class=\"status error\">‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${e.message}</div>`;
            }
        }

        // –ó–∞–ø—É—Å–∫ –æ–±—É—á–µ–Ω–∏—è —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —ç–ø–∏–∑–æ–¥–æ–≤
        async function startTrainingForSymbol(symbol) {
            const episodes = document.getElementById('episodesInput').value || 1000;
            const episodeLength = document.getElementById('episodeLengthInput').value || 2000;
            const seedVal = (document.getElementById('trainSeedInput')?.value || '').trim();
            const statusDiv = document.getElementById('trainStatus');
            statusDiv.innerHTML = '<div class="status info">‚è≥ –ó–∞–ø—É—Å–∫ –æ–±—É—á–µ–Ω–∏—è ' + symbol + '...</div>';
            try {
                const resp = await fetch('/training/train_dqn_symbol', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify({ symbol, episodes, episode_length: episodeLength, seed: seedVal })
                });
                const data = await resp.json().catch(() => null);
                if (data && data.success) {
                    statusDiv.innerHTML = '<div class="status success">‚úÖ –û–±—É—á–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ (task: ' + data.task_id + ')</div>';
                } else if (data && data.error) {
                    statusDiv.innerHTML = '<div class="status error">‚ùå ' + data.error + '</div>';
                } else if (resp.redirected) {
                    // –§–æ–ª–ª–±–µ–∫ –Ω–∞ —Å–ª—É—á–∞–π —Å—Ç–∞—Ä–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è
                    window.location.href = resp.url;
                } else {
                    statusDiv.innerHTML = '<div class="status error">‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞</div>';
                }
            } catch (e) {
                statusDiv.innerHTML = '<div class="status error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –æ–±—É—á–µ–Ω–∏—è: ' + e.message + '</div>';
            }
        }

        async function startTrainingMulti() {
            const statusDiv = document.getElementById('trainStatus');
            const episodes = document.getElementById('episodesInput').value || 1000;
            const episodeLength = document.getElementById('episodeLengthInput').value || 2000;
            const seedVal = (document.getElementById('trainSeedInput')?.value || '').trim();
            if (statusDiv) statusDiv.innerHTML = '<div class="status info">‚è≥ –ó–∞–ø—É—Å–∫ –º—É–ª—å—Ç–∏–≤–∞–ª—é—Ç–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è...</div>';
            try {
                const resp = await fetch('/training/train_dqn_multi_crypto', {
                    method: 'POST',
                    headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' },
                    body: JSON.stringify({ episodes, episode_length: episodeLength, seed: seedVal })
                });
                const data = await resp.json().catch(() => null);
                if (data && data.success) {
                    if (statusDiv) statusDiv.innerHTML = '<div class="status success">‚úÖ –û–±—É—á–µ–Ω–∏–µ (multi) –∑–∞–ø—É—â–µ–Ω–æ (task: ' + data.task_id + ')</div>';
                } else if (data && data.error) {
                    if (statusDiv) statusDiv.innerHTML = '<div class="status error">‚ùå ' + data.error + '</div>';
                } else if (resp.redirected) {
                    if (statusDiv) statusDiv.innerHTML = '<div class="status info">‚ÑπÔ∏è –û–±—É—á–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ, –æ—Å—Ç–∞–≤–∞–π—Ç–µ—Å—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ.</div>';
                } else {
                    if (statusDiv) statusDiv.innerHTML = '<div class="status error">‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞</div>';
                }
            } catch (e) {
                if (statusDiv) statusDiv.innerHTML = '<div class="status error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –º—É–ª—å—Ç–∏–≤–∞–ª—é—Ç–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è: ' + e.message + '</div>';
            }
        }

        // –°–µ–∫—Ü–∏—è "–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏" —É–¥–∞–ª–µ–Ω–∞

        // –ö–∞—Ä—Ç–æ—á–∫–∏/–∞–Ω–∞–ª–∏–∑/—É–¥–∞–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π –æ—Ç–∫–ª—é—á–µ–Ω—ã

        // –ê–Ω–∞–ª–∏–∑ –º–æ–¥–µ–ª–∏ –æ—Ç–∫–ª—é—á—ë–Ω

        // –£–¥–∞–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ –æ—Ç–∫–ª—é—á–µ–Ω–æ
    </script>
    <script src="/static/js/sidebar.js"></script>
</body>
</html>

