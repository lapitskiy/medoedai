<!DOCTYPE html>
<html lang="ru">
<head>
    <link rel="stylesheet" href="/static/css/styles.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>!–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª—è–º–∏ DQN</title>
    <style>
        /* –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è —Å–µ–∫—Ü–∏–∏ "–ú–æ–¥–µ–ª–∏ –≤ result (—É–¥–∞–ª–µ–Ω–∏–µ)" */
        #resultModelsSection { font-size: 12px; }
        #resultModelsSection #resultModelsList { display: block; overflow: visible; padding: 0; }
        #resultModelsTable { width: 100%; border-collapse: collapse; table-layout: fixed; }
        #resultModelsTable th, #resultModelsTable td { padding: 6px 8px; text-align: left; vertical-align: middle; }
        #resultModelsTable th { background: #f5f7fb; font-weight: 600; }
        #resultModelsTable tr:nth-child(even) { background: #fafbfe; }
        #resultModelsTable .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
        #resultModelsTable .muted { color: #6b7280; }
        #resultModelsTable .nowrap { white-space: nowrap; }
        #resultModelsTable .truncate { max-width: 360px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: inline-block; vertical-align: bottom; }
        #resultModelsSection .button-group { margin-bottom: 10px; }
        #resultModelsSection .btn.btn-danger { font-size: 12px; padding: 6px 10px; }
    </style>

</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª—è–º–∏ DQN</h1>
            <p>–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—É—á–µ–Ω–Ω—ã–º–∏ –º–æ–¥–µ–ª—è–º–∏</p>
        </div>
        
        <div class="content">
            <a href="/" class="back-link">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>
            
            <!-- –°–µ–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π –º–æ–¥–µ–ª–∏ -->
            <div class="section">
                <h2>üì¶ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é –º–æ–¥–µ–ª–∏</h2>
                <p>–°–∫–æ–ø–∏—Ä—É–µ—Ç –≤–µ—Å–∞/–±—É—Ñ–µ—Ä/—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–∑ <code>result/</code> –≤ <code>models/&lt;symbol&gt;/ensemble-a/vN</code> (—Å <code>manifest.yaml</code> –∏ —Å—Å—ã–ª–∫–æ–π <code>current</code>)</p>
                <div class="form-group">
                    <label>–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å –∏–∑ –ø–∞–ø–∫–∏ result</label>
                    <select id="resultFileSelect" class="form-control">
                        <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–ê–Ω—Å–∞–º–±–ª—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è</label>
                    <select id="resultEnsembleSelect" class="form-control">
                        <option value="ensemble-a" selected>ensemble-a</option>
                        <option value="ensemble-b">ensemble-b</option>
                        <option value="ensemble-c">ensemble-c</option>
                    </select>
                </div>
                <div class="button-group">
                    <button class="btn btn-success" onclick="createModelVersion()">üöÄ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é</button>
                </div>
            </div>

            <!-- –°–µ–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –æ–±—É—á–µ–Ω–∏—è DQN -->
            <div class="section">
                <h2>üéØ –û–±—É—á–µ–Ω–∏–µ DQN –º–æ–¥–µ–ª–∏</h2>
                <p>–ó–∞–ø—É—Å—Ç–∏—Ç–µ –æ–±—É—á–µ–Ω–∏–µ Deep Q-Network –º–æ–¥–µ–ª–∏ –¥–ª—è —Ç–æ—Ä–≥–æ–≤–ª–∏ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞–º–∏</p>
                <div class="form-group">
                    <label>–≠–ø–∏–∑–æ–¥—ã –æ–±—É—á–µ–Ω–∏—è</label>
                    <input id="episodesInput" class="form-control" type="number" min="1" step="1" value="1000">
                </div>
                <div class="form-group">
                    <label>Seed (–µ—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π)</label>
                    <input id="trainSeedInput" class="form-control" type="number" min="1" step="1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 42">
                </div>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="startTrainingForSymbol('BTCUSDT')">üöÄ –û–±—É—á–∏—Ç—å BTC</button>
                    <button class="btn btn-primary" onclick="startTrainingForSymbol('TONUSDT')">üöÄ –û–±—É—á–∏—Ç—å TON</button>
                    <button class="btn btn-primary" onclick="startTrainingForSymbol('ETHUSDT')">üöÄ –û–±—É—á–∏—Ç—å ETH</button>
                    <button class="btn btn-primary" onclick="startTrainingForSymbol('SOLUSDT')">üöÄ –û–±—É—á–∏—Ç—å SOL</button>
                    <button class="btn btn-primary" onclick="startTrainingForSymbol('ADAUSDT')">üöÄ –û–±—É—á–∏—Ç—å ADA</button>
                    <button class="btn btn-primary" onclick="startTrainingForSymbol('BNBUSDT')">üöÄ –û–±—É—á–∏—Ç—å BNB</button>
                    <button class="btn btn-primary" onclick="startTrainingForSymbol('XMRUSDT')">üöÄ –û–±—É—á–∏—Ç—å XMR</button>
                    <button class="btn btn-primary" onclick="startTrainingForSymbol('XRPUSDT')">üöÄ –û–±—É—á–∏—Ç—å XRP</button>
                    <button class="btn btn-success" onclick="startTrainingMulti()">üåü –û–±—É—á–∏—Ç—å –º—É–ª—å—Ç–∏–≤–∞–ª—é—Ç–Ω—É—é</button>
                </div>
                <div id="trainStatus"></div>
            </div>

            <!-- –°–µ–∫—Ü–∏—è –¥–æ–æ–±—É—á–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –º–æ–¥–µ–ª–∏ -->
            <div class="section">
                <h2>üîÅ –î–æ–æ–±—É—á–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –º–æ–¥–µ–ª—å</h2>
                <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –≤–µ—Å–æ–≤ –∏–∑ <code>result/</code> (—Ñ–æ—Ä–º–∞—Ç <code>dqn_model_*.pth</code>). –ï—Å–ª–∏ –Ω–∞–π–¥–µ—Ç—Å—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π <code>replay_buffer_*.pkl</code>, –æ–Ω —Ç–∞–∫–∂–µ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω. –î–æ–æ–±—É—á–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–∞–∫ –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é.</p>

                <div class="form-group">
                    <label>–°–∏–º–≤–æ–ª</label>
                    <select id="runsSymbolSelect" class="form-control" onchange="loadRunsForSymbol()">
                        <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–∏–º–≤–æ–ª–æ–≤...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>–í—ã–±–µ—Ä–∏—Ç–µ –≤–µ—Å–∞ –º–æ–¥–µ–ª–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, dqn_model_ton_ed10.pth)</label>
                    <select id="continueModelSelect" class="form-control" onchange="showSelectedContinueModelInfo()">
                        <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞...</option>
                    </select>
                </div>

                <div id="continueModelInfo" class="status info" style="display:none; white-space: pre-line;"></div>

                <div class="form-group">
                    <label>–≠–ø–∏–∑–æ–¥—ã –¥–æ–æ–±—É—á–µ–Ω–∏—è</label>
                    <input id="continueEpisodesInput" class="form-control" type="number" min="1" step="1" value="1000" oninput="updateEstimatedTime()">
                    <div id="episodesEstimate" class="status info" style="display:none; margin-top:6px;"></div>
                </div>
                <div class="form-group">
                    <label>Seed –¥–ª—è –¥–æ–æ–±—É—á–µ–Ω–∏—è (–µ—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî —Å–ª—É—á–∞–π–Ω—ã–π)</label>
                    <input id="continueSeedInput" class="form-control" type="number" min="1" step="1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 2024">
                </div>

                <div class="button-group">
                    <button class="btn btn-success" onclick="continueTraining()">üîÅ –ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–æ–æ–±—É—á–µ–Ω–∏–µ</button>
                </div>

                <div id="continueStatus"></div>
            </div>
                <div id="createStatus"></div>
            </div>

            
        </div>
    </div>

    <script>
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            loadResultFiles();
            loadContinueModels();
            loadRunsSymbols();
        });

        // –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é –º–æ–¥–µ–ª–∏
        async function createModelVersion() {
            const statusDiv = document.getElementById('createStatus');
            const button = event.target;
            const fileSelect = document.getElementById('resultFileSelect');
            const selectedFile = fileSelect ? fileSelect.value : '';
            const ensSelect = document.getElementById('resultEnsembleSelect');
            const selectedEns = ensSelect ? ensSelect.value : 'ensemble-a';
            
            if (!selectedFile) {
                statusDiv.innerHTML = '<div class="status error">‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å –∏–∑ result</div>';
                return;
            }
            
            button.disabled = true;
            button.textContent = '‚è≥ –°–æ–∑–¥–∞–Ω–∏–µ...';
            statusDiv.innerHTML = '<div class="status info">–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ –º–æ–¥–µ–ª–∏...</div>';
            
            try {
                const response = await fetch('/create_model_version', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ file: selectedFile, ensemble: selectedEns })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    statusDiv.innerHTML = `<div class="status success">
                        ‚úÖ –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è —Å–æ–∑–¥–∞–Ω–∞!<br>
                        ID: ${result.model_id}<br>
                        –§–∞–π–ª—ã: ${result.files.join(', ')}
                    </div>`;
                    // –°–µ–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π —É–¥–∞–ª–µ–Ω–∞
                } else {
                    statusDiv.innerHTML = `<div class="status error">
                        ‚ùå –û—à–∏–±–∫–∞: ${result.error}
                    </div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">
                    ‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}
                </div>`;
            } finally {
                button.disabled = false;
                button.textContent = 'üöÄ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é';
            }
        }

        // === Runs UI ===
        async function loadRunsSymbols(){
            const sel = document.getElementById('runsSymbolSelect');
            if(!sel) return;
            try{
                const resp = await fetch('/api/runs/symbols');
                const data = await resp.json();
                if(!data.success){ sel.innerHTML = '<option value="">–û—à–∏–±–∫–∞</option>'; return; }
                const list = Array.isArray(data.symbols)? data.symbols: [];
                if(list.length===0){ sel.innerHTML = '<option value="">–ù–µ—Ç —Å–∏–º–≤–æ–ª–æ–≤</option>'; return; }
                sel.innerHTML = list.map(s=>`<option value="${s}">${s}</option>`).join('');
                try{ loadRunsForSymbol(); }catch(_){ }
            }catch(e){ if(sel) sel.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>'; }
        }

        async function loadRunsForSymbol(){
            const sym = (document.getElementById('runsSymbolSelect')?.value||'').trim();
            if(!sym) return;
            try{
                const resp = await fetch('/api/runs/list?symbol='+encodeURIComponent(sym));
                const data = await resp.json();
                if(!data.success) return;
                // –ó–∞–ø–æ–ª–Ω—è–µ–º continueModelSelect —Ñ–∞–π–ª–∞–º–∏ model.pth –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
                const select = document.getElementById('continueModelSelect');
                if(!select) return;
                const runs = Array.isArray(data.runs)? data.runs: [];
                if(runs.length===0){ select.innerHTML = '<option value="">–ù–µ—Ç –∑–∞–ø—É—Å–∫–æ–≤</option>'; return; }
                // –æ—Ç–æ–±—Ä–∞–∑–∏–º –¥—Ä–µ–≤–æ–≤–∏–¥–Ω–æ: parent ‚Üí child (—É–ø—Ä–æ—Å—Ç–∏–º: –ø—Ä–µ—Ñ–∏–∫—Å ‚ñ∏)
                const idToChildren = {};
                const idToNode = {};
                runs.forEach(r=>{ idToChildren[r.run_id]=[]; idToNode[r.run_id]=r; });
                runs.forEach(r=>{ if(r.parent_run_id && idToChildren[r.parent_run_id]) idToChildren[r.parent_run_id].push(r.run_id); });
                function renderRun(runId, depth){
                    const r = idToNode[runId]; if(!r) return '';
                    const label = `${'‚ñ∏'.repeat(depth)} ${r.run_id}`;
                    const file = r.model_path || '';
                    const opt = `<option value="${file}">${label}</option>`;
                    const children = (idToChildren[runId]||[]).map(cid=>renderRun(cid, depth+1)).join('');
                    return opt+children;
                }
                // –∫–æ—Ä–Ω–∏: –±–µ–∑ parent
                const roots = runs.filter(r=>!r.parent_run_id).map(r=>r.run_id);
                const html = roots.map(rt=>renderRun(rt,0)).join('');
                select.innerHTML = html;
                try{ showSelectedContinueModelInfo(); }catch(_){ }
            }catch(e){ /* noop */ }
        }

        // –ì–ª–æ–±–∞–ª—å–Ω–æ —Ö—Ä–∞–Ω–∏–º —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –∑–∞ —ç–ø–∏–∑–æ–¥ (—Å–µ–∫)
        let avgTimePerEpisodeSec = null;

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ–±—É—á–µ–Ω–∏—è –∏–∑ result/
        async function loadResultFiles() {
            const select = document.getElementById('resultFileSelect');
            if (!select) return;
            
            try {
                const resp = await fetch('/list_training_results');
                const data = await resp.json();
                
                if (!data.success) {
                    select.innerHTML = '<option value="">–§–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</option>';
                    return;
                }
                
                if (!data.files || data.files.length === 0) {
                    select.innerHTML = '<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤</option>';
                    return;
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ train_result_btc_*
                const onlyBtc = (data.files || []).filter(f => {
                    const fn = (f.filename || '').toLowerCase();
                    return fn.includes('train_result_btc_');
                });
                if (onlyBtc.length === 0) {
                    select.innerHTML = '<option value="">–ù–µ—Ç —Ñ–∞–π–ª–æ–≤ train_result_btc_*</option>';
                    return;
                }
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ–ø—Ü–∏–∏: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∏–º—è —Ñ–∞–π–ª–∞ –±–µ–∑ –ø—É—Ç–∏
                select.innerHTML = onlyBtc.map(f => {
                    const filename = (f.filename || '').split('/').pop().split('\\').pop();
                    return `<option value="${f.filename}">${filename}</option>`;
                }).join('');
            } catch (e) {
                select.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞</option>';
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –≤–µ—Å–æ–≤ –¥–ª—è –¥–æ–æ–±—É—á–µ–Ω–∏—è (–≤—Å–µ dqn_model_*.pth)
        async function loadContinueModels() {
            const select = document.getElementById('continueModelSelect');
            if (!select) return;
            try {
                const resp = await fetch('/list_result_models');
                const data = await resp.json();
                if (!data.success || !data.files || data.files.length === 0) {
                    select.innerHTML = '<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤</option>';
                    return;
                }
                // –í—Å–µ dqn_model_* (–±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ —Å–∏–º–≤–æ–ª—É)
                const opts = data.files.map(f => {
                    const filename = (f.filename || '').split('/').pop().split('\\').pop();
                    return `<option value="${f.filename}">${filename}</option>`;
                }).join('');
                select.innerHTML = opts;
                // –ê–≤—Ç–æ-–ø–æ–∫–∞–∑ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
                try { showSelectedContinueModelInfo(); } catch(e){}
            } catch (e) {
                select.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞</option>';
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∫—Ä–∞—Ç–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –≤–µ—Å–∞—Ö –¥–ª—è –¥–æ–æ–±—É—á–µ–Ω–∏—è
        async function showSelectedContinueModelInfo() {
            const select = document.getElementById('continueModelSelect');
            const infoDiv = document.getElementById('continueModelInfo');
            if (!select || !infoDiv) return;
            const filename = select.value;
            if (!filename) { infoDiv.style.display = 'none'; return; }
            try {
                const resp = await fetch('/get_result_model_info', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename })
                });
                const result = await resp.json();
                if (!result.success) {
                    infoDiv.className = 'status error';
                    infoDiv.textContent = '‚ùå ' + (result.error || '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏');
                    infoDiv.style.display = 'block';
                    return;
                }
                const stats = result.stats || {};
                const winrate = typeof stats.winrate === 'number' ? (stats.winrate * 100).toFixed(1) + '%' : 'N/A';
                const plr = typeof stats.pl_ratio === 'number' ? stats.pl_ratio.toFixed(2) : 'N/A';
                const trades = (stats.trades_count != null) ? stats.trades_count : 'N/A';
                const episodes = (result.episodes != null) ? result.episodes : 'N/A';
                const seed = (result.seed != null) ? result.seed : null;
                const gpu = (result.cuda_available===true) ? (result.gpu_name || 'GPU') : 'CPU';
                const totalTime = (typeof result.total_training_time === 'number') ? result.total_training_time : null;
                const avgTime = (typeof result.avg_time_per_episode_sec === 'number') ? result.avg_time_per_episode_sec : (totalTime && episodes ? (totalTime/episodes) : null);
                const fmtSec = (s)=>{
                    if(!s && s!==0) return 'N/A';
                    try{ const m=Math.floor(s/60), r=Math.round(s%60); return (m>0?`${m}–º `:'')+`${r}—Å`; }catch(_){ return s.toFixed? s.toFixed(1)+'—Å' : String(s); }
                };
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –æ–Ω–ª–∞–π–Ω-–æ—Ü–µ–Ω–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏ –≤–≤–æ–¥–µ
                try { avgTimePerEpisodeSec = (typeof avgTime === 'number' && avgTime > 0) ? avgTime : null; } catch(_) { avgTimePerEpisodeSec = null; }
                // –ö–æ–¥ –º–æ–∂–µ—Ç –≤–∫–ª—é—á–∞—Ç—å —Å–∏–º–≤–æ–ª, –ø–æ–ø—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å
                const code = (result.code || '').toUpperCase();
                const symbolOut = (result.symbol || '').toUpperCase();
                let symbolGuess = '';
                if (code) {
                    // –ß–∞—Å—Ç–æ –∫–æ–¥ –≤–∏–¥–∞ btc_xxxx -> –¥–æ–±–∞–≤–∏–º USDT
                    const base = code.split('_')[0];
                    if (base && base.length <= 6) symbolGuess = base + 'USDT';
                }
                infoDiv.className = 'status info';
                infoDiv.innerHTML = `
–í—ã–±—Ä–∞–Ω–æ: ${filename.split('/').pop().split('\\').pop()}
–ö–æ–¥/—Å–∏–º–≤–æ–ª: ${code || 'N/A'} / ${symbolOut || symbolGuess || 'N/A'}
Seed: ${seed !== null ? seed : '‚Äî'}
–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${gpu}
Winrate: ${winrate}
P/L Ratio: ${plr}
–°–¥–µ–ª–æ–∫: ${trades}
–≠–ø–∏–∑–æ–¥–æ–≤: ${episodes}
–ë—É—Ñ–µ—Ä: ${result.replay_exists ? '‚úÖ –µ—Å—Ç—å' : '‚ùå –Ω–µ—Ç'}
–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—É—á–µ–Ω–∏—è: ${result.train_result_exists ? '‚úÖ –µ—Å—Ç—å' : '‚ùå –Ω–µ—Ç'}
–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –∑–∞ —ç–ø–∏–∑–æ–¥: ${fmtSec(avgTime)}
–û–±—â–µ–µ –≤—Ä–µ–º—è –æ–±—É—á–µ–Ω–∏—è: ${totalTime ? fmtSec(totalTime) : 'N/A'}
`;
                infoDiv.style.display = 'block';
                // –û–±–Ω–æ–≤–∏–º –ø–æ–¥—Å–∫–∞–∑–∫—É –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏
                try { updateEstimatedTime(); } catch(_) {}
            } catch (e) {
                infoDiv.className = 'status error';
                infoDiv.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + e.message;
                infoDiv.style.display = 'block';
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ü–µ–Ω–∫–∏ –æ–±—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏ –≤–≤–æ–¥–µ —ç–ø–∏–∑–æ–¥–æ–≤
        function updateEstimatedTime(){
            const estDiv = document.getElementById('episodesEstimate');
            const inp = document.getElementById('continueEpisodesInput');
            if(!estDiv || !inp){ return; }
            const n = Math.max(1, parseInt(inp.value || '0', 10) || 0);
            if (avgTimePerEpisodeSec && n > 0){
                const totalSec = n * avgTimePerEpisodeSec;
                const hours = Math.floor(totalSec/3600);
                const minutes = Math.round((totalSec%3600)/60);
                const human = (hours>0? `${hours} —á `: '') + `${minutes} –º–∏–Ω`;
                // –û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è
                try {
                    const finish = new Date(Date.now() + totalSec*1000);
                    const hh = String(finish.getHours()).padStart(2,'0');
                    const mm = String(finish.getMinutes()).padStart(2,'0');
                    estDiv.textContent = `‚âà ${human} (–æ–∫–æ–Ω—á–∞–Ω–∏–µ –≤ ${hh}:${mm})`;
                } catch(_) {
                    estDiv.textContent = `‚âà ${human}`;
                }
                estDiv.style.display = 'block';
            } else {
                estDiv.textContent = '–í—Ä–µ–º—è –±—É–¥–µ—Ç —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–æ –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏ —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π';
                estDiv.style.display = 'block';
            }
        }

        // –ó–∞–ø—É—Å–∫ –¥–æ–æ–±—É—á–µ–Ω–∏—è
        async function continueTraining() {
            const statusDiv = document.getElementById('continueStatus');
            const fileSelect = document.getElementById('continueModelSelect');
            const episodes = document.getElementById('continueEpisodesInput').value;
            const seedVal = (document.getElementById('continueSeedInput')?.value || '').trim();
            const selectedFile = fileSelect ? fileSelect.value : '';

            if (!selectedFile) {
                statusDiv.innerHTML = '<div class="status error">‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≤–µ—Å–∞ dqn_model_*.pth</div>';
                return;
            }

            statusDiv.innerHTML = '<div class="status info">‚è≥ –ó–∞–ø—É—Å–∫ –¥–æ–æ–±—É—á–µ–Ω–∏—è...</div>';
            try {
                const resp = await fetch('/continue_training', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: selectedFile, episodes, seed: seedVal })
                });
                const result = await resp.json();
                if (result.success) {
                    statusDiv.innerHTML = `<div class=\"status success\">‚úÖ –î–æ–æ–±—É—á–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ (task: ${result.task_id}). –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—è–≤–∏—Ç—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ –º–æ–¥–µ–ª–µ–π.</div>`;
                } else {
                    statusDiv.innerHTML = `<div class=\"status error\">‚ùå –û—à–∏–±–∫–∞: ${result.error}</div>`;
                }
            } catch (e) {
                statusDiv.innerHTML = `<div class=\"status error\">‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${e.message}</div>`;
            }
        }

        // –ó–∞–ø—É—Å–∫ –æ–±—É—á–µ–Ω–∏—è —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —ç–ø–∏–∑–æ–¥–æ–≤
        async function startTrainingForSymbol(symbol) {
            const episodes = document.getElementById('episodesInput').value || 1000;
            const seedVal = (document.getElementById('trainSeedInput')?.value || '').trim();
            const statusDiv = document.getElementById('trainStatus');
            statusDiv.innerHTML = '<div class="status info">‚è≥ –ó–∞–ø—É—Å–∫ –æ–±—É—á–µ–Ω–∏—è ' + symbol + '...</div>';
            try {
                const resp = await fetch('/train_dqn_symbol', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify({ symbol, episodes, seed: seedVal })
                });
                const data = await resp.json().catch(() => null);
                if (data && data.success) {
                    statusDiv.innerHTML = '<div class="status success">‚úÖ –û–±—É—á–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ (task: ' + data.task_id + ')</div>';
                } else if (data && data.error) {
                    statusDiv.innerHTML = '<div class="status error">‚ùå ' + data.error + '</div>';
                } else if (resp.redirected) {
                    // –§–æ–ª–ª–±–µ–∫ –Ω–∞ —Å–ª—É—á–∞–π —Å—Ç–∞—Ä–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è
                    window.location.href = resp.url;
                } else {
                    statusDiv.innerHTML = '<div class="status error">‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞</div>';
                }
            } catch (e) {
                statusDiv.innerHTML = '<div class="status error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –æ–±—É—á–µ–Ω–∏—è: ' + e.message + '</div>';
            }
        }

        async function startTrainingMulti() {
            const statusDiv = document.getElementById('trainStatus');
            if (statusDiv) statusDiv.innerHTML = '<div class="status info">‚è≥ –ó–∞–ø—É—Å–∫ –º—É–ª—å—Ç–∏–≤–∞–ª—é—Ç–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è...</div>';
            try {
                const resp = await fetch('/train_dqn_multi_crypto', {
                    method: 'POST',
                    headers: { 'Accept': 'application/json' }
                });
                const data = await resp.json().catch(() => null);
                if (data && data.success) {
                    if (statusDiv) statusDiv.innerHTML = '<div class="status success">‚úÖ –û–±—É—á–µ–Ω–∏–µ (multi) –∑–∞–ø—É—â–µ–Ω–æ (task: ' + data.task_id + ')</div>';
                } else if (data && data.error) {
                    if (statusDiv) statusDiv.innerHTML = '<div class="status error">‚ùå ' + data.error + '</div>';
                } else if (resp.redirected) {
                    if (statusDiv) statusDiv.innerHTML = '<div class="status info">‚ÑπÔ∏è –û–±—É—á–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ, –æ—Å—Ç–∞–≤–∞–π—Ç–µ—Å—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ.</div>';
                } else {
                    if (statusDiv) statusDiv.innerHTML = '<div class="status error">‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞</div>';
                }
            } catch (e) {
                if (statusDiv) statusDiv.innerHTML = '<div class="status error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –º—É–ª—å—Ç–∏–≤–∞–ª—é—Ç–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è: ' + e.message + '</div>';
            }
        }

        // –°–µ–∫—Ü–∏—è "–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏" —É–¥–∞–ª–µ–Ω–∞

        // === –ë–ª–æ–∫: —É–¥–∞–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π –∏–∑ –ø–∞–ø–∫–∏ result ===
        function ensureResultModelsSection() {
            if (document.getElementById('resultModelsSection')) return;
            const content = document.querySelector('.content');
            if (!content) return;
            const sectionHtml = `
                <div class="section" id="resultModelsSection">
                    <h2>üóëÔ∏è –ú–æ–¥–µ–ª–∏ –≤ result (—É–¥–∞–ª–µ–Ω–∏–µ)</h2>
                    <p>–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫–µ <code>result/</code> —Å –∫—Ä–∞—Ç–∫–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π. –ú–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –∫–æ–º–ø–ª–µ–∫—Ç (–≤–µ—Å–∞, –±—É—Ñ–µ—Ä, —Ä–µ–∑—É–ª—å—Ç–∞—Ç) –ø–æ –∫–æ–¥—É –º–æ–¥–µ–ª–∏.</p>
                    <div class="button-group">
                        <button class="btn btn-info" onclick="refreshResultModels()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
                    </div>
                    <div id="resultModelsList">
                        <div class="loading"><div class="spinner"></div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    </div>
                </div>
            `;
            content.insertAdjacentHTML('beforeend', sectionHtml);
        }

        async function refreshResultModels() {
            ensureResultModelsSection();
            const listDiv = document.getElementById('resultModelsList');
            if (!listDiv) return;
            listDiv.innerHTML = '<div class="loading"><div class="spinner"></div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            try {
                // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—É runs: —Å–æ–±–∏—Ä–∞–µ–º —Ç–∞–±–ª–∏—á–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø–æ –≤—Å–µ–º —Å–∏–º–≤–æ–ª–∞–º
                const symResp = await fetch('/api/runs/symbols');
                const symData = await symResp.json();
                if(!symData.success){ listDiv.innerHTML = '<div class="status error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∏–º–≤–æ–ª–æ–≤</div>'; return; }
                const symbols = Array.isArray(symData.symbols)? symData.symbols: [];
                if(symbols.length===0){ listDiv.innerHTML = '<div class="status info">üì≠ –ü–∞–ø–∫–∞ result –ø—É—Å—Ç–∞</div>'; return; }

                const rows = [];
                for(const s of symbols){
                    try{
                        const r = await fetch('/api/runs/list?symbol='+encodeURIComponent(s));
                        const d = await r.json();
                        const runs = Array.isArray(d.runs)? d.runs: [];
                        // –ü–æ—Å—Ç—Ä–æ–∏–º –¥–µ—Ä–µ–≤–æ parent->children
                        const idToNode = {}; const idToChildren = {};
                        runs.forEach(x=>{ idToNode[x.run_id]=x; idToChildren[x.run_id]=[]; });
                        runs.forEach(x=>{ if(x.parent_run_id && idToChildren[x.parent_run_id]) idToChildren[x.parent_run_id].push(x.run_id); });
                        const roots = runs.filter(x=>!x.parent_run_id).map(x=>x.run_id);

                        async function renderRunRow(runId, depth){
                            const run = idToNode[runId]; if(!run) return;
                            let win = 'N/A', episodes = 'N/A';
                            try{
                                if(run.model_path){
                                    const infoResp = await fetch('/get_result_model_info', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ filename: run.model_path })});
                                    const info = await infoResp.json();
                                    if(info && info.success){
                                        const st = info.stats||{};
                                        if(typeof st.winrate==='number') win = (st.winrate*100).toFixed(1)+'%';
                                        if(info.episodes!=null) episodes = info.episodes;
                                    }
                                }
                            }catch(_){ }
                            const indent = `<span style=\"display:inline-block; width:${depth*16}px;\"></span>`;
                            const label = `${depth>0?'‚ñ∏ ':''}${run.run_id}`;
                            const parent = run.parent_run_id || '‚Äî';
                            const oosBtn = run.model_path ? `<button class="btn btn-info" style="margin-right:6px;" onclick="runOOSTest('${run.run_id}','${run.model_path}')">Test</button>` : '';
                            const delBtn = `<button class="btn btn-danger" onclick="deleteRun('${s}','${run.run_id}')\">‚úñ</button>`;
                            rows.push(`
                                <tr>
                                    <td class="nowrap mono">${s}</td>
                                    <td class="nowrap mono">${indent}${label}</td>
                                    <td class="nowrap mono">${parent}</td>
                                    <td class="nowrap">${win}</td>
                                    <td class="nowrap">${episodes}</td>
                                    <td class="nowrap" style="text-align:right;">${oosBtn}${delBtn}</td>
                                </tr>
                            `);
                            const children = idToChildren[runId]||[];
                            for(const cid of children){ await renderRunRow(cid, depth+1); }
                        }
                        for(const rootId of roots){ await renderRunRow(rootId, 0); }
                    }catch(e){ /* skip sym */ }
                }
                const header = `
                    <thead>
                        <tr>
                            <th class="nowrap">–°–∏–º–≤–æ–ª</th>
                            <th class="nowrap">–ú–æ–¥–µ–ª—å</th>
                            <th class="nowrap">–†–æ–¥–∏—Ç–µ–ª—å</th>
                            <th class="nowrap">Winrate</th>
                            <th class="nowrap">–≠–ø–∏–∑–æ–¥—ã</th>
                            <th class="nowrap" style="width:160px; text-align:right;">–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>`;
                listDiv.innerHTML = rows.length>0 ? `<table id="resultModelsTable">${header}<tbody>${rows.join('')}</tbody></table>` : '<div class="status info">üì≠ –ü—É—Å—Ç–æ</div>';
            } catch (e) {
                listDiv.innerHTML = `<div class="status error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${e.message}</div>`;
            }
        }

        function renderResultModelRow(info) {
            if (info && info.error) {
                const fname = (info.model_file || '').split('/').pop().split('\\').pop();
                return `<tr><td colspan="7"><div class="status error">${fname ? fname + ': ' : ''}${info.error}</div></td></tr>`;
            }
            const stats = info.stats || {};
            const win = (typeof stats.winrate === 'number') ? `${(stats.winrate * 100).toFixed(1)}%` : 'N/A';
            const episodes = (info.episodes != null) ? info.episodes : 'N/A';
            const modelFile = (info.model_file || '').split('/').pop().split('\\').pop();
            const code = (info.code || (modelFile || '').replace(/^dqn_model_|\.pth$/g, '')) || '';
            const replay = info.replay_file ? info.replay_file.split('/').pop().split('\\').pop() : '‚Äî';
            const results = info.train_result_file ? info.train_result_file.split('/').pop().split('\\').pop() : '‚Äî';
            const replayMark = info.replay_exists ? '‚úÖ' : '‚Äî';
            const resultsMark = info.train_result_exists ? '‚úÖ' : '‚Äî';
            return `
                <tr>
                    <td class="nowrap mono">${code || '‚Äî'}</td>
                    <td class="mono"><span class="truncate" title="${modelFile}">${modelFile || '‚Äî'}</span></td>
                    <td class="nowrap">${replayMark}</td>
                    <td class="nowrap">${resultsMark}</td>
                    <td class="nowrap">${win}</td>
                    <td class="nowrap">${episodes}</td>
                    <td class="nowrap" style="text-align:right;">
                        <button class="btn btn-info" style="margin-right:6px;" title="OOS‚Äë—Ç–µ—Å—Ç 30 –¥–Ω–µ–π"
                            onclick="runOOSTest('${code}', '${info.model_file || ''}')">Test</button>
                        <button class="btn btn-danger" title="–£–¥–∞–ª–∏—Ç—å"
                            onclick="deleteResultModel('${code}', '${info.model_file || ''}')">‚úñ</button>
                    </td>
                </tr>
            `;
        }

        async function deleteResultModel(code, filename) {
            const name = code || (filename.split('/').pop().split('\\').pop());
            if (!confirm(`üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∫–æ–º–ø–ª–µ–∫—Ç —Ñ–∞–π–ª–æ–≤ –¥–ª—è –º–æ–¥–µ–ª–∏ ${name}?`)) return;
            try {
                const resp = await fetch('/delete_result_model', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, filename })
                });
                const data = await resp.json();
                if (data.success) {
                    alert('‚úÖ –£–¥–∞–ª–µ–Ω–æ: ' + (data.deleted || []).map(x=>x.split('/').pop()).join(', '));
                    refreshResultModels();
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (e) {
                alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + e.message);
            }
        }

        async function deleteRun(symbol, runId){
            if(!confirm(`–£–¥–∞–ª–∏—Ç—å run ${runId} –¥–ª—è ${symbol}?`)) return;
            try{
                const resp = await fetch('/api/runs/delete', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({symbol, run_id: runId})});
                const data = await resp.json();
                if(data.success){ refreshResultModels(); }
                else{ alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: '+(data.error||'Unknown')); }
            }catch(e){ alert('–°–µ—Ç—å: '+e.message); }
        }

        // –ó–∞–ø—É—Å–∫ OOS‚Äë—Ç–µ—Å—Ç–∞ –Ω–∞ 30 –¥–Ω–µ–π
        async function runOOSTest(code, filename){
            const file = filename || '';
            const name = code || (file.split('/').pop().split('\\').pop());
            try{
                const btn = event.target; const prev = btn.textContent; btn.disabled=true; btn.textContent='‚è≥ OOS...';
                console.log('[OOS] start', {code, file, ts: Date.now()});
                // –°—á–∏—Ç—ã–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ –º–æ–¥–∞–ª–∫–∏ (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–ª –µ—ë)
                const gateDisable = !!document.getElementById('oosGateDisable')?.checked;
                const multiRuns = !!document.getElementById('oosMultiRuns')?.checked;
                let gateScale = document.getElementById('oosGateScale')?.value;
                gateScale = gateScale===''? null : Number(gateScale);
                let startCapital = document.getElementById('oosStartCapital')?.value;
                startCapital = startCapital===''? null : Number(startCapital);
                const payloadBase = { filename:file, code:code, gate_disable: gateDisable, gate_scale: gateScale, start_capital: startCapital };
                // –ú—É–ª—å—Ç–∏‚Äë–æ–∫–Ω–∞: 30/60/90
                const windows = [30,60,90];
                const scales = multiRuns ? [0, 0.2, 0.6, 0.8] : [null];
                const allResults = [];
                for(const days of windows){
                    for(const s of scales){
                        const payload = {...payloadBase, days};
                        if (s !== null){ payload.gate_disable = false; payload.gate_scale = s; }
                        const r = await fetch('/oos_test_model', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
                        const j = await r.json().catch(()=>({success:false,error:'bad json'}));
                        allResults.push({days, scale:s, data:j});
                    }
                }
                btn.disabled=false; btn.textContent=prev;
                // –í—ã–≤–æ–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –ø–∞–Ω–µ–ª—å (–∫–æ–ø–∏—Ä—É–µ–º—ã–π —Ç–µ–∫—Å—Ç)
                ensureOOSPanel();
                const wrap = document.getElementById('oosResults');
                const first = (allResults[0]||{}).data || {success:false};
                if(!first.success){
                    const err = '‚ùå OOS: '+(first.error||'–æ—à–∏–±–∫–∞');
                    if (wrap){
                        const el = document.createElement('div'); el.className = 'status error'; el.textContent = err; wrap.prepend(el);
                    } else { alert(err); }
                    return;
                }
                function renderCard(title, res){
                    const r = (res||{}).result || {};
                    const details = Array.isArray(r.trades_details)? r.trades_details: [];
                    const roiPct = (r && r.start_capital && typeof r.pnl_total === 'number') ? ((r.pnl_total / r.start_capital) * 100.0) : null;
                    // –û—Ü–µ–Ω–∫–∞ –º–µ—Ç—Ä–∏–∫
                    const isGood = (roiPct!=null && roiPct>10) && (r.profit_factor!=null && r.profit_factor>=1.2) && (r.pl_ratio!=null && r.pl_ratio>1.0) && (r.max_dd!=null && r.max_dd<0.40);
                    const isBad  = (roiPct!=null && roiPct<=0) || (r.profit_factor!=null && r.profit_factor<1.0) || (r.pl_ratio!=null && r.pl_ratio<1.0) || (r.max_dd!=null && r.max_dd>0.70);
                    const candidateBadge = isGood ? '<span class="badge" style="background:#10b981;color:#fff;border-radius:4px;padding:2px 6px;">–ö–∞–Ω–¥–∏–¥–∞—Ç –Ω–∞ –¥–æ–æ–±—É—á–µ–Ω–∏–µ</span>' : '';
                    const lines = [title + (candidateBadge? ' ' + candidateBadge : ''),
                        `Winrate: ${r.winrate!=null?(r.winrate*100).toFixed(1)+'%':'N/A'}`,
                        `PLR: ${r.pl_ratio!=null?r.pl_ratio.toFixed(2):'N/A'}`,
                        `PF: ${r.profit_factor!=null?r.profit_factor.toFixed(2):'N/A'}`,
                        `MaxDD: ${r.max_dd!=null?(r.max_dd*100).toFixed(1)+'%':'N/A'}`,
                        `PnL: ${roiPct!=null?roiPct.toFixed(2)+'%':'N/A'}`,
                        `Trades: ${r.trades!=null?r.trades:'N/A'}`,
                        r.symbol? `Symbol: ${r.symbol}`: '',
                        r.days!=null? `Window: ${r.days}d`: ''
                    ].filter(Boolean);
                    const text = lines.join('\n');
                    const item = document.createElement('div'); item.className = 'card';
                    if(isGood){ item.style.border = '1px solid #10b981'; item.style.boxShadow = '0 0 0 2px rgba(16,185,129,0.12)'; }
                    else if(isBad){ item.style.border = '1px solid #ef4444'; item.style.boxShadow = '0 0 0 2px rgba(239,68,68,0.12)'; }
                    const ts = new Date(); const hh = String(ts.getHours()).padStart(2,'0'); const mm = String(ts.getMinutes()).padStart(2,'0');
                    const detailsId = 'oosd_'+Math.random().toString(36).slice(2);
                    item.innerHTML = `
                        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;"><div class="mono" style="font-weight:600;">${name}</div><div class="muted">${hh}:${mm}</div></div>
                        <pre style="white-space:pre-wrap;margin:6px 0;">${text}</pre>
                        <details id="${detailsId}"><summary>–°–¥–µ–ª–∫–∏ (${details.length})</summary>
                            <pre style="white-space:pre-wrap;margin:6px 0;max-height:240px;overflow:auto;">${details.map((t,idx)=>{
                                const e=t.entry_ts||''; const x=t.exit_ts||''; const ep=(t.entry_price!=null)? Number(t.entry_price).toFixed(2):'N/A'; const xp=(t.exit_price!=null)? Number(t.exit_price).toFixed(2):'N/A'; const pnl=(t.pnl!=null)? Number(t.pnl).toFixed(2):'N/A'; return `${idx+1}) ${e} @ ${ep} ‚Üí ${x} @ ${xp} | PnL ${pnl}`;}).join('\n')}</pre>
                        </details>
                        <div style="text-align:right;display:flex;gap:8px;justify-content:flex-end;"><button class="btn" data-text="${text.replace(/&/g,'&amp;').replace(/\"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}" onclick="copyText(this.getAttribute('data-text'))">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button></div>`;
                    return item;
                }
                // –†–µ–Ω–¥–µ—Ä–∏–º –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏: —Å–ø–µ—Ä–≤–∞ 30–¥, –ø–æ—Ç–æ–º 60, –ø–æ—Ç–æ–º 90
                // —Å–≥—Ä—É–ø–ø–∏—Ä—É–µ–º
                const groups = {30:[],60:[],90:[]};
                for(const r of allResults){ if(r.data&&r.data.success) groups[r.days].push(r); }
                // 30d
                const showOnlyCandidates = !!document.getElementById('oosShowOnlyCandidates')?.checked;
                for(const g of groups[30]){
                    const pct = (g.scale===null)? '100%' : ((1-g.scale)*100).toFixed(0)+'%';
                    const card = renderCard(`‚úÖ 30d (${pct})`, g.data);
                    if(showOnlyCandidates){ if(card && card.style && card.style.border && card.style.border.includes('#10b981')) wrap.prepend(card); }
                    else{ wrap.prepend(card); }
                }
                // 60d
                for(const g of groups[60]){
                    const pct = (g.scale===null)? '100%' : ((1-g.scale)*100).toFixed(0)+'%';
                    const card = renderCard(`‚úÖ 60d (${pct})`, g.data);
                    if(showOnlyCandidates){ if(card && card.style && card.style.border && card.style.border.includes('#10b981')) wrap.prepend(card); }
                    else{ wrap.prepend(card); }
                }
                // 90d
                for(const g of groups[90]){
                    const pct = (g.scale===null)? '100%' : ((1-g.scale)*100).toFixed(0)+'%';
                    const card = renderCard(`‚úÖ 90d (${pct})`, g.data);
                    if(showOnlyCandidates){ if(card && card.style && card.style.border && card.style.border.includes('#10b981')) wrap.prepend(card); }
                    else{ wrap.prepend(card); }
                }
            }catch(e){ console.error('[OOS] error', e); alert('‚ùå OOS —Å–µ—Ç—å: '+e.message); }
        }

        function ensureOOSPanel(){
            if (document.getElementById('oosPanel')) return;
            const content = document.querySelector('.content'); if(!content) return;
            const html = `
                <div class="section" id="oosPanel">
                    <h2>üìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã OOS (–∫–æ–ø–∏—Ä—É–µ–º—ã–µ)</h2>
                    <div style="margin-bottom:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
                        <button class="btn btn-info" onclick="openOOSModal()">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ OOS</button>
                        <label class="muted" style="display:flex;gap:6px;align-items:center;">
                            <input type="checkbox" id="oosShowOnlyCandidates"> –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –Ω–∞ –¥–æ–æ–±—É—á–µ–Ω–∏–µ
                        </label>
                        <div class="muted" style="font-size:12px;">
                            –ü–æ—Ä–æ–≥–∏: ROI>10%, PF‚â•1.2, PLR>1.0, MaxDD<40%
                        </div>
                    </div>
                    <div id="oosResults"></div>
                </div>
            `;
            content.insertAdjacentHTML('beforeend', html);
        }

        async function copyText(t){
            try{ await navigator.clipboard.writeText(String(t||'')); }
            catch(_){ try{ prompt('–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é:', String(t||'')); }catch(__){} }
        }

        // –ü—Ä–æ—Å—Ç–µ–π—à–∞—è –º–æ–¥–∞–ª–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ OOS
        function openOOSModal(){
            if(document.getElementById('oosModal')){ document.getElementById('oosModal').style.display='block'; return; }
            const html = `
                <div id="oosModal" style="position:fixed;inset:0;display:block;background:rgba(0,0,0,0.4);z-index:9999;">
                    <div style="background:#fff;max-width:460px;margin:10% auto;padding:16px;border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,.2);">
                        <h3 style="margin-top:0;">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ OOS</h3>
                        <div class="form-group">
                            <label><input type="checkbox" id="oosGateDisable"> –û—Ç–∫–ª—é—á–∏—Ç—å Q‚Äëgate (T1/T2=0)</label>
                        </div>
                        <div class="form-group">
                            <label>–°–Ω–∏–∑–∏—Ç—å –ø–æ—Ä–æ–≥–∏ Q‚Äëgate –Ω–∞ –¥–æ–ª—é (0..1)</label>
                            <input type="number" id="oosGateScale" class="form-control" step="0.05" min="0" max="1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 0.5">
                            <div class="muted">0.5 = –ø–æ—Ä–æ–≥–∏ –≤–¥–≤–æ–µ –Ω–∏–∂–µ; –ø—É—Å—Ç–æ = –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π</div>
                        </div>
                        <div class="form-group">
                            <label>–°—Ç–∞—Ä—Ç–æ–≤—ã–π –∫–∞–ø–∏—Ç–∞–ª (–¥–ª—è MaxDD)</label>
                            <input type="number" id="oosStartCapital" class="form-control" step="100" min="0" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 10000">
                            <div class="muted">–≠–∫–≤–∏—Ç–∏ = —Å—Ç–∞—Ä—Ç + PnL; MaxDD —Å—á–∏—Ç–∞–µ—Ç—Å—è –æ—Ç —ç–∫–≤–∏—Ç–∏</div>
                        </div>
                        <div class="form-group">
                            <label><input type="checkbox" id="oosMultiRuns"> –í—ã–ø–æ–ª–Ω–∏—Ç—å 4 –ø—Ä–æ–≥–æ–Ω–∞: 100% / 80% / 40% / 20% –ø–æ—Ä–æ–≥–æ–≤</label>
                        </div>
                        <div style="text-align:right;display:flex;gap:8px;justify-content:flex-end;">
                            <button class="btn" onclick="document.getElementById('oosModal').style.display='none'">–ó–∞–∫—Ä—ã—Ç—å</button>
                            <button class="btn btn-info" onclick="document.getElementById('oosModal').style.display='none'">OK</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }

        // –í—Å—Ç–∞–≤–ª—è–µ–º —Å–µ–∫—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏ —Å—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
        document.addEventListener('DOMContentLoaded', function() {
            try { ensureResultModelsSection(); refreshResultModels(); } catch(_){}
            try { ensureOOSPanel(); } catch(_){}
        });

        // –ö–∞—Ä—Ç–æ—á–∫–∏/–∞–Ω–∞–ª–∏–∑/—É–¥–∞–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π –æ—Ç–∫–ª—é—á–µ–Ω—ã

        // –ê–Ω–∞–ª–∏–∑ –º–æ–¥–µ–ª–∏ –æ—Ç–∫–ª—é—á—ë–Ω

        // –£–¥–∞–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ –æ—Ç–∫–ª—é—á–µ–Ω–æ
    </script>
</body>
</html>
