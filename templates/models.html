<!DOCTYPE html>
<html lang="ru">
<head>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="/static/css/sidebar.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>!–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª—è–º–∏ DQN</title>
</head>
<body>
    {% include 'include/_sidebar.html' %}

    <!-- –ö–Ω–æ–ø–∫–∞ –º–æ–±–∏–ª—å–Ω–æ–≥–æ –º–µ–Ω—é -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>

    <div class="container">
        <div class="main-content">
            <div class="header">
                <h1>ü§ñ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª—è–º–∏ DQN</h1>
                <p>–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—É—á–µ–Ω–Ω—ã–º–∏ –º–æ–¥–µ–ª—è–º–∏</p>
            </div>
            
            <div class="content">
            <a href="/" class="back-link">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>
            
            <!-- –°–µ–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π –º–æ–¥–µ–ª–∏ -->
            <div class="section" id="create-model">
                <h2>üì¶ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é –º–æ–¥–µ–ª–∏</h2>
                <p>–°–∫–æ–ø–∏—Ä—É–µ—Ç –≤–µ—Å–∞/–±—É—Ñ–µ—Ä/—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–∑ <code>result/</code> –≤ <code>models/&lt;symbol&gt;/ensemble-a/vN</code> (—Å <code>manifest.yaml</code> –∏ —Å—Å—ã–ª–∫–æ–π <code>current</code>)</p>
                <div class="form-group">
                    <label>–°–∏–º–≤–æ–ª</label>
                    <select id="resultSymbolSelect" class="form-control" onchange="loadResultFilesForCreate()">
                        <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–∏–º–≤–æ–ª–æ–≤...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å –∏–∑ –ø–∞–ø–∫–∏ result</label>
                    <select id="resultFileSelect" class="form-control">
                        <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å–∏–º–≤–æ–ª...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–ê–Ω—Å–∞–º–±–ª—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è</label>
                    <select id="resultEnsembleSelect" class="form-control">
                        <option value="ensemble-a" selected>ensemble-a</option>
                        <option value="ensemble-b">ensemble-b</option>
                        <option value="ensemble-c">ensemble-c</option>
                    </select>
                </div>
                <div class="button-group">
                    <button id="createModelBtn" class="btn btn-success" onclick="createModelVersion(this)">üöÄ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é</button>
                </div>
            </div>

            <!-- –°–µ–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –æ–±—É—á–µ–Ω–∏—è DQN -->
            <div class="section" id="training">
                <h2>üéØ –û–±—É—á–µ–Ω–∏–µ DQN –º–æ–¥–µ–ª–∏</h2>
                <p>–ó–∞–ø—É—Å—Ç–∏—Ç–µ –æ–±—É—á–µ–Ω–∏–µ Deep Q-Network –º–æ–¥–µ–ª–∏ –¥–ª—è —Ç–æ—Ä–≥–æ–≤–ª–∏ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞–º–∏</p>
                <div class="form-group">
                    <label>–°–∏–º–≤–æ–ª –¥–ª—è –æ–±—É—á–µ–Ω–∏—è</label>
                    <select id="trainSymbolSelect" class="form-control">
                        <option value="BTCUSDT">BTC</option>
                        <option value="TONUSDT">TON</option>
                        <option value="ETHUSDT">ETH</option>
                        <option value="SOLUSDT">SOL</option>
                        <option value="ADAUSDT">ADA</option>
                        <option value="BNBUSDT">BNB</option>
                        <option value="XMRUSDT">XMR</option>
                        <option value="XRPUSDT">XRP</option>
                    </select>
                </div>
                <div class="form-group" id="encoderGroup" style="display:none;">
                    <label>–≠–Ω–∫–æ–¥–µ—Ä (@unfrozen)</label>
                    <select id="encoderSelect" class="form-control">
                        <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
                    </select>
                </div>
                <!-- –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —ç–Ω–∫–æ–¥–µ—Ä–∞ -->
                <div id="encoderKeyMetrics" class="statistics-grid" style="display:none; margin-top:10px;">
                    <div class="stat-item">
                        <div class="stat-label">Avg Winrate</div>
                        <div class="stat-value" id="kmAvgWinrate">N/A</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Episodes (cum)</div>
                        <div class="stat-value" id="kmEpisodesCum">N/A</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Seed</div>
                        <div class="stat-value" id="kmSeed">N/A</div>
                    </div>
                </div>
                <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ q_loss -->
                <div id="qLossIndicator" class="status info" style="display:none; margin-top:10px;"></div>
                <!-- –ö–Ω–æ–ø–∫–∞ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞ -->
                <div class="button-group" id="manifestToggleGroup" style="display:none; margin-top:10px;">
                    <button id="toggleManifestBtn" type="button" class="btn btn-info">–ü–æ–∫–∞–∑–∞—Ç—å –º–∞–Ω–∏—Ñ–µ—Å—Ç</button>
                </div>
                <div id="encoderManifest" class="status info" style="display:none; white-space: pre-wrap;"></div>
                <div class="form-group" id="trainEncoderGroup" style="display:none;">
                    <label>
                        <input type="checkbox" id="trainEncoderCheckbox" checked>
                        –û–±—É—á–∞—Ç—å —ç–Ω–∫–æ–¥–µ—Ä (unfrozen)
                    </label>
                </div>
                <div class="form-group">
                    <label>–≠–ø–∏–∑–æ–¥—ã –æ–±—É—á–µ–Ω–∏—è</label>
                    <input id="episodesInput" class="form-control" type="number" min="1" step="1" value="1000">
                </div>
                <div class="form-group">
                    <label>–î–ª–∏–Ω–∞ —ç–ø–∏–∑–æ–¥–∞ (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–≤–µ—á–µ–π)</label>
                    <input id="episodeLengthInput" class="form-control" type="number" min="1" step="1" value="2000">
                </div>
                <div class="form-group">
                    <label>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label>
                    <select id="trainDirectionSelect" class="form-control">
                        <option value="long" selected>Long</option>
                        <option value="short">Short</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Seed (–µ—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π)</label>
                    <input id="trainSeedInput" class="form-control" type="number" min="1" step="1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 42">
                </div>
                <div id="xgb-training"></div>
                <div class="form-group">
                    <label>XGB: horizon_steps (5m —à–∞–≥–∏)</label>
                    <input id="xgbHorizonStepsInput" class="form-control" type="number" min="1" step="1" value="12">
                </div>
                <div class="form-group">
                    <label>XGB: threshold (future return)</label>
                    <input id="xgbThresholdInput" class="form-control" type="number" min="0" step="0.0001" value="0.002">
                </div>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="startTrainingSelected()">üöÄ –û–±—É—á–∏—Ç—å</button>
                    <button class="btn btn-warning" onclick="startDqnGridSelected()">üß™ Grid</button>
                    <button class="btn btn-info" onclick="startXgbTrainingSelected()">üß† –û–±—É—á–∏—Ç—å XGB</button>
                </div>
                <div id="trainStatus"></div>

                <!-- –ü–æ–¥–ø—É–Ω–∫—Ç: DQN Grid (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–µ –∂–µ episodes/episode_length/direction/seed/encoder —Å–≤–µ—Ä—Ö—É) -->
                <div id="training-grid" style="margin-top:14px; padding-top:12px; border-top:1px solid #e5e7eb;">
                    <div class="muted" style="margin-bottom:6px;"><b>üß™ DQN Grid</b> ‚Äî –ø–µ—Ä–µ–±–æ—Ä risk_management + (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) DQN hyperparams</div>
                    <div class="statistics-grid" style="grid-template-columns: repeat(4, 1fr); gap:10px;">
                        <div class="form-group">
                            <label>SL (–æ—Ç—Ä–∏—Ü.), from (–±–æ–ª–µ–µ –æ—Ç—Ä–∏—Ü.) / to (–º–µ–Ω–µ–µ –æ—Ç—Ä–∏—Ü.) / step</label>
                            <input id="gridSlFrom" class="form-control" type="number" step="0.0001" value="-0.03">
                            <input id="gridSlTo" class="form-control" type="number" step="0.0001" value="-0.01" style="margin-top:6px;">
                            <input id="gridSlStep" class="form-control" type="number" step="0.0001" value="0.005" style="margin-top:6px;">
                        </div>
                        <div class="form-group">
                            <label>TP from / to / step</label>
                            <input id="gridTpFrom" class="form-control" type="number" step="0.0001" value="0.015">
                            <input id="gridTpTo" class="form-control" type="number" step="0.0001" value="0.03" style="margin-top:6px;">
                            <input id="gridTpStep" class="form-control" type="number" step="0.0001" value="0.005" style="margin-top:6px;">
                        </div>
                        <div class="form-group">
                            <label>min_hold_steps from / to / step</label>
                            <input id="gridHoldFrom" class="form-control" type="number" step="1" value="8">
                            <input id="gridHoldTo" class="form-control" type="number" step="1" value="24" style="margin-top:6px;">
                            <input id="gridHoldStep" class="form-control" type="number" step="1" value="4" style="margin-top:6px;">
                        </div>
                        <div class="form-group">
                            <label>volume_threshold from / to / step</label>
                            <input id="gridVolFrom" class="form-control" type="number" step="0.0001" value="0.002">
                            <input id="gridVolTo" class="form-control" type="number" step="0.0001" value="0.004" style="margin-top:6px;">
                            <input id="gridVolStep" class="form-control" type="number" step="0.0001" value="0.001" style="margin-top:6px;">
                        </div>
                    </div>
                    <div class="statistics-grid" style="grid-template-columns: repeat(4, 1fr); gap:10px; margin-top:10px;">
                        <div class="form-group">
                            <label>batch_size from / to / step</label>
                            <input id="gridBatchFrom" class="form-control" type="number" step="1" value="192">
                            <input id="gridBatchTo" class="form-control" type="number" step="1" value="192" style="margin-top:6px;">
                            <input id="gridBatchStep" class="form-control" type="number" step="1" value="64" style="margin-top:6px;">
                        </div>
                        <div class="form-group">
                            <label>memory_size from / to / step</label>
                            <input id="gridMemFrom" class="form-control" type="number" step="1" value="100000">
                            <input id="gridMemTo" class="form-control" type="number" step="1" value="100000" style="margin-top:6px;">
                            <input id="gridMemStep" class="form-control" type="number" step="1" value="50000" style="margin-top:6px;">
                        </div>
                        <div class="form-group">
                            <label>hidden_sizes from / to / step (CSV per-layer)</label>
                            <input id="gridHiddenFrom" class="form-control" type="text" value="384,256,192" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 384,256,192">
                            <input id="gridHiddenTo" class="form-control" type="text" value="384,256,192" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 512,384,256" style="margin-top:6px;">
                            <input id="gridHiddenStep" class="form-control" type="text" value="64,64,32" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 64,64,32" style="margin-top:6px;">
                        </div>
                        <div class="form-group">
                            <label>eps_decay_steps from / to / step</label>
                            <input id="gridEpsDecayFrom" class="form-control" type="number" step="1" value="2500000">
                            <input id="gridEpsDecayTo" class="form-control" type="number" step="1" value="2500000" style="margin-top:6px;">
                            <input id="gridEpsDecayStep" class="form-control" type="number" step="1" value="250000" style="margin-top:6px;">
                        </div>
                    </div>
                    <div class="form-group" style="margin-top:10px;">
                        <label>Max models to queue (selected subset if grid larger) ‚Äî <span id="gridTotalCombo" style="color:#2563eb;font-weight:600;">0</span> –∫–æ–º–±–∏–Ω–∞—Ü–∏–π –≤ —Å–µ—Ç–∫–µ</label>
                        <input id="gridMaxModels" class="form-control" type="number" min="1" max="100" step="1" value="10">
                    </div>
                    <div id="gridStatus"></div>
                    <div id="gridPreview" class="status info" style="display:none; white-space: pre-wrap;"></div>
                </div>
            </div>

            <!-- –°–µ–∫—Ü–∏—è –¥–æ–æ–±—É—á–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –º–æ–¥–µ–ª–∏ -->
            <div class="section" id="continue-training">
                <h2>üîÅ –î–æ–æ–±—É—á–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –º–æ–¥–µ–ª—å</h2>
                <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –≤–µ—Å–æ–≤ –∏–∑ <code>result/</code> (—Ñ–æ—Ä–º–∞—Ç <code>dqn_model_*.pth</code>). –ï—Å–ª–∏ –Ω–∞–π–¥–µ—Ç—Å—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π <code>replay_buffer_*.pkl</code>, –æ–Ω —Ç–∞–∫–∂–µ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω. –î–æ–æ–±—É—á–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–∞–∫ –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é.</p>

                <div class="form-group">
                    <label>–°–∏–º–≤–æ–ª</label>
                    <select id="runsSymbolSelect" class="form-control" onchange="loadRunsForSymbol()">
                        <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–∏–º–≤–æ–ª–æ–≤...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>–í—ã–±–µ—Ä–∏—Ç–µ –≤–µ—Å–∞ –º–æ–¥–µ–ª–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, dqn_model_ton_ed10.pth)</label>
                    <select id="continueModelSelect" class="form-control" onchange="showSelectedContinueModelInfo()">
                        <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞...</option>
                    </select>
                </div>

                <div id="continueModelInfo" class="status info" style="display:none; white-space: pre-line;"></div>

                <div class="form-group">
                    <label>–≠–ø–∏–∑–æ–¥—ã –¥–æ–æ–±—É—á–µ–Ω–∏—è</label>
                    <input id="continueEpisodesInput" class="form-control" type="number" min="1" step="1" value="1000" oninput="updateEstimatedTime()">
                    <div id="episodesEstimate" class="status info" style="display:none; margin-top:6px;"></div>
                </div>
                <div class="form-group">
                    <label>–î–ª–∏–Ω–∞ —ç–ø–∏–∑–æ–¥–∞ (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–≤–µ—á–µ–π)</label>
                    <input id="continueEpisodeLengthInput" class="form-control" type="number" min="1" step="1" value="2000">
                </div>
                <div class="form-group">
                    <label>Seed –¥–ª—è –¥–æ–æ–±—É—á–µ–Ω–∏—è (–µ—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî —Å–ª—É—á–∞–π–Ω—ã–π)</label>
                    <input id="continueSeedInput" class="form-control" type="number" min="1" step="1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 2024">
                </div>
                <div class="form-group">
                    <label>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–¥–ª—è do-–æ–±—É—á–µ–Ω–∏—è)</label>
                    <select id="continueDirectionSelect" class="form-control">
                        <option value="long" selected>Long</option>
                        <option value="short">Short</option>
                    </select>
                </div>

                <div class="button-group">
                    <button class="btn btn-success" onclick="continueTraining()">üîÅ –ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–æ–æ–±—É—á–µ–Ω–∏–µ</button>
                </div>

                <div id="continueStatus"></div>
            </div>
                <div id="createStatus"></div>
            </div>

            
            </div>
        </div>
    </div>

    <script>
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            try{ loadResultSymbolsForCreate(); }catch(_){ }
            loadContinueModels();
            loadRunsSymbols();
            // –ê–≤—Ç–æ–ø–æ–¥–≥—Ä—É–∑–∫–∞ —ç–Ω–∫–æ–¥–µ—Ä–æ–≤ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
            try{
                const symSel = document.getElementById('trainSymbolSelect');
                const val = (symSel && symSel.value) ? symSel.value.trim() : '';
                if(val){ loadEncodersForSymbol(val); }
            }catch(_){ }
        });

        // –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é –º–æ–¥–µ–ª–∏
        async function createModelVersion(btnEl) {
            const statusDiv = document.getElementById('createStatus');
            const button = btnEl || document.getElementById('createModelBtn');
            const fileSelect = document.getElementById('resultFileSelect');
            const symbolSelect = document.getElementById('resultSymbolSelect');
            const selectedFile = fileSelect ? fileSelect.value : '';
            const selectedSymbol = symbolSelect ? symbolSelect.value : '';
            const ensSelect = document.getElementById('resultEnsembleSelect');
            const selectedEns = ensSelect ? ensSelect.value : 'ensemble-a';
            
            if (!selectedFile) {
                statusDiv.innerHTML = '<div class="status error">‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å –∏–∑ result</div>';
                return;
            }
            
            if (button) { button.disabled = true; button.textContent = '‚è≥ –°–æ–∑–¥–∞–Ω–∏–µ...'; }
            statusDiv.innerHTML = '<div class="status info">–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ –º–æ–¥–µ–ª–∏...</div>';
            
            try {
                const payload = { file: selectedFile, symbol: selectedSymbol, ensemble: selectedEns };
                try { console.log('[createModelVersion] payload', payload); } catch(_){}
                const response = await fetch('/create_model_version', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                try { console.log('[createModelVersion] response', response.status, response.statusText); } catch(_){}
                if(!response.ok){
                    let bodyText = '';
                    try { bodyText = await response.text(); } catch(_){}
                    try { console.error('[createModelVersion] HTTP error', response.status, bodyText); } catch(_){}
                    statusDiv.innerHTML = `<div class="status error">‚ùå –û—à–∏–±–∫–∞ HTTP ${response.status}: ${response.statusText || ''}<br><pre style="white-space:pre-wrap;">${(bodyText||'').slice(0,2000)}</pre></div>`;
                    return;
                }
                
                let result = null;
                try { result = await response.json(); } catch(e){
                    let bodyText = '';
                    try { bodyText = await response.text(); } catch(_){}
                    statusDiv.innerHTML = `<div class="status error">‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞<br><pre style="white-space:pre-wrap;">${(bodyText||String(e)).slice(0,2000)}</pre></div>`;
                    try { console.error('[createModelVersion] JSON parse error', e, bodyText); } catch(_){}
                    return;
                }
                
                if (result.success) {
                    try { console.log('[createModelVersion] success', result); } catch(_){}
                    statusDiv.innerHTML = `<div class="status success">
                        ‚úÖ –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è —Å–æ–∑–¥–∞–Ω–∞!<br>
                        ID: ${result.model_id}<br>
                        –§–∞–π–ª—ã: ${result.files.join(', ')}
                    </div>`;
                    // –°–µ–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π —É–¥–∞–ª–µ–Ω–∞
                } else {
                    try { console.warn('[createModelVersion] server error', result); } catch(_){}
                    statusDiv.innerHTML = `<div class="status error">
                        ‚ùå –û—à–∏–±–∫–∞: ${result.error}
                    </div>`;
                }
            } catch (error) {
                try { console.error('[createModelVersion] network error', error); } catch(_){}
                statusDiv.innerHTML = `<div class="status error">
                    ‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}
                </div>`;
            } finally {
                if (button) { button.disabled = false; button.textContent = 'üöÄ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é'; }
            }
        }

        // === Runs UI ===
        async function loadRunsSymbols(){
            const sel = document.getElementById('runsSymbolSelect');
            if(!sel) return;
            try{
                const resp = await fetch('/api/runs/symbols');
                const data = await resp.json();
                if(!data.success){ sel.innerHTML = '<option value="">–û—à–∏–±–∫–∞</option>'; return; }
                const list = Array.isArray(data.symbols)? data.symbols: [];
                if(list.length===0){ sel.innerHTML = '<option value="">–ù–µ—Ç —Å–∏–º–≤–æ–ª–æ–≤</option>'; return; }
                sel.innerHTML = list.map(s=>`<option value="${s}">${s}</option>`).join('');
                try{ loadRunsForSymbol(); }catch(_){ }
            }catch(e){ if(sel) sel.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>'; }
        }

        async function loadRunsForSymbol(){
            const sym = (document.getElementById('runsSymbolSelect')?.value||'').trim();
            if(!sym) return;
            try{
                const resp = await fetch('/api/runs/list?symbol='+encodeURIComponent(sym));
                const data = await resp.json();
                if(!data.success) return;
                // –ó–∞–ø–æ–ª–Ω—è–µ–º continueModelSelect —Ñ–∞–π–ª–∞–º–∏ model.pth –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
                const select = document.getElementById('continueModelSelect');
                if(!select) return;
                const runs = Array.isArray(data.runs)? data.runs: [];
                if(runs.length===0){ select.innerHTML = '<option value="">–ù–µ—Ç –∑–∞–ø—É—Å–∫–æ–≤</option>'; return; }
                function dirTag(r){
                    const d = (r && typeof r.direction === 'string') ? r.direction.trim().toLowerCase() : '';
                    if(d === 'long') return ' (–ª–æ–Ω–≥)';
                    if(d === 'short') return ' (—à–æ—Ä—Ç)';
                    return '';
                }
                function dirVal(r){
                    const d = (r && typeof r.direction === 'string') ? r.direction.trim().toLowerCase() : '';
                    if(d === 'long' || d === 'short') return d;
                    return '';
                }
                // –æ—Ç–æ–±—Ä–∞–∑–∏–º –¥—Ä–µ–≤–æ–≤–∏–¥–Ω–æ: parent ‚Üí child (—É–ø—Ä–æ—Å—Ç–∏–º: –ø—Ä–µ—Ñ–∏–∫—Å ‚ñ∏)
                const idToChildren = {};
                const idToNode = {};
                runs.forEach(r=>{ idToChildren[r.run_id]=[]; idToNode[r.run_id]=r; });
                runs.forEach(r=>{ if(r.parent_run_id && idToChildren[r.parent_run_id]) idToChildren[r.parent_run_id].push(r.run_id); });
                function renderRun(runId, depth){
                    const r = idToNode[runId]; if(!r) return '';
                    const label = `${'‚ñ∏'.repeat(depth)} ${r.run_id}${dirTag(r)}`;
                    const file = r.model_path || '';
                    const opt = `<option value="${file}" data-direction="${dirVal(r)}">${label}</option>`;
                    const children = (idToChildren[runId]||[]).map(cid=>renderRun(cid, depth+1)).join('');
                    return opt+children;
                }
                // –∫–æ—Ä–Ω–∏: –±–µ–∑ parent
                const roots = runs.filter(r=>!r.parent_run_id).map(r=>r.run_id);
                const html = roots.map(rt=>renderRun(rt,0)).join('');
                select.innerHTML = html;
                try{ showSelectedContinueModelInfo(); }catch(_){ }
            }catch(e){ /* noop */ }
        }

        // –ì–ª–æ–±–∞–ª—å–Ω–æ —Ö—Ä–∞–Ω–∏–º —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –∑–∞ —ç–ø–∏–∑–æ–¥ (—Å–µ–∫)
        let avgTimePerEpisodeSec = null;

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è —Å–µ–∫—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω–∏—è –≤–µ—Ä—Å–∏–∏
        async function loadResultSymbolsForCreate(){
            const sel = document.getElementById('resultSymbolSelect');
            if(!sel) return;
            try{
                const resp = await fetch('/api/runs/symbols');
                const data = await resp.json();
                if(!data.success){ sel.innerHTML = '<option value="">–û—à–∏–±–∫–∞</option>'; return; }
                const list = Array.isArray(data.symbols)? data.symbols: [];
                if(list.length===0){ sel.innerHTML = '<option value="">–ù–µ—Ç —Å–∏–º–≤–æ–ª–æ–≤</option>'; return; }
                sel.innerHTML = list.map(s=>`<option value="${s}">${s}</option>`).join('');
                try{ loadResultFilesForCreate(); }catch(_){ }
            }catch(e){ sel.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>'; }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–µ–π (–≤–µ—Å–æ–≤) –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞ –∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã runs
        async function loadResultFilesForCreate(){
            const sym = (document.getElementById('resultSymbolSelect')?.value||'').trim();
            const select = document.getElementById('resultFileSelect');
            if(!select) return;
            if(!sym){ select.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å–∏–º–≤–æ–ª...</option>'; return; }
            try{
                const resp = await fetch('/api/runs/list?symbol='+encodeURIComponent(sym));
                const data = await resp.json();
                if(!data.success){ select.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>'; return; }
                const runs = Array.isArray(data.runs)? data.runs: [];
                const options = [];
                for(const r of runs){
                    const path = r.model_path || '';
                    if(path && path.toLowerCase().endsWith('.pth')){
                        const fname = path.split('/').pop().split('\\').pop();
                        const d = String(r.direction || '').trim().toLowerCase();
                        const dirTag = (d === 'long' || d === 'short') ? ` (${d})` : '';
                        const label = `${r.run_id || 'run'} ‚Äî ${fname}${dirTag}`;
                        options.push(`<option value="${path}" data-direction="${d}">${label}</option>`);
                    }
                }
                select.innerHTML = options.length? options.join('') : '<option value="">–ù–µ—Ç –æ–±—É—á–µ–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π</option>';
            }catch(e){ select.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>'; }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –≤–µ—Å–æ–≤ –¥–ª—è –¥–æ–æ–±—É—á–µ–Ω–∏—è (–≤—Å–µ dqn_model_*.pth)
        async function loadContinueModels() {
            const select = document.getElementById('continueModelSelect');
            if (!select) return;
            try {
                const resp = await fetch('/get_models_list');
                const data = await resp.json();
                if (!data.success || !data.files || data.files.length === 0) {
                    select.innerHTML = '<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤</option>';
                    return;
                }
                // –í—Å–µ dqn_model_* (–±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ —Å–∏–º–≤–æ–ª—É)
                const opts = data.files.map(f => {
                    const filename = (f.filename || '').split('/').pop().split('\\').pop();
                    return `<option value="${f.filename}">${filename}</option>`;
                }).join('');
                select.innerHTML = opts;
                // –ê–≤—Ç–æ-–ø–æ–∫–∞–∑ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
                try { showSelectedContinueModelInfo(); } catch(e){}
            } catch (e) {
                select.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞</option>';
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∫—Ä–∞—Ç–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –≤–µ—Å–∞—Ö –¥–ª—è –¥–æ–æ–±—É—á–µ–Ω–∏—è
        async function showSelectedContinueModelInfo() {
            const select = document.getElementById('continueModelSelect');
            const infoDiv = document.getElementById('continueModelInfo');
            if (!select || !infoDiv) return;
            const filename = select.value;
            if (!filename) { infoDiv.style.display = 'none'; return; }
            // –ê–≤—Ç–æ–ø–æ–¥—Å—Ç–∞–≤–∏–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ run (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
            try{
                const dirSel = document.getElementById('continueDirectionSelect');
                const opt = select.options && (select.selectedIndex >= 0) ? select.options[select.selectedIndex] : null;
                const d = (opt && opt.dataset) ? String(opt.dataset.direction || '').trim().toLowerCase() : '';
                if(dirSel && (d === 'short' || d === 'long')) dirSel.value = d;
            }catch(_){}
            try {
                const resp = await fetch('/get_result_model_info', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename })
                });
                const result = await resp.json();
                if (!result.success) {
                    infoDiv.className = 'status error';
                    infoDiv.textContent = '‚ùå ' + (result.error || '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏');
                    infoDiv.style.display = 'block';
                    return;
                }
                const stats = result.stats || {};
                const winrate = typeof stats.winrate === 'number' ? (stats.winrate * 100).toFixed(1) + '%' : 'N/A';
                const plr = typeof stats.pl_ratio === 'number' ? stats.pl_ratio.toFixed(2) : 'N/A';
                const trades = (stats.trades_count != null) ? stats.trades_count : 'N/A';
                const episodes = (result.episodes != null) ? result.episodes : 'N/A';
                const seed = (result.seed != null) ? result.seed : null;
                const gpu = (result.cuda_available===true) ? (result.gpu_name || 'GPU') : 'CPU';
                const totalTime = (typeof result.total_training_time === 'number') ? result.total_training_time : null;
                const avgTime = (typeof result.avg_time_per_episode_sec === 'number') ? result.avg_time_per_episode_sec : (totalTime && episodes ? (totalTime/episodes) : null);
                const fmtSec = (s)=>{
                    if(!s && s!==0) return 'N/A';
                    try{ const m=Math.floor(s/60), r=Math.round(s%60); return (m>0?`${m}–º `:'')+`${r}—Å`; }catch(_){ return s.toFixed? s.toFixed(1)+'—Å' : String(s); }
                };
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –æ–Ω–ª–∞–π–Ω-–æ—Ü–µ–Ω–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏ –≤–≤–æ–¥–µ
                try { avgTimePerEpisodeSec = (typeof avgTime === 'number' && avgTime > 0) ? avgTime : null; } catch(_) { avgTimePerEpisodeSec = null; }
                // –ö–æ–¥ –º–æ–∂–µ—Ç –≤–∫–ª—é—á–∞—Ç—å —Å–∏–º–≤–æ–ª, –ø–æ–ø—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å
                const code = (result.code || '').toUpperCase();
                const symbolOut = (result.symbol || '').toUpperCase();
                let symbolGuess = '';
                if (code) {
                    // –ß–∞—Å—Ç–æ –∫–æ–¥ –≤–∏–¥–∞ btc_xxxx -> –¥–æ–±–∞–≤–∏–º USDT
                    const base = code.split('_')[0];
                    if (base && base.length <= 6) symbolGuess = base + 'USDT';
                }
                infoDiv.className = 'status info';
                infoDiv.innerHTML = `
–í—ã–±—Ä–∞–Ω–æ: ${filename.split('/').pop().split('\\').pop()}
–ö–æ–¥/—Å–∏–º–≤–æ–ª: ${code || 'N/A'} / ${symbolOut || symbolGuess || 'N/A'}
Seed: ${seed !== null ? seed : '‚Äî'}
–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${gpu}
Winrate: ${winrate}
P/L Ratio: ${plr}
–°–¥–µ–ª–æ–∫: ${trades}
–≠–ø–∏–∑–æ–¥–æ–≤: ${episodes}
–î–ª–∏–Ω–∞ —ç–ø–∏–∑–æ–¥–∞: ${result.episode_length != null ? result.episode_length : 'N/A'}
–ë—É—Ñ–µ—Ä: ${result.replay_exists ? '‚úÖ –µ—Å—Ç—å' : '‚ùå –Ω–µ—Ç'}
–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—É—á–µ–Ω–∏—è: ${result.train_result_exists ? '‚úÖ –µ—Å—Ç—å' : '‚ùå –Ω–µ—Ç'}
–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –∑–∞ —ç–ø–∏–∑–æ–¥: ${fmtSec(avgTime)}
–û–±—â–µ–µ –≤—Ä–µ–º—è –æ–±—É—á–µ–Ω–∏—è: ${totalTime ? fmtSec(totalTime) : 'N/A'}
`;
                infoDiv.style.display = 'block';
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–ª–∏–Ω—É —ç–ø–∏–∑–æ–¥–∞
                const continueEpisodeLengthInput = document.getElementById('continueEpisodeLengthInput');
                if (continueEpisodeLengthInput && result.episode_length != null) {
                    continueEpisodeLengthInput.value = result.episode_length;
                }
                // –û–±–Ω–æ–≤–∏–º –ø–æ–¥—Å–∫–∞–∑–∫—É –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏
                try { updateEstimatedTime(); } catch(_) {}
            } catch (e) {
                infoDiv.className = 'status error';
                infoDiv.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + e.message;
                infoDiv.style.display = 'block';
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ü–µ–Ω–∫–∏ –æ–±—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏ –≤–≤–æ–¥–µ —ç–ø–∏–∑–æ–¥–æ–≤
        function updateEstimatedTime(){
            const estDiv = document.getElementById('episodesEstimate');
            const inp = document.getElementById('continueEpisodesInput');
            if(!estDiv || !inp){ return; }
            const n = Math.max(1, parseInt(inp.value || '0', 10) || 0);
            if (avgTimePerEpisodeSec && n > 0){
                const totalSec = n * avgTimePerEpisodeSec;
                const hours = Math.floor(totalSec/3600);
                const minutes = Math.round((totalSec%3600)/60);
                const human = (hours>0? `${hours} —á `: '') + `${minutes} –º–∏–Ω`;
                // –û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è
                try {
                    const finish = new Date(Date.now() + totalSec*1000);
                    const hh = String(finish.getHours()).padStart(2,'0');
                    const mm = String(finish.getMinutes()).padStart(2,'0');
                    estDiv.textContent = `‚âà ${human} (–æ–∫–æ–Ω—á–∞–Ω–∏–µ –≤ ${hh}:${mm})`;
                } catch(_) {
                    estDiv.textContent = `‚âà ${human}`;
                }
                estDiv.style.display = 'block';
            } else {
                estDiv.textContent = '–í—Ä–µ–º—è –±—É–¥–µ—Ç —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–æ –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏ —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π';
                estDiv.style.display = 'block';
            }
        }

        // –ó–∞–ø—É—Å–∫ –¥–æ–æ–±—É—á–µ–Ω–∏—è
        async function continueTraining() {
            const statusDiv = document.getElementById('continueStatus');
            const fileSelect = document.getElementById('continueModelSelect');
            const episodes = document.getElementById('continueEpisodesInput').value;
            const seedVal = (document.getElementById('continueSeedInput')?.value || '').trim();
            const selectedFile = fileSelect ? fileSelect.value : '';

            if (!selectedFile) {
                statusDiv.innerHTML = '<div class="status error">‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≤–µ—Å–∞ dqn_model_*.pth</div>';
                return;
            }
            const episodeLengthEl = document.getElementById('continueEpisodeLengthInput');
            const episodeLength = episodeLengthEl ? episodeLengthEl.value : 2000;
            const dirEl = document.getElementById('continueDirectionSelect');
            const dirVal = (dirEl && dirEl.value) ? String(dirEl.value).trim().toLowerCase() : 'long';

            statusDiv.innerHTML = '<div class="status info">‚è≥ –ó–∞–ø—É—Å–∫ –¥–æ–æ–±—É—á–µ–Ω–∏—è...</div>';
            try {
                const resp = await fetch('/training/continue_training', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: selectedFile, episodes, episode_length: episodeLength, seed: seedVal, direction: dirVal })
                });
                const result = await resp.json();
                if (result.success) {
                    statusDiv.innerHTML = `<div class=\"status success\">‚úÖ –î–æ–æ–±—É—á–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ (task: ${result.task_id}). –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—è–≤–∏—Ç—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ –º–æ–¥–µ–ª–µ–π.</div>`;
                } else {
                    statusDiv.innerHTML = `<div class=\"status error\">‚ùå –û—à–∏–±–∫–∞: ${result.error}</div>`;
                }
            } catch (e) {
                statusDiv.innerHTML = `<div class=\"status error\">‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${e.message}</div>`;
            }
        }

        // –ö—ç—à –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤ —ç–Ω–∫–æ–¥–µ—Ä–æ–≤ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
        let __encodersCache = { list: [], byId: {} };

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —ç–Ω–∫–æ–¥–µ—Ä–æ–≤ –¥–ª—è —Å–∏–º–≤–æ–ª–∞
        async function loadEncodersForSymbol(symbol){
            const encGroup = document.getElementById('encoderGroup');
            const encSelect = document.getElementById('encoderSelect');
            const encManifestDiv = document.getElementById('encoderManifest');
            const trainEncGroup = document.getElementById('trainEncoderGroup');
            if(!encGroup || !encSelect) return;
            encGroup.style.display = 'block';
            trainEncGroup && (trainEncGroup.style.display = 'block');
            encSelect.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>';
            encManifestDiv && (encManifestDiv.style.display = 'none');
            __encodersCache = { list: [], byId: {} };
            try {
                const resp = await fetch('/api/encoders?symbol=' + encodeURIComponent(symbol));
                const data = await resp.json();
                const items = (data && data.success && Array.isArray(data.encoders)) ? data.encoders : [];
                __encodersCache.list = items;
                __encodersCache.byId = Object.fromEntries(items.map(it => [it.id, it]));
                if(items.length === 0){
                    encSelect.innerHTML = '<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —ç–Ω–∫–æ–¥–µ—Ä–æ–≤</option>';
                } else {
                    const opts = ['<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —ç–Ω–∫–æ–¥–µ—Ä</option>'].concat(items.map(it => {
                        const m = it.manifest || {};
                        const dir = (m.direction || m.trained_as || '').toString().toLowerCase();
                        const tag = dir === 'short' ? ' [short]' : (dir === 'long' ? ' [long]' : '');
                        const label = (it.name || it.id) + tag;
                        return `<option value="${it.id}">${label}</option>`;
                    })).join('');
                    encSelect.innerHTML = opts;
                }
            } catch(e){
                encSelect.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —ç–Ω–∫–æ–¥–µ—Ä–∞
        function onEncoderChanged(){
            const encSelect = document.getElementById('encoderSelect');
            const encManifestDiv = document.getElementById('encoderManifest');
            const metricsGrid = document.getElementById('encoderKeyMetrics');
            const kmAvg = document.getElementById('kmAvgWinrate');
            const kmEps = document.getElementById('kmEpisodesCum');
            const kmSeed = document.getElementById('kmSeed');
            const qLossDiv = document.getElementById('qLossIndicator');
            const toggleGroup = document.getElementById('manifestToggleGroup');
            const toggleBtn = document.getElementById('toggleManifestBtn');
            if(!encSelect || !encManifestDiv) return;
            const encId = encSelect.value;
            if(!encId){
                encManifestDiv.style.display = 'none';
                if (metricsGrid) metricsGrid.style.display = 'none';
                if (qLossDiv) qLossDiv.style.display = 'none';
                if (toggleGroup) toggleGroup.style.display = 'none';
                return;
            }
            const item = __encodersCache.byId[encId];
            // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤
            const fmtPct = (v)=>{
                if (typeof v !== 'number') return 'N/A';
                return (v*100).toFixed(2) + '%';
            };
            // –°–±—Ä–æ—Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            if (metricsGrid) metricsGrid.style.display = 'none';
            if (qLossDiv) qLossDiv.style.display = 'none';
            if (toggleGroup) toggleGroup.style.display = 'none';
            encManifestDiv.style.display = 'none';

            if(item && item.manifest){
                // –ü–µ—á–∞—Ç—å –ø–æ–ª–Ω–æ–≥–æ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞ –≤ —Å–∫—Ä—ã—Ç—ã–π –±–ª–æ–∫
                try{ encManifestDiv.textContent = JSON.stringify(item.manifest, null, 2); }
                catch(_){ encManifestDiv.textContent = String(item.manifest); }

                // –¢–æ–≥–≥–ª–µ—Ä –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞
                if (toggleGroup && toggleBtn){
                    toggleGroup.style.display = 'flex';
                    toggleBtn.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –º–∞–Ω–∏—Ñ–µ—Å—Ç';
                    // –°–±—Ä–æ—Å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞
                    try{ toggleBtn.onclick = null; }catch(_){ }
                    toggleBtn.addEventListener('click', function(){
                        const isHidden = encManifestDiv.style.display === 'none';
                        encManifestDiv.style.display = isHidden ? 'block' : 'none';
                        toggleBtn.textContent = isHidden ? '–°–∫—Ä—ã—Ç—å –º–∞–Ω–∏—Ñ–µ—Å—Ç' : '–ü–æ–∫–∞–∑–∞—Ç—å –º–∞–Ω–∏—Ñ–µ—Å—Ç';
                    }, { once: false });
                }

                // –ï—Å–ª–∏ –º–∞–Ω–∏—Ñ–µ—Å—Ç –ø—Ä–∏—à—ë–ª –∫–∞–∫ YAML, –∫–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –∏–∑–≤–ª–µ—á—å –Ω–µ–ª—å–∑—è
                if (item.manifest && typeof item.manifest === 'object' && !('yaml' in item.manifest)){
                    const m = item.manifest;
                    const perf = m.performance || {};
                    const train = m.training || {};
                    const avg_wr = (typeof perf.avg_winrate === 'number') ? perf.avg_winrate : null;
                    const cum_eps = (typeof train.cumulative_episodes_completed === 'number') ? train.cumulative_episodes_completed : null;
                    const seedVal = (typeof m.seed === 'number') ? m.seed : null;

                    if (metricsGrid){
                        kmAvg && (kmAvg.textContent = (avg_wr != null ? fmtPct(avg_wr) : 'N/A'));
                        kmEps && (kmEps.textContent = (cum_eps != null ? String(cum_eps) : 'N/A'));
                        kmSeed && (kmSeed.textContent = (seedVal != null ? String(seedVal) : 'N/A'));
                        metricsGrid.style.display = 'grid';
                    }

                    // –ê–Ω–∞–ª–∏–∑ q_loss_stability
                    const ind = (m.training_indicators || {});
                    const qlm = ind.q_loss_stability || null;
                    if (qLossDiv){
                        if (qlm && typeof qlm === 'object'){
                            const thr = qlm.thresholds || {};
                            const slope = Number(qlm.slope_last_20pct);
                            const std20 = Number(qlm.std_last_20pct);
                            const absSlopeThr = Number(thr.abs_slope);
                            const stdThr = Number(thr.std);
                            const isStableFlag = !!qlm.stable;

                            let level = 'error'; // red –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                            if (isFinite(slope) && isFinite(std20) && isFinite(absSlopeThr) && isFinite(stdThr)){
                                const okSlope = Math.abs(slope) <= absSlopeThr;
                                const okStd = std20 <= stdThr;
                                if (isStableFlag && okSlope && okStd){
                                    level = 'success'; // green
                                } else if ((Math.abs(slope) <= absSlopeThr*2) && (std20 <= stdThr*2)){
                                    level = 'warning'; // yellow
                                } else {
                                    level = 'error'; // red
                                }
                            } else if (isStableFlag){
                                level = 'warning';
                            }

                            qLossDiv.className = 'status ' + (level === 'warning' ? 'warning' : (level === 'success' ? 'success' : 'error'));
                            qLossDiv.innerHTML = (
                                '<b>q_loss_stability</b><br>'+
                                'count: ' + (qlm.count ?? 'N/A') + '<br>'+
                                'ema: ' + (typeof qlm.ema === 'number' ? qlm.ema.toFixed(6) : 'N/A') + '<br>'+
                                'slope_last_20pct: ' + (isFinite(slope) ? slope.toExponential(3) : 'N/A') + '<br>'+
                                'std_last_20pct: ' + (isFinite(std20) ? std20.toFixed(6) : 'N/A') + '<br>'+
                                'stable: ' + String(isStableFlag) + '<br>'+
                                'thresholds: { abs_slope: ' + (isFinite(absSlopeThr)? absSlopeThr : 'N/A') + ', std: ' + (isFinite(stdThr)? stdThr : 'N/A') + ' }' + '<br>'+
                                ((ind.freeze_recommendation && typeof ind.freeze_recommendation === 'object')
                                    ? ('<br><b>freeze_recommendation</b>: ' + (ind.freeze_recommendation.should_freeze ? 'FREEZE (–∑–∞–º–æ—Ä–æ–∑–∏—Ç—å —ç–Ω–∫–æ–¥–µ—Ä)' : 'CONTINUE (–µ—â—ë —É—á–∏—Ç—å)') +
                                       (Array.isArray(ind.freeze_recommendation.reasons) ? ('<br>reasons: ' + ind.freeze_recommendation.reasons.join(', ')) : ''))
                                    : '')
                            );
                            qLossDiv.style.display = 'block';
                        } else {
                            qLossDiv.className = 'status info';
                            qLossDiv.textContent = 'q_loss_stability: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ';
                            qLossDiv.style.display = 'block';
                        }
                    }
                } else {
                    if (metricsGrid) metricsGrid.style.display = 'none';
                    if (qLossDiv){
                        qLossDiv.className = 'status info';
                        qLossDiv.textContent = '–ú–∞–Ω–∏—Ñ–µ—Å—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ YAML ‚Äî –º–µ—Ç—Ä–∏–∫–∏ –Ω–µ –∏–∑–≤–ª–µ—á—å';
                        qLossDiv.style.display = 'block';
                    }
                }
            } else {
                encManifestDiv.textContent = '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —ç–Ω–∫–æ–¥–µ—Ä–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞';
                if (toggleGroup) toggleGroup.style.display = 'none';
                encManifestDiv.style.display = 'none';
                if (metricsGrid) metricsGrid.style.display = 'none';
                if (qLossDiv){
                    qLossDiv.className = 'status info';
                    qLossDiv.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ';
                    qLossDiv.style.display = 'block';
                }
            }
        }

        async function clearTrainingLock(symbol, taskId){
            const resp = await fetch('/training/clear_train_lock', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                body: JSON.stringify({ symbol: symbol, task_id: taskId || '' })
            });
            return await resp.json().catch(() => null);
        }

        // –ó–∞–ø—É—Å–∫ –æ–±—É—á–µ–Ω–∏—è —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —ç–ø–∏–∑–æ–¥–æ–≤
        async function startTrainingForSymbol(symbol, engine='optimized') {
            const episodes = document.getElementById('episodesInput').value || 1000;
            const episodeLength = document.getElementById('episodeLengthInput').value || 2000;
            const seedVal = (document.getElementById('trainSeedInput')?.value || '').trim();
            const encoderId = (document.getElementById('encoderSelect')?.value || '').trim();
            const trainEncoder = !!(document.getElementById('trainEncoderCheckbox')?.checked);
            const statusDiv = document.getElementById('trainStatus');
            const isNewEncoder = !encoderId;
            statusDiv.innerHTML = '<div class="status info">‚è≥ –ó–∞–ø—É—Å–∫ –æ–±—É—á–µ–Ω–∏—è ' + symbol + (isNewEncoder ? ' (–Ω–æ–≤—ã–π —ç–Ω–∫–æ–¥–µ—Ä)' : '') + '...</div>';
            try {
                const payload = { symbol, episodes, episode_length: episodeLength, seed: seedVal, engine };
                const dirEl = document.getElementById('trainDirectionSelect');
                const dirVal = (dirEl && dirEl.value) ? String(dirEl.value).trim().toLowerCase() : 'long';
                payload.direction = dirVal;
                if (encoderId) {
                    payload.encoder_id = encoderId;
                    payload.train_encoder = trainEncoder;
                } else {
                    // –ï—Å–ª–∏ —ç–Ω–∫–æ–¥–µ—Ä –Ω–µ –≤—ã–±—Ä–∞–Ω ‚Äî –Ω–µ –≥—Ä—É–∑–∏–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π, —Å–æ–∑–¥–∞—ë–º –∏ –æ–±—É—á–∞–µ–º –Ω–æ–≤—ã–π
                    payload.train_encoder = true;
                }
                const resp = await fetch('/training/train_dqn_symbol', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await resp.json().catch(() => null);
                if (data && data.success) {
                    statusDiv.innerHTML = '<div class="status success">‚úÖ –û–±—É—á–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ (task: ' + data.task_id + ')</div>';
                } else if (data && data.error) {
                    const err = String(data.error || 'unknown');
                    const taskId = data.task_id ? String(data.task_id) : '';
                    const errLc = err.toLowerCase();
                    const isLockedLike =
                        errLc.includes('already running') ||
                        errLc.includes('training duplicate') ||
                        errLc.includes('duplicate') ||
                        errLc.includes('dedup') ||
                        errLc.includes('skipped');
                    if (isLockedLike) {
                        statusDiv.innerHTML =
                            '<div class="status error">‚ùå ' + err +
                            ' <button class="btn btn-warning" id="clearTrainLockBtn" style="margin-left:8px;">–°–±—Ä–æ—Å–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É</button></div>';
                        const btn = document.getElementById('clearTrainLockBtn');
                        if (btn) {
                            btn.onclick = async () => {
                                btn.disabled = true;
                                try {
                                    const res = await clearTrainingLock(symbol, taskId);
                                    if (res && res.success) {
                                        statusDiv.innerHTML = '<div class="status success">‚úÖ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–±—Ä–æ—à–µ–Ω–∞ –¥–ª—è ' + symbol + ' ‚Äî –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å –æ–±—É—á–µ–Ω–∏–µ –µ—â—ë —Ä–∞–∑</div>';
                                    } else {
                                        statusDiv.innerHTML = '<div class="status error">‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–±—Ä–æ—Å–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É: ' + ((res && res.error) ? res.error : 'unknown') + '</div>';
                                    }
                                } catch (e) {
                                    statusDiv.innerHTML = '<div class="status error">‚ùå –û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏: ' + (e && e.message ? e.message : e) + '</div>';
                                } finally {
                                    btn.disabled = false;
                                }
                            };
                        }
                    } else {
                        statusDiv.innerHTML = '<div class="status error">‚ùå ' + err + '</div>';
                    }
                } else if (resp.redirected) {
                    // –§–æ–ª–ª–±–µ–∫ –Ω–∞ —Å–ª—É—á–∞–π —Å—Ç–∞—Ä–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è
                    window.location.href = resp.url;
                } else {
                    statusDiv.innerHTML = '<div class="status error">‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞</div>';
                }
            } catch (e) {
                statusDiv.innerHTML = '<div class="status error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –æ–±—É—á–µ–Ω–∏—è: ' + e.message + '</div>';
            }
        }

        async function startXgbTrainingForSymbol(symbol) {
            const statusDiv = document.getElementById('trainStatus');
            const dirEl = document.getElementById('trainDirectionSelect');
            const direction = (dirEl && dirEl.value) ? String(dirEl.value).trim().toLowerCase() : 'long';
            const horizonSteps = document.getElementById('xgbHorizonStepsInput')?.value || 12;
            const threshold = document.getElementById('xgbThresholdInput')?.value || 0.002;
            statusDiv.innerHTML = '<div class="status info">‚è≥ –ó–∞–ø—É—Å–∫ XGB –æ–±—É—á–µ–Ω–∏—è ' + symbol + ' (' + direction + ')...</div>';
            try {
                const payload = { symbol, direction, horizon_steps: horizonSteps, threshold: threshold };
                const resp = await fetch('/training/train_xgb_symbol', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await resp.json().catch(() => null);
                if (data && data.success) {
                    statusDiv.innerHTML = '<div class="status success">‚úÖ XGB –æ–±—É—á–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ (task: ' + data.task_id + ')</div>';
                } else if (data && data.error) {
                    statusDiv.innerHTML = '<div class="status error">‚ùå ' + String(data.error) + '</div>';
                } else {
                    statusDiv.innerHTML = '<div class="status error">‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞</div>';
                }
            } catch (e) {
                statusDiv.innerHTML = '<div class="status error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ XGB: ' + (e && e.message ? e.message : e) + '</div>';
            }
        }

        function startTrainingSelected(){
            const sel = document.getElementById('trainSymbolSelect');
            const encSelect = document.getElementById('encoderSelect');
            const statusDiv = document.getElementById('trainStatus');
            const symbol = sel ? (sel.value || '').trim() : '';
            if(!symbol){
                if(statusDiv) statusDiv.innerHTML = '<div class="status error">‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Å–∏–º–≤–æ–ª</div>';
                return;
            }
            // –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ —ç–Ω–∫–æ–¥–µ—Ä–æ–≤ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω –¥–ª—è —Å–∏–º–≤–æ–ª–∞ ‚Äî –ø–æ–¥–≥—Ä—É–∑–∏–º
            try{ if(encSelect && encSelect.options.length<=1) loadEncodersForSymbol(symbol); }catch(_){ }
            startTrainingForSymbol(symbol, 'optimized');
        }

        function startXgbTrainingSelected(){
            const sel = document.getElementById('trainSymbolSelect');
            const statusDiv = document.getElementById('trainStatus');
            const symbol = sel ? (sel.value || '').trim() : '';
            if(!symbol){
                if(statusDiv) statusDiv.innerHTML = '<div class="status error">‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Å–∏–º–≤–æ–ª</div>';
                return;
            }
            startXgbTrainingForSymbol(symbol);
        }

        async function startDqnGridSelected(){
            const statusDiv = document.getElementById('gridStatus');
            const previewDiv = document.getElementById('gridPreview');
            const symSel = document.getElementById('trainSymbolSelect');
            const symbol = symSel ? (symSel.value || '').trim() : '';
            if(!symbol){
                if(statusDiv) statusDiv.innerHTML = '<div class="status error">‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Å–∏–º–≤–æ–ª</div>';
                return;
            }

            const episodes = document.getElementById('episodesInput')?.value;
            const episodeLength = document.getElementById('episodeLengthInput')?.value;
            const seedVal = (document.getElementById('trainSeedInput')?.value || '').trim();
            const dirVal = (document.getElementById('trainDirectionSelect')?.value || 'long').trim().toLowerCase();
            const encoderId = (document.getElementById('encoderSelect')?.value || '').trim();
            const trainEncoder = !!(document.getElementById('trainEncoderCheckbox')?.checked);
            const maxModels = document.getElementById('gridMaxModels')?.value || '10';

            const grid = {
                sl_from: document.getElementById('gridSlFrom')?.value,
                sl_to: document.getElementById('gridSlTo')?.value,
                sl_step: document.getElementById('gridSlStep')?.value,
                tp_from: document.getElementById('gridTpFrom')?.value,
                tp_to: document.getElementById('gridTpTo')?.value,
                tp_step: document.getElementById('gridTpStep')?.value,
                min_hold_from: document.getElementById('gridHoldFrom')?.value,
                min_hold_to: document.getElementById('gridHoldTo')?.value,
                min_hold_step: document.getElementById('gridHoldStep')?.value,
                vol_from: document.getElementById('gridVolFrom')?.value,
                vol_to: document.getElementById('gridVolTo')?.value,
                vol_step: document.getElementById('gridVolStep')?.value,
                batch_from: document.getElementById('gridBatchFrom')?.value,
                batch_to: document.getElementById('gridBatchTo')?.value,
                batch_step: document.getElementById('gridBatchStep')?.value,
                mem_from: document.getElementById('gridMemFrom')?.value,
                mem_to: document.getElementById('gridMemTo')?.value,
                mem_step: document.getElementById('gridMemStep')?.value,
                hidden_from: (document.getElementById('gridHiddenFrom')?.value || '').trim(),
                hidden_to: (document.getElementById('gridHiddenTo')?.value || '').trim(),
                hidden_step: (document.getElementById('gridHiddenStep')?.value || '').trim(),
                eps_decay_from: document.getElementById('gridEpsDecayFrom')?.value,
                eps_decay_to: document.getElementById('gridEpsDecayTo')?.value,
                eps_decay_step: document.getElementById('gridEpsDecayStep')?.value,
            };

            if(statusDiv) statusDiv.innerHTML = '<div class="status info">‚è≥ Grid: –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–¥–∞—á –≤ –æ—á–µ—Ä–µ–¥—å...</div>';
            if(previewDiv){ previewDiv.style.display='none'; previewDiv.textContent=''; }
            try{
                const payload = {
                    symbol,
                    episodes,
                    episode_length: episodeLength,
                    direction: dirVal,
                    engine: 'optimized',
                    encoder_id: encoderId,
                    train_encoder: (encoderId ? trainEncoder : true),
                    seed: seedVal,
                    max_models: maxModels,
                    grid,
                };
                const resp = await fetch('/training/train_dqn_grid', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify(payload),
                });
                const data = await resp.json().catch(() => null);
                if(data && data.success){
                    if(statusDiv) statusDiv.innerHTML = '<div class="status success">‚úÖ Grid queued: ' + data.selected + ' –∑–∞–¥–∞—á (–≤—Å–µ–≥–æ –∫–æ–º–±–∏–Ω–∞—Ü–∏–π: ' + data.total_combinations + ')</div>';
                    if(previewDiv){
                        const lines = [];
                        lines.push('seed_base: ' + data.seed_base);
                        lines.push('');
                        (data.queued || []).forEach((q)=>{
                            const rm = q.risk_management || {};
                            const cfg = q.cfg_overrides || {};
                            lines.push(
                                '#' + q.i + ' task=' + q.task_id +
                                ' seed=' + q.seed +
                                ' SL=' + rm.STOP_LOSS_PCT +
                                ' TP=' + rm.TAKE_PROFIT_PCT +
                                ' hold=' + rm.min_hold_steps +
                                ' vol=' + rm.volume_threshold +
                                (Object.keys(cfg).length ? (' | cfg=' + JSON.stringify(cfg)) : '')
                            );
                        });
                        previewDiv.textContent = lines.join('\n');
                        previewDiv.style.display = 'block';
                    }
                } else {
                    const err = (data && data.error) ? String(data.error) : 'unknown';
                    if(statusDiv) statusDiv.innerHTML = '<div class="status error">‚ùå Grid error: ' + err + '</div>';
                }
            }catch(e){
                if(statusDiv) statusDiv.innerHTML = '<div class="status error">‚ùå Grid error: ' + (e && e.message ? e.message : e) + '</div>';
            }
        }

        function countGridSteps(fromId, toId, stepId){
            const f=parseFloat(document.getElementById(fromId)?.value)||0;
            const t=parseFloat(document.getElementById(toId)?.value)||0;
            const s=parseFloat(document.getElementById(stepId)?.value)||0;
            if(s<=0||f===t) return 1;
            return Math.max(1, Math.round(Math.abs(t-f)/s)+1);
        }
        function countGridStepsInt(fromId, toId, stepId){
            const f=parseInt(document.getElementById(fromId)?.value)||0;
            const t=parseInt(document.getElementById(toId)?.value)||0;
            const s=parseInt(document.getElementById(stepId)?.value)||0;
            if(s<=0||f===t) return 1;
            return Math.max(1, Math.floor(Math.abs(t-f)/s)+1);
        }
        function parseCsvInts(s){
            const raw = String(s||'').trim();
            if(!raw) return [];
            return raw.split(',').map(x=>x.trim()).filter(Boolean).map(x=>parseInt(x,10)).filter(x=>Number.isFinite(x));
        }
        function countHiddenRange(){
            const a = parseCsvInts(document.getElementById('gridHiddenFrom')?.value);
            const b = parseCsvInts(document.getElementById('gridHiddenTo')?.value);
            const st = parseCsvInts(document.getElementById('gridHiddenStep')?.value);
            if(!a.length || !b.length || !st.length) return 1;
            if(a.length !== b.length || a.length !== st.length) return 1;
            let total = 1;
            for(let i=0;i<a.length;i++){
                const f=a[i], t=b[i], s=st[i];
                if(!Number.isFinite(f) || !Number.isFinite(t) || !Number.isFinite(s) || s<=0) return 1;
                if(f===t){ total *= 1; continue; }
                total *= (Math.floor(Math.abs(t-f)/s)+1);
            }
            return Math.max(1, total);
        }
        function updateGridComboCount(){
            const sl=countGridSteps('gridSlFrom','gridSlTo','gridSlStep');
            const tp=countGridSteps('gridTpFrom','gridTpTo','gridTpStep');
            const hold=countGridSteps('gridHoldFrom','gridHoldTo','gridHoldStep');
            const vol=countGridSteps('gridVolFrom','gridVolTo','gridVolStep');
            const bs = countGridStepsInt('gridBatchFrom','gridBatchTo','gridBatchStep');
            const ms = countGridStepsInt('gridMemFrom','gridMemTo','gridMemStep');
            const dec = countGridStepsInt('gridEpsDecayFrom','gridEpsDecayTo','gridEpsDecayStep');
            const hs = countHiddenRange();
            const total=sl*tp*hold*vol*bs*ms*hs*dec;
            const el=document.getElementById('gridTotalCombo');
            if(el){ el.textContent=total; el.style.color=total>500?'#dc2626':'#2563eb'; }
        }

        // –ü—Ä–∏–≤—è–∑–∫–∏
        document.addEventListener('DOMContentLoaded', function(){
            ['gridSlFrom','gridSlTo','gridSlStep','gridTpFrom','gridTpTo','gridTpStep',
             'gridHoldFrom','gridHoldTo','gridHoldStep','gridVolFrom','gridVolTo','gridVolStep',
             'gridBatchFrom','gridBatchTo','gridBatchStep','gridMemFrom','gridMemTo','gridMemStep',
             'gridHiddenFrom','gridHiddenTo','gridHiddenStep','gridEpsDecayFrom','gridEpsDecayTo','gridEpsDecayStep'
            ].forEach(function(id){ var e=document.getElementById(id); e&&e.addEventListener('input',updateGridComboCount); });
            updateGridComboCount();
            try{
                const symSel = document.getElementById('trainSymbolSelect');
                symSel && symSel.addEventListener('change', function(){
                    const val = (this.value||'').trim();
                    if(val){ loadEncodersForSymbol(val); }
                });
                const encSel = document.getElementById('encoderSelect');
                encSel && encSel.addEventListener('change', onEncoderChanged);
            }catch(_){ }
        });

        // –°–µ–∫—Ü–∏—è "–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏" —É–¥–∞–ª–µ–Ω–∞

        // –ö–∞—Ä—Ç–æ—á–∫–∏/–∞–Ω–∞–ª–∏–∑/—É–¥–∞–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π –æ—Ç–∫–ª—é—á–µ–Ω—ã

        // –ê–Ω–∞–ª–∏–∑ –º–æ–¥–µ–ª–∏ –æ—Ç–∫–ª—é—á—ë–Ω

        // –£–¥–∞–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ –æ—Ç–∫–ª—é—á–µ–Ω–æ
    </script>
    <script src="/static/js/sidebar.js"></script>
</body>
</html>

